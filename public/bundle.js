(()=>{var le={checkRectRectCollision(r,e){let t=(p,M)=>p.x*M.x+p.y*M.y,s=(p,M)=>({x:p.x-M.x,y:p.y-M.y}),a=p=>{let M=Math.hypot(p.x,p.y);return M===0?{x:0,y:0}:{x:p.x/M,y:p.y/M}},d=p=>{let M=p.w/2,D=p.h/2,x=Math.cos(p.r),H=Math.sin(p.r);return[{x:-M,y:-D},{x:M,y:-D},{x:M,y:D},{x:-M,y:D}].map(L=>({x:p.x+L.x*x-L.y*H,y:p.y+L.x*H+L.y*x}))},w=p=>{let M=[];for(let D=0;D<2;D++){let x=p[D],H=p[(D+1)%4],A=s(H,x),L={x:-A.y,y:A.x};M.push(a(L))}return M},g=(p,M)=>{let D=t(p[0],M),x=D;for(let H=1;H<p.length;H++){let A=t(p[H],M);A<D&&(D=A),A>x&&(x=A)}return{min:D,max:x}},u=(p,M)=>!(p.max<M.min||M.max<p.min);if(r.w<=0||r.h<=0||e.w<=0||e.h<=0)return!1;let c=d(r),f=d(e),o=[...w(c),...w(f)];for(let p of o){let M=g(c,p),D=g(f,p);if(!u(M,D))return!1}return!0},getPointRectDist(r,e){function t(c){let f=Math.cos(c.r),o=Math.sin(c.r),p=c.w/2,M=c.h/2;return[[-p,-M],[p,-M],[p,M],[-p,M]].map(([x,H])=>[c.x+x*f-H*o,c.y+x*o+H*f])}function s(c,f,o,p,M,D){let x=M-o,H=D-p,A=x*x+H*H;if(A===0)return Math.hypot(c-o,f-p);let L=((c-o)*x+(f-p)*H)/A;L=Math.max(0,Math.min(1,L));let J=o+L*x,I=p+L*H;return Math.hypot(c-J,f-I)}function a(c,f,o){let p=Math.cos(-o.r),M=Math.sin(-o.r),D=(c-o.x)*p-(f-o.y)*M,x=(c-o.x)*M+(f-o.y)*p;return Math.abs(D)<=o.w/2&&Math.abs(x)<=o.h/2}function d(c,f){let o=t(c),p=t(f),M=[[Math.cos(c.r),Math.sin(c.r)],[-Math.sin(c.r),Math.cos(c.r)],[Math.cos(f.r),Math.sin(f.r)],[-Math.sin(f.r),Math.cos(f.r)]];for(let[D,x]of M){let H=o.map(([C,Y])=>C*D+Y*x),A=p.map(([C,Y])=>C*D+Y*x),L=Math.min(...H),J=Math.max(...H),I=Math.min(...A),P=Math.max(...A);if(J<I||P<L)return!1}return!0}if(d(r,e))return 0;let w=t(r),g=t(e),u=1/0;for(let c=0;c<4;c++){let[f,o]=w[c];for(let p=0;p<4;p++){let[M,D]=g[p],[x,H]=g[(p+1)%4],A=s(f,o,M,D,x,H);u=Math.min(u,A)}}for(let c=0;c<4;c++){let[f,o]=g[c];for(let p=0;p<4;p++){let[M,D]=w[p],[x,H]=w[(p+1)%4],A=s(f,o,M,D,x,H);u=Math.min(u,A)}}return u}};var ce=class{x;y;constructor(e,t){this.x=e,this.y=t}};var Ce=class{x;y;hp;constructor(e,t,s){this.x=e,this.y=t,this.hp=s}getSize(){return new ce(64,64)}draw(e){e.fillStyle="green";let t=this.getSize();e.fillRect(this.x-t.x/2,this.y-t.y/2,t.x,t.y)}getRotation(){return 0}heal(e){}bounce(e,t){}};var Te=class r{static FAST_DURATION=10;static SLOW_DURATION=60;orientation;x;y;w;h;sections;background;borderColor;animColor;value;valueReference;timer;animDuration;mode;fastValue;slowValue;fastTimer;slowTimer;targetValue;fastStartValue;slowStartValue;constructor(e,t,s,a,d,w,g,u,c,f){this.orientation=e,this.x=s,this.y=a,this.w=d,this.h=w,this.sections=g,this.background=c,this.borderColor=f,this.animColor=u,t=Math.max(0,Math.min(1,t)),this.value=t,this.valueReference=t,this.timer=-1,this.animDuration=0,this.mode=null,this.fastValue=t,this.slowValue=t,this.fastTimer=-1,this.slowTimer=-1,this.targetValue=t,this.fastStartValue=t,this.slowStartValue=t}animFunction(e){return 1-Math.pow(1-e,3)}setValue(e){e=Math.max(0,Math.min(1,e)),e!==this.targetValue&&(this.targetValue=e,e>this.value?(this.mode="up",this.slowStartValue=this.value,this.slowTimer=0,this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0):(this.mode="down",this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0,this.slowStartValue=this.value,this.slowTimer=0))}update(){let e=!1;if(this.fastTimer>=0)if(this.fastTimer++,this.fastTimer<=r.FAST_DURATION){let t=this.fastTimer/r.FAST_DURATION,s=this.animFunction(t);this.mode==="up"?this.fastValue=this.fastStartValue+(this.targetValue-this.fastStartValue)*s:this.value=this.fastStartValue+(this.targetValue-this.fastStartValue)*s,e=!0}else this.mode==="up"?this.fastValue=this.targetValue:this.value=this.targetValue,this.fastTimer=-1;if(this.slowTimer>=0)if(this.slowTimer++,this.slowTimer<=r.SLOW_DURATION){let t=this.slowTimer/r.SLOW_DURATION,s=this.animFunction(t);this.mode==="up"?this.value=this.slowStartValue+(this.targetValue-this.slowStartValue)*s:this.slowValue=this.slowStartValue+(this.targetValue-this.slowStartValue)*s,e=!0}else this.mode==="up"?this.value=this.targetValue:this.slowValue=this.targetValue,this.slowTimer=-1;e||(this.mode=null,this.fastValue=this.value,this.slowValue=this.value)}draw(e){this.background&&(e.fillStyle=this.background,e.fillRect(this.x,this.y,this.w,this.h));let t=2,s=this.x+t,a=this.y+t,d=this.w-2*t,w=this.h-2*t;this.drawSections(e,s,a,d,w,this.value),this.mode==="up"&&this.slowTimer>=0?this.drawAnimationBar(e,s,a,d,w,this.value,this.fastValue):this.mode==="down"&&this.slowTimer>=0&&this.drawAnimationBar(e,s,a,d,w,this.value,this.slowValue),e.strokeStyle=this.borderColor,e.lineWidth=t,e.strokeRect(this.x,this.y,this.w,this.h)}drawSections(e,t,s,a,d,w){let g=this.sections.length;if(this.orientation==="horizontal"){let u=a*w,c=a/g,f=2;for(let o=0;o<g;o++){let p=t+o*c,M=t+(o+1)*c,D=Math.max(p,t),x=Math.min(M,t+u);x>D&&(e.fillStyle=this.sections[o],e.fillRect(D,s,x-D,d)),o<g-1&&M<t+u&&(e.fillStyle="black",e.fillRect(M-f/2,s,f,d))}}else{let u=d*w,c=d/g,f=2;for(let o=0;o<g;o++){let p=s+d-(o+1)*c,M=s+d-o*c,D=Math.max(p,s+d-u),x=Math.min(M,s+d);x>D&&(e.fillStyle=this.sections[o],e.fillRect(t,D,a,x-D)),o<g-1&&p>s+d-u&&(e.fillStyle="black",e.fillRect(t,p-f/2,a,f))}}}drawAnimationBar(e,t,s,a,d,w,g){if(e.fillStyle=this.animColor,this.orientation==="horizontal"){let u=t+a*Math.min(w,g),c=a*Math.abs(g-w);e.fillRect(u,s,c,d)}else{let u=s+d*(1-Math.max(w,g)),c=d*Math.abs(g-w);e.fillRect(t,u,a,c)}}};var V=class r extends Ce{static GRAVITY=.9;static DASH=20;static JUMP=25;static MAX_SPEED=25;static SPEED_INC=3;static SPEED_DEC=10;static JUMP_COUNT=3;static HP=3;static JUMP_HP_COST=1;static RESPAWN_COULDOWN=30;static DEATH_ANIM_COULDOWN=60;static SIZE=40;static SIZE_2=r.SIZE/2;vx=0;vy=0;eternalMode=!1;jumps=r.JUMP_COUNT;respawnCouldown=-1;jump_leveledBar=new Te("vertical",1,1500,150,30,600,["#FFA800","#FFD000","#FFF200"],"#fffdceff",null,"black");hp_leveledBar=new Te("horizontal",1,300,100,1e3,30,["#ff0044","#ff002f","#ff001a"],"#ffb1c5",null,"black");constructor(){super(0,0,r.HP),this.respawn()}getSize(){return new ce(r.SIZE,r.SIZE)}consumeJump(e=1){if(this.jumps>0){this.jumps-=e,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT);return}this.hit(r.JUMP_HP_COST,null)}bounce(e,t){if(this.vy<=0)return;let s=t*this.vy;this.jumps>=s?(this.jumps-=s,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT)):(this.jumps=0,this.jump_leveledBar.setValue(0)),this.vy*=-e}restoreJumps(){this.jumps=r.JUMP_COUNT,this.jump_leveledBar.setValue(1)}restoreJumpAdd(e){let t=this.jumps+e;this.jumps=t>=r.JUMP_COUNT?r.JUMP_COUNT:t,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT)}restoreHp(){this.hp=r.HP,this.hp_leveledBar.setValue(1)}hit(e,t){this.eternalMode||this.isAlive()&&(this.hp-=e,this.hp_leveledBar.setValue(this.hp/r.HP),this.hp<=0&&this.kill())}heal(e){this.hp+=e,this.hp>=r.HP?(this.hp=r.HP,this.hp_leveledBar.setValue(1)):this.hp_leveledBar.setValue(this.hp/r.HP)}isAlive(){return this.respawnCouldown<=r.RESPAWN_COULDOWN}kill(){this.eternalMode||(this.respawnCouldown=r.DEATH_ANIM_COULDOWN)}respawn(){this.x=0,this.y=0,this.vx=0,this.vy=-r.JUMP,this.restoreHp(),this.restoreJumps()}getSpeed2(){return this.vx*this.vx+this.vy*this.vy}reduceCouldown(){return this.respawnCouldown>=0&&(this.respawnCouldown--,this.respawnCouldown==r.RESPAWN_COULDOWN)}frame(e){let t=e.inputHandler;t.press("left")?this.vx>0?this.vx-=r.SPEED_DEC:this.vx-=r.SPEED_INC:t.press("right")?this.vx<0?this.vx+=r.SPEED_DEC:this.vx+=r.SPEED_INC:this.vx>0?(this.vx-=r.SPEED_DEC,this.vx<0&&(this.vx=0)):this.vx<0&&(this.vx+=r.SPEED_DEC,this.vx>0&&(this.vx=0)),this.vx>r.MAX_SPEED&&(this.vx=r.MAX_SPEED),this.vx<-r.MAX_SPEED&&(this.vx=-r.MAX_SPEED),t.first("up")&&(this.consumeJump(),this.vy=-r.JUMP),this.vy+=r.GRAVITY,t.press("down")&&(this.y+=r.DASH),this.x+=this.vx*(this.eternalMode?3:1),this.y+=this.vy}draw(e){e.fillStyle="white",e.strokeStyle="black",e.lineWidth=5;let t=4,s=this.x-r.SIZE_2,a=this.y-r.SIZE_2,d=r.SIZE;e.fillRect(s,a,d,d),e.beginPath(),e.moveTo(s+t,a),e.lineTo(s+d-t,a),e.quadraticCurveTo(s+d,a,s+d,a+t),e.lineTo(s+d,a+d-t),e.quadraticCurveTo(s+d,a+d,s+d-t,a+d),e.lineTo(s+t,a+d),e.quadraticCurveTo(s,a+d,s,a+d-t),e.lineTo(s,a+t),e.quadraticCurveTo(s,a,s+t,a),e.closePath(),e.stroke()}drawInfos(e){this.jump_leveledBar.update(),this.jump_leveledBar.draw(e),this.hp_leveledBar.update(),this.hp_leveledBar.draw(e)}drawDeathTransition(e){if(this.respawnCouldown<0)return;e.fillStyle="#ff0044";function t(a){return Math.sin(a*Math.PI/2)}let s=t(this.respawnCouldown/r.DEATH_ANIM_COULDOWN);if(s<.5){let a=W.WIDTH*2*s;e.fillRect(W.WIDTH-a,0,a,W.HEIGHT)}else{let a=W.WIDTH*2*(1-s);e.fillRect(0,0,a,W.HEIGHT)}}};var Ve=class{dx;dy;duration;constructor(e,t,s=-1){this.dx=e,this.dy=t,this.duration=s}},Ie=class{liberationCouldown;usages=new Map;constructor(e){this.liberationCouldown=e}track(e,t){let s=this.usages.get(e);return this.usages.set(e,t+this.liberationCouldown),s===void 0||s<=t}reset(){this.usages.clear()}},Ke=class r{patterns;times;currentPattern;currentTime;loopCount;active;constructor(e,t){this.patterns=e,this.times=t,this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}update(e,t){if(!this.active||this.patterns.length===0)return;let s=this.patterns[this.currentPattern];if(e.x+=s.dx,e.y+=s.dy,this.currentTime++,s.duration!==-1&&this.currentTime>=s.duration&&(this.currentPattern++,this.currentTime=0,this.currentPattern>=this.patterns.length&&(this.loopCount++,this.times!==-1&&this.loopCount>=this.times?this.active=!1:this.currentPattern=0)),!t.containsBox(e.x,e.y,e.w,e.h)){let a=null;for(let d of t.adjacentRooms)d.containsBox(e.x,e.y,e.w,e.h)&&(a=d);a?e.toMove=a:e.toRemove=!0}}reset(){this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}copy(){let e=new r(this.patterns,this.times);return e.currentPattern=this.currentPattern,e.currentTime=this.currentTime,e.loopCount=this.loopCount,e.active=this.active,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},je=class{spikes_x;spikes_y;spikes_w;spikes_h;constructor(e,t,s=32,a=32){this.spikes_x=Math.max(1,Math.ceil(e/s)),this.spikes_w=e/this.spikes_x,this.spikes_y=Math.max(1,Math.ceil(t/a)),this.spikes_h=t/this.spikes_y}},Je=class r{damages;duration;playerOnly;couldowns=new Map;constructor(e,t,s=!0){this.damages=e,this.duration=t,this.playerOnly=s}update(e){for(let[t,s]of this.couldowns){let a=s-1;a<=0?this.couldowns.delete(t):this.couldowns.set(t,a)}}reset(){this.couldowns.clear()}onTouch(e){this.playerOnly&&!(e instanceof V)||this.couldowns.has(e)||(this.couldowns.set(e,this.duration),e.hit(this.damages,null))}copy(){let e=new r(this.damages,this.duration,this.playerOnly);return e.couldowns=new Map(this.couldowns),e}draw(e,t,s){t.fillStyle="#9B59B6",t.fillRect(-e.w/2,-e.h/2,e.w,e.h);let a=1;for(let[w,g]of this.couldowns)if(w instanceof V){a=(this.duration-g)/this.duration,a<0&&(a=0),a>1&&(a=1);break}function d(w,g,u){let[c,f]=w,[o,p]=g,[M,D]=u;{let x=c+(M-c),H=f+(D-f),A=o+(M-o),L=p+(D-p);t.beginPath(),t.moveTo(c,f),t.lineTo(x,H),t.lineTo(A,L),t.lineTo(o,p),t.closePath(),t.fillStyle="#dec5ffff",t.fill()}if(t.beginPath(),t.moveTo(c,f),t.lineTo(M,D),t.lineTo(o,p),t.closePath(),t.strokeStyle="#FFEEAA",t.lineWidth=2,t.stroke(),a>0){let x=c+(M-c)*a,H=f+(D-f)*a,A=o+(M-o)*a,L=p+(D-p)*a;t.beginPath(),t.moveTo(c,f),t.lineTo(x,H),t.lineTo(A,L),t.lineTo(o,p),t.closePath(),t.fillStyle="#882dffff",t.fill()}}for(let w=0;w<s.spikes_x;w++){let g=-e.w/2+w*s.spikes_w+s.spikes_w/2,u=-e.h/2;d([g-s.spikes_w/2,u],[g+s.spikes_w/2,u],[g,u-s.spikes_h]);let c=e.h/2;d([g-s.spikes_w/2,c],[g+s.spikes_w/2,c],[g,c+s.spikes_h])}for(let w=0;w<s.spikes_y;w++){let g=-e.h/2+w*s.spikes_h+s.spikes_h/2,u=-e.w/2;d([u,g-s.spikes_w/2],[u,g+s.spikes_w/2],[u-s.spikes_h,g]);let c=e.w/2;d([c,g-s.spikes_w/2],[c,g+s.spikes_w/2],[c+s.spikes_h,g])}}generateAnimator(e){return new je(e.w,e.h)}},qe=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,a=e.createRadialGradient(0,0,0,0,0,t*1.5);a.addColorStop(0,`rgba(114, 0, 129, ${this.alpha})`),a.addColorStop(1,"rgba(114, 0, 129, 0)"),e.fillStyle=a,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},Ze=class r{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.particles.push(new qe(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Qe=class r{damages;playerOnly;constructor(e,t=!0){this.damages=e,this.playerOnly=t}reset(){}onTouch(e){this.playerOnly&&!(e instanceof V)||e.hit(this.damages,null)}copy(){return new r(this.damages,this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgb(111, 0, 255)",t.shadowBlur=50,t.fillStyle="rgba(212, 0, 255, 1)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new Ze}},et=class{arrows=[];spacing;time=0;constructor(e,t=30){let s=Math.ceil(e/t);this.spacing=e/s;for(let a=0;a<s;a++)this.arrows.push({y:a*this.spacing})}getSpeed(){return Math.max(.3,Math.sin(this.time/2)*3)}update(e){this.time+=.1;let t=this.getSpeed();for(let s of this.arrows)s.y+=t,s.y>e&&(s.y-=e)}getArrows(){return this.arrows}getOpacity(e,t){let s=this.spacing;return e<s?e/s:e>t-s?(t-e)/s:1}},tt=class r{cost;factor;playerOnly;helper;constructor(e,t,s=!0,a=12){this.factor=e,this.cost=t,this.playerOnly=s,this.helper=new Ie(a)}reset(){this.helper.reset()}onTouch(e,t){this.playerOnly&&!(e instanceof V)||this.helper.track(e,t)&&e.bounce(this.factor,this.cost)}update(){}copy(){return new r(this.factor,this.cost,this.playerOnly)}draw(e,t,s){s.update(e.h),t.save(),t.shadowColor="rgba(255, 220, 100, 0.9)",t.shadowBlur=35;let a=t.createLinearGradient(-e.w/2,-e.h/2,e.w/2,e.h/2);a.addColorStop(0,"#FFE066"),a.addColorStop(1,"#FFAA00"),t.fillStyle=a,t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore();let d=e.w*.6,w=20;for(let g=0;g<s.getArrows().length;g++){let u=s.getArrows()[g],c=0,f=e.h/2-u.y-10,o=s.getOpacity(u.y,e.h);t.save(),t.globalAlpha=o,t.strokeStyle="#FFFF80",t.lineWidth=3,t.shadowColor="rgba(255, 240, 180, 1)",t.shadowBlur=20,t.beginPath(),t.moveTo(c,f-w/2),t.lineTo(c-d/2,f+w/2),t.moveTo(c,f-w/2),t.lineTo(c+d/2,f+w/2),t.stroke(),t.restore()}}generateAnimator(e){return new et(e.h)}},st=class{x;y;r;vx;vy;alpha;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.r=2+Math.random()*4,this.vx=(Math.random()-.5)*.5,this.vy=-.5-Math.random()*1,this.alpha=1.4}update(){return this.x+=this.vx,this.y+=this.vy,this.alpha-=.01,this.alpha>0}draw(e){let t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r*2);t.addColorStop(0,`rgba(200, 20, 0, ${this.alpha})`),t.addColorStop(1,"rgba(255, 30, 0, 0)"),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.r,0,Math.PI*2),e.fill()}},nt=class r{bubbles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.bubbles.push(new st(e,t))),this.bubbles=this.bubbles.filter(s=>s.update())}draw(e){this.bubbles.forEach(t=>t.draw(e))}},ot=class r{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e){this.playerOnly&&!(e instanceof V)||e.hit(1/0,null)}copy(){return new r(this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgba(255,0,0,0.8)",t.shadowBlur=20,t.fillStyle="red",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new nt}},at=class r{duration;couldown;constructor(e){this.duration=e,this.couldown=e}update(e){--this.couldown<=0&&(e.toRemove=!0)}reset(){this.couldown=this.duration}copy(){let e=new r(this.duration);return e.couldown=this.couldown,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},rt=class r{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e,t){this.playerOnly&&!(e instanceof V)||(t.toRemove=!0)}copy(){return new r(this.playerOnly)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Me=class r{particles=[];usableColor={r:50,g:150,b:50};touchedColor={r:30,g:100,b:30};currentColor={r:50,g:150,b:50};baseShadowBlur=30;shadowPulse=0;production=0;static PRODUCTION=2e5;update(e){e.module.heal?.playerHasTouched?(this.currentColor.r+=(this.touchedColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.touchedColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.touchedColor.b-this.currentColor.b)*.05):(this.currentColor.r+=(this.usableColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.usableColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.usableColor.b-this.currentColor.b)*.05),e.module.heal?.playerHasTouched?this.shadowPulse=0:this.shadowPulse+=.04,e.module.heal?.playerHasTouched||(this.production+=e.w*e.h,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.particles.push({x:(Math.random()-.5)*e.w*.8,y:(Math.random()-.5)*e.h*.8,vy:-.5-Math.random(),size:5+Math.random()*5,alpha:1})));for(let s of this.particles)s.y+=s.vy,s.alpha-=.02;this.particles=this.particles.filter(s=>s.alpha>0)}getColor(){return`rgb(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b})`}getShadowBlur(e){return e.module.heal?.playerHasTouched?this.baseShadowBlur*.1:this.baseShadowBlur+Math.sin(this.shadowPulse)*5}},it=class r{hp;playerOnly;touched=new Set;playerHasTouched=!1;constructor(e,t=!0){this.hp=e,this.playerOnly=t}reset(){this.touched.clear(),this.playerHasTouched=!1}onTouch(e){let t=e instanceof V;this.playerOnly&&!t||(t&&(this.playerHasTouched=!0),this.touched.has(e)||(this.touched.add(e),e.heal(this.hp)))}copy(){let e=new r(this.hp,this.playerOnly);return e.touched=new Set(this.touched),e}draw(e,t,s){s.update(e);let a=s.getShadowBlur(e);t.save(),t.shadowColor="rgba(100, 255, 100, 0.8)",t.shadowBlur=a,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),e.cancelRotation(t,()=>{for(let d of s.particles){t.save(),t.globalAlpha=d.alpha,t.strokeStyle="#B0FFB0",t.lineWidth=2,t.shadowColor="rgba(180, 255, 180, 0.8)",t.shadowBlur=a/2;let w=d.x,g=d.y,u=d.size/2;t.beginPath(),t.moveTo(w-u,g),t.lineTo(w+u,g),t.moveTo(w,g-u),t.lineTo(w,g+u),t.stroke(),t.restore()}})}generateAnimator(e){return new Me}},Be=class r{vx;vy;constructor(e=0,t=0){this.vx=e,this.vy=t}update(e,t){if(e.x+=this.vx,e.y+=this.vy,!t.containsBox(e.x,e.y,e.w,e.h)){let s=null;for(let a of t.adjacentRooms)a.containsBox(e.x,e.y,e.w,e.h)&&(s=a);s?e.toMove=s:e.toRemove=!0}}reset(){this.vx=0,this.vy=0}copy(){return new r(this.vx,this.vy)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},lt=class r{ax;ay;constructor(e,t){this.ax=e,this.ay=t}update(e){if(!e.module.speed)throw new Error("AccelerationModule requires SpeedModule to be used");e.module.speed.vx+=this.ax,e.module.speed.vy+=this.ay}reset(){}copy(){return new r(this.ax,this.ay)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},ct=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,a=e.createRadialGradient(0,0,0,0,0,t*1.5);a.addColorStop(0,`rgba(255, 255, 180, ${this.alpha})`),a.addColorStop(1,"rgba(255, 200, 0, 0)"),e.fillStyle=a,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},dt=class{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>Me.PRODUCTION&&(this.production-=Me.PRODUCTION,this.particles.push(new ct(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},ut=class r{gain;helper;constructor(e,t=12){this.gain=e,this.helper=new Ie(t)}reset(){this.helper.reset()}onTouch(e,t){e instanceof V&&this.helper.track(e,t)&&e.restoreJumpAdd(this.gain)}copy(){return new r(this.gain)}draw(e,t,s){t.save(),t.shadowColor="rgba(255, 230, 100, 0.9)",t.shadowBlur=15,t.fillStyle="rgba(255, 220, 0, 0.6)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new dt}},ht=class r{start;speed;angle;constructor(e,t){this.start=e,this.speed=t,this.angle=e}update(){this.angle+=this.speed,this.angle>=360&&(this.angle-=360)}reset(){this.angle=this.start}getAngle(){let e=Math.PI*2;return(this.angle%e+e)%e}copy(){let e=new r(this.start,this.speed);return e.angle=this.angle,e}},pt=class{time=0;getColor(){let e=.7+.3*Math.sin(this.time*4),t=0,s=Math.floor(150+50*e);return`rgb(${t}, ${s}, 255)`}getShadowBlur(e){return e+15*Math.sin(this.time*4)}},mt=class{type;constructor(e){this.type=e}draw(e,t,s){s.time+=.015;function a(d){t.save(),t.shadowColor="rgba(0, 200, 255, 0.9)",t.shadowBlur=d,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),t.lineWidth=2,t.strokeStyle="rgba(0, 150, 255, 0.8)",t.strokeRect(-e.w/2,-e.h/2,e.w,e.h)}a(s.getShadowBlur(100)),a(s.getShadowBlur(70)),a(s.getShadowBlur(40))}generateAnimator(e){return new pt}},ft=class r{rythm;couldown;blocks;index=0;constructor(e,t,s){this.rythm=e,this.couldown=t?1:e,this.blocks=s}update(e,t){if(--this.couldown<=0){this.couldown+=this.rythm;let s=this.blocks[this.index];++this.index>=this.blocks.length&&(this.index-=this.blocks.length);let a=s.build(e);a&&(a.fromSpawner=!0,t.blocks.push(a))}}copy(){let e=new r(this.rythm,!1,this.blocks);return e.couldown=this.couldown,e.index=this.index,e}},de=class r{static DEFAULT_SIZE=50;dx;dy;w;h;keepRotation;goal;module;constructor(e,t={}){this.dx=t.dx??0,this.dy=t.dy??0,this.w=t.w??r.DEFAULT_SIZE,this.h=t.h??r.DEFAULT_SIZE,this.goal=t.goal??0,this.keepRotation=t.keepRotation??!1,this.module=e}build(e){return this.module?new K(e.x+this.dx,e.y+this.dy,this.w,this.h,this.module.copy()):null}},Q=class r{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal;checkCollision;runInAdjacentRoom;constructor(e){this.moving=e.moving,this.rotation=e.rotation,this.couldownedAttack=e.couldownedAttack,this.continuousAttack=e.continuousAttack,this.bounce=e.bounce,this.kill=e.kill,this.heal=e.heal,this.touchDespawn=e.touchDespawn,this.restoreJump=e.restoreJump,this.couldownDespawn=e.couldownDespawn,this.spawner=e.spawner,this.speed=e.speed,this.acceleration=e.acceleration,this.acceleration&&!this.speed&&(this.speed=new Be(0,0)),this.runInAdjacentRoom=!!e.runInAdjacentRoom,e.goal&&(this.goal=new mt(e.goal)),this.checkCollision=[e.couldownedAttack,e.continuousAttack,e.bounce,e.kill,e.heal,e.touchDespawn,e.restoreJump,e.goal].some(t=>t)}copy(){return new r({moving:this.moving?.copy(),rotation:this.rotation?.copy(),couldownedAttack:this.couldownedAttack?.copy(),continuousAttack:this.continuousAttack?.copy(),bounce:this.bounce?.copy(),kill:this.kill?.copy(),heal:this.heal?.copy(),touchDespawn:this.touchDespawn?.copy(),restoreJump:this.restoreJump?.copy(),couldownDespawn:this.couldownDespawn?.copy(),spawner:this.spawner?.copy(),speed:this.speed?.copy(),acceleration:this.acceleration?.copy(),runInAdjacentRoom:this.runInAdjacentRoom})}getDrawModule(e){let t=[this.goal,this.kill,this.heal,this.couldownedAttack,this.continuousAttack,this.restoreJump,this.bounce,this.moving,this.speed,this.acceleration],s=e;for(let a of t)if(a){if(s===0)return a;s--}return null}},K=class{x;y;w;h;start_x;start_y;start_w;start_h;module;toRemove=!1;addAtReset=!1;toMove=null;spawnRoom;fromSpawner=!1;drawMode;drawAnimator;constructor(e,t,s,a,d){this.x=e,this.y=t,this.w=s,this.h=a,this.start_x=e,this.start_y=t,this.start_w=s,this.start_h=a,this.module=d,this.drawMode=d.getDrawModule(0),this.drawMode?this.drawAnimator=this.drawMode.generateAnimator(this):this.drawAnimator=void 0}getRotation(){return this.module.rotation?this.module.rotation.getAngle():0}handleTouch(e,t){let s=e.getSize();le.checkRectRectCollision({x:this.x,y:this.y,w:this.w,h:this.h,r:this.getRotation()},{x:e.x,y:e.y,w:s.x,h:s.y,r:e.getRotation()})&&(this.module.couldownedAttack?.onTouch(e),this.module.continuousAttack?.onTouch(e),this.module.bounce?.onTouch(e,t.frame),this.module.kill?.onTouch(e),this.module.heal?.onTouch(e),this.module.touchDespawn?.onTouch(e,this),this.module.restoreJump?.onTouch(e,t.frame),this.module.goal&&(t.goalComplete=this.module.goal.type))}init(e){this.spawnRoom=e}frame(e,t){this.module.moving?.update(this,t),this.module.speed?.update(this,t),this.module.acceleration?.update(this),this.module.rotation?.update(),this.module.couldownedAttack?.update(this),this.module.couldownDespawn?.update(this),this.module.spawner?.update(this,t),this.module.bounce?.update(),this.module.checkCollision&&this.handleTouch(e.player,e),this.toRemove&&!this.fromSpawner&&this.spawnRoom.missingBlocks.push(this)}reset(){this.x=this.start_x,this.y=this.start_y,this.w=this.start_w,this.h=this.start_h,this.module.moving?.reset(),this.module.rotation?.reset(),this.module.couldownedAttack?.reset(),this.module.continuousAttack?.reset(),this.module.bounce?.reset(),this.module.kill?.reset(),this.module.heal?.reset(),this.module.touchDespawn?.reset(),this.module.restoreJump?.reset(),this.module.couldownDespawn?.reset()}draw(e){e.fillStyle="#555",e.save(),e.translate(this.x,this.y),this.module.rotation&&e.rotate(this.module.rotation.getAngle()),this.drawMode?this.drawMode.draw(this,e,this.drawAnimator):this.drawAsDefault(e),e.restore()}drawAsDefault(e){e.fillStyle="#555",e.fillRect(-this.w/2,-this.h/2,this.w,this.h)}cancelRotation(e,t){this.module.rotation?(e.save(),e.rotate(-this.module.rotation.getAngle()),t(),e.restore()):t()}},Ae={MovingPath:Ve,MovingModule:Ke,CouldownedAttackModule:Je,ContinuousAttackModule:Qe,BounceModule:tt,KillModule:ot,CouldownDespawnModule:at,TouchDespawnModule:rt,HealModule:it,SpeedModule:Be,AccelerationModule:lt,RestoreJumpModule:ut,RotationModule:ht,SpawnerModule:ft};var Z=class{x;y;w;h;blocks;missingBlocks=[];adjacentRooms=null;adjacenceRects=null;constructor(e,t,s,a,d){this.x=e,this.y=t,this.w=s,this.h=a,this.blocks=d}fillAdjacenceRects(){let e=this.adjacentRooms,t=[],s=20,a=[{name:"top",start:this.x,end:this.x+this.w,coord:this.y},{name:"bottom",start:this.x,end:this.x+this.w,coord:this.y+this.h},{name:"left",start:this.y,end:this.y+this.h,coord:this.x},{name:"right",start:this.y,end:this.y+this.h,coord:this.x+this.w}];for(let d of a){let w=[];for(let c of e)if(d.name==="top"&&c.y+c.h===this.y){let f=Math.max(this.x,c.x),o=Math.min(this.x+this.w,c.x+c.w);f<o&&w.push({start:f,end:o})}else if(d.name==="bottom"&&c.y===this.y+this.h){let f=Math.max(this.x,c.x),o=Math.min(this.x+this.w,c.x+c.w);f<o&&w.push({start:f,end:o})}else if(d.name==="left"&&c.x+c.w===this.x){let f=Math.max(this.y,c.y),o=Math.min(this.y+this.h,c.y+c.h);f<o&&w.push({start:f,end:o})}else if(d.name==="right"&&c.x===this.x+this.w){let f=Math.max(this.y,c.y),o=Math.min(this.y+this.h,c.y+c.h);f<o&&w.push({start:f,end:o})}w.sort((c,f)=>c.start-f.start);let g=[];for(let c of w)g.length===0||g[g.length-1].end<c.start?g.push({...c}):g[g.length-1].end=Math.max(g[g.length-1].end,c.end);let u=d.start;for(let c of g)u<c.start&&(d.name==="top"?t.push({x:u,y:this.y,w:c.start-u,h:s}):d.name==="bottom"?t.push({x:u,y:this.y+this.h-s,w:c.start-u,h:s}):d.name==="left"?t.push({x:this.x,y:u,w:s,h:c.start-u}):d.name==="right"&&t.push({x:this.x+this.w-s,y:u,w:s,h:c.start-u})),u=c.end;u<d.end&&(d.name==="top"?t.push({x:u,y:this.y,w:d.end-u,h:s}):d.name==="bottom"?t.push({x:u,y:this.y+this.h-s,w:d.end-u,h:s}):d.name==="left"?t.push({x:this.x,y:u,w:s,h:d.end-u}):d.name==="right"&&t.push({x:this.x+this.w-s,y:u,w:s,h:d.end-u}))}this.adjacenceRects=t}contains(e,t){return e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h}containsBox(e,t,s,a){let d=this.x,w=this.x+this.w,g=this.y,u=this.y+this.h,c=e-s/2,f=e+s/2,o=t-a/2,p=t+a/2;return w>=c&&d<=f&&u>=o&&g<=p}init(){let e=this.blocks.length;for(let t=0;t<e;t++)this.blocks[t].init(this)}frame(e,t){for(let s=this.blocks.length-1;s>=0;s--){let a=this.blocks[s];a.frame(e,this),a.toRemove&&(this.blocks.splice(s,1),a.toRemove=!1,a.toMove=null),a.toMove&&(t.push({block:a,dest:a.toMove}),this.blocks.splice(s,1),a.toMove=null)}}reset(){for(let e of this.missingBlocks)this.blocks.push(e);this.missingBlocks.length=0;for(let e=this.blocks.length-1;e>=0;e--)this.blocks[e].fromSpawner?this.blocks.splice(e,1):this.blocks[e].reset()}drawAdjacenceRects(e,t,s){let a=t.getSize(),d={x:t.x,y:t.y,w:a.x,h:a.y,r:0};for(let w of this.adjacenceRects){let g=le.checkRectRectCollision({x:w.x,y:w.y,w:w.w,h:w.h,r:0},d);s===g&&e.fillRect(w.x,w.y,w.w,w.h)}}draw(e){for(let t of this.blocks)t.draw(e)}};function fn(){return new Promise((r,e)=>{let t=indexedDB.open("levels-db",1);t.onupgradeneeded=s=>{let a=s.target.result;a.objectStoreNames.contains("levels")||a.createObjectStore("levels")},t.onsuccess=()=>r(t.result),t.onerror=()=>e(t.error)})}var ue=class{stage;name;key;constructor(e,t=null,s=null){this.key=e,this.stage=t,this.name=s}async load(){if(this.stage&&this.name)return{stage:this.stage,name:this.name};let a=(await fn()).transaction("levels","readonly").objectStore("levels").get(this.key),d=await new Promise((c,f)=>{a.onsuccess=()=>c(a.result??null),a.onerror=()=>f(a.error)});function*w(){let c="",f=!1;for(let o=0;o<d.length;o++){let p=d[o];if(!f)if(p===`
`||p==="\r"){yield c,c="",f=!0;continue}else{c+=p;continue}p!==" "&&p!=="	"&&p!==`
`&&p!=="\r"?c+=p:c.length>0&&(yield c,c="")}c.length>0&&(yield c)}let{stage:g,name:u}=await he(w);return this.stage=g,this.name=u,{stage:g,name:u}}},ae=class{rooms;currentRoom;constructor(e){this.rooms=e,this.fillAdjacentRooms();for(let s of e)s.fillAdjacenceRects();let t=this.findRoom(0,0);if(t===null)throw new Error("Missing spawn room");this.currentRoom=t;for(let s of this.rooms)s.init()}fillAdjacentRooms(){for(let e=0;e<this.rooms.length;e++){let t=this.rooms[e];t.adjacentRooms=[];for(let s=0;s<this.rooms.length;s++){if(e===s)continue;let a=this.rooms[s];if(t.x>=a.x&&t.y>=a.y&&t.x+t.w<=a.x+a.w&&t.y+t.h<=a.y+a.h)throw new Error("A room touches another");let d=(t.x+t.w===a.x||a.x+a.w===t.x)&&t.y<a.y+a.h&&t.y+t.h>a.y,w=(t.y+t.h===a.y||a.y+a.h===t.y)&&t.x<a.x+a.w&&t.x+t.w>a.x;(d||w)&&t.adjacentRooms.push(a)}}}findRoom(e,t){for(let s of this.rooms)if(s.contains(e,t))return s;return null}frame(e){let t=[];this.currentRoom.frame(e,t);for(let s of this.currentRoom.adjacentRooms)s.frame(e,t);for(let s of t)s.dest.blocks.push(s.block)}drawAdjacenceRects(e,t){let d=[],w=t.getSize(),g={x:t.x,y:t.y,w:w.x,h:w.y,r:0};function u(f){return le.getPointRectDist({x:f.x+f.w/2,y:f.y+f.h/2,w:f.w,h:f.h,r:0},g)}function c(f){for(let o of f.adjacenceRects){let p=u(o);p>400?e.fillRect(o.x,o.y,o.w,o.h):p>70?d.push({rect:o,factor:1-(p-70)/330}):d.push({rect:o,factor:1})}}e.fillStyle="white",c(this.currentRoom);for(let f of this.currentRoom.adjacentRooms)c(f);d.sort((f,o)=>f.factor-o.factor);for(let f of d){let o=[255,255,255],p=[247,112,34],M=Math.round(o[0]+(p[0]-o[0])*f.factor),D=Math.round(o[1]+(p[1]-o[1])*f.factor),x=Math.round(o[2]+(p[2]-o[2])*f.factor);e.fillStyle=`rgb(${M}, ${D}, ${x})`,e.fillRect(f.rect.x,f.rect.y,f.rect.w,f.rect.h)}}update(e,t,s,a){if(this.currentRoom.contains(e,t))return"same";let d=this.findRoom(e,t);return d?(this.currentRoom=d,"new"):this.currentRoom.containsBox(e,t,s,a)?"same":"out"}reset(){for(let e of this.rooms)e.reset()}};var{MovingModule:Jt,MovingPath:yn,CouldownedAttackModule:wn,ContinuousAttackModule:gn,BounceModule:bn,KillModule:vn,CouldownDespawnModule:xn,TouchDespawnModule:kn,HealModule:Tn,SpeedModule:Mn,AccelerationModule:Rn,RestoreJumpModule:Sn,RotationModule:En,SpawnerModule:qt}=Ae;async function he(r){let e=[],t=[0,0,0,0],s=[0,0,0,0],a=[],d=null,w=0,g=[];class u{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal=0;checkCollision=!1;runInAdjacentRoom=!1}let c=null,f=[],o=-1,p=0,M=0,D=[];function x(I){let P=Number(I);if(!Number.isFinite(P))throw new Error(`"${I}" is not a number`);return P}function H(){c&&(g.push(new K(s[0],s[1],s[2],s[3],new Q(c))),s[0]=-1,s[1]=-1,s[2]=-1,s[3]=-1,c=null)}function A(I=!1){(I||g.length)&&(e.push(new Z(t[0],t[1],t[2],t[3],g)),g=[])}function L(){if(D.length>0){let I=D[D.length-1];return I.currentBuilderModule||(I.currentBuilderModule=new u),I.currentBuilderModule}return c}let J=null;for await(let I of r()){if(console.log(I),J===null){J=I,console.log(J);continue}if(I==="endbuilder"){if(D.length>0){let P=D[D.length-1],C=P.currentBuilderModule?new Q(P.currentBuilderModule):void 0,Y=new de(C,{dx:P.currentBuilderBuffer[0],dy:P.currentBuilderBuffer[1],w:P.currentBuilderBuffer[2],h:P.currentBuilderBuffer[3],keepRotation:!!P.currentBuilderBuffer[4],goal:P.currentBuilderBuffer[5]});if(P.blocks.push(Y),P.currentBuilderModule=null,P.currentBuilderStep=0,P.blocks.length>=P.blockCount){let Re=D.pop();Re.parentModule.spawner=new qt(Re.rythm,!1,Re.blocks)}d=null}continue}switch(d){case"room":{H(),A(),t[w]=x(I),w++,w===4&&(d="block",w=0);break}case"emptyroom":{H(),A(),t[w]=x(I),w++,w===4&&(d=null,w=0,A(!0));break}case"block":{s[w]=x(I),w++,w===4&&(d=null,w=0,c=new u);break}case"moving":{a.length<2&&(a.push(x(I)),a.length===2&&(o=a[0],p=a[1],f=[],a.length=0,p===0?(L().moving=new Jt([],o),d=null):(d="movingPattern",M=0)));break}case"movingPattern":{a.push(x(I)),a.length>=3&&(f.push(new yn(a[0],a[1],a[2])),a.length=0,M++,M>=p&&(L().moving=new Jt(f,o),d=null));break}case"rotation":if(a.push(x(I)),a.length<2)break;L().rotation=new En(a[0],a[1]),a.length=0,d=null;break;case"couldownedAttack":if(a.push(x(I)),a.length<2)break;L().couldownedAttack=new wn(a[0],a[1]),a.length=0,d=null;break;case"continuousAttack":if(a.push(x(I)),a.length<1)break;L().continuousAttack=new gn(a[0]),a.length=0,d=null;break;case"bounce":if(a.push(x(I)),a.length<2)break;L().bounce=new bn(a[0],a[1]),a.length=0,d=null;break;case"kill":if(a.push(x(I)),a.length<1)break;L().kill=new vn(!!a[0]),a.length=0,d=null;break;case"heal":if(a.push(x(I)),a.length<1)break;L().heal=new Tn(a[0]),a.length=0,d=null;break;case"touchDespawn":if(a.push(x(I)),a.length<1)break;L().touchDespawn=new kn(!!a[0]),a.length=0,d=null;break;case"restoreJump":if(a.push(x(I)),a.length<1)break;L().restoreJump=new Sn(a[0]),a.length=0,d=null;break;case"couldownDespawn":if(a.push(x(I)),a.length<1)break;L().couldownDespawn=new xn(a[0]),a.length=0,d=null;break;case"spawner":{if(a.length<2&&(a.push(x(I)),a.length===2)){let P=a[0],C=a[1];if(a.length=0,D.push({rythm:P,blockCount:C,blocks:[],currentBuilderBuffer:[0,0,0,0,0,0],currentBuilderStep:0,currentBuilderModule:null,parentModule:L()}),C===0){let Y=D.pop();Y.parentModule.spawner=new qt(Y.rythm,!1,[]),d=null}else d="spawnerBuilder"}break}case"spawnerBuilder":{let P=D[D.length-1];P.currentBuilderBuffer[P.currentBuilderStep]=x(I),P.currentBuilderStep++,P.currentBuilderStep>=6&&(d=null);break}case"speed":if(a.push(x(I)),a.length<2)break;L().speed=new Mn(a[0],a[1]),a.length=0,d=null;break;case"acceleration":if(a.push(x(I)),a.length<2)break;L().acceleration=new Rn(a[0],a[1]),a.length=0,d=null;break;case"goal":if(a.push(x(I)),a.length<1)break;L().goal=a[0],a.length=0,d=null;break;case null:{let P=+I;Number.isFinite(P)?(H(),c=new u,s[0]=x(I),w=1,d="block"):d=I;break}}}return H(),A(),{stage:new ae(e),name:J}}var He=class r{static TRANSITION_SPEED=60;static TRANSITION_DURATION=25;x=0;y=0;startX=0;startY=0;targetX=0;targetY=0;instant=!0;speed=0;move(e,t){this.targetX=e,this.targetY=t}teleport(e,t){this.targetX=e,this.targetY=t,this.instant=!0}startTracker(e,t){let s=e-this.x,a=t-this.y,d=Math.sqrt(s*s+a*a);this.startX=this.x,this.startY=this.y,this.targetX=e,this.targetY=t,this.instant=!1,this.speed=d/r.TRANSITION_DURATION}update(e){if(this.instant){this.x=this.targetX,this.y=this.targetY;return}let t=this.targetX-this.x,s=this.targetY-this.y,a=t*t+s*s;if(a<this.speed*this.speed){this.x=this.targetX,this.y=this.targetY,this.instant=!0;return}let d=this.speed/Math.sqrt(a);this.x+=t*d,this.y+=s*d}reset(){this.teleport(0,0)}};var se=class{left=!1;right=!1;up=!1;down=!1;debug=!1;enter=!1};var Le=class{left=0;right=0;up=0;down=0;debug=0;enter=0},$e=class r{static CONTROLS=["left","right","up","down","debug","enter"];static CONTROL_STACK_SIZE=256;keyboardUsed=!1;mobileUsed=!1;collectedKeys=new Le;keysDown=new se;firstPress=new se;killedPress=new se;keyMap;gameFirstRecord=0;gameRecords=null;frameCount=0;recordCompletion=-1;recordState="none";static KEYBOARDS={zqsd:{KeyZ:"up",KeyQ:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"},wasd:{KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"}};constructor(e){this.keyMap=r.KEYBOARDS[e]}onKeydown=e=>{let t=e,s=this.keyMap[t.code];if(s)switch(this.collectedKeys[s]){case 0:this.collectedKeys[s]=1;break;case 1:break;case 2:this.collectedKeys[s]=4;break;case 3:this.collectedKeys[s]=4;break;case 4:this.collectedKeys[s]=4;break}};onKeyup=e=>{let t=e,s=this.keyMap[t.code];if(s)switch(this.collectedKeys[s]){case 0:this.collectedKeys[s]=2;break;case 1:this.collectedKeys[s]=3;break;case 2:break;case 3:this.collectedKeys[s]=3;break;case 4:this.collectedKeys[s]=3;break}};onButtonTouchStart=(e,t)=>{if(t.classList.add("high"),e!=="special")switch(this.collectedKeys[e]){case 0:this.collectedKeys[e]=1;break;case 1:break;case 2:this.collectedKeys[e]=4;break;case 3:this.collectedKeys[e]=4;break;case 4:this.collectedKeys[e]=4;break}};onButtonTouchEnd=(e,t)=>{if(t.classList.remove("high"),e==="special"){document.getElementById("mobileEntry-specialContainer")?.classList.toggle("hidden");return}switch(this.collectedKeys[e]){case 0:this.collectedKeys[e]=2;break;case 1:this.collectedKeys[e]=3;break;case 2:break;case 3:this.collectedKeys[e]=3;break;case 4:this.collectedKeys[e]=3;break}};startRecord(){this.recordState==="emulate"||this.recordState==="forbid"||(this.gameFirstRecord=+this.firstPress.left<<0|+this.firstPress.right<<1|+this.firstPress.up<<2|+this.firstPress.down<<3|+this.keysDown.left<<4|+this.keysDown.right<<5|+this.keysDown.up<<6|+this.keysDown.down<<7|+this.killedPress.left<<8|+this.killedPress.right<<9|+this.killedPress.up<<10|+this.killedPress.down<<11,this.gameRecords=[],this.recordCompletion=r.CONTROL_STACK_SIZE,this.frameCount=0,this.recordState="record")}pushRecord(){if(!this.gameRecords||this.recordState!=="record")return;let e=this.collectedKeys.left<<24|this.collectedKeys.right<<16|this.collectedKeys.up<<8|this.collectedKeys.down;this.recordCompletion===r.CONTROL_STACK_SIZE&&(this.recordCompletion=0,this.gameRecords.push(new Uint32Array(r.CONTROL_STACK_SIZE))),this.gameRecords[this.gameRecords.length-1][this.recordCompletion]=e,this.recordCompletion++}stopRecord(){this.recordState!=="emulate"&&this.recordState!=="forbid"&&(this.recordState="none")}resumeRecord(){this.recordState==="none"&&(this.recordState="record")}async saveRecord(e){if(!this.gameRecords)return null;let t=this.gameRecords,s=this.recordCompletion,a=this.gameFirstRecord,d=await window.showSaveFilePicker({suggestedName:`record_${e??"jumpyJump"}.bin`,types:[{description:"Binary data",accept:{"application/octet-stream":[".bin"]}}]}),w=await d.createWritable();await w.write(new Uint32Array([a]).slice(0));for(let g=0;g<t.length;g++){let u=t[g];if(g===t.length-1){let c=u.slice(0,s);await w.write(c)}else await w.write(u.slice(0))}return await w.close(),d}async loadRecord(){let[e]=await window.showOpenFilePicker(),s=await(await e.getFile()).arrayBuffer();this.recordState="forbid",this.gameRecords=[new Uint32Array(s)]}startEmulation(){this.recordState="emulate",this.frameCount=0,this.recordCompletion=0;let e=this.gameRecords[0][0];function t(s){return!!(e&1<<s)}this.firstPress.left=t(0),this.firstPress.right=t(1),this.firstPress.up=t(2),this.firstPress.down=t(3),this.keysDown.left=t(4),this.keysDown.right=t(5),this.keysDown.up=t(6),this.keysDown.down=t(7),this.killedPress.left=t(8),this.killedPress.right=t(9),this.killedPress.up=t(10),this.killedPress.down=t(11)}restartRecord(){this.startRecord()}startListeners(e){"ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia("(pointer: coarse)").matches?this.startMobileListeners():this.enableKeyboardListeners(e)}removeListeners(e){this.keyboardUsed&&(e.removeEventListener("keydown",this.onKeydown),e.removeEventListener("keyup",this.onKeyup))}enableKeyboardListeners(e){e.addEventListener("keydown",this.onKeydown),e.addEventListener("keyup",this.onKeyup),this.keyboardUsed=!0}startMobileListeners(){let e=(t,s)=>{let a=document.getElementById(t);a&&(a.ontouchstart=()=>this.onButtonTouchStart(s,a),a.ontouchend=()=>this.onButtonTouchEnd(s,a))};document.getElementById("mobileEntryContainer")?.classList.remove("hidden"),e("mobileEntry-left","left"),e("mobileEntry-right","right"),e("mobileEntry-up","up"),e("mobileEntry-down","down"),e("mobileEntry-special","special"),e("mobileEntry-special-enter","enter"),e("mobileEntry-special-debug","debug"),this.mobileUsed=!0}update(){if(this.recordState==="record"&&this.pushRecord(),this.recordState==="record"||this.recordState==="none")for(let e of r.CONTROLS)this.play(e,this.collectedKeys[e]),this.collectedKeys[e]=0;if(this.recordState==="record")this.frameCount++;else if(this.recordState==="emulate"){if(this.frameCount<=0){this.frameCount++;return}let e=this.gameRecords[0],t=e[this.frameCount];this.play("left",t>>24&255),this.play("right",t>>16&255),this.play("up",t>>8&255),this.play("down",t>>0&255),this.frameCount++,this.frameCount>e.length&&(this.recordState="none",this.collectedKeys=new Le,this.keysDown=new se,this.firstPress=new se,this.killedPress=new se)}}play(e,t){switch(t){case 0:this.firstPress[e]=!1,this.killedPress[e]=!1;break;case 1:this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break;case 2:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1);break;case 3:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1):this.firstPress[e]=!0,this.killedPress[e]=!0;break;case 4:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1),this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break}}press(e){return this.firstPress[e]||this.keysDown[e]}first(e){return this.firstPress[e]}killed(e){return this.killedPress[e]}kill(e,t=!1){this.keysDown[e]=!1,t&&(this.firstPress[e]=!1)}draw(){}};var Dn="https://jumpyjump-production.up.railway.app";async function Zt(r,e,t,s){let a=await r.getFile(),w=await(await fetch(Dn+"/pushRun",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,time:s,mapname:t})})).json();console.log(w)}var Pe=class r{type="menu";chrono=0;static PLAY_TO_WIN_DURATION=60;game;constructor(e){this.game=e}update(){switch(this.chrono++,this.type){case"playToWin":this.chrono>=r.PLAY_TO_WIN_DURATION&&this.set("win");break}}getChrono(){return this.chrono}set(e){switch(e){case"play":break;default:this.game.inputHandler.stopRecord();break}this.type=e,this.chrono=0}get(){return this.type}},W=class r{static WIDTH=1600;static HEIGHT=900;static WIDTH_2=r.WIDTH/2;static HEIGHT_2=r.HEIGHT/2;static GAME_VERSION="1.3.2";player=new V;camera=new He;inputHandler;stageList;stage=null;frame=0;goalComplete=0;gameChrono=0;state=new Pe(this);validRun=!0;currentWorld=0;currentLevel=0;selectWorldFile=!1;playerUsername=null;stageName=null;constructor(e,t,s){this.inputHandler=new $e(e),this.inputHandler.startListeners(t),this.stageList=s}startLevel(e,t){this.stage=e,this.stageName=t,this.player.respawnCouldown=0,this.resetStage()}startReplay(e){this.startLoading(),this.inputHandler.loadRecord().then(()=>{this.state.set("play"),this.startLevel(e,this.stageName),this.inputHandler.startEmulation()}).catch(t=>{console.error(t)}).finally(()=>{this.finishLoading()})}playLogic(e){let t=this.player.reduceCouldown();if(e&&(this.inputHandler.press("debug")?(this.validRun=!1,this.player.eternalMode=!0):this.player.eternalMode=!1,t&&this.resetStage()),this.inputHandler.first("enter")){let s=prompt("replay");s&&this.handleSpecial(s),this.inputHandler.kill("enter",!0)}this.player.frame(this),this.stage.frame(this),this.player.isAlive()&&this.handleRoom(),e&&(this.goalComplete>0&&this.state.set("playToWin"),this.player.respawnCouldown<=V.RESPAWN_COULDOWN&&this.gameChrono++)}menuLogic(){if(this.inputHandler.first("enter")&&!this.selectWorldFile){let e=this.stageList[this.currentWorld][this.currentLevel];document.getElementById("loadingIcon")?.classList.remove("hidden"),e.load().then(({stage:t,name:s})=>{this.state.set("play"),this.startLevel(t,s)}).catch(t=>{console.error(t)}).finally(()=>{document.getElementById("loadingIcon")?.classList.add("hidden")})}this.inputHandler.first("right")&&(this.selectWorldFile?this.selectWorldFile=!1:this.currentLevel<this.stageList[this.currentWorld].length-1&&this.currentLevel++),this.inputHandler.first("left")&&!this.selectWorldFile&&(this.currentLevel>0?this.currentLevel--:this.selectWorldFile=!0),this.selectWorldFile?this.inputHandler.first("debug")&&(async()=>{let[e]=await window.showOpenFilePicker(),t=await e.getFile();async function*s(){let w=t.stream().getReader(),g=new TextDecoder,u,c="",f=!1;for(;!(u=await w.read()).done;){if(c+=g.decode(u.value,{stream:!0}),!f){let M=c.search(/[\r\n]/);if(M!==-1){let D=c.slice(0,M).trim();c=c.slice(M+1),yield D,f=!0}else continue}let p;for(;(p=c.search(/[ \r\n]/))!==-1;){let M=c.slice(0,p).trim();c=c.slice(p+1),M&&(yield M)}}let o=c.trim();o&&(yield o)}let{stage:a,name:d}=await he(s);this.inputHandler.kill("debug"),this.state.set("play"),this.startLevel(a,d)})():(this.inputHandler.first("down")&&this.currentWorld<this.stageList.length-1&&this.currentWorld++,this.inputHandler.first("up")&&this.currentWorld>0&&this.currentWorld--)}winLogic(){if(this.validRun&&this.inputHandler.first("debug")){let e=confirm("Do you want to send your run?");document.getElementById("savingRun")?.classList.remove("hidden"),this.inputHandler.saveRecord(this.stageName).then(t=>{if(document.getElementById("savingRun")?.classList.add("hidden"),e&&t){let s;this.playerUsername?s=this.playerUsername:(s=prompt("Enter your username"),this.playerUsername=s),document.getElementById("sendingRun")?.classList.remove("hidden"),Zt(t,s,this.stageName??Date.now().toString(),this.gameChrono).finally(()=>{document.getElementById("sendingRun")?.classList.add("hidden")})}}).catch(t=>{document.getElementById("savingRun")?.classList.add("hidden"),console.error(t)})}this.inputHandler.first("enter")&&this.state.set("menu"),this.inputHandler.first("up")&&(this.resetStage(),this.state.set("play"))}gameLogic(){switch(this.inputHandler.update(),this.state.get()){case"play":this.playLogic(!0);break;case"playToWin":this.playLogic(!1);break;case"menu":this.menuLogic();break;case"win":this.winLogic();break}this.frame++,this.state.update()}generateChronoText(){let e=this.state.get();if(e!=="play"&&e!=="playToWin"&&e!=="win")return"";if(!this.validRun)return"debug";let t=this.gameChrono/60,s=Math.floor(t/60),a=Math.floor(t%60),d=Math.floor((t-Math.floor(t))*1e3),w=(g,u)=>g.toString().padStart(u,"0");return`${w(s,2)}:${w(a,2)}.${w(d,3)}`}resetStage(){this.inputHandler.restartRecord(),this.stage.reset();let e=this.state.get();(e==="play"||e==="win")&&(console.log("respawn"),this.player.respawn(),this.camera.reset(),this.validRun=!0,this.gameChrono=0,this.goalComplete=0)}handleRoom(){let e=this.player.getSize(),t=s=>{let a,d;return s.w<=r.WIDTH?a=s.x+s.w/2:this.player.x-r.WIDTH_2<=s.x?a=s.x+r.WIDTH_2:this.player.x+r.WIDTH_2>=s.x+s.w?a=s.x+s.w-r.WIDTH_2:a=this.player.x,s.h<=r.HEIGHT?d=s.y+s.h/2:this.player.y-r.HEIGHT_2<=s.y?d=s.y+r.HEIGHT_2:this.player.y+r.HEIGHT_2>=s.y+s.h?d=s.y+s.h-r.HEIGHT_2:d=this.player.y,{camX:a,camY:d}};switch(this.stage.update(this.player.x,this.player.y,e.x,e.y)){case"same":{let s=t(this.stage.currentRoom);this.camera.move(s.camX,s.camY);break}case"new":{let s=t(this.stage.currentRoom);this.camera.startTracker(s.camX,s.camY),this.player.restoreJumps();break}case"out":this.player.kill();break}}drawMethod(e,t,s){let a=this.state.get();switch(this.state.get()){case"play":case"playToWin":{t(),e.fillStyle="#111",e.fillRect(this.stage.currentRoom.x,this.stage.currentRoom.y,this.stage.currentRoom.w,this.stage.currentRoom.h),e.fillStyle="#1a1a1a";for(let d of this.stage.currentRoom.adjacentRooms)e.fillRect(d.x,d.y,d.w,d.h);this.stage.currentRoom.draw(e);for(let d of this.stage.currentRoom.adjacentRooms)d.draw(e);if(this.stage.drawAdjacenceRects(e,this.player),this.player.draw(e),s(),this.player.drawInfos(e),this.player.drawDeathTransition(e),a==="playToWin"){let d=1.5*this.state.getChrono()/Pe.PLAY_TO_WIN_DURATION;d<1?d=Math.sin(d*Math.PI/2):d=1,e.fillStyle=`rgba(0, 0, 0, ${d*d*d})`,e.fillRect(0,0,r.WIDTH,r.HEIGHT)}break}case"menu":{if(e.fillStyle="#111",e.fillRect(0,0,r.WIDTH,r.HEIGHT),e.textAlign="center",e.font="30px Arial",e.fillStyle="white",this.selectWorldFile)e.fillText("Select file (press P)",r.WIDTH_2,100);else if(e.fillText(`World ${this.currentWorld+1}`,r.WIDTH_2,100),this.currentWorld<this.stageList.length)for(let w=0;w<this.stageList[this.currentWorld].length;w++){e.fillStyle=w==this.currentLevel?"yellow":"white";let g=400+200*(w%5),u=300+Math.floor(w/5)*100;e.fillText(`#${w}`,g,u)}let d=e.textBaseline;e.textBaseline="bottom",e.textAlign="right",e.font="20px monospace",e.fillStyle="grey",e.fillText("v"+r.GAME_VERSION,r.WIDTH,r.HEIGHT),e.textBaseline=d;break}case"win":{e.fillStyle="black",e.fillRect(0,0,r.WIDTH,r.HEIGHT),e.font="30px Arial",e.fillStyle="white",e.textAlign="center",e.fillText("Press P to save",r.WIDTH_2,r.HEIGHT_2-20),e.fillStyle="white",e.fillText("Press SPACE to restart",r.WIDTH_2,r.HEIGHT_2+20),e.fillStyle="white",e.fillText("Press ENTER to select level",r.WIDTH_2,r.HEIGHT_2+60);break}}}gameDraw(e,t,s,a){let d=t/r.WIDTH,w=s/r.HEIGHT,g=Math.min(d,w),u=(t-r.WIDTH*g)/2,c=(s-r.HEIGHT*g)/2;e.save(),e.translate(u,c),e.scale(g,g),e.fillStyle="black",e.fillRect(0,0,r.WIDTH,r.HEIGHT),this.camera.update(this.player.getSpeed2()),a(e,()=>{e.save(),e.translate(r.WIDTH_2-this.camera.x,r.HEIGHT_2-this.camera.y)},()=>{e.restore()}),e.restore(),e.fillStyle="black",c>0&&e.fillRect(0,0,t,c),c>0&&e.fillRect(0,s-c,t,c),u>0&&e.fillRect(0,0,u,s),u>0&&e.fillRect(t-u,0,u,s)}handleSpecial(e){switch(e){case"replay":this.stage&&this.startReplay(this.stage);break}}startLoading(){let e=document.getElementById("loadingIcon");e&&e.classList.remove("hidden")}finishLoading(){let e=document.getElementById("loadingIcon");e&&e.classList.add("hidden")}};async function ts(r){return console.log("fetch: "+r),await fetch(r,{cache:"no-store"})}function ss(){return new Promise((r,e)=>{let t=indexedDB.open("levels-db",1);t.onupgradeneeded=s=>{let a=s.target.result;a.objectStoreNames.contains("levels")||a.createObjectStore("levels")},t.onsuccess=()=>r(t.result),t.onerror=()=>e(t.error)})}async function Cn(r,e,t){let a=(await ss()).transaction("levels","readwrite"),d=a.objectStore("levels"),w=`#${r}#${e}`;return d.put(t,w),new Promise((g,u)=>{a.oncomplete=()=>g(),a.onerror=()=>u(a.error)})}async function In(r,e){let s=(await ss()).transaction("levels","readwrite"),a=s.objectStore("levels"),d=`#${r}#${e}`;return a.delete(d),new Promise((w,g)=>{s.oncomplete=()=>w(),s.onerror=()=>g(s.error)})}async function Bn(r,e,t){let a=await(await ts(r)).text();await Cn(e,t,a)}async function Qt(r,e){await In(r,e)}async function es(r,e){let s=await(await ts(r+"/architecture.json")).json(),a=e??[],d=[],w=[];for(let u of s){let c=a.find(p=>p.name===u.name),f=[];for(let p of u.levels){let M=c?.levels.find(x=>x.filename===p.filename);if(!M||M.version!==p.version){let x=`${r}/${u.name}/${p.filename}`;console.log(`Fetch: ${x}`),w.push(Bn(x,u.name,p.filename).then(()=>{console.log(`Update level: ${u.name}/${p.filename}`)}))}f.push({name:p.name,filename:p.filename,version:p.version})}let o=(c?.levels??[]).filter(p=>!u.levels.some(M=>M.filename===p.filename));for(let p of o)console.log(`Delete level: ${u.name}/${p.filename}`),await Qt(u.name,p.filename);d.push({name:u.name,levels:f})}let g=a.filter(u=>!s.some(c=>c.name===u.name));for(let u of g){console.log(`Delete world: ${u.name}`);for(let c of u.levels)await Qt(u.name,c.filename)}return await Promise.all(w),localStorage.setItem("architecture",JSON.stringify(d)),d}function yt(r){let e=[];for(let t of r){let s=[];for(let a of t.levels)s.push(new ue(`#${t.name}#${a.filename}`));e.push(s)}return e}async function An(){let r=document.getElementById("gameCanvas");function e(){r.width=window.innerWidth,r.height=window.innerHeight}e(),window.addEventListener("resize",e);let t=localStorage.getItem("keyboardMode"),s;t!=="zqsd"&&t!=="wasd"?s="wasd":s=t;let a,d="https://raw.githubusercontent.com/musiquammation/JumpyJump/levels",w=localStorage.getItem("architecture"),g,u;w?(g=JSON.parse(w),u=yt(g),es(d,g).then(p=>{a.stageList=yt(p),document.getElementById("fullyLoadLevels")?.classList.remove("hidden"),setTimeout(()=>{document.getElementById("fullyLoadLevels")?.classList.add("hidden")},2e3)}).catch(p=>{console.error(p)})):(g=await es(d,[]),u=yt(g),document.getElementById("fullyLoadingGame")?.classList.remove("hidden"),document.getElementById("fullyLoadingGame")?.classList.add("hidden"));let c=r.getContext("2d");a=new W(s,document,u);let f=document.getElementById("chrono");function o(){a.gameLogic(),a.gameDraw(c,r.width,r.height,(p,M,D)=>{a.drawMethod(p,M,D)}),f.innerHTML=a.generateChronoText(),window.running&&requestAnimationFrame(o)}window.game=a,window.running=!0,o()}window.game=null;window.running=!1;window.startGame=An;var Oe=null,{MovingPath:Hn,MovingModule:Ln,CouldownedAttackModule:$n,ContinuousAttackModule:Pn,BounceModule:ns,KillModule:os,CouldownDespawnModule:as,TouchDespawnModule:On,HealModule:Wn,SpeedModule:rs,AccelerationModule:is,RestoreJumpModule:Nn,RotationModule:ls,SpawnerModule:_n}=Ae;async function cs(r,e,t){if(r.moving){await e(`${t}moving ${r.moving.times} ${r.moving.patterns.length}`);for(let s of r.moving.patterns)await e(`${t}	${s.dx} ${s.dy} ${s.duration}`)}if(r.rotation&&await e(`${t}rotation ${r.rotation.start??0} ${r.rotation.speed??0}`),r.couldownedAttack&&await e(`${t}couldownedAttack ${r.couldownedAttack.damages??0} ${r.couldownedAttack.duration??0}`),r.continuousAttack&&await e(`${t}continuousAttack ${r.continuousAttack.damages??0}`),r.bounce&&await e(`${t}bounce ${r.bounce.factor??0} ${r.bounce.cost??0}`),r.kill&&await e(`${t}kill ${r.kill.playerOnly?1:0}`),r.heal&&await e(`${t}heal ${r.heal.hp??0}`),r.touchDespawn&&await e(`${t}touchDespawn ${r.touchDespawn.playerOnly?1:0}`),r.restoreJump&&await e(`${t}restoreJump ${r.restoreJump.gain??0}`),r.couldownDespawn&&await e(`${t}couldownDespawn ${r.couldownDespawn.duration??0}`),r.spawner){await e(`${t}spawner ${r.spawner.rythm} ${r.spawner.blocks.length}`);for(let s of r.spawner.blocks)await e(`${t}	${s.dx} ${s.dy} ${s.w} ${s.h} ${s.keepRotation?1:0} ${s.goal}`),s.module&&await cs(s.module,e,t+"		"),await e(`${t}	endbuilder`)}r.speed&&await e(`${t}speed ${r.speed.vx??0} ${r.speed.vy??0}`),r.acceleration&&await e(`${t}acceleration ${r.acceleration.ax??0} ${r.acceleration.ay??0}`),r.goal&&await e(`${t}goal ${r.goal.type??0}`)}async function Fn(r,e){Oe===null&&(Oe=prompt("Level name?")),await e(Oe.split(`
`)[0]);for(let t of r.rooms){await e(`${t.blocks.length?"room":"emptyroom"} ${t.x} ${t.y} ${t.w} ${t.h}`);for(let s of t.blocks)await e(`	${s.x} ${s.y} ${s.w} ${s.h}`),s.module&&await cs(s.module,e,"		")}}function Xn(){let r=document.getElementById("gameCanvas"),e=document.getElementById("mode"),t=document.getElementById("panel"),s=r.getContext("2d"),a=[],d=[];function w(){A=null,window.game=null}function g(){r.width=window.innerWidth,r.height=window.innerHeight}g(),window.addEventListener("resize",g);let u=25,c={x:0,y:0,zoom:1},f={sx:0,sy:0,wx:0,wy:0,down:!1,button:-1},o={active:!1,type:null,target:null,startMouseX:0,startMouseY:0,startTargetX:0,startTargetY:0},p="default",M=!1,D={x:0,y:0},x=null,H=-1,A=null,L="default",J=[new Z(-800,-450,1600,900,[])],I=[new ae(J)],P=(n,i,l)=>Math.max(i,Math.min(l,n));function C(n){return Math.round(n/u-.5)*u}function Y(n,i){let l=r.getBoundingClientRect(),h=(n-l.left)*(r.width/l.width),y=(i-l.top)*(r.height/l.height),m=r.width/W.WIDTH,b=r.height/W.HEIGHT,T=Math.min(m,b),R=(r.width-W.WIDTH*T)/2,S=(r.height-W.HEIGHT*T)/2,v=((h-R)/T-W.WIDTH_2)/c.zoom+c.x,E=((y-S)/T-W.HEIGHT_2)/c.zoom+c.y;return{x:v,y:E}}function Re(){let n=Y(f.sx,f.sy);f.wx=C(n.x),f.wy=C(n.y)}function Se(n,i){let l=I[0];for(let h of l.rooms)for(let y of h.blocks){let m=y.w/2,b=y.h/2;if(n>=y.x-m&&n<=y.x+m&&i>=y.y-b&&i<=y.y+b)return y}return null}function ne(n,i){let l=I[0];for(let h of l.rooms)if(n>=h.x&&n<=h.x+h.w&&i>=h.y&&i<=h.y+h.h)return h;return null}function wt(n,i,l){let h=9/c.zoom,y=n.w/2,m=n.h/2,b=Math.abs(i-(n.x-y))<h,T=Math.abs(i-(n.x+y))<h,R=Math.abs(l-(n.y-m))<h,S=Math.abs(l-(n.y+m))<h;return R&&b?"top-left":R&&T?"top-right":S&&b?"bottom-left":S&&T?"bottom-right":b?"left":T?"right":R?"top":S?"bottom":null}function gt(n,i,l){let h=19/c.zoom,y=Math.abs(i-n.x)<h,m=Math.abs(i-(n.x+n.w))<h,b=Math.abs(l-n.y)<h,T=Math.abs(l-(n.y+n.h))<h;return b&&y?"top-left":b&&m?"top-right":T&&y?"bottom-left":T&&m?"bottom-right":y?"left":m?"right":b?"top":T?"bottom":null}function bt(n){return n&&{top:"ns-resize",bottom:"ns-resize",left:"ew-resize",right:"ew-resize","top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"}[n]||"default"}function pe(n){let i=I[0];for(let l of i.rooms)if(l.containsBox(n.x,n.y,n.w,n.h))return l;return null}function me(n,i){let l=n.x-n.w/2,h=n.x+n.w/2,y=n.y-n.h/2,m=n.y+n.h/2;return l>=i.x&&h<=i.x+i.w&&y>=i.y&&m<=i.y+i.h}function vt(n,i){let l=I[0];for(let h of l.rooms){let y=h.blocks.indexOf(n);if(y>=0){h.blocks.splice(y,1);break}}i.blocks.push(n)}function Yn(n){if(n.length===0)return{minX:0,minY:0,maxX:0,maxY:0};let i=1/0,l=1/0,h=-1/0,y=-1/0;for(let m of n){let b=m.x-m.w/2,T=m.x+m.w/2,R=m.y-m.h/2,S=m.y+m.h/2;i=Math.min(i,b),h=Math.max(h,T),l=Math.min(l,R),y=Math.max(y,S)}return{minX:i,minY:l,maxX:h,maxY:y}}function ds(n,i,l){let h=I[0],y=new Set(n);for(let m of n){let b=m.x+i,T=m.y+l,R=ne(b,T);if(!R||!me({x:b,y:T,w:m.w,h:m.h},R))return!1;for(let S of h.rooms)for(let v of S.blocks){if(y.has(v))continue;let E=Math.abs(b-v.x),F=Math.abs(T-v.y),$=(m.w+v.w)/2,N=(m.h+v.h)/2;if(E<$&&F<N)return!1}}return!0}function us(n,i,l){let h=I[0];for(let y of n){let m=y.x+i,b=y.y+l,T=ne(m,b);T&&pe(y)!==T&&vt(y,T),y.x=m,y.y=b}}function oe(){t.innerHTML="",t.classList.add("hidden"),x=null}function xt(n){t.classList.remove("hidden");let i=[],l=n.module.bounce?"checked":"",h=n.module.bounce?"block":"none",y=n.module.bounce?.factor||1,m=n.module.bounce?.cost||.003;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modBounce" ${l}> Bounce
				</label>
				<div id="bounceOptions" style="display: ${h}; margin-top: 10px; padding-left: 20px;">
					<label>Factor: <input type="number" id="bounceFactor" value="${y}" step="0.1" style="width: 80px;"></label><br>
					<label>Cost: <input type="number" id="bounceCost" value="${m}" step="0.001" style="width: 80px;"></label>
				</div>
			</div>
		`);let b=n.module.kill?"checked":"";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modKill" ${b}> Kill
				</label>
			</div>
		`);let T=n.module.heal?"checked":"",R=n.module.heal?"block":"none",S=n.module.heal?.hp||2;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modHeal" ${T}> Heal
				</label>
				<div id="healOptions" style="display: ${R}; margin-top: 10px; padding-left: 20px;">
					<label>HP: <input type="number" id="healHp" value="${S}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let v=n.module.couldownedAttack?"checked":"",E=n.module.couldownedAttack?"block":"none",F=n.module.couldownedAttack?.damages||1,$=n.module.couldownedAttack?.duration||100;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownAttack" ${v}> Cooldown Attack
				</label>
				<div id="cooldownAttackOptions" style="display: ${E}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="cooldownAttackDamages" value="${F}" step="0.1" style="width: 80px;"></label><br>
					<label>Duration: <input type="number" id="cooldownAttackDuration" value="${$}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let N=n.module.continuousAttack?"checked":"",U=n.module.continuousAttack?"block":"none",j=n.module.continuousAttack?.damages||.02;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modContinuousAttack" ${N}> Continuous Attack
				</label>
				<div id="continuousAttackOptions" style="display: ${U}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="continuousAttackDamages" value="${j}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let fe=n.module.restoreJump?"checked":"",ye=n.module.restoreJump?"block":"none",we=n.module.restoreJump?.gain||1;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRestoreJump" ${fe}> Restore Jump
				</label>
				<div id="restoreJumpOptions" style="display: ${ye}; margin-top: 10px; padding-left: 20px;">
					<label>Gain: <input type="number" id="restoreJumpGain" value="${we}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let We=n.module.goal!==void 0?"checked":"",ws=n.module.goal!==void 0?"block":"none",gs=n.module.goal?.type||1;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modGoal" ${We}> Goal
				</label>
				<div id="goalOptions" style="display: ${ws}; margin-top: 10px; padding-left: 20px;">
					<label>Type: <input type="number" id="goalType" value="${gs}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let bs=n.module.moving?"checked":"",vs=n.module.moving?"block":"none",xs=n.module.moving?.times||-1,ks=n.module.moving?.patterns||[],Rt="";ks.forEach((B,k)=>{Rt+=`
				<div class="pattern-row" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
					<input type="number" class="pattern-dx" data-idx="${k}" value="${B.dx}" step="0.1" style="width: 60px;" placeholder="dx">
					<input type="number" class="pattern-dy" data-idx="${k}" value="${B.dy}" step="0.1" style="width: 60px;" placeholder="dy">
					<input type="number" class="pattern-duration" data-idx="${k}" value="${B.duration}" step="1" style="width: 60px;" placeholder="dur">
					<button class="pattern-remove" data-idx="${k}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
				</div>
			`}),i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modMoving" ${bs}> Moving
				</label>
				<div id="movingOptions" style="display: ${vs}; margin-top: 10px; padding-left: 20px;">
					<label>Times (-1 = infinite): <input type="number" id="movingTimes" value="${xs}" step="1" style="width: 100px;"></label><br>
					<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Patterns:</label>
					<div id="movingPatternsList">
						${Rt}
					</div>
					<button id="addPattern" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Pattern</button>
				</div>
			</div>
		`);let Ts=n.module.speed?"checked":"",Ms=n.module.speed?"block":"none",Rs=n.module.speed?.vx||0,Ss=n.module.speed?.vy||0;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpeed" ${Ts}> Speed
				</label>
				<div id="speedOptions" style="display: ${Ms}; margin-top: 10px; padding-left: 20px;">
					<label>VX: <input type="number" id="speedVx" value="${Rs}" step="0.5" style="width: 80px;"></label><br>
					<label>VY: <input type="number" id="speedVy" value="${Ss}" step="0.5" style="width: 80px;"></label>
				</div>
			</div>
		`);let Es=n.module.acceleration?"checked":"",Ds=n.module.acceleration?"block":"none",Cs=n.module.acceleration?.ax||0,Is=n.module.acceleration?.ay||0;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modAcceleration" ${Es}> Acceleration
				</label>
				<div id="accelerationOptions" style="display: ${Ds}; margin-top: 10px; padding-left: 20px;">
					<label>AX: <input type="number" id="accelerationAx" value="${Cs}" step="0.01" style="width: 80px;"></label><br>
					<label>AY: <input type="number" id="accelerationAy" value="${Is}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let Bs=n.module.rotation?"checked":"",As=n.module.rotation?"block":"none",Hs=n.module.rotation?.start||0,Ls=n.module.rotation?.speed||.01;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRotation" ${Bs}> Rotation
				</label>
				<div id="rotationOptions" style="display: ${As}; margin-top: 10px; padding-left: 20px;">
					<label>Start: <input type="number" id="rotationStart" value="${Hs}" step="0.1" style="width: 80px;"></label><br>
					<label>Speed: <input type="number" id="rotationSpeed" value="${Ls}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let $s=n.module.spawner?"checked":"",Ps=n.module.spawner?"block":"none",Os=n.module.spawner?.rythm||60,Ws=n.module.spawner?.blocks||[],St="";Ws.forEach((B,k)=>{let O=!!B.module,X=B.module?.speed?"checked":"",re=B.module?.speed?.vx||0,q=B.module?.speed?.vy||0,ee=B.module?.acceleration?"checked":"",Ne=B.module?.acceleration?.ax||0,ge=B.module?.acceleration?.ay||0,be=B.module?.kill?"checked":"",ie=B.module?.bounce?"checked":"",_e=B.module?.bounce?.factor||1,Fe=B.module?.bounce?.cost||.003,ve=B.module?.rotation?"checked":"",Xe=B.module?.rotation?.start||0,Ye=B.module?.rotation?.speed||.01,De=B.module?.couldownDespawn?"checked":"",Ue=B.module?.couldownDespawn?.duration||100;St+=`
				<div class="spawner-block" style="border: 1px solid #999; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #f9f9f9;">
					<div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
						<input type="number" class="spawn-dx" data-idx="${k}" value="${B.dx}" step="1" style="width: 60px;" placeholder="dx" title="Offset X">
						<input type="number" class="spawn-dy" data-idx="${k}" value="${B.dy}" step="1" style="width: 60px;" placeholder="dy" title="Offset Y">
						<input type="number" class="spawn-w" data-idx="${k}" value="${B.w}" step="1" style="width: 60px;" placeholder="w" title="Width">
						<input type="number" class="spawn-h" data-idx="${k}" value="${B.h}" step="1" style="width: 60px;" placeholder="h" title="Height">
						<button class="spawn-remove" data-idx="${k}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715 Remove</button>
					</div>
					
					<details ${O?"open":""}>
						<summary style="cursor: pointer; font-weight: bold; margin: 5px 0;">Module Options</summary>
						<div style="padding-left: 10px; margin-top: 5px;">
							<label style="display: block;"><input type="checkbox" class="spawn-hasSpeed" data-idx="${k}" ${X}> Speed</label>
							<div class="spawn-speed-opts" data-idx="${k}" style="display: ${X?"block":"none"}; padding-left: 20px;">
								<input type="number" class="spawn-speedVx" data-idx="${k}" value="${re}" step="0.5" style="width: 60px;" placeholder="vx">
								<input type="number" class="spawn-speedVy" data-idx="${k}" value="${q}" step="0.5" style="width: 60px;" placeholder="vy">
							</div>
							
							<label style="display: block;"><input type="checkbox" class="spawn-hasAcceleration" data-idx="${k}" ${ee}> Acceleration</label>
							<div class="spawn-accel-opts" data-idx="${k}" style="display: ${ee?"block":"none"}; padding-left: 20px;">
								<input type="number" class="spawn-accelAx" data-idx="${k}" value="${Ne}" step="0.01" style="width: 60px;" placeholder="ax">
								<input type="number" class="spawn-accelAy" data-idx="${k}" value="${ge}" step="0.01" style="width: 60px;" placeholder="ay">
							</div>
							
							<label style="display: block;"><input type="checkbox" class="spawn-hasRotation" data-idx="${k}" ${ve}> Rotation</label>
							<div class="spawn-rotation-opts" data-idx="${k}" style="display: ${ve?"block":"none"}; padding-left: 20px;">
								<input type="number" class="spawn-rotationStart" data-idx="${k}" value="${Xe}" step="0.1" style="width: 60px;" placeholder="start">
								<input type="number" class="spawn-rotationSpeed" data-idx="${k}" value="${Ye}" step="0.01" style="width: 60px;" placeholder="speed">
							</div>
							
							<label style="display: block;"><input type="checkbox" class="spawn-hasBounce" data-idx="${k}" ${ie}> Bounce</label>
							<div class="spawn-bounce-opts" data-idx="${k}" style="display: ${ie?"block":"none"}; padding-left: 20px;">
								<input type="number" class="spawn-bounceFactor" data-idx="${k}" value="${_e}" step="0.1" style="width: 60px;" placeholder="factor">
								<input type="number" class="spawn-bounceCost" data-idx="${k}" value="${Fe}" step="0.001" style="width: 60px;" placeholder="cost">
							</div>
							
							<label style="display: block;"><input type="checkbox" class="spawn-hasKill" data-idx="${k}" ${be}> Kill</label>
							
							<label style="display: block;"><input type="checkbox" class="spawn-hasCouldownDespawn" data-idx="${k}" ${De}> Cooldown Despawn</label>
							<div class="spawn-despawn-opts" data-idx="${k}" style="display: ${De?"block":"none"}; padding-left: 20px;">
								<input type="number" class="spawn-despawnDuration" data-idx="${k}" value="${Ue}" step="10" style="width: 60px;" placeholder="duration">
							</div>
						</div>
					</details>
				</div>
			`}),i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpawner" ${$s}> Spawner
				</label>
				<div id="spawnerOptions" style="display: ${Ps}; margin-top: 10px; padding-left: 20px;">
					<label>Rythm (frames): <input type="number" id="spawnerRythm" value="${Os}" step="1" style="width: 100px;"></label><br>
					<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Blocks to spawn:</label>
					<div id="spawnerBlocksList">
						${St}
					</div>
					<button id="addSpawnerBlock" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Block</button>
				</div>
			</div>
		`);let Ns=n.module.touchDespawn?"checked":"";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modTouchDespawn" ${Ns}> Touch Despawn
				</label>
			</div>
		`);let _s=n.module.couldownDespawn?"checked":"",Fs=n.module.couldownDespawn?"block":"none",Xs=n.module.couldownDespawn?.duration||100;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownDespawn" ${_s}> Cooldown Despawn
				</label>
				<div id="cooldownDespawnOptions" style="display: ${Fs}; margin-top: 10px; padding-left: 20px;">
					<label>Duration: <input type="number" id="cooldownDespawnDuration" value="${Xs}" step="10" style="width: 80px;"></label>
				</div>
			</div>
		`),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px; max-height: 80vh; overflow-y: auto;">
				<h3>Block Properties</h3>
				<button id="deleteBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Block (Suppr)</button>
				<div>
					<label>X: <input type="number" id="blockX" value="${n.x}" step="${u}"></label><br>
					<label>Y: <input type="number" id="blockY" value="${n.y}" step="${u}"></label><br>
					<label>Width: <input type="number" id="blockW" value="${n.w}" step="${u}" min="${u}"></label><br>
					<label>Height: <input type="number" id="blockH" value="${n.h}" step="${u}" min="${u}"></label><br>
				</div>
				<div style="margin-top: 20px;">
					<h4>Modules</h4>
					${i.join("")}
				</div>
			</div>
		`,document.getElementById("deleteBtn").addEventListener("click",()=>{let B=pe(n);if(B){let k=B.blocks.indexOf(n);k>=0&&B.blocks.splice(k,1)}oe()});let Ee=()=>{let B=parseFloat(document.getElementById("blockX").value),k=parseFloat(document.getElementById("blockY").value),O=parseFloat(document.getElementById("blockW").value),X=parseFloat(document.getElementById("blockH").value);n.x=C(B),n.y=C(k),n.w=Math.max(u,C(O)),n.h=Math.max(u,C(X))},Ys=()=>{document.getElementById("blockX").value=n.x.toString(),document.getElementById("blockY").value=n.y.toString(),document.getElementById("blockW").value=n.w.toString(),document.getElementById("blockH").value=n.h.toString()};document.getElementById("blockX").addEventListener("change",Ee),document.getElementById("blockY").addEventListener("change",Ee),document.getElementById("blockW").addEventListener("change",Ee),document.getElementById("blockH").addEventListener("change",Ee);let z=()=>{let B=document.getElementById("modBounce").checked,k=document.getElementById("modKill").checked,O=document.getElementById("modHeal").checked,X=document.getElementById("modCooldownAttack").checked,re=document.getElementById("modContinuousAttack").checked,q=document.getElementById("modRestoreJump").checked,ee=document.getElementById("modGoal").checked,Ne=document.getElementById("modMoving").checked,ge=document.getElementById("modSpeed").checked,be=document.getElementById("modAcceleration").checked,ie=document.getElementById("modRotation").checked,_e=document.getElementById("modSpawner").checked,Fe=document.getElementById("modTouchDespawn").checked,ve=document.getElementById("modCooldownDespawn").checked,Xe=B?parseFloat(document.getElementById("bounceFactor").value):1,Ye=B?parseFloat(document.getElementById("bounceCost").value):.003,De=O?parseFloat(document.getElementById("healHp").value):2,Ue=X?parseFloat(document.getElementById("cooldownAttackDamages").value):1,Vs=X?parseInt(document.getElementById("cooldownAttackDuration").value):100,Ks=re?parseFloat(document.getElementById("continuousAttackDamages").value):.02,js=q?parseFloat(document.getElementById("restoreJumpGain").value):1,Js=ee?parseInt(document.getElementById("goalType").value):1,qs=ge?parseFloat(document.getElementById("speedVx").value):0,Zs=ge?parseFloat(document.getElementById("speedVy").value):0,Qs=be?parseFloat(document.getElementById("accelerationAx").value):0,en=be?parseFloat(document.getElementById("accelerationAy").value):0,tn=ie?parseFloat(document.getElementById("rotationStart").value):0,sn=ie?parseFloat(document.getElementById("rotationSpeed").value):.01,nn=ve?parseInt(document.getElementById("cooldownDespawnDuration").value):100,ze;if(Ne)try{let te=parseInt(document.getElementById("movingTimes").value),Ge=document.getElementById("movingPatterns").value,ke=JSON.parse(Ge).map(_=>new Hn(_.dx,_.dy,_.duration));ze=new Ln(ke,te)}catch(te){console.error("Error parsing moving patterns:",te),ze=n.module.moving}let xe;if(_e)try{let te=document.getElementById("spawnerRythm");if(!te)xe=n.module.spawner;else{let Ge=parseInt(te.value),Ct=document.querySelectorAll(".spawner-block"),ke=[];Ct.forEach(_=>{let It=_.querySelector(".spawn-dx"),Bt=_.querySelector(".spawn-dy"),At=_.querySelector(".spawn-w"),Ht=_.querySelector(".spawn-h");if(!It||!Bt||!At||!Ht)return;let on=parseFloat(It.value),an=parseFloat(Bt.value),rn=parseFloat(At.value),ln=parseFloat(Ht.value),cn=_.querySelector(".spawn-hasSpeed"),dn=_.querySelector(".spawn-hasAcceleration"),un=_.querySelector(".spawn-hasRotation"),hn=_.querySelector(".spawn-hasBounce"),pn=_.querySelector(".spawn-hasKill"),mn=_.querySelector(".spawn-hasCouldownDespawn"),Lt=cn?.checked||!1,$t=dn?.checked||!1,Pt=un?.checked||!1,Ot=hn?.checked||!1,Wt=pn?.checked||!1,Nt=mn?.checked||!1,_t;if(Lt||$t||Pt||Ot||Wt||Nt){let Ft=_.querySelector(".spawn-speedVx"),Xt=_.querySelector(".spawn-speedVy"),Yt=_.querySelector(".spawn-accelAx"),Ut=_.querySelector(".spawn-accelAy"),zt=_.querySelector(".spawn-rotationStart"),Gt=_.querySelector(".spawn-rotationSpeed"),Vt=_.querySelector(".spawn-bounceFactor"),Kt=_.querySelector(".spawn-bounceCost"),jt=_.querySelector(".spawn-despawnDuration");_t=new Q({speed:Lt&&Ft&&Xt?new rs(parseFloat(Ft.value),parseFloat(Xt.value)):void 0,acceleration:$t&&Yt&&Ut?new is(parseFloat(Yt.value),parseFloat(Ut.value)):void 0,rotation:Pt&&zt&&Gt?new ls(parseFloat(zt.value),parseFloat(Gt.value)):void 0,bounce:Ot&&Vt&&Kt?new ns(parseFloat(Vt.value),parseFloat(Kt.value)):void 0,kill:Wt?new os:void 0,couldownDespawn:Nt&&jt?new as(parseInt(jt.value)):void 0})}ke.push(new de(_t,{dx:on,dy:an,w:rn,h:ln}))}),ke.length>0?xe=new _n(Ge,!1,ke):xe=n.module.spawner}}catch(te){console.error("Error parsing spawner blocks:",te),xe=n.module.spawner}let Dt=new Q({bounce:B?new ns(Xe,Ye):void 0,kill:k?new os:void 0,heal:O?new Wn(De):void 0,couldownedAttack:X?new $n(Ue,Vs):void 0,continuousAttack:re?new Pn(Ks):void 0,restoreJump:q?new Nn(js):void 0,goal:ee?Js:void 0,moving:ze,speed:ge?new rs(qs,Zs):void 0,acceleration:be?new is(Qs,en):void 0,rotation:ie?new ls(tn,sn):void 0,spawner:xe,touchDespawn:Fe?new On:void 0,couldownDespawn:ve?new as(nn):void 0});n.module=Dt,n.drawMode=Dt.getDrawModule(0),n.drawMode&&(n.drawAnimator=n.drawMode.generateAnimator(n))},G=(B,k)=>{let O=document.getElementById(B),X=document.getElementById(k);O&&X?O.addEventListener("change",()=>{X.style.display=O.checked?"block":"none",z()}):O&&O.addEventListener("change",z)};G("modBounce","bounceOptions"),G("modHeal","healOptions"),G("modCooldownAttack","cooldownAttackOptions"),G("modContinuousAttack","continuousAttackOptions"),G("modRestoreJump","restoreJumpOptions"),G("modGoal","goalOptions"),G("modMoving","movingOptions"),G("modSpeed","speedOptions"),G("modAcceleration","accelerationOptions"),G("modRotation","rotationOptions"),G("modSpawner","spawnerOptions"),G("modCooldownDespawn","cooldownDespawnOptions"),G("modKill",""),G("modTouchDespawn",""),document.getElementById("addPattern")?.addEventListener("click",()=>{let B=document.getElementById("movingPatternsList"),k=B.children.length,O=document.createElement("div");O.className="pattern-row",O.style.cssText="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;",O.innerHTML=`
				<input type="number" class="pattern-dx" data-idx="${k}" value="0" step="0.1" style="width: 60px;" placeholder="dx">
				<input type="number" class="pattern-dy" data-idx="${k}" value="0" step="0.1" style="width: 60px;" placeholder="dy">
				<input type="number" class="pattern-duration" data-idx="${k}" value="100" step="1" style="width: 60px;" placeholder="dur">
				<button class="pattern-remove" data-idx="${k}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
			`,B.appendChild(O),O.querySelectorAll("input").forEach(X=>{X.addEventListener("change",z)}),O.querySelector(".pattern-remove")?.addEventListener("click",X=>{O.remove(),z()})}),document.querySelectorAll(".pattern-dx, .pattern-dy, .pattern-duration").forEach(B=>{B.addEventListener("change",z)}),document.querySelectorAll(".pattern-remove").forEach(B=>{B.addEventListener("click",k=>{k.target.closest(".pattern-row")?.remove(),z()})}),document.getElementById("addSpawnerBlock")?.addEventListener("click",()=>{let B=document.getElementById("spawnerBlocksList"),k=B.children.length,O=document.createElement("div");O.className="spawner-block",O.style.cssText="border: 1px solid #999; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #f9f9f9;",O.innerHTML=`
				<div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
					<input type="number" class="spawn-dx" data-idx="${k}" value="0" step="1" style="width: 60px;" placeholder="dx" title="Offset X">
					<input type="number" class="spawn-dy" data-idx="${k}" value="-50" step="1" style="width: 60px;" placeholder="dy" title="Offset Y">
					<input type="number" class="spawn-w" data-idx="${k}" value="50" step="1" style="width: 60px;" placeholder="w" title="Width">
					<input type="number" class="spawn-h" data-idx="${k}" value="50" step="1" style="width: 60px;" placeholder="h" title="Height">
					<button class="spawn-remove" data-idx="${k}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715 Remove</button>
				</div>
				
				<details>
					<summary style="cursor: pointer; font-weight: bold; margin: 5px 0;">Module Options</summary>
					<div style="padding-left: 10px; margin-top: 5px;">
						<label style="display: block;"><input type="checkbox" class="spawn-hasSpeed" data-idx="${k}"> Speed</label>
						<div class="spawn-speed-opts" data-idx="${k}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-speedVx" data-idx="${k}" value="0" step="0.5" style="width: 60px;" placeholder="vx">
							<input type="number" class="spawn-speedVy" data-idx="${k}" value="0" step="0.5" style="width: 60px;" placeholder="vy">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasAcceleration" data-idx="${k}"> Acceleration</label>
						<div class="spawn-accel-opts" data-idx="${k}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-accelAx" data-idx="${k}" value="0" step="0.01" style="width: 60px;" placeholder="ax">
							<input type="number" class="spawn-accelAy" data-idx="${k}" value="0" step="0.01" style="width: 60px;" placeholder="ay">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasRotation" data-idx="${k}"> Rotation</label>
						<div class="spawn-rotation-opts" data-idx="${k}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-rotationStart" data-idx="${k}" value="0" step="0.1" style="width: 60px;" placeholder="start">
							<input type="number" class="spawn-rotationSpeed" data-idx="${k}" value="0.01" step="0.01" style="width: 60px;" placeholder="speed">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasBounce" data-idx="${k}"> Bounce</label>
						<div class="spawn-bounce-opts" data-idx="${k}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-bounceFactor" data-idx="${k}" value="1" step="0.1" style="width: 60px;" placeholder="factor">
							<input type="number" class="spawn-bounceCost" data-idx="${k}" value="0.003" step="0.001" style="width: 60px;" placeholder="cost">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasKill" data-idx="${k}"> Kill</label>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasCouldownDespawn" data-idx="${k}"> Cooldown Despawn</label>
						<div class="spawn-despawn-opts" data-idx="${k}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-despawnDuration" data-idx="${k}" value="100" step="10" style="width: 60px;" placeholder="duration">
						</div>
					</div>
				</details>
			`,B.appendChild(O),Et(O)});function Et(B){B.querySelectorAll("input[type='number']:not([type='checkbox'])").forEach(X=>{X.addEventListener("change",z)}),B.querySelector(".spawn-remove")?.addEventListener("click",()=>{B.remove(),z()});let k=(X,re)=>{let q=B.querySelector(`.${X}`),ee=B.querySelector(`.${re}`);q&&ee?q.addEventListener("change",()=>{ee.style.display=q.checked?"block":"none",z()}):q&&q.addEventListener("change",z)};k("spawn-hasSpeed","spawn-speed-opts"),k("spawn-hasAcceleration","spawn-accel-opts"),k("spawn-hasRotation","spawn-rotation-opts"),k("spawn-hasBounce","spawn-bounce-opts"),k("spawn-hasCouldownDespawn","spawn-despawn-opts");let O=B.querySelector(".spawn-hasKill");O&&O.addEventListener("change",z)}document.querySelectorAll(".spawner-block").forEach(Et);let Us=["bounceFactor","bounceCost","healHp","cooldownAttackDamages","cooldownAttackDuration","continuousAttackDamages","restoreJumpGain","goalType","speedVx","speedVy","accelerationAx","accelerationAy","rotationStart","rotationSpeed","cooldownDespawnDuration"];for(let B of Us){let k=document.getElementById(B);k&&k.addEventListener("change",z)}let zs=["movingTimes","movingPatterns"];for(let B of zs){let k=document.getElementById(B);k&&k.addEventListener("change",z)}let Gs=["spawnerRythm","spawnerBlocks"];for(let B of Gs){let k=document.getElementById(B);k&&k.addEventListener("change",z)}n._updateDisplay=Ys}function kt(n){t.classList.remove("hidden"),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px;">
				<h3>Room Properties</h3>
				<button id="deleteRoomBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Room (Suppr)</button>
				<div>
					<label>X: <input type="number" id="roomX" value="${n.x}" step="${u}"></label><br>
					<label>Y: <input type="number" id="roomY" value="${n.y}" step="${u}"></label><br>
					<label>Width: <input type="number" id="roomW" value="${n.w}" step="${u}" min="${u*4}"></label><br>
					<label>Height: <input type="number" id="roomH" value="${n.h}" step="${u}" min="${u*4}"></label><br>
				</div>
			</div>
		`,document.getElementById("deleteRoomBtn").addEventListener("click",()=>{let y=I[0],m=y.rooms.indexOf(n);m>=0&&y.rooms.splice(m,1),oe()});let l=()=>{let y=parseFloat(document.getElementById("roomX").value),m=parseFloat(document.getElementById("roomY").value),b=parseFloat(document.getElementById("roomW").value),T=parseFloat(document.getElementById("roomH").value);n.x=C(y),n.y=C(m),n.w=Math.max(u*4,C(b)),n.h=Math.max(u*4,C(T))},h=()=>{document.getElementById("roomX").value=n.x.toString(),document.getElementById("roomY").value=n.y.toString(),document.getElementById("roomW").value=n.w.toString(),document.getElementById("roomH").value=n.h.toString()};document.getElementById("roomX").addEventListener("change",l),document.getElementById("roomY").addEventListener("change",l),document.getElementById("roomW").addEventListener("change",l),document.getElementById("roomH").addEventListener("change",l),n._updateDisplay=h}t.addEventListener("mousedown",n=>{n.stopPropagation()}),t.addEventListener("click",n=>{n.stopPropagation()}),t.addEventListener("wheel",n=>{n.stopPropagation()}),t.addEventListener("pointerdown",n=>{n.stopPropagation()}),t.addEventListener("pointermove",n=>{n.stopPropagation()}),t.addEventListener("pointerup",n=>{n.stopPropagation()}),document.addEventListener("mousedown",n=>{let i=Y(n.clientX,n.clientY);if(f.down=!0,f.button=n.button,f.sx=n.clientX,f.sy=n.clientY,f.wx=C(i.x),f.wy=C(i.y),p!=="play"){if(n.button===1){M=!0,D.x=n.clientX,D.y=n.clientY,n.preventDefault();return}if(n.button===2&&p==="default"){if(n.preventDefault(),a.length>0){let l=Se(i.x,i.y);if(l&&a.includes(l)){o.active=!0,o.type="multi-select-move",o.startMouseX=i.x,o.startMouseY=i.y;return}}o.active=!0,o.type="multi-select",o.createStartX=i.x,o.createStartY=i.y;return}if(n.button===0){if(p==="default"){if(a.length>0){let h=Se(i.x,i.y);if(h&&a.includes(h)){o.active=!0,o.type="multi-select-move",o.startMouseX=i.x,o.startMouseY=i.y;return}else a=[]}let l=Se(i.x,i.y);if(l){let h=wt(l,i.x,i.y);if(h){o.active=!0,o.type="resize-block",o.target=l,o.resizeEdge=h,o.startMouseX=i.x,o.startMouseY=i.y,o.startTargetX=l.x,o.startTargetY=l.y,o.startTargetW=l.w,o.startTargetH=l.h;return}o.active=!0,o.type="block",o.target=l,o.startMouseX=i.x,o.startMouseY=i.y,o.startTargetX=l.x,o.startTargetY=l.y,x=l,xt(l);return}o.active=!0,o.type="create-block",o.createStartX=C(i.x),o.createStartY=C(i.y)}else if(p==="rooms"){let l=ne(i.x,i.y);if(l){let h=gt(l,i.x,i.y);if(h){o.active=!0,o.type="resize-room",o.target=l,o.resizeEdge=h,o.startMouseX=i.x,o.startMouseY=i.y,o.startTargetX=l.x,o.startTargetY=l.y,o.startTargetW=l.w,o.startTargetH=l.h;return}o.active=!0,o.type="room",o.target=l,o.startMouseX=i.x,o.startMouseY=i.y,o.startTargetX=l.x,o.startTargetY=l.y,x=l,kt(l);return}o.active=!0,o.type="create-room",o.createStartX=C(i.x),o.createStartY=C(i.y)}}}}),document.addEventListener("mouseup",n=>{if(f.down=!1,n.button===1&&(M=!1),n.button===2&&o.active){if(o.type==="multi-select-move"){o.active=!1,o.type=null;return}if(o.type==="multi-select"){let i=Y(n.clientX,n.clientY),l=Math.min(o.createStartX,i.x),h=Math.min(o.createStartY,i.y),y=Math.max(o.createStartX,i.x),m=Math.max(o.createStartY,i.y);a=[];let b=I[0];for(let T of b.rooms)for(let R of T.blocks){let S=R.x-R.w/2,v=R.x+R.w/2,E=R.y-R.h/2,F=R.y+R.h/2,$=!(v<=l||S>=y),N=!(F<=h||E>=m);$&&N&&a.push(R)}o.active=!1,o.type=null,a.length>0&&oe();return}}if(n.button===0&&o.active){let i=Y(n.clientX,n.clientY);if(o.type==="multi-select-move"){o.active=!1,o.type=null;return}if(o.type==="create-block"){let l=Math.min(o.createStartX,C(i.x)),h=Math.min(o.createStartY,C(i.y)),y=Math.max(o.createStartX,C(i.x))+u,m=Math.max(o.createStartY,C(i.y))+u,b=y-l,T=m-h;if(b>=u&&T>=u){let R=l+b/2,S=h+T/2,v=new K(R,S,b,T,new Q({})),E=ne(v.x,v.y);if(E){let F=I[0],$=!0;for(let N of F.rooms){for(let U of N.blocks){let j=Math.abs(v.x-U.x),fe=Math.abs(v.y-U.y),ye=(v.w+U.w)/2,we=(v.h+U.h)/2;if(j<ye&&fe<we){$=!1;break}}if(!$)break}$&&(E.blocks.push(v),x=v,xt(v))}}}else if(o.type==="create-room"){let l=Math.min(o.createStartX,C(i.x)),h=Math.min(o.createStartY,C(i.y)),y=Math.max(o.createStartX,C(i.x))+u,m=Math.max(o.createStartY,C(i.y))+u,b=y-l,T=m-h;if(b>=u*4&&T>=u*4){let R=new Z(l,h,b,T,[]),S=I[0],v=!0;for(let E of S.rooms){let F=!(R.x+R.w<=E.x||R.x>=E.x+E.w),$=!(R.y+R.h<=E.y||R.y>=E.y+E.h);if(F&&$){v=!1;break}}v&&(S.rooms.push(R),x=R,kt(R))}}o.active=!1,o.type=null,o.target=null}}),document.addEventListener("mousemove",n=>{let i=Y(n.clientX,n.clientY);if(f.sx=n.clientX,f.sy=n.clientY,f.wx=C(i.x),f.wy=C(i.y),p!=="play"&&!o.active&&!M){let l="default";if(p==="default"){let h=Se(i.x,i.y);if(h){let y=wt(h,i.x,i.y);l=y?bt(y):"move"}}else if(p==="rooms"){let h=ne(i.x,i.y);if(h){let y=gt(h,i.x,i.y);l=y?bt(y):"move"}}l!==L&&(L=l,r.style.cursor=l)}else M&&(r.style.cursor="grabbing");if(M){let l=(n.clientX-D.x)/c.zoom,h=(n.clientY-D.y)/c.zoom;c.x-=l,c.y-=h,D.x=n.clientX,D.y=n.clientY}if(o.active&&(o.type==="multi-select-move"||o.type==="multi-select"&&a.length>0&&f.button===0)&&a.length>0){let l=C(i.x)-C(o.startMouseX),h=C(i.y)-C(o.startMouseY);if(l===0&&h===0)return;ds(a,l,h)&&(us(a,l,h),o.startMouseX=C(i.x),o.startMouseY=C(i.y))}else if(o.active&&o.type==="block"&&o.target){let l=o.target,h=C(i.x)-C(o.startMouseX),y=C(i.y)-C(o.startMouseY),m=o.startTargetX+h,b=o.startTargetY+y,T=I[0],R=!0;for(let v of T.rooms){for(let E of v.blocks){if(E===l)continue;let F=Math.abs(m-E.x),$=Math.abs(b-E.y),N=(l.w+E.w)/2,U=(l.h+E.h)/2;if(F<N&&$<U){R=!1;break}}if(!R)break}let S=ne(m,b);(!S||!me({x:m,y:b,w:l.w,h:l.h},S))&&(R=!1),R&&(S&&pe(l)!==S&&vt(l,S),l.x=m,l.y=b,l._updateDisplay&&l._updateDisplay())}else if(o.active&&o.type==="room"&&o.target){let l=o.target,h=C(i.x)-C(o.startMouseX),y=C(i.y)-C(o.startMouseY),m=o.startTargetX+h,b=o.startTargetY+y,T=I[0],R=!0;for(let S of T.rooms){if(S===l)continue;let v=!(m+l.w<=S.x||m>=S.x+S.w),E=!(b+l.h<=S.y||b>=S.y+S.h);if(v&&E){R=!1;break}}if(R){let S=m-l.x,v=b-l.y;for(let E of l.blocks)E.x+=S,E.y+=v;l.x=m,l.y=b,l._updateDisplay&&l._updateDisplay()}}else if(o.active&&o.type==="resize-block"&&o.target){let l=o.target,h=C(i.x)-C(o.startMouseX),y=C(i.y)-C(o.startMouseY),m=o.resizeEdge,b=u,T=n.shiftKey,R=o.startTargetX,S=o.startTargetY,v=o.startTargetW,E=o.startTargetH;if(T){let U=o.startTargetW/o.startTargetH;m.includes("left")||m.includes("right")?(v=m.includes("left")?o.startTargetW-h:o.startTargetW+h,v>=b?(E=v/U,E>=b?(m.includes("left"),R=o.startTargetX+h/2,m.includes("top")?S=o.startTargetY+(o.startTargetH-E)/2:m.includes("bottom")&&(S=o.startTargetY-(o.startTargetH-E)/2)):(v=o.startTargetW,E=o.startTargetH)):(v=o.startTargetW,E=o.startTargetH)):(E=m.includes("top")?o.startTargetH-y:o.startTargetH+y,E>=b?(v=E*U,v>=b?(m.includes("top"),S=o.startTargetY+y/2,m.includes("left")?R=o.startTargetX+(o.startTargetW-v)/2:m.includes("right")&&(R=o.startTargetX-(o.startTargetW-v)/2)):(v=o.startTargetW,E=o.startTargetH)):(v=o.startTargetW,E=o.startTargetH))}else m.includes("left")&&(v=o.startTargetW-h,v>=b?R=o.startTargetX+h/2:v=o.startTargetW),m.includes("right")&&(v=o.startTargetW+h,v>=b?R=o.startTargetX+h/2:v=o.startTargetW),m.includes("top")&&(E=o.startTargetH-y,E>=b?S=o.startTargetY+y/2:E=o.startTargetH),m.includes("bottom")&&(E=o.startTargetH+y,E>=b?S=o.startTargetY+y/2:E=o.startTargetH);let F=I[0],$=!0;for(let U of F.rooms){for(let j of U.blocks){if(j===l)continue;let fe=Math.abs(R-j.x),ye=Math.abs(S-j.y),we=(v+j.w)/2,We=(E+j.h)/2;if(fe<we&&ye<We){$=!1;break}}if(!$)break}let N=pe(l);N&&!me({x:R,y:S,w:v,h:E},N)&&($=!1),$&&(l.x=R,l.y=S,l.w=v,l.h=E,l._updateDisplay&&l._updateDisplay())}else if(o.active&&o.type==="resize-room"&&o.target){let l=o.target,h=C(i.x)-C(o.startMouseX),y=C(i.y)-C(o.startMouseY),m=o.resizeEdge,b=u*4,T=n.shiftKey,R=o.startTargetX,S=o.startTargetY,v=o.startTargetW,E=o.startTargetH;if(T){let N=o.startTargetW/o.startTargetH;m.includes("left")||m.includes("right")?(v=m.includes("left")?o.startTargetW-h:o.startTargetW+h,v>=b?(E=v/N,E>=b?(m.includes("left")&&(R=o.startTargetX+h),m.includes("top")&&(S=o.startTargetY+(o.startTargetH-E))):(v=o.startTargetW,E=o.startTargetH)):(v=o.startTargetW,E=o.startTargetH)):(E=m.includes("top")?o.startTargetH-y:o.startTargetH+y,E>=b?(v=E*N,v>=b?(m.includes("top")&&(S=o.startTargetY+y),m.includes("left")&&(R=o.startTargetX+(o.startTargetW-v))):(v=o.startTargetW,E=o.startTargetH)):(v=o.startTargetW,E=o.startTargetH))}else m.includes("left")&&(v=o.startTargetW-h,v>=b?R=o.startTargetX+h:v=o.startTargetW),m.includes("right")&&(v=o.startTargetW+h,v<b&&(v=o.startTargetW)),m.includes("top")&&(E=o.startTargetH-y,E>=b?S=o.startTargetY+y:E=o.startTargetH),m.includes("bottom")&&(E=o.startTargetH+y,E<b&&(E=o.startTargetH));let F=I[0],$=!0;for(let N of F.rooms){if(N===l)continue;let U=!(R+v<=N.x||R>=N.x+N.w),j=!(S+E<=N.y||S>=N.y+N.h);if(U&&j){$=!1;break}}if($){let N={x:R,y:S,w:v,h:E};for(let U of l.blocks)if(!me(U,N)){$=!1;break}}$&&(l.x=R,l.y=S,l.w=v,l.h=E,l._updateDisplay&&l._updateDisplay())}}),document.addEventListener("keydown",n=>{switch(n.code){case"F1":{n.preventDefault(),p==="play"?(p="default",A=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",H>=0&&(clearInterval(H),H=-1)):(p==="default"?(p="rooms",e.style.backgroundColor="#ff0044",e.textContent="rooms"):(p="default",e.style.backgroundColor="black",e.textContent="default"),a=[],oe());break}case"F2":{if(n.preventDefault(),p==="play")p="default",A=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",H>=0&&(clearInterval(H),H=-1);else{p="play",a=[],oe();let i=localStorage.getItem("keyboardMode"),l="wasd";(i==="zqsd"||i==="wasd")&&(l=i);let h=new ae(I[0].rooms.map(m=>new Z(m.x,m.y,m.w,m.h,m.blocks.map(b=>new K(b.x,b.y,b.w,b.h,b.module.copy()))))),y=Oe??"edited";A=new W(l,document,[[new ue("",h,y)]]),window.game=A,A.state.set("play"),A.startLevel(h,y),e.style.backgroundColor="rgb(0, 132, 255)",e.textContent="play"}break}case"F3":{n.preventDefault();break}case"F9":{n.preventDefault(),(async()=>{let l=await(await window.showSaveFilePicker({suggestedName:"stage.txt",types:[{description:"Stage",accept:{"text/plain":[".txt"]}}]})).createWritable(),h=new TextEncoder;function y(m){return l.write(h.encode(m+`
`))}await Fn(I[0],y),await l.close()})();break}case"F10":{n.preventDefault(),(async()=>{let[i]=await window.showOpenFilePicker(),l=await i.getFile();async function*h(){let b=l.stream().getReader(),T=new TextDecoder,R,S="",v=!1;for(;!(R=await b.read()).done;){if(S+=T.decode(R.value,{stream:!0}),!v){let $=S.search(/[\r\n]/);if($!==-1){let N=S.slice(0,$).trim();S=S.slice($+1),yield N,v=!0}else continue}let F;for(;(F=S.search(/[ \r\n]/))!==-1;){let $=S.slice(0,F).trim();S=S.slice(F+1),$&&(yield $)}}let E=S.trim();E&&(yield E)}let{stage:y,name:m}=await he(h);I[0]=y})();break}case"Escape":{a.length>0?a=[]:x?oe():t.classList.toggle("hidden");break}case"Delete":{if(a.length>0){let i=I[0];for(let l of a)for(let h of i.rooms){let y=h.blocks.indexOf(l);if(y>=0){h.blocks.splice(y,1);break}}a=[]}else if(x){if(x instanceof K){let i=pe(x);if(i){let l=i.blocks.indexOf(x);l>=0&&i.blocks.splice(l,1)}}else if(x instanceof Z){let i=I[0],l=i.rooms.indexOf(x);l>=0&&i.rooms.splice(l,1)}oe()}break}case"KeyC":{if(n.ctrlKey&&a.length>0){n.preventDefault();let i=Math.min(...a.map(h=>h.x)),l=Math.min(...a.map(h=>h.y));d=a.map(h=>({module:h.module.copy(),dx:h.x-i,dy:h.y-l,w:h.w,h:h.h}))}break}case"KeyV":{if(n.ctrlKey&&d.length>0){n.preventDefault();let i=Y(f.sx,f.sy),l=C(i.x),h=C(i.y),y=ne(l,h);if(!y)break;a=[];for(let m of d){let b=new K(l+m.dx,h+m.dy,m.w,m.h,m.module.copy());me(b,y)&&(y.blocks.push(b),a.push(b))}}break}}}),document.addEventListener("wheel",n=>{n.preventDefault();let i=Y(n.clientX,n.clientY),l=i.x,h=i.y,y=1.12,m=n.deltaY<0?y:1/y;c.zoom=P(c.zoom*m,.2,8)},{passive:!1}),document.addEventListener("contextmenu",n=>{p!=="play"&&n.preventDefault()});function hs(n){let i=Math.floor((c.x-W.WIDTH_2/c.zoom)/u)*u,l=Math.ceil((c.x+W.WIDTH_2/c.zoom)/u)*u,h=Math.floor((c.y-W.HEIGHT_2/c.zoom)/u)*u,y=Math.ceil((c.y+W.HEIGHT_2/c.zoom)/u)*u;n.strokeStyle="#444";let m=.3,b=1,T=3,R=16,S=9;for(let v=i;v<=l;v+=u)Math.floor(v/u)%(R*4)===0?n.lineWidth=T:Math.floor(v/u)%R===0?n.lineWidth=b:n.lineWidth=m,n.beginPath(),n.moveTo(v,h),n.lineTo(v,y),n.stroke();for(let v=h;v<=y;v+=u)Math.floor(v/u)%(S*4)===0?n.lineWidth=T:Math.floor(v/u)%S===0?n.lineWidth=b:n.lineWidth=m,n.beginPath(),n.moveTo(i,v),n.lineTo(l,v),n.stroke()}function ps(n){if(!o.active)return;let i=Y(f.sx,f.sy);if(o.type==="create-block"){let l=Math.min(o.createStartX,C(i.x)),h=Math.min(o.createStartY,C(i.y)),y=Math.max(o.createStartX,C(i.x))+u,m=Math.max(o.createStartY,C(i.y))+u,b=y-l,T=m-h;n.strokeStyle="cyan",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(l,h,b,T),n.setLineDash([])}else if(o.type==="create-room"){let l=Math.min(o.createStartX,C(i.x)),h=Math.min(o.createStartY,C(i.y)),y=Math.max(o.createStartX,C(i.x))+u,m=Math.max(o.createStartY,C(i.y))+u,b=y-l,T=m-h;n.strokeStyle="lime",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(l,h,b,T),n.setLineDash([])}else if(o.type==="multi-select"){let l=Math.min(o.createStartX,i.x),h=Math.min(o.createStartY,i.y),y=Math.max(o.createStartX,i.x),m=Math.max(o.createStartY,i.y),b=y-l,T=m-h;n.strokeStyle="blue",n.fillStyle="rgba(0, 0, 255, 0.1)",n.lineWidth=2,n.setLineDash([5,5]),n.fillRect(l,h,b,T),n.strokeRect(l,h,b,T),n.setLineDash([])}}function Tt(n,i){let l=8/c.zoom;n.fillStyle="cyan",n.strokeStyle="white",n.lineWidth=2/c.zoom;let h,y,m,b;i instanceof K?(h=i.x-i.w/2,y=i.y-i.h/2,m=i.w,b=i.h):(h=i.x,y=i.y,m=i.w,b=i.h);let T=[[h,y],[h+m,y],[h,y+b],[h+m,y+b]];for(let[S,v]of T)n.fillRect(S-l/2,v-l/2,l,l),n.strokeRect(S-l/2,v-l/2,l,l);let R=[[h+m/2,y],[h+m/2,y+b],[h,y+b/2],[h+m,y+b/2]];for(let[S,v]of R)n.fillRect(S-l/2,v-l/2,l,l),n.strokeRect(S-l/2,v-l/2,l,l)}function ms(n,i){i.module.rotation&&(n.save(),n.strokeStyle="rgba(255, 165, 0, 0.5)",n.lineWidth=2/c.zoom,n.setLineDash([5,5]),n.strokeRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h),n.setLineDash([]),n.restore())}function fs(n,i){i.module.spawner&&(n.save(),n.fillStyle="rgba(255, 0, 255, 0.3)",n.fillRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h),n.fillStyle="magenta",n.font=`${Math.min(i.w,i.h)*.6}px Arial`,n.textAlign="center",n.textBaseline="middle",n.fillText("S",i.x,i.y),n.restore())}function ys(n){let i=r.width/W.WIDTH,l=r.height/W.HEIGHT,h=Math.min(i,l),y=(r.width-W.WIDTH*h)/2,m=(r.height-W.HEIGHT*h)/2;n.fillStyle="black",n.fillRect(0,0,r.width,r.height),n.save(),n.translate(y,m),n.scale(h,h),n.save(),n.translate(W.WIDTH_2,W.HEIGHT_2),n.scale(c.zoom,c.zoom),n.translate(-c.x,-c.y),hs(n);let b=I[0];n.fillStyle="#ccc2";for(let T of b.rooms)n.fillRect(T.x,T.y,T.w,T.h);for(let T of b.rooms)T.draw(n);for(let T of b.rooms)for(let R of T.blocks)R.module.rotation&&ms(n,R),R.module.spawner&&fs(n,R);n.strokeStyle="white",n.lineWidth=3;for(let T of b.rooms)n.strokeRect(T.x,T.y,T.w,T.h);n.strokeStyle="white",n.lineWidth=3;for(let T of b.rooms)n.strokeRect(T.x,T.y,T.w,T.h);if(x&&(x instanceof K?(n.strokeStyle="yellow",n.lineWidth=4/c.zoom,n.strokeRect(x.x-x.w/2,x.y-x.h/2,x.w,x.h),Tt(n,x)):x instanceof Z&&(n.strokeStyle="yellow",n.lineWidth=4/c.zoom,n.strokeRect(x.x,x.y,x.w,x.h),Tt(n,x))),a.length>0){n.strokeStyle="blue",n.lineWidth=3/c.zoom;for(let T of a)n.strokeRect(T.x-T.w/2,T.y-T.h/2,T.w,T.h)}o.active&&ps(n),n.fillStyle="rgba(255, 255, 255, 0.3)",n.fillRect(f.wx,f.wy,u,u),n.restore(),n.restore(),n.fillStyle="black",m>0&&n.fillRect(0,0,r.width,m),m>0&&n.fillRect(0,r.height-m,r.width,m),y>0&&n.fillRect(0,0,y,r.height),y>0&&n.fillRect(r.width-y,0,y,r.height),n.fillStyle="white",n.font="16px monospace",n.fillText(`Camera: (${c.x.toFixed(0)}, ${c.y.toFixed(0)}) Zoom: ${c.zoom.toFixed(2)}`,10,r.height-60),n.fillText(`Mouse: (${f.wx.toFixed(0)}, ${f.wy.toFixed(0)})`,10,r.height-40),n.fillText(`Mode: ${p} | F1: Default/Rooms | F2: Play | Esc: deselect | Del: delete`,10,r.height-20),a.length>0&&(n.fillStyle="yellow",n.fillText(`Selected blocks: ${a.length} | Ctrl+C to copy | Ctrl+V to paste`,10,r.height-80))}function Mt(){p==="play"&&A?(A.gameLogic(),A.gameDraw(s,r.width,r.height,(n,i,l)=>{A.drawMethod(n,i,l)})):ys(s),window.running&&requestAnimationFrame(Mt)}window.game=A,window.running=!0,Mt()}window.startEditor=Xn;})();
