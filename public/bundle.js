(()=>{var xe={checkRectRectCollision(i,e){let t=(p,M)=>p.x*M.x+p.y*M.y,s=(p,M)=>({x:p.x-M.x,y:p.y-M.y}),o=p=>{let M=Math.hypot(p.x,p.y);return M===0?{x:0,y:0}:{x:p.x/M,y:p.y/M}},c=p=>{let M=p.w/2,C=p.h/2,k=Math.cos(p.r),P=Math.sin(p.r);return[{x:-M,y:-C},{x:M,y:-C},{x:M,y:C},{x:-M,y:C}].map(O=>({x:p.x+O.x*k-O.y*P,y:p.y+O.x*P+O.y*k}))},g=p=>{let M=[];for(let C=0;C<2;C++){let k=p[C],P=p[(C+1)%4],L=s(P,k),O={x:-L.y,y:L.x};M.push(o(O))}return M},b=(p,M)=>{let C=t(p[0],M),k=C;for(let P=1;P<p.length;P++){let L=t(p[P],M);L<C&&(C=L),L>k&&(k=L)}return{min:C,max:k}},u=(p,M)=>!(p.max<M.min||M.max<p.min);if(i.w<=0||i.h<=0||e.w<=0||e.h<=0)return!1;let l=c(i),m=c(e),a=[...g(l),...g(m)];for(let p of a){let M=b(l,p),C=b(m,p);if(!u(M,C))return!1}return!0},getPointRectDist(i,e){function t(l){let m=Math.cos(l.r),a=Math.sin(l.r),p=l.w/2,M=l.h/2;return[[-p,-M],[p,-M],[p,M],[-p,M]].map(([k,P])=>[l.x+k*m-P*a,l.y+k*a+P*m])}function s(l,m,a,p,M,C){let k=M-a,P=C-p,L=k*k+P*P;if(L===0)return Math.hypot(l-a,m-p);let O=((l-a)*k+(m-p)*P)/L;O=Math.max(0,Math.min(1,O));let re=a+O*k,D=p+O*P;return Math.hypot(l-re,m-D)}function o(l,m,a){let p=Math.cos(-a.r),M=Math.sin(-a.r),C=(l-a.x)*p-(m-a.y)*M,k=(l-a.x)*M+(m-a.y)*p;return Math.abs(C)<=a.w/2&&Math.abs(k)<=a.h/2}function c(l,m){let a=t(l),p=t(m),M=[[Math.cos(l.r),Math.sin(l.r)],[-Math.sin(l.r),Math.cos(l.r)],[Math.cos(m.r),Math.sin(m.r)],[-Math.sin(m.r),Math.cos(m.r)]];for(let[C,k]of M){let P=a.map(([I,q])=>I*C+q*k),L=p.map(([I,q])=>I*C+q*k),O=Math.min(...P),re=Math.max(...P),D=Math.min(...L),G=Math.max(...L);if(re<D||G<O)return!1}return!0}if(c(i,e))return 0;let g=t(i),b=t(e),u=1/0;for(let l=0;l<4;l++){let[m,a]=g[l];for(let p=0;p<4;p++){let[M,C]=b[p],[k,P]=b[(p+1)%4],L=s(m,a,M,C,k,P);u=Math.min(u,L)}}for(let l=0;l<4;l++){let[m,a]=b[l];for(let p=0;p<4;p++){let[M,C]=g[p],[k,P]=g[(p+1)%4],L=s(m,a,M,C,k,P);u=Math.min(u,L)}}return u}};var he=class{x;y;constructor(e,t){this.x=e,this.y=t}};var ze=class{x;y;hp;constructor(e,t,s){this.x=e,this.y=t,this.hp=s}getSize(){return new he(64,64)}draw(e){e.fillStyle="green";let t=this.getSize();e.fillRect(this.x-t.x/2,this.y-t.y/2,t.x,t.y)}getRotation(){return 0}heal(e){}bounce(e,t){}};var Ae=class i{static FAST_DURATION=10;static SLOW_DURATION=60;orientation;x;y;w;h;sections;background;borderColor;animColor;value;valueReference;timer;animDuration;mode;fastValue;slowValue;fastTimer;slowTimer;targetValue;fastStartValue;slowStartValue;constructor(e,t,s,o,c,g,b,u,l,m){this.orientation=e,this.x=s,this.y=o,this.w=c,this.h=g,this.sections=b,this.background=l,this.borderColor=m,this.animColor=u,t=Math.max(0,Math.min(1,t)),this.value=t,this.valueReference=t,this.timer=-1,this.animDuration=0,this.mode=null,this.fastValue=t,this.slowValue=t,this.fastTimer=-1,this.slowTimer=-1,this.targetValue=t,this.fastStartValue=t,this.slowStartValue=t}animFunction(e){return 1-Math.pow(1-e,3)}setValue(e){e=Math.max(0,Math.min(1,e)),e!==this.targetValue&&(this.targetValue=e,e>this.value?(this.mode="up",this.slowStartValue=this.value,this.slowTimer=0,this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0):(this.mode="down",this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0,this.slowStartValue=this.value,this.slowTimer=0))}update(){let e=!1;if(this.fastTimer>=0)if(this.fastTimer++,this.fastTimer<=i.FAST_DURATION){let t=this.fastTimer/i.FAST_DURATION,s=this.animFunction(t);this.mode==="up"?this.fastValue=this.fastStartValue+(this.targetValue-this.fastStartValue)*s:this.value=this.fastStartValue+(this.targetValue-this.fastStartValue)*s,e=!0}else this.mode==="up"?this.fastValue=this.targetValue:this.value=this.targetValue,this.fastTimer=-1;if(this.slowTimer>=0)if(this.slowTimer++,this.slowTimer<=i.SLOW_DURATION){let t=this.slowTimer/i.SLOW_DURATION,s=this.animFunction(t);this.mode==="up"?this.value=this.slowStartValue+(this.targetValue-this.slowStartValue)*s:this.slowValue=this.slowStartValue+(this.targetValue-this.slowStartValue)*s,e=!0}else this.mode==="up"?this.value=this.targetValue:this.slowValue=this.targetValue,this.slowTimer=-1;e||(this.mode=null,this.fastValue=this.value,this.slowValue=this.value)}draw(e){this.background&&(e.fillStyle=this.background,e.fillRect(this.x,this.y,this.w,this.h));let t=2,s=this.x+t,o=this.y+t,c=this.w-2*t,g=this.h-2*t;this.drawSections(e,s,o,c,g,this.value),this.mode==="up"&&this.slowTimer>=0?this.drawAnimationBar(e,s,o,c,g,this.value,this.fastValue):this.mode==="down"&&this.slowTimer>=0&&this.drawAnimationBar(e,s,o,c,g,this.value,this.slowValue),e.strokeStyle=this.borderColor,e.lineWidth=t,e.strokeRect(this.x,this.y,this.w,this.h)}drawSections(e,t,s,o,c,g){let b=this.sections.length;if(this.orientation==="horizontal"){let u=o*g,l=o/b,m=2;for(let a=0;a<b;a++){let p=t+a*l,M=t+(a+1)*l,C=Math.max(p,t),k=Math.min(M,t+u);k>C&&(e.fillStyle=this.sections[a],e.fillRect(C,s,k-C,c)),a<b-1&&M<t+u&&(e.fillStyle="black",e.fillRect(M-m/2,s,m,c))}}else{let u=c*g,l=c/b,m=2;for(let a=0;a<b;a++){let p=s+c-(a+1)*l,M=s+c-a*l,C=Math.max(p,s+c-u),k=Math.min(M,s+c);k>C&&(e.fillStyle=this.sections[a],e.fillRect(t,C,o,k-C)),a<b-1&&p>s+c-u&&(e.fillStyle="black",e.fillRect(t,p-m/2,o,m))}}}drawAnimationBar(e,t,s,o,c,g,b){if(e.fillStyle=this.animColor,this.orientation==="horizontal"){let u=t+o*Math.min(g,b),l=o*Math.abs(b-g);e.fillRect(u,s,l,c)}else{let u=s+c*(1-Math.max(g,b)),l=c*Math.abs(b-g);e.fillRect(t,u,o,l)}}};var ee=class i extends ze{static GRAVITY=.9;static DASH=20;static JUMP=25;static MAX_SPEED=25;static SPEED_INC=3;static SPEED_DEC=10;static JUMP_COUNT=3;static HP=3;static JUMP_HP_COST=1;static RESPAWN_COULDOWN=30;static DEATH_ANIM_COULDOWN=60;static SIZE=40;static SIZE_2=i.SIZE/2;vx=0;vy=0;eternalMode=!1;jumps=i.JUMP_COUNT;respawnCouldown=-1;jump_leveledBar=new Ae("vertical",1,1500,150,30,600,["#FFA800","#FFD000","#FFF200"],"#fffdceff",null,"black");hp_leveledBar=new Ae("horizontal",1,300,100,1e3,30,["#ff0044","#ff002f","#ff001a"],"#ffb1c5",null,"black");constructor(){super(0,0,i.HP),this.respawn()}getSize(){return new he(i.SIZE,i.SIZE)}consumeJump(e=1){if(this.jumps>0){this.jumps-=e,this.jumps>=i.JUMP_COUNT&&(this.jumps=i.JUMP_COUNT),this.jump_leveledBar.setValue(this.jumps/i.JUMP_COUNT);return}this.hit(i.JUMP_HP_COST,null)}bounce(e,t){if(this.vy<=0)return;let s=t*this.vy;this.jumps>=s?(this.jumps-=s,this.jump_leveledBar.setValue(this.jumps/i.JUMP_COUNT)):(this.jumps=0,this.jump_leveledBar.setValue(0)),this.vy*=-e}restoreJumps(){this.jumps=i.JUMP_COUNT,this.jump_leveledBar.setValue(1)}restoreJumpAdd(e){let t=this.jumps+e;this.jumps=t>=i.JUMP_COUNT?i.JUMP_COUNT:t,this.jump_leveledBar.setValue(this.jumps/i.JUMP_COUNT)}restoreHp(){this.hp=i.HP,this.hp_leveledBar.setValue(1)}hit(e,t){this.eternalMode||this.isAlive()&&(this.hp-=e,this.hp_leveledBar.setValue(this.hp/i.HP),this.hp<=0&&this.kill())}heal(e){this.hp+=e,this.hp>=i.HP?(this.hp=i.HP,this.hp_leveledBar.setValue(1)):this.hp_leveledBar.setValue(this.hp/i.HP)}isAlive(){return this.respawnCouldown<=i.RESPAWN_COULDOWN}kill(){this.eternalMode||(this.respawnCouldown=i.DEATH_ANIM_COULDOWN)}respawn(){this.x=0,this.y=0,this.vx=0,this.vy=-i.JUMP,this.restoreHp(),this.restoreJumps()}getSpeed2(){return this.vx*this.vx+this.vy*this.vy}reduceCouldown(){return this.respawnCouldown>=0&&(this.respawnCouldown--,this.respawnCouldown==i.RESPAWN_COULDOWN)}frame(e){let t=e.inputHandler;t.press("left")?this.vx>0?this.vx-=i.SPEED_DEC:this.vx-=i.SPEED_INC:t.press("right")?this.vx<0?this.vx+=i.SPEED_DEC:this.vx+=i.SPEED_INC:this.vx>0?(this.vx-=i.SPEED_DEC,this.vx<0&&(this.vx=0)):this.vx<0&&(this.vx+=i.SPEED_DEC,this.vx>0&&(this.vx=0)),this.vx>i.MAX_SPEED&&(this.vx=i.MAX_SPEED),this.vx<-i.MAX_SPEED&&(this.vx=-i.MAX_SPEED),t.first("up")&&(this.consumeJump(),this.vy=-i.JUMP),this.vy+=i.GRAVITY,t.press("down")&&(this.y+=i.DASH),this.x+=this.vx*(this.eternalMode?3:1),this.y+=this.vy}draw(e){e.fillStyle="white",e.strokeStyle="black",e.lineWidth=5;let t=4,s=this.x-i.SIZE_2,o=this.y-i.SIZE_2,c=i.SIZE;e.fillRect(s,o,c,c),e.beginPath(),e.moveTo(s+t,o),e.lineTo(s+c-t,o),e.quadraticCurveTo(s+c,o,s+c,o+t),e.lineTo(s+c,o+c-t),e.quadraticCurveTo(s+c,o+c,s+c-t,o+c),e.lineTo(s+t,o+c),e.quadraticCurveTo(s,o+c,s,o+c-t),e.lineTo(s,o+t),e.quadraticCurveTo(s,o,s+t,o),e.closePath(),e.stroke()}drawInfos(e){this.jump_leveledBar.update(),this.jump_leveledBar.draw(e),this.hp_leveledBar.update(),this.hp_leveledBar.draw(e)}drawDeathTransition(e){if(this.respawnCouldown<0)return;e.fillStyle="#ff0044";function t(o){return Math.sin(o*Math.PI/2)}let s=t(this.respawnCouldown/i.DEATH_ANIM_COULDOWN);if(s<.5){let o=F.WIDTH*2*s;e.fillRect(F.WIDTH-o,0,o,F.HEIGHT)}else{let o=F.WIDTH*2*(1-s);e.fillRect(0,0,o,F.HEIGHT)}}};var pt=class{dx;dy;duration;constructor(e,t,s=-1){this.dx=e,this.dy=t,this.duration=s}},qe=class{liberationCouldown;usages=new Map;constructor(e){this.liberationCouldown=e}track(e,t){let s=this.usages.get(e);return this.usages.set(e,t+this.liberationCouldown),s===void 0||s<=t}reset(){this.usages.clear()}},ht=class i{patterns;times;currentPattern;currentTime;loopCount;active;constructor(e,t){this.patterns=e,this.times=t,this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}update(e,t){if(!this.active||this.patterns.length===0)return;let s=this.patterns[this.currentPattern];if(e.x+=s.dx,e.y+=s.dy,this.currentTime++,s.duration!==-1&&this.currentTime>=s.duration&&(this.currentPattern++,this.currentTime=0,this.currentPattern>=this.patterns.length&&(this.loopCount++,this.times!==-1&&this.loopCount>=this.times?this.active=!1:this.currentPattern=0)),!t.containsBox(e.x,e.y,e.w,e.h)){let o=null;for(let c of t.adjacentRooms)c.containsBox(e.x,e.y,e.w,e.h)&&(o=c);o?e.toMove=o:e.toRemove=!0}}reset(){this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}copy(){let e=new i(this.patterns,this.times);return e.currentPattern=this.currentPattern,e.currentTime=this.currentTime,e.loopCount=this.loopCount,e.active=this.active,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},mt=class{spikes_x;spikes_y;spikes_w;spikes_h;constructor(e,t,s=32,o=32){this.spikes_x=Math.max(1,Math.ceil(e/s)),this.spikes_w=e/this.spikes_x,this.spikes_y=Math.max(1,Math.ceil(t/o)),this.spikes_h=t/this.spikes_y}},ft=class i{damages;duration;playerOnly;couldowns=new Map;constructor(e,t,s=!0){this.damages=e,this.duration=t,this.playerOnly=s}update(e){for(let[t,s]of this.couldowns){let o=s-1;o<=0?this.couldowns.delete(t):this.couldowns.set(t,o)}}reset(){this.couldowns.clear()}onTouch(e){this.playerOnly&&!(e instanceof ee)||this.couldowns.has(e)||(this.couldowns.set(e,this.duration),e.hit(this.damages,null))}copy(){let e=new i(this.damages,this.duration,this.playerOnly);return e.couldowns=new Map(this.couldowns),e}draw(e,t,s){t.fillStyle="#9B59B6",t.fillRect(-e.w/2,-e.h/2,e.w,e.h);let o=1;for(let[g,b]of this.couldowns)if(g instanceof ee){o=(this.duration-b)/this.duration,o<0&&(o=0),o>1&&(o=1);break}function c(g,b,u){let[l,m]=g,[a,p]=b,[M,C]=u;{let k=l+(M-l),P=m+(C-m),L=a+(M-a),O=p+(C-p);t.beginPath(),t.moveTo(l,m),t.lineTo(k,P),t.lineTo(L,O),t.lineTo(a,p),t.closePath(),t.fillStyle="#dec5ffff",t.fill()}if(t.beginPath(),t.moveTo(l,m),t.lineTo(M,C),t.lineTo(a,p),t.closePath(),t.strokeStyle="#FFEEAA",t.lineWidth=2,t.stroke(),o>0){let k=l+(M-l)*o,P=m+(C-m)*o,L=a+(M-a)*o,O=p+(C-p)*o;t.beginPath(),t.moveTo(l,m),t.lineTo(k,P),t.lineTo(L,O),t.lineTo(a,p),t.closePath(),t.fillStyle="#882dffff",t.fill()}}for(let g=0;g<s.spikes_x;g++){let b=-e.w/2+g*s.spikes_w+s.spikes_w/2,u=-e.h/2;c([b-s.spikes_w/2,u],[b+s.spikes_w/2,u],[b,u-s.spikes_h]);let l=e.h/2;c([b-s.spikes_w/2,l],[b+s.spikes_w/2,l],[b,l+s.spikes_h])}for(let g=0;g<s.spikes_y;g++){let b=-e.h/2+g*s.spikes_h+s.spikes_h/2,u=-e.w/2;c([u,b-s.spikes_w/2],[u,b+s.spikes_w/2],[u-s.spikes_h,b]);let l=e.w/2;c([l,b-s.spikes_w/2],[l,b+s.spikes_w/2],[l+s.spikes_h,b])}}generateAnimator(e){return new mt(e.w,e.h)}},yt=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,o=e.createRadialGradient(0,0,0,0,0,t*1.5);o.addColorStop(0,`rgba(114, 0, 129, ${this.alpha})`),o.addColorStop(1,"rgba(114, 0, 129, 0)"),e.fillStyle=o,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},wt=class i{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>i.PRODUCTION&&(this.production-=i.PRODUCTION,this.particles.push(new yt(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},gt=class i{damages;playerOnly;constructor(e,t=!0){this.damages=e,this.playerOnly=t}reset(){}onTouch(e){this.playerOnly&&!(e instanceof ee)||e.hit(this.damages,null)}copy(){return new i(this.damages,this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgb(111, 0, 255)",t.shadowBlur=50,t.fillStyle="rgba(212, 0, 255, 1)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new wt}},bt=class{arrows=[];spacing;time=0;constructor(e,t=30){let s=Math.ceil(e/t);this.spacing=e/s;for(let o=0;o<s;o++)this.arrows.push({y:o*this.spacing})}getSpeed(){return Math.max(.3,Math.sin(this.time/2)*3)}update(e){this.time+=.1;let t=this.getSpeed();for(let s of this.arrows)s.y+=t,s.y>e&&(s.y-=e)}getArrows(){return this.arrows}getOpacity(e,t){let s=this.spacing;return e<s?e/s:e>t-s?(t-e)/s:1}},vt=class i{cost;factor;playerOnly;helper;constructor(e,t,s=!0,o=12){this.factor=e,this.cost=t,this.playerOnly=s,this.helper=new qe(o)}reset(){this.helper.reset()}onTouch(e,t){this.playerOnly&&!(e instanceof ee)||this.helper.track(e,t)&&e.bounce(this.factor,this.cost)}update(){}copy(){return new i(this.factor,this.cost,this.playerOnly)}draw(e,t,s){s.update(e.h),t.save(),t.shadowColor="rgba(255, 220, 100, 0.9)",t.shadowBlur=35;let o=t.createLinearGradient(-e.w/2,-e.h/2,e.w/2,e.h/2);o.addColorStop(0,"#FFE066"),o.addColorStop(1,"#FFAA00"),t.fillStyle=o,t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore();let c=e.w*.6,g=20;for(let b=0;b<s.getArrows().length;b++){let u=s.getArrows()[b],l=0,m=e.h/2-u.y-10,a=s.getOpacity(u.y,e.h);t.save(),t.globalAlpha=a,t.strokeStyle="#FFFF80",t.lineWidth=3,t.shadowColor="rgba(255, 240, 180, 1)",t.shadowBlur=20,t.beginPath(),t.moveTo(l,m-g/2),t.lineTo(l-c/2,m+g/2),t.moveTo(l,m-g/2),t.lineTo(l+c/2,m+g/2),t.stroke(),t.restore()}}generateAnimator(e){return new bt(e.h)}},xt=class{x;y;r;vx;vy;alpha;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.r=2+Math.random()*4,this.vx=(Math.random()-.5)*.5,this.vy=-.5-Math.random()*1,this.alpha=1.4}update(){return this.x+=this.vx,this.y+=this.vy,this.alpha-=.01,this.alpha>0}draw(e){let t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r*2);t.addColorStop(0,`rgba(200, 20, 0, ${this.alpha})`),t.addColorStop(1,"rgba(255, 30, 0, 0)"),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.r,0,Math.PI*2),e.fill()}},kt=class i{bubbles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>i.PRODUCTION&&(this.production-=i.PRODUCTION,this.bubbles.push(new xt(e,t))),this.bubbles=this.bubbles.filter(s=>s.update())}draw(e){this.bubbles.forEach(t=>t.draw(e))}},Tt=class i{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e){this.playerOnly&&!(e instanceof ee)||e.hit(1/0,null)}copy(){return new i(this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgba(255,0,0,0.8)",t.shadowBlur=20,t.fillStyle="red",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new kt}},Mt=class i{duration;couldown;constructor(e){this.duration=e,this.couldown=e}update(e){--this.couldown<=0&&(e.toRemove=!0)}reset(){this.couldown=this.duration}copy(){let e=new i(this.duration);return e.couldown=this.couldown,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Rt=class i{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e,t){this.playerOnly&&!(e instanceof ee)||(t.toRemove=!0)}copy(){return new i(this.playerOnly)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Be=class i{particles=[];usableColor={r:50,g:150,b:50};touchedColor={r:30,g:100,b:30};currentColor={r:50,g:150,b:50};baseShadowBlur=30;shadowPulse=0;production=0;static PRODUCTION=2e5;update(e){e.module.heal?.playerHasTouched?(this.currentColor.r+=(this.touchedColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.touchedColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.touchedColor.b-this.currentColor.b)*.05):(this.currentColor.r+=(this.usableColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.usableColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.usableColor.b-this.currentColor.b)*.05),e.module.heal?.playerHasTouched?this.shadowPulse=0:this.shadowPulse+=.04,e.module.heal?.playerHasTouched||(this.production+=e.w*e.h,this.production>i.PRODUCTION&&(this.production-=i.PRODUCTION,this.particles.push({x:(Math.random()-.5)*e.w*.8,y:(Math.random()-.5)*e.h*.8,vy:-.5-Math.random(),size:5+Math.random()*5,alpha:1})));for(let s of this.particles)s.y+=s.vy,s.alpha-=.02;this.particles=this.particles.filter(s=>s.alpha>0)}getColor(){return`rgb(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b})`}getShadowBlur(e){return e.module.heal?.playerHasTouched?this.baseShadowBlur*.1:this.baseShadowBlur+Math.sin(this.shadowPulse)*5}},St=class i{hp;playerOnly;touched=new Set;playerHasTouched=!1;constructor(e,t=!0){this.hp=e,this.playerOnly=t}reset(){this.touched.clear(),this.playerHasTouched=!1}onTouch(e){let t=e instanceof ee;this.playerOnly&&!t||(t&&(this.playerHasTouched=!0),this.touched.has(e)||(this.touched.add(e),e.heal(this.hp)))}copy(){let e=new i(this.hp,this.playerOnly);return e.touched=new Set(this.touched),e}draw(e,t,s){s.update(e);let o=s.getShadowBlur(e);t.save(),t.shadowColor="rgba(100, 255, 100, 0.8)",t.shadowBlur=o,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),e.cancelRotation(t,()=>{for(let c of s.particles){t.save(),t.globalAlpha=c.alpha,t.strokeStyle="#B0FFB0",t.lineWidth=2,t.shadowColor="rgba(180, 255, 180, 0.8)",t.shadowBlur=o/2;let g=c.x,b=c.y,u=c.size/2;t.beginPath(),t.moveTo(g-u,b),t.lineTo(g+u,b),t.moveTo(g,b-u),t.lineTo(g,b+u),t.stroke(),t.restore()}})}generateAnimator(e){return new Be}},Je=class i{vx;vy;constructor(e=0,t=0){this.vx=e,this.vy=t}update(e,t){if(e.x+=this.vx,e.y+=this.vy,!t.containsBox(e.x,e.y,e.w,e.h)){let s=null;for(let o of t.adjacentRooms)o.containsBox(e.x,e.y,e.w,e.h)&&(s=o);s?e.toMove=s:e.toRemove=!0}}reset(){this.vx=0,this.vy=0}copy(){return new i(this.vx,this.vy)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},$t=class i{ax;ay;constructor(e,t){this.ax=e,this.ay=t}update(e){if(!e.module.speed)throw new Error("AccelerationModule requires SpeedModule to be used");e.module.speed.vx+=this.ax,e.module.speed.vy+=this.ay}reset(){}copy(){return new i(this.ax,this.ay)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Ct=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,o=e.createRadialGradient(0,0,0,0,0,t*1.5);o.addColorStop(0,`rgba(255, 255, 180, ${this.alpha})`),o.addColorStop(1,"rgba(255, 200, 0, 0)"),e.fillStyle=o,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},It=class{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>Be.PRODUCTION&&(this.production-=Be.PRODUCTION,this.particles.push(new Ct(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Dt=class i{gain;helper;constructor(e,t=12){this.gain=e,this.helper=new qe(t)}reset(){this.helper.reset()}onTouch(e,t){e instanceof ee&&this.helper.track(e,t)&&e.restoreJumpAdd(this.gain)}copy(){return new i(this.gain)}draw(e,t,s){t.save(),t.shadowColor="rgba(255, 230, 100, 0.9)",t.shadowBlur=15,t.fillStyle="rgba(255, 220, 0, 0.6)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new It}},Et=class i{start;speed;angle;constructor(e,t){this.start=e,this.speed=t,this.angle=e}update(){this.angle+=this.speed,this.angle>=360&&(this.angle-=360)}reset(){this.angle=this.start}getAngle(){let e=Math.PI*2;return(this.angle%e+e)%e}copy(){let e=new i(this.start,this.speed);return e.angle=this.angle,e}},At=class{time=0;getColor(){let e=.7+.3*Math.sin(this.time*4),t=0,s=Math.floor(150+50*e);return`rgb(${t}, ${s}, 255)`}getShadowBlur(e){return e+15*Math.sin(this.time*4)}},Bt=class{type;constructor(e){this.type=e}draw(e,t,s){s.time+=.015;function o(c){t.save(),t.shadowColor="rgba(0, 200, 255, 0.9)",t.shadowBlur=c,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),t.lineWidth=2,t.strokeStyle="rgba(0, 150, 255, 0.8)",t.strokeRect(-e.w/2,-e.h/2,e.w,e.h)}o(s.getShadowBlur(100)),o(s.getShadowBlur(70)),o(s.getShadowBlur(40))}generateAnimator(e){return new At}},Ht=class i{rythm;couldown;blocks;index=0;constructor(e,t,s){this.rythm=e,this.couldown=t?1:e,this.blocks=s}update(e,t){if(--this.couldown<=0){this.couldown+=this.rythm;let s=this.blocks[this.index];++this.index>=this.blocks.length&&(this.index-=this.blocks.length);let o=s.build(e);o&&(o.fromSpawner=!0,t.blocks.push(o))}}copy(){let e=new i(this.rythm,!1,this.blocks);return e.couldown=this.couldown,e.index=this.index,e}},ke=class i{static DEFAULT_SIZE=50;dx;dy;w;h;keepRotation;goal;module;constructor(e,t={}){this.dx=t.dx??0,this.dy=t.dy??0,this.w=t.w??i.DEFAULT_SIZE,this.h=t.h??i.DEFAULT_SIZE,this.goal=t.goal??0,this.keepRotation=t.keepRotation??!1,this.module=e}build(e){return this.module?new te(e.x+this.dx,e.y+this.dy,this.w,this.h,this.module.copy()):null}},ue=class i{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal;checkCollision;runInAdjacentRoom;constructor(e){this.moving=e.moving,this.rotation=e.rotation,this.couldownedAttack=e.couldownedAttack,this.continuousAttack=e.continuousAttack,this.bounce=e.bounce,this.kill=e.kill,this.heal=e.heal,this.touchDespawn=e.touchDespawn,this.restoreJump=e.restoreJump,this.couldownDespawn=e.couldownDespawn,this.spawner=e.spawner,this.speed=e.speed,this.acceleration=e.acceleration,this.acceleration&&!this.speed&&(this.speed=new Je(0,0)),this.runInAdjacentRoom=!!e.runInAdjacentRoom,e.goal&&(this.goal=new Bt(e.goal)),this.checkCollision=[e.couldownedAttack,e.continuousAttack,e.bounce,e.kill,e.heal,e.touchDespawn,e.restoreJump,e.goal].some(t=>t)}copy(){return new i({moving:this.moving?.copy(),rotation:this.rotation?.copy(),couldownedAttack:this.couldownedAttack?.copy(),continuousAttack:this.continuousAttack?.copy(),bounce:this.bounce?.copy(),kill:this.kill?.copy(),heal:this.heal?.copy(),touchDespawn:this.touchDespawn?.copy(),restoreJump:this.restoreJump?.copy(),couldownDespawn:this.couldownDespawn?.copy(),spawner:this.spawner?.copy(),speed:this.speed?.copy(),acceleration:this.acceleration?.copy(),runInAdjacentRoom:this.runInAdjacentRoom})}getDrawModule(e){let t=[this.goal,this.kill,this.heal,this.couldownedAttack,this.continuousAttack,this.restoreJump,this.bounce,this.moving,this.speed,this.acceleration],s=e;for(let o of t)if(o){if(s===0)return o;s--}return null}},te=class{x;y;w;h;start_x;start_y;start_w;start_h;module;toRemove=!1;addAtReset=!1;toMove=null;spawnRoom;fromSpawner=!1;drawMode;drawAnimator;constructor(e,t,s,o,c){this.x=e,this.y=t,this.w=s,this.h=o,this.start_x=e,this.start_y=t,this.start_w=s,this.start_h=o,this.module=c,this.drawMode=c.getDrawModule(0),this.drawMode?this.drawAnimator=this.drawMode.generateAnimator(this):this.drawAnimator=void 0}getRotation(){return this.module.rotation?this.module.rotation.getAngle():0}handleTouch(e,t){let s=e.getSize();xe.checkRectRectCollision({x:this.x,y:this.y,w:this.w,h:this.h,r:this.getRotation()},{x:e.x,y:e.y,w:s.x,h:s.y,r:e.getRotation()})&&(this.module.couldownedAttack?.onTouch(e),this.module.continuousAttack?.onTouch(e),this.module.bounce?.onTouch(e,t.frame),this.module.kill?.onTouch(e),this.module.heal?.onTouch(e),this.module.touchDespawn?.onTouch(e,this),this.module.restoreJump?.onTouch(e,t.frame),this.module.goal&&(t.goalComplete=this.module.goal.type))}init(e){this.spawnRoom=e}frame(e,t){this.module.moving?.update(this,t),this.module.speed?.update(this,t),this.module.acceleration?.update(this),this.module.rotation?.update(),this.module.couldownedAttack?.update(this),this.module.couldownDespawn?.update(this),this.module.spawner?.update(this,t),this.module.bounce?.update(),this.module.checkCollision&&this.handleTouch(e.player,e),this.toRemove&&!this.fromSpawner&&this.spawnRoom.missingBlocks.push(this)}reset(){this.x=this.start_x,this.y=this.start_y,this.w=this.start_w,this.h=this.start_h,this.module.moving?.reset(),this.module.couldownedAttack?.reset(),this.module.rotation?.reset(),this.module.continuousAttack?.reset(),this.module.bounce?.reset(),this.module.kill?.reset(),this.module.heal?.reset(),this.module.speed?.reset(),this.module.acceleration?.reset(),this.module.touchDespawn?.reset(),this.module.restoreJump?.reset(),this.module.couldownDespawn?.reset()}draw(e){e.fillStyle="#555",e.save(),e.translate(this.x,this.y),this.module.rotation&&e.rotate(this.module.rotation.getAngle()),this.drawMode?this.drawMode.draw(this,e,this.drawAnimator):this.drawAsDefault(e),e.restore()}drawAsDefault(e){e.fillStyle="#555",e.fillRect(-this.w/2,-this.h/2,this.w,this.h)}cancelRotation(e,t){this.module.rotation?(e.save(),e.rotate(-this.module.rotation.getAngle()),t(),e.restore()):t()}},Ke={MovingPath:pt,MovingModule:ht,CouldownedAttackModule:ft,ContinuousAttackModule:gt,BounceModule:vt,KillModule:Tt,CouldownDespawnModule:Mt,TouchDespawnModule:Rt,HealModule:St,SpeedModule:Je,AccelerationModule:$t,RestoreJumpModule:Dt,RotationModule:Et,SpawnerModule:Ht};var ie=class{x;y;w;h;blocks;missingBlocks=[];adjacentRooms=null;adjacenceRects=null;constructor(e,t,s,o,c){this.x=e,this.y=t,this.w=s,this.h=o,this.blocks=c}fillAdjacenceRects(){let e=this.adjacentRooms,t=[],s=20,o=[{name:"top",start:this.x,end:this.x+this.w,coord:this.y},{name:"bottom",start:this.x,end:this.x+this.w,coord:this.y+this.h},{name:"left",start:this.y,end:this.y+this.h,coord:this.x},{name:"right",start:this.y,end:this.y+this.h,coord:this.x+this.w}];for(let c of o){let g=[];for(let l of e)if(c.name==="top"&&l.y+l.h===this.y){let m=Math.max(this.x,l.x),a=Math.min(this.x+this.w,l.x+l.w);m<a&&g.push({start:m,end:a})}else if(c.name==="bottom"&&l.y===this.y+this.h){let m=Math.max(this.x,l.x),a=Math.min(this.x+this.w,l.x+l.w);m<a&&g.push({start:m,end:a})}else if(c.name==="left"&&l.x+l.w===this.x){let m=Math.max(this.y,l.y),a=Math.min(this.y+this.h,l.y+l.h);m<a&&g.push({start:m,end:a})}else if(c.name==="right"&&l.x===this.x+this.w){let m=Math.max(this.y,l.y),a=Math.min(this.y+this.h,l.y+l.h);m<a&&g.push({start:m,end:a})}g.sort((l,m)=>l.start-m.start);let b=[];for(let l of g)b.length===0||b[b.length-1].end<l.start?b.push({...l}):b[b.length-1].end=Math.max(b[b.length-1].end,l.end);let u=c.start;for(let l of b)u<l.start&&(c.name==="top"?t.push({x:u,y:this.y,w:l.start-u,h:s}):c.name==="bottom"?t.push({x:u,y:this.y+this.h-s,w:l.start-u,h:s}):c.name==="left"?t.push({x:this.x,y:u,w:s,h:l.start-u}):c.name==="right"&&t.push({x:this.x+this.w-s,y:u,w:s,h:l.start-u})),u=l.end;u<c.end&&(c.name==="top"?t.push({x:u,y:this.y,w:c.end-u,h:s}):c.name==="bottom"?t.push({x:u,y:this.y+this.h-s,w:c.end-u,h:s}):c.name==="left"?t.push({x:this.x,y:u,w:s,h:c.end-u}):c.name==="right"&&t.push({x:this.x+this.w-s,y:u,w:s,h:c.end-u}))}this.adjacenceRects=t}contains(e,t){return e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h}containsBox(e,t,s,o){let c=this.x,g=this.x+this.w,b=this.y,u=this.y+this.h,l=e-s/2,m=e+s/2,a=t-o/2,p=t+o/2;return g>=l&&c<=m&&u>=a&&b<=p}init(){let e=this.blocks.length;for(let t=0;t<e;t++)this.blocks[t].init(this)}frame(e,t){for(let s=this.blocks.length-1;s>=0;s--){let o=this.blocks[s];o.frame(e,this),o.toRemove&&(this.blocks.splice(s,1),o.toRemove=!1,o.toMove=null),o.toMove&&(t.push({block:o,dest:o.toMove}),this.blocks.splice(s,1),o.toMove=null)}}reset(){for(let e of this.missingBlocks)this.blocks.push(e);this.missingBlocks.length=0;for(let e=this.blocks.length-1;e>=0;e--)this.blocks[e].fromSpawner?this.blocks.splice(e,1):this.blocks[e].reset()}drawAdjacenceRects(e,t,s){let o=t.getSize(),c={x:t.x,y:t.y,w:o.x,h:o.y,r:0};for(let g of this.adjacenceRects){let b=xe.checkRectRectCollision({x:g.x,y:g.y,w:g.w,h:g.h,r:0},c);s===b&&e.fillRect(g.x,g.y,g.w,g.h)}}draw(e){for(let t of this.blocks)t.draw(e)}};function jn(){return new Promise((i,e)=>{let t=indexedDB.open("levels-db",1);t.onupgradeneeded=s=>{let o=s.target.result;o.objectStoreNames.contains("levels")||o.createObjectStore("levels")},t.onsuccess=()=>i(t.result),t.onerror=()=>e(t.error)})}var Te=class{stage;name;key;constructor(e,t=null,s=null){this.key=e,this.stage=t,this.name=s}async load(){if(this.stage&&this.name)return{stage:this.stage,name:this.name};let o=(await jn()).transaction("levels","readonly").objectStore("levels").get(this.key),c=await new Promise((l,m)=>{o.onsuccess=()=>l(o.result??null),o.onerror=()=>m(o.error)});function*g(){let l="",m=!1;for(let a=0;a<c.length;a++){let p=c[a];if(!m)if(p===`
`||p==="\r"){yield l,l="",m=!0;continue}else{l+=p;continue}p!==" "&&p!=="	"&&p!==`
`&&p!=="\r"?l+=p:l.length>0&&(yield l,l="")}l.length>0&&(yield l)}let{stage:b,name:u}=await Me(g);return this.stage=b,this.name=u,{stage:b,name:u}}},we=class{rooms;currentRoom;constructor(e){this.rooms=e,this.fillAdjacentRooms();for(let s of e)s.fillAdjacenceRects();let t=this.findRoom(0,0);if(t===null)throw new Error("Missing spawn room");this.currentRoom=t;for(let s of this.rooms)s.init()}fillAdjacentRooms(){for(let e=0;e<this.rooms.length;e++){let t=this.rooms[e];t.adjacentRooms=[];for(let s=0;s<this.rooms.length;s++){if(e===s)continue;let o=this.rooms[s];if(t.x>=o.x&&t.y>=o.y&&t.x+t.w<=o.x+o.w&&t.y+t.h<=o.y+o.h)throw new Error("A room touches another");let c=(t.x+t.w===o.x||o.x+o.w===t.x)&&t.y<o.y+o.h&&t.y+t.h>o.y,g=(t.y+t.h===o.y||o.y+o.h===t.y)&&t.x<o.x+o.w&&t.x+t.w>o.x;(c||g)&&t.adjacentRooms.push(o)}}}findRoom(e,t){for(let s of this.rooms)if(s.contains(e,t))return s;return null}frame(e){let t=[];this.currentRoom.frame(e,t);for(let s of this.currentRoom.adjacentRooms)s.frame(e,t);for(let s of t)s.dest.blocks.push(s.block)}drawAdjacenceRects(e,t){let c=[],g=t.getSize(),b={x:t.x,y:t.y,w:g.x,h:g.y,r:0};function u(m){return xe.getPointRectDist({x:m.x+m.w/2,y:m.y+m.h/2,w:m.w,h:m.h,r:0},b)}function l(m){for(let a of m.adjacenceRects){let p=u(a);p>400?e.fillRect(a.x,a.y,a.w,a.h):p>70?c.push({rect:a,factor:1-(p-70)/330}):c.push({rect:a,factor:1})}}e.fillStyle="white",l(this.currentRoom);for(let m of this.currentRoom.adjacentRooms)l(m);c.sort((m,a)=>m.factor-a.factor);for(let m of c){let a=[255,255,255],p=[247,112,34],M=Math.round(a[0]+(p[0]-a[0])*m.factor),C=Math.round(a[1]+(p[1]-a[1])*m.factor),k=Math.round(a[2]+(p[2]-a[2])*m.factor);e.fillStyle=`rgb(${M}, ${C}, ${k})`,e.fillRect(m.rect.x,m.rect.y,m.rect.w,m.rect.h)}}update(e,t,s,o){if(this.currentRoom.contains(e,t))return"same";let c=this.findRoom(e,t);return c?(this.currentRoom=c,"new"):this.currentRoom.containsBox(e,t,s,o)?"same":"out"}reset(){for(let e of this.rooms)e.reset()}};var{MovingModule:Cs,MovingPath:Zn,CouldownedAttackModule:Qn,ContinuousAttackModule:ea,BounceModule:ta,KillModule:sa,CouldownDespawnModule:na,TouchDespawnModule:aa,HealModule:oa,SpeedModule:ia,AccelerationModule:ra,RestoreJumpModule:la,RotationModule:da,SpawnerModule:Is}=Ke;async function Me(i){let e=[],t=[0,0,0,0],s=[0,0,0,0],o=[],c=null,g=0,b=[];class u{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal=0;checkCollision=!1;runInAdjacentRoom=!1}let l=null,m=[],a=-1,p=0,M=0,C=[];function k(D){let G=Number(D);if(!Number.isFinite(G))throw new Error(`"${D}" is not a number`);return G}function P(){l&&(b.push(new te(s[0],s[1],s[2],s[3],new ue(l))),s[0]=-1,s[1]=-1,s[2]=-1,s[3]=-1,l=null)}function L(D=!1){(D||b.length)&&(e.push(new ie(t[0],t[1],t[2],t[3],b)),b=[])}function O(){if(C.length>0){let D=C[C.length-1];return D.currentBuilderModule||(D.currentBuilderModule=new u),D.currentBuilderModule}return l}let re=null;for await(let D of i()){if(re===null){re=D;continue}if(D==="endbuilder"){if(C.length>0){let G=C[C.length-1],I=G.currentBuilderModule?new ue(G.currentBuilderModule):void 0,q=new ke(I,{dx:G.currentBuilderBuffer[0],dy:G.currentBuilderBuffer[1],w:G.currentBuilderBuffer[2],h:G.currentBuilderBuffer[3],keepRotation:!!G.currentBuilderBuffer[4],goal:G.currentBuilderBuffer[5]});if(G.blocks.push(q),G.currentBuilderModule=null,G.currentBuilderStep=0,G.blocks.length>=G.blockCount){let Le=C.pop();Le.parentModule.spawner=new Is(Le.rythm,!1,Le.blocks),c=null}else c="spawnerBuilder"}continue}switch(c){case"room":{P(),L(),t[g]=k(D),g++,g===4&&(c="block",g=0);break}case"emptyroom":{P(),L(),t[g]=k(D),g++,g===4&&(c=null,g=0,L(!0));break}case"block":{s[g]=k(D),g++,g===4&&(c=null,g=0,l=new u);break}case"moving":{o.length<2&&(o.push(k(D)),o.length===2&&(a=o[0],p=o[1],m=[],o.length=0,p===0?(O().moving=new Cs([],a),c=null):(c="movingPattern",M=0)));break}case"movingPattern":{o.push(k(D)),o.length>=3&&(m.push(new Zn(o[0],o[1],o[2])),o.length=0,M++,M>=p&&(O().moving=new Cs(m,a),c=null));break}case"rotation":if(o.push(k(D)),o.length<2)break;O().rotation=new da(o[0],o[1]),o.length=0,c=null;break;case"couldownedAttack":if(o.push(k(D)),o.length<2)break;O().couldownedAttack=new Qn(o[0],o[1]),o.length=0,c=null;break;case"continuousAttack":if(o.push(k(D)),o.length<1)break;O().continuousAttack=new ea(o[0]),o.length=0,c=null;break;case"bounce":if(o.push(k(D)),o.length<2)break;O().bounce=new ta(o[0],o[1]),o.length=0,c=null;break;case"kill":if(o.push(k(D)),o.length<1)break;O().kill=new sa(!!o[0]),o.length=0,c=null;break;case"heal":if(o.push(k(D)),o.length<1)break;O().heal=new oa(o[0]),o.length=0,c=null;break;case"touchDespawn":if(o.push(k(D)),o.length<1)break;O().touchDespawn=new aa(!!o[0]),o.length=0,c=null;break;case"restoreJump":if(o.push(k(D)),o.length<1)break;O().restoreJump=new la(o[0]),o.length=0,c=null;break;case"couldownDespawn":if(o.push(k(D)),o.length<1)break;O().couldownDespawn=new na(o[0]),o.length=0,c=null;break;case"spawner":{if(o.length<2&&(o.push(k(D)),o.length===2)){let G=o[0],I=o[1];if(o.length=0,C.push({rythm:G,blockCount:I,blocks:[],currentBuilderBuffer:[0,0,0,0,0,0],currentBuilderStep:0,currentBuilderModule:null,parentModule:O()}),I===0){let q=C.pop();q.parentModule.spawner=new Is(q.rythm,!1,[]),c=null}else c="spawnerBuilder"}break}case"spawnerBuilder":{let G=C[C.length-1];G.currentBuilderBuffer[G.currentBuilderStep]=k(D),G.currentBuilderStep++,G.currentBuilderStep>=6&&(c=null);break}case"speed":if(o.push(k(D)),o.length<2)break;O().speed=new ia(o[0],o[1]),o.length=0,c=null;break;case"acceleration":if(o.push(k(D)),o.length<2)break;O().acceleration=new ra(o[0],o[1]),o.length=0,c=null;break;case"goal":if(o.push(k(D)),o.length<1)break;O().goal=o[0],o.length=0,c=null;break;case null:{let G=+D;Number.isFinite(G)?(P(),l=new u,s[0]=k(D),g=1,c="block"):c=D;break}}}return P(),L(),{stage:new we(e),name:re}}var je=class i{static TRANSITION_SPEED=60;static TRANSITION_DURATION=25;static VISION_RATIO_INIT=1.2;static VISION_RATIO_MIN=0;x=0;y=0;time=0;targetX=0;targetY=0;instant=!0;speed=0;move(e,t){this.targetX=e,this.targetY=t}teleport(e,t){this.targetX=e,this.targetY=t,this.instant=!0}startTracker(e,t){let s=e-this.x,o=t-this.y,c=Math.sqrt(s*s+o*o);this.targetX=e,this.targetY=t,this.instant=!1,this.time=0,this.speed=c/i.TRANSITION_DURATION}getVisionRatio(e){let s=Math.exp(-e/10);return console.log(i.VISION_RATIO_MIN+(i.VISION_RATIO_INIT-i.VISION_RATIO_MIN)*s),i.VISION_RATIO_MIN+(i.VISION_RATIO_INIT-i.VISION_RATIO_MIN)*s}update(e){if(this.instant){this.x=this.targetX,this.y=this.targetY;return}let t=this.getVisionRatio(this.time);this.time++;let s=this.targetX-this.x,o=this.targetY-this.y,c=s*s+o*o;if(c<this.speed*this.speed){this.x=this.targetX,this.y=this.targetY,this.instant=!0;return}let g=this.speed/Math.sqrt(c);this.x+=s*g,this.y+=o*g;let b=t*F.HEIGHT,u=this.y-this.targetY,l=e?this.x-e.x:u;l<=u&&u<=-b?this.x=this.targetX-b:e&&u<=l&&l<=-b&&(this.x=e.x-b),e&&l>=u&&u>=b?this.x=e.x+b:u>=l&&l>=b&&(this.x=this.targetX+b);let m=t*F.HEIGHT,a=this.y-this.targetY,p=e?this.y-e.y:a;p<=a&&a<=-m?this.y=this.targetY-m:e&&a<=p&&p<=-m&&(this.y=e.y-m),e&&p>=a&&a>=m?this.y=e.y+m:a>=p&&p>=m&&(this.y=this.targetY+m)}reset(){this.teleport(0,0)}};var me=class{left=!1;right=!1;up=!1;down=!1;debug=!1;enter=!1};var Ze=class{left=0;right=0;up=0;down=0;debug=0;enter=0},Qe=class i{static CONTROLS=["left","right","up","down","debug","enter"];static CONTROL_STACK_SIZE=256;keyboardUsed=!1;mobileUsed=!1;collectedKeys=new Ze;keysDown=new me;firstPress=new me;killedPress=new me;keyMap;gameRecords=null;frameCount=0;recordCompletion=-1;recordState="none";firstRecordLine=0;firstRecordLineCount=0;static KEYBOARDS={zqsd:{KeyZ:"up",KeyQ:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"},wasd:{KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"}};constructor(e){this.keyMap=i.KEYBOARDS[e]}onKeydown=e=>{let t=e,s=this.keyMap[t.code];if(s)switch(this.collectedKeys[s]){case 0:this.collectedKeys[s]=1;break;case 1:break;case 2:this.collectedKeys[s]=4;break;case 3:this.collectedKeys[s]=4;break;case 4:this.collectedKeys[s]=4;break}};onKeyup=e=>{let t=e,s=this.keyMap[t.code];if(s)switch(this.collectedKeys[s]){case 0:this.collectedKeys[s]=2;break;case 1:this.collectedKeys[s]=3;break;case 2:break;case 3:this.collectedKeys[s]=3;break;case 4:this.collectedKeys[s]=3;break}};onButtonTouchStart=(e,t)=>{if(t.classList.add("high"),e!=="special")switch(this.collectedKeys[e]){case 0:this.collectedKeys[e]=1;break;case 1:break;case 2:this.collectedKeys[e]=4;break;case 3:this.collectedKeys[e]=4;break;case 4:this.collectedKeys[e]=4;break}};onButtonTouchEnd=(e,t)=>{if(t.classList.remove("high"),e==="special"){document.getElementById("mobileEntry-specialContainer")?.classList.toggle("hidden");return}switch(this.collectedKeys[e]){case 0:this.collectedKeys[e]=2;break;case 1:this.collectedKeys[e]=3;break;case 2:break;case 3:this.collectedKeys[e]=3;break;case 4:this.collectedKeys[e]=3;break}};startRecord(){this.recordState==="emulate"||this.recordState==="forbid"||(this.firstRecordLine=0,this.firstRecordLineCount=0,this.gameRecords=[],this.recordCompletion=i.CONTROL_STACK_SIZE,this.frameCount=0,this.recordState="record")}pushRecord(){if(!this.gameRecords||this.recordState!=="record")return;let e=(s,o)=>{this.recordCompletion===i.CONTROL_STACK_SIZE&&(this.recordCompletion=0,o.push(new Uint32Array(i.CONTROL_STACK_SIZE))),o[o.length-1][this.recordCompletion]=s,this.recordCompletion++},t=this.createRecordLine();this.firstRecordLine===t?this.firstRecordLineCount++:this.firstRecordLineCount===0?(e(this.firstRecordLine,this.gameRecords),this.firstRecordLine=t):(e(4294967295,this.gameRecords),e(this.firstRecordLineCount,this.gameRecords),e(this.firstRecordLine,this.gameRecords),this.firstRecordLine=t,this.firstRecordLineCount=0)}stopRecord(){this.recordState!=="emulate"&&this.recordState!=="forbid"&&(this.recordState="none");let e=(t,s)=>{this.recordCompletion===i.CONTROL_STACK_SIZE&&(this.recordCompletion=0,s.push(new Uint32Array(i.CONTROL_STACK_SIZE))),s[s.length-1][this.recordCompletion]=t,this.recordCompletion++};this.gameRecords&&this.firstRecordLineCount>0&&(e(4294967295,this.gameRecords),e(this.firstRecordLineCount,this.gameRecords),e(this.firstRecordLine,this.gameRecords),this.firstRecordLineCount=0)}resumeRecord(){this.recordState==="none"&&(this.recordState="record")}async saveRecord(e,t=0){if(!this.gameRecords)return null;let s=this.gameRecords,o=this.recordCompletion,c=await window.showSaveFilePicker({suggestedName:`record_${e??"jumpyJump"}_${t}.bin`,types:[{description:"Binary data",accept:{"application/octet-stream":[".bin"]}}]}),g=await c.createWritable();for(let b=0;b<s.length;b++){let u=s[b];if(b===s.length-1){let l=u.slice(0,o);await g.write(l)}else await g.write(u.slice(0))}return await g.close(),c}async loadRecord(){let[e]=await window.showOpenFilePicker(),s=await(await e.getFile()).arrayBuffer();this.recordState="forbid",this.gameRecords=[new Uint32Array(s)]}startEmulation(){this.recordState="emulate",this.frameCount=0,this.recordCompletion=0,this.firstRecordLineCount=0}playRecordLine(e){function t(s){return!!(e&1<<s)}this.firstPress.left=t(0),this.firstPress.right=t(1),this.firstPress.up=t(2),this.firstPress.down=t(3),this.keysDown.left=t(4),this.keysDown.right=t(5),this.keysDown.up=t(6),this.keysDown.down=t(7),this.killedPress.left=t(8),this.killedPress.right=t(9),this.killedPress.up=t(10),this.killedPress.down=t(11)}createRecordLine(){let e=0,t=0;function s(o){o&&(e|=1<<t),t++}return s(this.firstPress.left),s(this.firstPress.right),s(this.firstPress.up),s(this.firstPress.down),s(this.keysDown.left),s(this.keysDown.right),s(this.keysDown.up),s(this.keysDown.down),s(this.killedPress.left),s(this.killedPress.right),s(this.killedPress.up),s(this.killedPress.down),e}restartRecord(){this.startRecord()}startListeners(e){("ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia("(pointer: coarse)").matches)&&this.startMobileListeners(),this.enableKeyboardListeners(e)}removeListeners(e){this.keyboardUsed&&(e.removeEventListener("keydown",this.onKeydown),e.removeEventListener("keyup",this.onKeyup))}enableKeyboardListeners(e){e.addEventListener("keydown",this.onKeydown),e.addEventListener("keyup",this.onKeyup),this.keyboardUsed=!0}startMobileListeners(){let e=(t,s)=>{let o=document.getElementById(t);o&&(o.ontouchstart=()=>this.onButtonTouchStart(s,o),o.ontouchend=()=>this.onButtonTouchEnd(s,o))};document.getElementById("mobileEntryContainer")?.classList.remove("hidden"),e("mobileEntry-left","left"),e("mobileEntry-right","right"),e("mobileEntry-up","up"),e("mobileEntry-down","down"),e("mobileEntry-special","special"),e("mobileEntry-special-enter","enter"),e("mobileEntry-special-debug","debug"),this.mobileUsed=!0}update(){if(this.recordState==="record"||this.recordState==="none"){for(let e of i.CONTROLS)this.play(e,this.collectedKeys[e]),this.collectedKeys[e]=0;this.recordState==="record"&&this.pushRecord()}if(this.recordState==="record")this.frameCount++;else if(this.recordState==="emulate"){let e=this.gameRecords[0];if(this.firstRecordLineCount>0){this.firstRecordLineCount--;return}if(this.frameCount>=e.length){this.recordState="none",this.collectedKeys=new Ze,this.keysDown=new me,this.firstPress=new me,this.killedPress=new me;return}let t=e[this.frameCount];if(this.frameCount++,t!=4294967295){this.playRecordLine(t);return}this.firstRecordLineCount=e[this.frameCount],this.frameCount++,this.playRecordLine(e[this.frameCount]),this.frameCount++}}play(e,t){switch(t){case 0:this.firstPress[e]=!1,this.killedPress[e]=!1;break;case 1:this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break;case 2:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1);break;case 3:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1):this.firstPress[e]=!0,this.killedPress[e]=!0;break;case 4:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1),this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break}}press(e){return this.firstPress[e]||this.keysDown[e]}first(e){return this.firstPress[e]}killed(e){return this.killedPress[e]}kill(e,t=!1){this.keysDown[e]=!1,t&&(this.firstPress[e]=!1)}draw(){}};var ca="https://jumpyjump-production.up.railway.app";async function Ds(i,e,t,s){let c=await(await fetch(ca+"/pushRun",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e,time:s,mapname:t})})).json();console.log(c)}var et=class i{type="menu";chrono=0;static PLAY_TO_WIN_DURATION=60;game;constructor(e){this.game=e}update(){switch(this.chrono++,this.type){case"playToWin":this.chrono>=i.PLAY_TO_WIN_DURATION&&this.set("win");break}}getChrono(){return this.chrono}set(e){switch(e){case"play":break;default:this.game.inputHandler.stopRecord();break}this.type=e,this.chrono=0}get(){return this.type}},F=class i{static WIDTH=1600;static HEIGHT=900;static WIDTH_2=i.WIDTH/2;static HEIGHT_2=i.HEIGHT/2;static GAME_VERSION="1.4.0";player=new ee;camera=new je;inputHandler;stageList;stage=null;frame=0;goalComplete=0;gameChrono=0;state=new et(this);validRun=!0;currentWorld=0;currentLevel=0;selectWorldFile=!1;playerUsername=null;stageName=null;constructor(e,t,s){this.inputHandler=new Qe(e),this.inputHandler.startListeners(t),this.stageList=s}startLevel(e,t){this.stage=e,this.stageName=t,this.player.respawnCouldown=0,this.resetStage();let s=document.getElementById("levelName");s&&(s.classList.remove("shown"),s.offsetWidth,s.innerText=t,s.classList.add("shown"))}startReplay(e){this.startLoading(),this.inputHandler.loadRecord().then(()=>{this.state.set("play"),this.startLevel(e,this.stageName),this.inputHandler.startEmulation()}).catch(t=>{console.error(t)}).finally(()=>{this.finishLoading()})}playLogic(e){let t=this.player.reduceCouldown();if(e&&(this.inputHandler.press("debug")?(this.validRun=!1,this.player.eternalMode=!0):this.player.eternalMode=!1,t&&this.resetStage()),this.inputHandler.first("enter")){let s=prompt("replay");s&&this.handleSpecial(s),this.inputHandler.kill("enter",!0)}this.player.frame(this),this.stage.frame(this),this.player.isAlive()&&this.handleRoom(),e&&(this.goalComplete>0&&this.state.set("playToWin"),this.player.respawnCouldown<=ee.RESPAWN_COULDOWN&&this.gameChrono++)}menuLogic(){if(this.inputHandler.first("enter")&&!this.selectWorldFile){let e=this.stageList[this.currentWorld][this.currentLevel];document.getElementById("loadingIcon")?.classList.remove("hidden"),e.load().then(({stage:t,name:s})=>{this.state.set("play"),this.startLevel(t,s)}).catch(t=>{console.error(t)}).finally(()=>{document.getElementById("loadingIcon")?.classList.add("hidden")})}this.inputHandler.first("right")&&(this.selectWorldFile?this.selectWorldFile=!1:this.currentLevel<this.stageList[this.currentWorld].length-1&&this.currentLevel++),this.inputHandler.first("left")&&!this.selectWorldFile&&(this.currentLevel>0?this.currentLevel--:this.selectWorldFile=!0),this.selectWorldFile?this.inputHandler.first("debug")&&(async()=>{let[e]=await window.showOpenFilePicker(),t=await e.getFile();async function*s(){let g=t.stream().getReader(),b=new TextDecoder,u,l="",m=!1;for(;!(u=await g.read()).done;){if(l+=b.decode(u.value,{stream:!0}),!m){let M=l.search(/[\r\n]/);if(M!==-1){let C=l.slice(0,M).trim();l=l.slice(M+1),yield C,m=!0}else continue}let p;for(;(p=l.search(/[ \r\n]/))!==-1;){let M=l.slice(0,p).trim();l=l.slice(p+1),M&&(yield M)}}let a=l.trim();a&&(yield a)}let{stage:o,name:c}=await Me(s);this.inputHandler.kill("debug"),this.state.set("play"),this.startLevel(o,c)})():(this.inputHandler.first("down")&&this.currentWorld<this.stageList.length-1&&this.currentWorld++,this.inputHandler.first("up")&&this.currentWorld>0&&this.currentWorld--)}winLogic(){if(this.validRun&&this.inputHandler.first("debug")){let e=confirm("Do you want to send your run?");document.getElementById("savingRun")?.classList.remove("hidden"),this.inputHandler.saveRecord(this.stageName,this.gameChrono).then(t=>{if(document.getElementById("savingRun")?.classList.add("hidden"),e&&t){let s;this.playerUsername?s=this.playerUsername:(s=prompt("Enter your username"),this.playerUsername=s),document.getElementById("sendingRun")?.classList.remove("hidden"),Ds(t,s,this.stageName??Date.now().toString(),this.gameChrono).finally(()=>{document.getElementById("sendingRun")?.classList.add("hidden")})}}).catch(t=>{document.getElementById("savingRun")?.classList.add("hidden"),console.error(t)})}this.inputHandler.first("enter")&&this.state.set("menu"),this.inputHandler.first("up")&&(this.resetStage(),this.state.set("play"))}gameLogic(){switch(this.inputHandler.update(),this.state.get()){case"play":this.playLogic(!0);break;case"playToWin":this.playLogic(!1);break;case"menu":this.menuLogic();break;case"win":this.winLogic();break}this.frame++,this.state.update()}generateChronoText(){let e=this.state.get();if(e!=="play"&&e!=="playToWin"&&e!=="win")return"";if(!this.validRun)return"debug";let t=this.gameChrono/60,s=Math.floor(t/60),o=Math.floor(t%60),c=Math.floor((t-Math.floor(t))*1e3),g=(b,u)=>b.toString().padStart(u,"0");return`${g(s,2)}:${g(o,2)}.${g(c,3)}`}resetStage(){this.inputHandler.restartRecord(),this.stage.reset();let e=this.state.get();(e==="play"||e==="win")&&(console.log("respawn"),this.player.respawn(),this.camera.reset(),this.validRun=!0,this.gameChrono=0,this.goalComplete=0)}handleRoom(){let e=this.player.getSize(),t=s=>{let o,c;return s.w<=i.WIDTH?o=s.x+s.w/2:this.player.x-i.WIDTH_2<=s.x?o=s.x+i.WIDTH_2:this.player.x+i.WIDTH_2>=s.x+s.w?o=s.x+s.w-i.WIDTH_2:o=this.player.x,s.h<=i.HEIGHT?c=s.y+s.h/2:this.player.y-i.HEIGHT_2<=s.y?c=s.y+i.HEIGHT_2:this.player.y+i.HEIGHT_2>=s.y+s.h?c=s.y+s.h-i.HEIGHT_2:c=this.player.y,{camX:o,camY:c}};switch(this.stage.update(this.player.x,this.player.y,e.x,e.y)){case"same":{let s=t(this.stage.currentRoom);this.camera.move(s.camX,s.camY);break}case"new":{let s=t(this.stage.currentRoom);this.camera.startTracker(s.camX,s.camY),this.player.restoreJumps();break}case"out":this.player.kill();break}}drawMethod(e,t,s){let o=this.state.get();switch(this.state.get()){case"play":case"playToWin":{t(),e.fillStyle="#111",e.fillRect(this.stage.currentRoom.x,this.stage.currentRoom.y,this.stage.currentRoom.w,this.stage.currentRoom.h),e.fillStyle="#1a1a1a";for(let c of this.stage.currentRoom.adjacentRooms)e.fillRect(c.x,c.y,c.w,c.h);this.stage.currentRoom.draw(e);for(let c of this.stage.currentRoom.adjacentRooms)c.draw(e);if(this.stage.drawAdjacenceRects(e,this.player),this.player.draw(e),s(),this.player.drawInfos(e),this.player.drawDeathTransition(e),o==="playToWin"){let c=1.5*this.state.getChrono()/et.PLAY_TO_WIN_DURATION;c<1?c=Math.sin(c*Math.PI/2):c=1,e.fillStyle=`rgba(0, 0, 0, ${c*c*c})`,e.fillRect(0,0,i.WIDTH,i.HEIGHT)}break}case"menu":{if(e.fillStyle="#111",e.fillRect(0,0,i.WIDTH,i.HEIGHT),e.textAlign="center",e.font="30px Arial",e.fillStyle="white",this.selectWorldFile)e.fillText("Select file (press P)",i.WIDTH_2,100);else if(e.fillText(`World ${this.currentWorld+1}`,i.WIDTH_2,100),this.currentWorld<this.stageList.length)for(let g=0;g<this.stageList[this.currentWorld].length;g++){e.fillStyle=g==this.currentLevel?"yellow":"white";let b=400+200*(g%5),u=300+Math.floor(g/5)*100;e.fillText(`#${g}`,b,u)}let c=e.textBaseline;e.textBaseline="bottom",e.textAlign="right",e.font="20px monospace",e.fillStyle="grey",e.fillText("v"+i.GAME_VERSION,i.WIDTH,i.HEIGHT),e.textBaseline=c;break}case"win":{e.fillStyle="black",e.fillRect(0,0,i.WIDTH,i.HEIGHT),e.font="30px Arial",e.fillStyle="white",e.textAlign="center",e.fillText("Press P to save",i.WIDTH_2,i.HEIGHT_2-20),e.fillStyle="white",e.fillText("Press SPACE to restart",i.WIDTH_2,i.HEIGHT_2+20),e.fillStyle="white",e.fillText("Press ENTER to select level",i.WIDTH_2,i.HEIGHT_2+60);break}}}gameDraw(e,t,s,o){let c=t/i.WIDTH,g=s/i.HEIGHT,b=Math.min(c,g),u=(t-i.WIDTH*b)/2,l=(s-i.HEIGHT*b)/2;e.save(),e.translate(u,l),e.scale(b,b),e.fillStyle="black",e.fillRect(0,0,i.WIDTH,i.HEIGHT),this.camera.update(new he(this.player.x,this.player.y)),o(e,()=>{e.save(),e.translate(i.WIDTH_2-this.camera.x,i.HEIGHT_2-this.camera.y)},()=>{e.restore()}),e.restore(),e.fillStyle="black",l>0&&e.fillRect(0,0,t,l),l>0&&e.fillRect(0,s-l,t,l),u>0&&e.fillRect(0,0,u,s),u>0&&e.fillRect(t-u,0,u,s)}handleSpecial(e){switch(e){case"replay":this.stage&&this.startReplay(this.stage);break}}startLoading(){let e=document.getElementById("loadingIcon");e&&e.classList.remove("hidden")}finishLoading(){let e=document.getElementById("loadingIcon");e&&e.classList.add("hidden")}};async function Bs(i){return console.log("fetch: "+i),await fetch(i,{cache:"no-store"})}function Hs(){return new Promise((i,e)=>{let t=indexedDB.open("levels-db",1);t.onupgradeneeded=s=>{let o=s.target.result;o.objectStoreNames.contains("levels")||o.createObjectStore("levels")},t.onsuccess=()=>i(t.result),t.onerror=()=>e(t.error)})}async function ua(i,e,t){let o=(await Hs()).transaction("levels","readwrite"),c=o.objectStore("levels"),g=`#${i}#${e}`;return c.put(t,g),new Promise((b,u)=>{o.oncomplete=()=>b(),o.onerror=()=>u(o.error)})}async function pa(i,e){let s=(await Hs()).transaction("levels","readwrite"),o=s.objectStore("levels"),c=`#${i}#${e}`;return o.delete(c),new Promise((g,b)=>{s.oncomplete=()=>g(),s.onerror=()=>b(s.error)})}async function ha(i,e,t){let o=await(await Bs(i)).text();await ua(e,t,o)}async function Es(i,e){await pa(i,e)}async function As(i,e){let s=await(await Bs(i+"/architecture.json")).json(),o=e??[],c=[],g=[];for(let u of s){let l=o.find(p=>p.name===u.name),m=[];for(let p of u.levels){let M=l?.levels.find(k=>k.filename===p.filename);if(!M||M.version!==p.version){let k=`${i}/${u.name}/${p.filename}`;console.log(`Fetch: ${k}`),g.push(ha(k,u.name,p.filename).then(()=>{console.log(`Update level: ${u.name}/${p.filename}`)}))}m.push({name:p.name,filename:p.filename,version:p.version})}let a=(l?.levels??[]).filter(p=>!u.levels.some(M=>M.filename===p.filename));for(let p of a)console.log(`Delete level: ${u.name}/${p.filename}`),await Es(u.name,p.filename);c.push({name:u.name,levels:m})}let b=o.filter(u=>!s.some(l=>l.name===u.name));for(let u of b){console.log(`Delete world: ${u.name}`);for(let l of u.levels)await Es(u.name,l.filename)}return await Promise.all(g),localStorage.setItem("architecture",JSON.stringify(c)),c}function Lt(i){let e=[];for(let t of i){let s=[];for(let o of t.levels)s.push(new Te(`#${t.name}#${o.filename}`));e.push(s)}return e}async function ma(){let i=document.getElementById("gameCanvas");function e(){i.width=window.innerWidth,i.height=window.innerHeight}e(),window.addEventListener("resize",e);let t=localStorage.getItem("keyboardMode"),s;t!=="zqsd"&&t!=="wasd"?s="wasd":s=t;let o,c="https://raw.githubusercontent.com/musiquammation/JumpyJump/levels",g=localStorage.getItem("architecture"),b,u;g?(b=JSON.parse(g),u=Lt(b),As(c,b).then(p=>{o.stageList=Lt(p),document.getElementById("fullyLoadLevels")?.classList.remove("hidden"),setTimeout(()=>{document.getElementById("fullyLoadLevels")?.classList.add("hidden")},2e3)}).catch(p=>{console.error(p)})):(b=await As(c,[]),u=Lt(b),document.getElementById("fullyLoadingGame")?.classList.remove("hidden"),document.getElementById("fullyLoadingGame")?.classList.add("hidden"));let l=i.getContext("2d");o=new F(s,document,u);let m=document.getElementById("chrono");function a(){o.gameLogic(),o.gameDraw(l,i.width,i.height,(p,M,C)=>{o.drawMethod(p,M,C)}),m.innerHTML=o.generateChronoText(),window.running&&requestAnimationFrame(a)}window.game=o,window.running=!0,a()}window.game=null;window.running=!1;window.startGame=ma;var He=null,{MovingPath:fa,MovingModule:ya,CouldownedAttackModule:Ls,ContinuousAttackModule:Ps,BounceModule:Os,KillModule:Ns,CouldownDespawnModule:Ws,TouchDespawnModule:_s,HealModule:Fs,SpeedModule:Ys,AccelerationModule:Xs,RestoreJumpModule:Us,RotationModule:Gs,SpawnerModule:Vs}=Ke;async function zs(i,e,t){if(i.moving){await e(`${t}moving ${i.moving.times} ${i.moving.patterns.length}`);for(let s of i.moving.patterns)await e(`${t}	${s.dx} ${s.dy} ${s.duration}`)}if(i.rotation&&await e(`${t}rotation ${i.rotation.start??0} ${i.rotation.speed??0}`),i.couldownedAttack&&await e(`${t}couldownedAttack ${i.couldownedAttack.damages??0} ${i.couldownedAttack.duration??0}`),i.continuousAttack&&await e(`${t}continuousAttack ${i.continuousAttack.damages??0}`),i.bounce&&await e(`${t}bounce ${i.bounce.factor??0} ${i.bounce.cost??0}`),i.kill&&await e(`${t}kill ${i.kill.playerOnly?1:0}`),i.heal&&await e(`${t}heal ${i.heal.hp??0}`),i.touchDespawn&&await e(`${t}touchDespawn ${i.touchDespawn.playerOnly?1:0}`),i.restoreJump&&await e(`${t}restoreJump ${i.restoreJump.gain??0}`),i.couldownDespawn&&await e(`${t}couldownDespawn ${i.couldownDespawn.duration??0}`),i.spawner){await e(`${t}spawner ${i.spawner.rythm} ${i.spawner.blocks.length}`);for(let s of i.spawner.blocks)await e(`${t}	${s.dx} ${s.dy} ${s.w} ${s.h} ${s.keepRotation?1:0} ${s.goal}`),s.module&&await zs(s.module,e,t+"		"),await e(`${t}	endbuilder`)}i.speed&&await e(`${t}speed ${i.speed.vx??0} ${i.speed.vy??0}`),i.acceleration&&await e(`${t}acceleration ${i.acceleration.ax??0} ${i.acceleration.ay??0}`),i.goal&&await e(`${t}goal ${i.goal.type??0}`)}async function wa(i,e){He===null&&(He=prompt("Level name?")),await e(He.split(`
`)[0]);for(let t of i.rooms){await e(`${t.blocks.length?"room":"emptyroom"} ${t.x} ${t.y} ${t.w} ${t.h}`);for(let s of t.blocks)await e(`	${s.x} ${s.y} ${s.w} ${s.h}`),s.module&&await zs(s.module,e,"		")}}function ga(){let i=document.getElementById("gameCanvas"),e=document.getElementById("mode"),t=document.getElementById("panel"),s=i.getContext("2d"),o=[],c=[];function g(){L=null,window.game=null}function b(){i.width=window.innerWidth,i.height=window.innerHeight}b(),window.addEventListener("resize",b);let u=25,l={x:0,y:0,zoom:1},m={sx:0,sy:0,wx:0,wy:0,down:!1,button:-1},a={active:!1,type:null,target:null,startMouseX:0,startMouseY:0,startTargetX:0,startTargetY:0},p="default",M=!1,C={x:0,y:0},k=null,P=-1,L=null,O="default",re=[new ie(-800,-450,1600,900,[])],D=[new we(re)],G=(n,d,r)=>Math.max(d,Math.min(r,n));function I(n){return Math.round(n/u-.5)*u}function q(n,d){let r=i.getBoundingClientRect(),h=(n-r.left)*(i.width/r.width),w=(d-r.top)*(i.height/r.height),f=i.width/F.WIDTH,v=i.height/F.HEIGHT,T=Math.min(f,v),R=(i.width-F.WIDTH*T)/2,S=(i.height-F.HEIGHT*T)/2,x=((h-R)/T-F.WIDTH_2)/l.zoom+l.x,$=((w-S)/T-F.HEIGHT_2)/l.zoom+l.y;return{x,y:$}}function Le(){let n=q(m.sx,m.sy);m.wx=I(n.x),m.wy=I(n.y)}function Pe(n,d){let r=D[0];for(let h of r.rooms)for(let w of h.blocks){let f=w.w/2,v=w.h/2;if(n>=w.x-f&&n<=w.x+f&&d>=w.y-v&&d<=w.y+v)return w}return null}function fe(n,d){let r=D[0];for(let h of r.rooms)if(n>=h.x&&n<=h.x+h.w&&d>=h.y&&d<=h.y+h.h)return h;return null}function Pt(n,d,r){let h=9/l.zoom,w=n.w/2,f=n.h/2,v=Math.abs(d-(n.x-w))<h,T=Math.abs(d-(n.x+w))<h,R=Math.abs(r-(n.y-f))<h,S=Math.abs(r-(n.y+f))<h;return R&&v?"top-left":R&&T?"top-right":S&&v?"bottom-left":S&&T?"bottom-right":v?"left":T?"right":R?"top":S?"bottom":null}function Ot(n,d,r){let h=19/l.zoom,w=Math.abs(d-n.x)<h,f=Math.abs(d-(n.x+n.w))<h,v=Math.abs(r-n.y)<h,T=Math.abs(r-(n.y+n.h))<h;return v&&w?"top-left":v&&f?"top-right":T&&w?"bottom-left":T&&f?"bottom-right":w?"left":f?"right":v?"top":T?"bottom":null}function Nt(n){return n&&{top:"ns-resize",bottom:"ns-resize",left:"ew-resize",right:"ew-resize","top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"}[n]||"default"}function Re(n){let d=D[0];for(let r of d.rooms)if(r.containsBox(n.x,n.y,n.w,n.h))return r;return null}function Se(n,d){let r=n.x-n.w/2,h=n.x+n.w/2,w=n.y-n.h/2,f=n.y+n.h/2;return r>=d.x&&h<=d.x+d.w&&w>=d.y&&f<=d.y+d.h}function Wt(n,d){let r=D[0];for(let h of r.rooms){let w=h.blocks.indexOf(n);if(w>=0){h.blocks.splice(w,1);break}}d.blocks.push(n)}function ba(n){if(n.length===0)return{minX:0,minY:0,maxX:0,maxY:0};let d=1/0,r=1/0,h=-1/0,w=-1/0;for(let f of n){let v=f.x-f.w/2,T=f.x+f.w/2,R=f.y-f.h/2,S=f.y+f.h/2;d=Math.min(d,v),h=Math.max(h,T),r=Math.min(r,R),w=Math.max(w,S)}return{minX:d,minY:r,maxX:h,maxY:w}}function qs(n,d,r){let h=D[0],w=new Set(n);for(let f of n){let v=f.x+d,T=f.y+r,R=fe(v,T);if(!R||!Se({x:v,y:T,w:f.w,h:f.h},R))return!1;for(let S of h.rooms)for(let x of S.blocks){if(w.has(x))continue;let $=Math.abs(v-x.x),z=Math.abs(T-x.y),Y=(f.w+x.w)/2,V=(f.h+x.h)/2;if($<Y&&z<V)return!1}}return!0}function Js(n,d,r){let h=D[0];for(let w of n){let f=w.x+d,v=w.y+r,T=fe(f,v);T&&Re(w)!==T&&Wt(w,T),w.x=f,w.y=v}}function ye(){t.innerHTML="",t.classList.add("hidden"),k=null}function _t(n){t.classList.remove("hidden");function d(A,y=0){let _="",K=y*20;return A.forEach((H,E)=>{let le=!!H.module,j=H.module?.speed?"checked":"",de=H.module?.speed?.vx||0,ne=H.module?.speed?.vy||0,B=H.module?.acceleration?"checked":"",N=H.module?.acceleration?.ax||0,ae=H.module?.acceleration?.ay||0,Ne=H.module?.kill?"checked":"",We=H.module?.bounce?"checked":"",nt=H.module?.bounce?.factor||1,at=H.module?.bounce?.cost||.003,_e=H.module?.rotation?"checked":"",ot=H.module?.rotation?.start||0,it=H.module?.rotation?.speed||.01,Fe=H.module?.couldownDespawn?"checked":"",rt=H.module?.couldownDespawn?.duration||100,Ye=H.module?.spawner?"checked":"",lt=H.module?.spawner?.rythm||60,Xe=H.module?.couldownedAttack?"checked":"",dt=H.module?.couldownedAttack?.damages||1,ct=H.module?.couldownedAttack?.duration||100,Ue=H.module?.continuousAttack?"checked":"",ut=H.module?.continuousAttack?.damages||.02,ge=H.module?.heal?"checked":"",be=H.module?.heal?.hp||2,De=H.module?.restoreJump?"checked":"",oe=H.module?.restoreJump?.gain||1,Ee=H.module?.touchDespawn?"checked":"",ce=H.module?.goal?"checked":"",pe=H.module?.goal?.type||1;_+=`
					<div class="spawner-block" data-depth="${y}" data-idx="${E}" style="border: 1px solid #999; padding: 10px; margin-left: ${K}px; margin-bottom: 10px; border-radius: 5px; background: ${y%2===0?"#f9f9f9":"#efefef"};">
						<div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
							<input type="number" class="spawn-dx" data-depth="${y}" data-idx="${E}" value="${H.dx}" step="1" style="width: 60px;" placeholder="dx" title="Offset X">
							<input type="number" class="spawn-dy" data-depth="${y}" data-idx="${E}" value="${H.dy}" step="1" style="width: 60px;" placeholder="dy" title="Offset Y">
							<input type="number" class="spawn-w" data-depth="${y}" data-idx="${E}" value="${H.w}" step="1" style="width: 60px;" placeholder="w" title="Width">
							<input type="number" class="spawn-h" data-depth="${y}" data-idx="${E}" value="${H.h}" step="1" style="width: 60px;" placeholder="h" title="Height">
							<button class="spawn-remove" data-depth="${y}" data-idx="${E}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
						</div>
						
						<details ${le?"open":""}>
							<summary style="cursor: pointer; font-weight: bold; margin: 5px 0;">Module Options</summary>
							<div style="padding-left: 10px; margin-top: 5px;">
								<label style="display: block;"><input type="checkbox" class="spawn-hasSpeed" data-depth="${y}" data-idx="${E}" ${j}> Speed</label>
								<div class="spawn-speed-opts" data-depth="${y}" data-idx="${E}" style="display: ${j?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-speedVx" data-depth="${y}" data-idx="${E}" value="${de}" step="0.5" style="width: 60px;" placeholder="vx">
									<input type="number" class="spawn-speedVy" data-depth="${y}" data-idx="${E}" value="${ne}" step="0.5" style="width: 60px;" placeholder="vy">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasAcceleration" data-depth="${y}" data-idx="${E}" ${B}> Acceleration</label>
								<div class="spawn-accel-opts" data-depth="${y}" data-idx="${E}" style="display: ${B?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-accelAx" data-depth="${y}" data-idx="${E}" value="${N}" step="0.01" style="width: 60px;" placeholder="ax">
									<input type="number" class="spawn-accelAy" data-depth="${y}" data-idx="${E}" value="${ae}" step="0.01" style="width: 60px;" placeholder="ay">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasRotation" data-depth="${y}" data-idx="${E}" ${_e}> Rotation</label>
								<div class="spawn-rotation-opts" data-depth="${y}" data-idx="${E}" style="display: ${_e?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-rotationStart" data-depth="${y}" data-idx="${E}" value="${ot}" step="0.1" style="width: 60px;" placeholder="start">
									<input type="number" class="spawn-rotationSpeed" data-depth="${y}" data-idx="${E}" value="${it}" step="0.01" style="width: 60px;" placeholder="speed">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasBounce" data-depth="${y}" data-idx="${E}" ${We}> Bounce</label>
								<div class="spawn-bounce-opts" data-depth="${y}" data-idx="${E}" style="display: ${We?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-bounceFactor" data-depth="${y}" data-idx="${E}" value="${nt}" step="0.1" style="width: 60px;" placeholder="factor">
									<input type="number" class="spawn-bounceCost" data-depth="${y}" data-idx="${E}" value="${at}" step="0.001" style="width: 60px;" placeholder="cost">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasKill" data-depth="${y}" data-idx="${E}" ${Ne}> Kill</label>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasCooldownAttack" data-depth="${y}" data-idx="${E}" ${Xe}> Cooldown Attack</label>
								<div class="spawn-cooldownattack-opts" data-depth="${y}" data-idx="${E}" style="display: ${Xe?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-cooldownAttackDamages" data-depth="${y}" data-idx="${E}" value="${dt}" step="0.1" style="width: 60px;" placeholder="damages">
									<input type="number" class="spawn-cooldownAttackDuration" data-depth="${y}" data-idx="${E}" value="${ct}" step="1" style="width: 60px;" placeholder="duration">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasContinuousAttack" data-depth="${y}" data-idx="${E}" ${Ue}> Continuous Attack</label>
								<div class="spawn-continuousattack-opts" data-depth="${y}" data-idx="${E}" style="display: ${Ue?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-continuousAttackDamages" data-depth="${y}" data-idx="${E}" value="${ut}" step="0.01" style="width: 60px;" placeholder="damages">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasHeal" data-depth="${y}" data-idx="${E}" ${ge}> Heal</label>
								<div class="spawn-heal-opts" data-depth="${y}" data-idx="${E}" style="display: ${ge?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-healHp" data-depth="${y}" data-idx="${E}" value="${be}" step="0.1" style="width: 60px;" placeholder="hp">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasRestoreJump" data-depth="${y}" data-idx="${E}" ${De}> Restore Jump</label>
								<div class="spawn-restorejump-opts" data-depth="${y}" data-idx="${E}" style="display: ${De?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-restoreJumpGain" data-depth="${y}" data-idx="${E}" value="${oe}" step="0.1" style="width: 60px;" placeholder="gain">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasTouchDespawn" data-depth="${y}" data-idx="${E}" ${Ee}> Touch Despawn</label>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasCouldownDespawn" data-depth="${y}" data-idx="${E}" ${Fe}> Cooldown Despawn</label>
								<div class="spawn-despawn-opts" data-depth="${y}" data-idx="${E}" style="display: ${Fe?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-despawnDuration" data-depth="${y}" data-idx="${E}" value="${rt}" step="10" style="width: 60px;" placeholder="duration">
								</div>
								
								<label style="display: block;"><input type="checkbox" class="spawn-hasGoal" data-depth="${y}" data-idx="${E}" ${ce}> Goal</label>
								<div class="spawn-goal-opts" data-depth="${y}" data-idx="${E}" style="display: ${ce?"block":"none"}; padding-left: 20px;">
									<input type="number" class="spawn-goalType" data-depth="${y}" data-idx="${E}" value="${pe}" step="1" style="width: 60px;" placeholder="type">
								</div>
								
								<!-- NESTED SPAWNER -->
								<label style="display: block; font-weight: bold; color: #6600cc;"><input type="checkbox" class="spawn-hasSpawner" data-depth="${y}" data-idx="${E}" ${Ye}> Spawner (nested)</label>
								<div class="spawn-spawner-opts" data-depth="${y}" data-idx="${E}" style="display: ${Ye?"block":"none"}; padding-left: 20px; border-left: 2px solid #6600cc; margin-top: 5px;">
									<label>Rythm: <input type="number" class="spawn-spawnerRythm" data-depth="${y}" data-idx="${E}" value="${lt}" step="1" style="width: 80px;"></label><br>
									<div class="spawn-spawner-blocks" data-depth="${y}" data-idx="${E}">
										${H.module?.spawner?d(H.module.spawner.blocks,y+1):""}
									</div>
									<button class="spawn-addNestedBlock" data-depth="${y}" data-idx="${E}" style="background: #6600cc; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Nested Block</button>
								</div>
							</div>
						</details>
					</div>
				`}),_}let r=[],h=n.module.bounce?"checked":"",w=n.module.bounce?"block":"none",f=n.module.bounce?.factor||1,v=n.module.bounce?.cost||.003;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modBounce" ${h}> Bounce
				</label>
				<div id="bounceOptions" style="display: ${w}; margin-top: 10px; padding-left: 20px;">
					<label>Factor: <input type="number" id="bounceFactor" value="${f}" step="0.1" style="width: 80px;"></label><br>
					<label>Cost: <input type="number" id="bounceCost" value="${v}" step="0.001" style="width: 80px;"></label>
				</div>
			</div>
		`);let T=n.module.kill?"checked":"";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modKill" ${T}> Kill
				</label>
			</div>
		`);let R=n.module.heal?"checked":"",S=n.module.heal?"block":"none",x=n.module.heal?.hp||2;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modHeal" ${R}> Heal
				</label>
				<div id="healOptions" style="display: ${S}; margin-top: 10px; padding-left: 20px;">
					<label>HP: <input type="number" id="healHp" value="${x}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let $=n.module.couldownedAttack?"checked":"",z=n.module.couldownedAttack?"block":"none",Y=n.module.couldownedAttack?.damages||1,V=n.module.couldownedAttack?.duration||100;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownAttack" ${$}> Cooldown Attack
				</label>
				<div id="cooldownAttackOptions" style="display: ${z}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="cooldownAttackDamages" value="${Y}" step="0.1" style="width: 80px;"></label><br>
					<label>Duration: <input type="number" id="cooldownAttackDuration" value="${V}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let J=n.module.continuousAttack?"checked":"",se=n.module.continuousAttack?"block":"none",$e=n.module.continuousAttack?.damages||.02;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modContinuousAttack" ${J}> Continuous Attack
				</label>
				<div id="continuousAttackOptions" style="display: ${se}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="continuousAttackDamages" value="${$e}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let Ce=n.module.restoreJump?"checked":"",Ie=n.module.restoreJump?"block":"none",tt=n.module.restoreJump?.gain||1;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRestoreJump" ${Ce}> Restore Jump
				</label>
				<div id="restoreJumpOptions" style="display: ${Ie}; margin-top: 10px; padding-left: 20px;">
					<label>Gain: <input type="number" id="restoreJumpGain" value="${tt}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let tn=n.module.goal!==void 0?"checked":"",sn=n.module.goal!==void 0?"block":"none",nn=n.module.goal?.type||1;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modGoal" ${tn}> Goal
				</label>
				<div id="goalOptions" style="display: ${sn}; margin-top: 10px; padding-left: 20px;">
					<label>Type: <input type="number" id="goalType" value="${nn}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let an=n.module.moving?"checked":"",on=n.module.moving?"block":"none",rn=n.module.moving?.times||-1,ln=n.module.moving?.patterns||[],Ut="";ln.forEach((A,y)=>{Ut+=`
				<div class="pattern-row" style="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;">
					<input type="number" class="pattern-dx" data-idx="${y}" value="${A.dx}" step="0.1" style="width: 60px;" placeholder="dx">
					<input type="number" class="pattern-dy" data-idx="${y}" value="${A.dy}" step="0.1" style="width: 60px;" placeholder="dy">
					<input type="number" class="pattern-duration" data-idx="${y}" value="${A.duration}" step="1" style="width: 60px;" placeholder="dur">
					<button class="pattern-remove" data-idx="${y}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
				</div>
			`}),r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modMoving" ${an}> Moving
				</label>
				<div id="movingOptions" style="display: ${on}; margin-top: 10px; padding-left: 20px;">
					<label>Times (-1 = infinite): <input type="number" id="movingTimes" value="${rn}" step="1" style="width: 100px;"></label><br>
					<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Patterns:</label>
					<div id="movingPatternsList">
						${Ut}
					</div>
					<button id="addPattern" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Pattern</button>
				</div>
			</div>
		`);let dn=n.module.speed?"checked":"",cn=n.module.speed?"block":"none",un=n.module.speed?.vx||0,pn=n.module.speed?.vy||0;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpeed" ${dn}> Speed
				</label>
				<div id="speedOptions" style="display: ${cn}; margin-top: 10px; padding-left: 20px;">
					<label>VX: <input type="number" id="speedVx" value="${un}" step="0.5" style="width: 80px;"></label><br>
					<label>VY: <input type="number" id="speedVy" value="${pn}" step="0.5" style="width: 80px;"></label>
				</div>
			</div>
		`);let hn=n.module.acceleration?"checked":"",mn=n.module.acceleration?"block":"none",fn=n.module.acceleration?.ax||0,yn=n.module.acceleration?.ay||0;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modAcceleration" ${hn}> Acceleration
				</label>
				<div id="accelerationOptions" style="display: ${mn}; margin-top: 10px; padding-left: 20px;">
					<label>AX: <input type="number" id="accelerationAx" value="${fn}" step="0.01" style="width: 80px;"></label><br>
					<label>AY: <input type="number" id="accelerationAy" value="${yn}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let wn=n.module.rotation?"checked":"",gn=n.module.rotation?"block":"none",bn=n.module.rotation?.start||0,vn=n.module.rotation?.speed||.01;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRotation" ${wn}> Rotation
				</label>
				<div id="rotationOptions" style="display: ${gn}; margin-top: 10px; padding-left: 20px;">
					<label>Start: <input type="number" id="rotationStart" value="${bn}" step="0.1" style="width: 80px;"></label><br>
					<label>Speed: <input type="number" id="rotationSpeed" value="${vn}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let xn=n.module.spawner?"checked":"",kn=n.module.spawner?"block":"none",Tn=n.module.spawner?.rythm||60,Mn=n.module.spawner?.blocks||[];r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpawner" ${xn}> Spawner
				</label>
				<div id="spawnerOptions" style="display: ${kn}; margin-top: 10px; padding-left: 20px;">
					<label>Rythm (frames): <input type="number" id="spawnerRythm" value="${Tn}" step="1" style="width: 100px;"></label><br>
					<label style="display: block; margin-top: 10px; margin-bottom: 5px; font-weight: bold;">Blocks to spawn:</label>
					<div id="spawnerBlocksList" data-depth="0">
						${d(Mn,0)}
					</div>
					<button id="addSpawnerBlock" style="background: green; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Block</button>
				</div>
			</div>
		`);let Rn=n.module.touchDespawn?"checked":"";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modTouchDespawn" ${Rn}> Touch Despawn
				</label>
			</div>
		`);let Sn=n.module.couldownDespawn?"checked":"",$n=n.module.couldownDespawn?"block":"none",Cn=n.module.couldownDespawn?.duration||100;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownDespawn" ${Sn}> Cooldown Despawn
				</label>
				<div id="cooldownDespawnOptions" style="display: ${$n}; margin-top: 10px; padding-left: 20px;">
					<label>Duration: <input type="number" id="cooldownDespawnDuration" value="${Cn}" step="10" style="width: 80px;"></label>
				</div>
			</div>
		`),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px; max-height: 80vh; overflow-y: auto;">
				<h3>Block Properties</h3>
				<button id="deleteBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Block (Suppr)</button>
				<div>
					<label>X: <input type="number" id="blockX" value="${n.x}" step="${u}"></label><br>
					<label>Y: <input type="number" id="blockY" value="${n.y}" step="${u}"></label><br>
					<label>Width: <input type="number" id="blockW" value="${n.w}" step="${u}" min="${u}"></label><br>
					<label>Height: <input type="number" id="blockH" value="${n.h}" step="${u}" min="${u}"></label><br>
				</div>
				<div style="margin-top: 20px;">
					<h4>Modules</h4>
					${r.join("")}
				</div>
			</div>
		`,document.getElementById("deleteBtn").addEventListener("click",()=>{let A=Re(n);if(A){let y=A.blocks.indexOf(n);y>=0&&A.blocks.splice(y,1)}ye()});let Oe=()=>{let A=parseFloat(document.getElementById("blockX").value),y=parseFloat(document.getElementById("blockY").value),_=parseFloat(document.getElementById("blockW").value),K=parseFloat(document.getElementById("blockH").value);n.x=I(A),n.y=I(y),n.w=Math.max(u,I(_)),n.h=Math.max(u,I(K))},In=()=>{document.getElementById("blockX").value=n.x.toString(),document.getElementById("blockY").value=n.y.toString(),document.getElementById("blockW").value=n.w.toString(),document.getElementById("blockH").value=n.h.toString()};document.getElementById("blockX").addEventListener("change",Oe),document.getElementById("blockY").addEventListener("change",Oe),document.getElementById("blockW").addEventListener("change",Oe),document.getElementById("blockH").addEventListener("change",Oe);let Z=()=>{let A=document.getElementById("modBounce").checked,y=document.getElementById("modKill").checked,_=document.getElementById("modHeal").checked,K=document.getElementById("modCooldownAttack").checked,H=document.getElementById("modContinuousAttack").checked,E=document.getElementById("modRestoreJump").checked,le=document.getElementById("modGoal").checked,j=document.getElementById("modMoving").checked,de=document.getElementById("modSpeed").checked,ne=document.getElementById("modAcceleration").checked,B=document.getElementById("modRotation").checked,N=document.getElementById("modSpawner").checked,ae=document.getElementById("modTouchDespawn").checked,Ne=document.getElementById("modCooldownDespawn").checked,We=A?parseFloat(document.getElementById("bounceFactor").value):1,nt=A?parseFloat(document.getElementById("bounceCost").value):.003,at=_?parseFloat(document.getElementById("healHp").value):2,_e=K?parseFloat(document.getElementById("cooldownAttackDamages").value):1,ot=K?parseInt(document.getElementById("cooldownAttackDuration").value):100,it=H?parseFloat(document.getElementById("continuousAttackDamages").value):.02,Fe=E?parseFloat(document.getElementById("restoreJumpGain").value):1,rt=le?parseInt(document.getElementById("goalType").value):1,Ye=de?parseFloat(document.getElementById("speedVx").value):0,lt=de?parseFloat(document.getElementById("speedVy").value):0,Xe=ne?parseFloat(document.getElementById("accelerationAx").value):0,dt=ne?parseFloat(document.getElementById("accelerationAy").value):0,ct=B?parseFloat(document.getElementById("rotationStart").value):0,Ue=B?parseFloat(document.getElementById("rotationSpeed").value):.01,ut=Ne?parseInt(document.getElementById("cooldownDespawnDuration").value):100,ge;if(j)try{let oe=parseInt(document.getElementById("movingTimes").value),Ee=document.querySelectorAll(".pattern-row"),ce=[];Ee.forEach(pe=>{let ve=parseFloat(pe.querySelector(".pattern-dx").value),Ge=parseFloat(pe.querySelector(".pattern-dy").value),Gt=parseInt(pe.querySelector(".pattern-duration").value);ce.push(new fa(ve,Ge,Gt))}),ce.length>0&&(ge=new ya(ce,oe))}catch(oe){console.error("Error parsing moving patterns:",oe),ge=n.module.moving}let be;if(N)try{let oe=document.getElementById("spawnerRythm");if(!oe)be=n.module.spawner;else{let ce=function(ve){let Ge=[];return ve.querySelectorAll(":scope > .spawner-block").forEach(W=>{let Ve=W.querySelector(".spawn-dx"),Vt=W.querySelector(".spawn-dy"),zt=W.querySelector(".spawn-w"),qt=W.querySelector(".spawn-h");if(!Ve||!Vt||!zt||!qt)return;let X=Ve.getAttribute("data-depth"),U=Ve.getAttribute("data-idx"),Bn=parseFloat(Ve.value),Hn=parseFloat(Vt.value),Ln=parseFloat(zt.value),Pn=parseFloat(qt.value),On=W.querySelector(`.spawn-hasSpeed[data-depth="${X}"][data-idx="${U}"]`),Nn=W.querySelector(`.spawn-hasAcceleration[data-depth="${X}"][data-idx="${U}"]`),Wn=W.querySelector(`.spawn-hasRotation[data-depth="${X}"][data-idx="${U}"]`),_n=W.querySelector(`.spawn-hasBounce[data-depth="${X}"][data-idx="${U}"]`),Fn=W.querySelector(`.spawn-hasKill[data-depth="${X}"][data-idx="${U}"]`),Yn=W.querySelector(`.spawn-hasCouldownDespawn[data-depth="${X}"][data-idx="${U}"]`),Xn=W.querySelector(`.spawn-hasSpawner[data-depth="${X}"][data-idx="${U}"]`),Un=W.querySelector(`.spawn-hasCooldownAttack[data-depth="${X}"][data-idx="${U}"]`),Gn=W.querySelector(`.spawn-hasContinuousAttack[data-depth="${X}"][data-idx="${U}"]`),Vn=W.querySelector(`.spawn-hasHeal[data-depth="${X}"][data-idx="${U}"]`),zn=W.querySelector(`.spawn-hasRestoreJump[data-depth="${X}"][data-idx="${U}"]`),qn=W.querySelector(`.spawn-hasTouchDespawn[data-depth="${X}"][data-idx="${U}"]`),Jn=W.querySelector(`.spawn-hasGoal[data-depth="${X}"][data-idx="${U}"]`),Jt=On?.checked||!1,Kt=Nn?.checked||!1,jt=Wn?.checked||!1,Zt=_n?.checked||!1,Qt=Fn?.checked||!1,es=Yn?.checked||!1,ts=Xn?.checked||!1,ss=Un?.checked||!1,ns=Gn?.checked||!1,as=Vn?.checked||!1,os=zn?.checked||!1,is=qn?.checked||!1,rs=Jn?.checked||!1,ls;if(Jt||Kt||jt||Zt||Qt||es||ts||ss||ns||as||os||is||rs){let ds=W.querySelector(`.spawn-speedVx[data-depth="${X}"][data-idx="${U}"]`),cs=W.querySelector(`.spawn-speedVy[data-depth="${X}"][data-idx="${U}"]`),us=W.querySelector(`.spawn-accelAx[data-depth="${X}"][data-idx="${U}"]`),ps=W.querySelector(`.spawn-accelAy[data-depth="${X}"][data-idx="${U}"]`),hs=W.querySelector(`.spawn-rotationStart[data-depth="${X}"][data-idx="${U}"]`),ms=W.querySelector(`.spawn-rotationSpeed[data-depth="${X}"][data-idx="${U}"]`),fs=W.querySelector(`.spawn-bounceFactor[data-depth="${X}"][data-idx="${U}"]`),ys=W.querySelector(`.spawn-bounceCost[data-depth="${X}"][data-idx="${U}"]`),ws=W.querySelector(`.spawn-despawnDuration[data-depth="${X}"][data-idx="${U}"]`),gs=W.querySelector(`.spawn-cooldownAttackDamages[data-depth="${X}"][data-idx="${U}"]`),bs=W.querySelector(`.spawn-cooldownAttackDuration[data-depth="${X}"][data-idx="${U}"]`),vs=W.querySelector(`.spawn-continuousAttackDamages[data-depth="${X}"][data-idx="${U}"]`),xs=W.querySelector(`.spawn-healHp[data-depth="${X}"][data-idx="${U}"]`),ks=W.querySelector(`.spawn-restoreJumpGain[data-depth="${X}"][data-idx="${U}"]`),Ts=W.querySelector(`.spawn-goalType[data-depth="${X}"][data-idx="${U}"]`),Ms;if(ts){let Rs=W.querySelector(`.spawn-spawnerRythm[data-depth="${X}"][data-idx="${U}"]`),Ss=W.querySelector(`.spawn-spawner-blocks[data-depth="${X}"][data-idx="${U}"]`);if(Rs&&Ss){let Kn=parseInt(Rs.value),$s=ce(Ss);$s.length>0&&(Ms=new Vs(Kn,!1,$s))}}ls=new ue({speed:Jt&&ds&&cs?new Ys(parseFloat(ds.value),parseFloat(cs.value)):void 0,acceleration:Kt&&us&&ps?new Xs(parseFloat(us.value),parseFloat(ps.value)):void 0,rotation:jt&&hs&&ms?new Gs(parseFloat(hs.value),parseFloat(ms.value)):void 0,bounce:Zt&&fs&&ys?new Os(parseFloat(fs.value),parseFloat(ys.value)):void 0,kill:Qt?new Ns:void 0,couldownDespawn:es&&ws?new Ws(parseInt(ws.value)):void 0,couldownedAttack:ss&&gs&&bs?new Ls(parseFloat(gs.value),parseInt(bs.value)):void 0,continuousAttack:ns&&vs?new Ps(parseFloat(vs.value)):void 0,heal:as&&xs?new Fs(parseFloat(xs.value)):void 0,restoreJump:os&&ks?new Us(parseFloat(ks.value)):void 0,touchDespawn:is?new _s:void 0,goal:rs&&Ts?parseInt(Ts.value):void 0,spawner:Ms})}Ge.push(new ke(ls,{dx:Bn,dy:Hn,w:Ln,h:Pn}))}),Ge},Ee=parseInt(oe.value),pe=document.getElementById("spawnerBlocksList");if(pe){let ve=ce(pe);ve.length>0&&(be=new Vs(Ee,!1,ve))}}}catch(oe){console.error("Error parsing spawner blocks:",oe),be=n.module.spawner}let De=new ue({bounce:A?new Os(We,nt):void 0,kill:y?new Ns:void 0,heal:_?new Fs(at):void 0,couldownedAttack:K?new Ls(_e,ot):void 0,continuousAttack:H?new Ps(it):void 0,restoreJump:E?new Us(Fe):void 0,goal:le?rt:void 0,moving:ge,speed:de?new Ys(Ye,lt):void 0,acceleration:ne?new Xs(Xe,dt):void 0,rotation:B?new Gs(ct,Ue):void 0,spawner:be,touchDespawn:ae?new _s:void 0,couldownDespawn:Ne?new Ws(ut):void 0});n.module=De,n.drawMode=De.getDrawModule(0),n.drawMode&&(n.drawAnimator=n.drawMode.generateAnimator(n))},Q=(A,y)=>{let _=document.getElementById(A),K=document.getElementById(y);_&&K?_.addEventListener("change",()=>{K.style.display=_.checked?"block":"none",Z()}):_&&_.addEventListener("change",Z)};Q("modBounce","bounceOptions"),Q("modHeal","healOptions"),Q("modCooldownAttack","cooldownAttackOptions"),Q("modContinuousAttack","continuousAttackOptions"),Q("modRestoreJump","restoreJumpOptions"),Q("modGoal","goalOptions"),Q("modMoving","movingOptions"),Q("modSpeed","speedOptions"),Q("modAcceleration","accelerationOptions"),Q("modRotation","rotationOptions"),Q("modSpawner","spawnerOptions"),Q("modCooldownDespawn","cooldownDespawnOptions"),Q("modKill",""),Q("modTouchDespawn","");let Dn=["bounceFactor","bounceCost","healHp","cooldownAttackDamages","cooldownAttackDuration","continuousAttackDamages","restoreJumpGain","goalType","speedVx","speedVy","accelerationAx","accelerationAy","rotationStart","rotationSpeed","cooldownDespawnDuration"];for(let A of Dn){let y=document.getElementById(A);y&&y.addEventListener("change",Z)}document.getElementById("addPattern")?.addEventListener("click",()=>{let A=document.getElementById("movingPatternsList"),y=A.children.length,_=document.createElement("div");_.className="pattern-row",_.style.cssText="display: flex; gap: 5px; margin-bottom: 5px; align-items: center;",_.innerHTML=`
				<input type="number" class="pattern-dx" data-idx="${y}" value="0" step="0.1" style="width: 60px;" placeholder="dx">
				<input type="number" class="pattern-dy" data-idx="${y}" value="0" step="0.1" style="width: 60px;" placeholder="dy">
				<input type="number" class="pattern-duration" data-idx="${y}" value="100" step="1" style="width: 60px;" placeholder="dur">
				<button class="pattern-remove" data-idx="${y}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
			`,A.appendChild(_),_.querySelectorAll("input").forEach(K=>{K.addEventListener("change",Z)}),_.querySelector(".pattern-remove")?.addEventListener("click",K=>{_.remove(),Z()})}),document.querySelectorAll(".pattern-dx, .pattern-dy, .pattern-duration").forEach(A=>{A.addEventListener("change",Z)}),document.querySelectorAll(".pattern-remove").forEach(A=>{A.addEventListener("click",y=>{y.target.closest(".pattern-row")?.remove(),Z()})});let En=["movingTimes"];for(let A of En){let y=document.getElementById(A);y&&y.addEventListener("change",Z)}let An=["spawnerRythm"];for(let A of An){let y=document.getElementById(A);y&&y.addEventListener("change",Z)}function st(A){A.querySelectorAll("input[type='number']:not([type='checkbox'])").forEach(E=>{E.addEventListener("change",Z)}),A.querySelector(".spawn-remove")?.addEventListener("click",()=>{A.remove(),Z()});let y=(E,le)=>{let j=A.querySelector(`.${E}`);if(!j)return;let de=j.getAttribute("data-depth"),ne=j.getAttribute("data-idx"),B=A.querySelector(`.${le}[data-depth="${de}"][data-idx="${ne}"]`);j&&B?j.addEventListener("change",()=>{B.style.display=j.checked?"block":"none",Z()}):j&&j.addEventListener("change",Z)};y("spawn-hasSpeed","spawn-speed-opts"),y("spawn-hasAcceleration","spawn-accel-opts"),y("spawn-hasRotation","spawn-rotation-opts"),y("spawn-hasBounce","spawn-bounce-opts"),y("spawn-hasCouldownDespawn","spawn-despawn-opts"),y("spawn-hasSpawner","spawn-spawner-opts"),y("spawn-hasCooldownAttack","spawn-cooldownattack-opts"),y("spawn-hasContinuousAttack","spawn-continuousattack-opts"),y("spawn-hasHeal","spawn-heal-opts"),y("spawn-hasRestoreJump","spawn-restorejump-opts"),y("spawn-hasGoal","spawn-goal-opts");let _=A.querySelector(".spawn-hasKill");_&&_.addEventListener("change",Z);let K=A.querySelector(".spawn-hasTouchDespawn");K&&K.addEventListener("change",Z);let H=A.querySelector(".spawn-addNestedBlock");H&&H.addEventListener("click",E=>{E.stopPropagation();let le=E.target,j=parseInt(le.getAttribute("data-depth")||"0"),de=le.getAttribute("data-idx"),ne=A.querySelector(`.spawn-spawner-blocks[data-depth="${j}"][data-idx="${de}"]`);if(ne){let B=j+1,N=ne.children.length,ae=document.createElement("div");ae.className="spawner-block",ae.setAttribute("data-depth",B.toString()),ae.setAttribute("data-idx",N.toString()),ae.style.cssText=`border: 1px solid #999; padding: 10px; margin-left: ${B*20}px; margin-bottom: 10px; border-radius: 5px; background: ${B%2===0?"#f9f9f9":"#efefef"};`,ae.innerHTML=`
							<div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
								<input type="number" class="spawn-dx" data-depth="${B}" data-idx="${N}" value="0" step="1" style="width: 60px;" placeholder="dx">
								<input type="number" class="spawn-dy" data-depth="${B}" data-idx="${N}" value="0" step="1" style="width: 60px;" placeholder="dy">
								<input type="number" class="spawn-w" data-depth="${B}" data-idx="${N}" value="${u*2}" step="1" style="width: 60px;" placeholder="w">
								<input type="number" class="spawn-h" data-depth="${B}" data-idx="${N}" value="${u*2}" step="1" style="width: 60px;" placeholder="h">
								<button class="spawn-remove" data-depth="${B}" data-idx="${N}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
							</div>
							
							<details>
								<summary style="cursor: pointer; font-weight: bold; margin: 5px 0;">Module Options</summary>
								<div style="padding-left: 10px; margin-top: 5px;">
									<label style="display: block;"><input type="checkbox" class="spawn-hasSpeed" data-depth="${B}" data-idx="${N}"> Speed</label>
									<div class="spawn-speed-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px;">
										<input type="number" class="spawn-speedVx" data-depth="${B}" data-idx="${N}" value="0" step="0.5" style="width: 60px;" placeholder="vx">
										<input type="number" class="spawn-speedVy" data-depth="${B}" data-idx="${N}" value="0" step="0.5" style="width: 60px;" placeholder="vy">
									</div>
									
									<label style="display: block;"><input type="checkbox" class="spawn-hasAcceleration" data-depth="${B}" data-idx="${N}"> Acceleration</label>
									<div class="spawn-accel-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px;">
										<input type="number" class="spawn-accelAx" data-depth="${B}" data-idx="${N}" value="0" step="0.01" style="width: 60px;" placeholder="ax">
										<input type="number" class="spawn-accelAy" data-depth="${B}" data-idx="${N}" value="0" step="0.01" style="width: 60px;" placeholder="ay">
									</div>
									
									<label style="display: block;"><input type="checkbox" class="spawn-hasRotation" data-depth="${B}" data-idx="${N}"> Rotation</label>
									<div class="spawn-rotation-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px;">
										<input type="number" class="spawn-rotationStart" data-depth="${B}" data-idx="${N}" value="0" step="0.1" style="width: 60px;" placeholder="start">
										<input type="number" class="spawn-rotationSpeed" data-depth="${B}" data-idx="${N}" value="0.01" step="0.01" style="width: 60px;" placeholder="speed">
									</div>
									
									<label style="display: block;"><input type="checkbox" class="spawn-hasBounce" data-depth="${B}" data-idx="${N}"> Bounce</label>
									<div class="spawn-bounce-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px;">
										<input type="number" class="spawn-bounceFactor" data-depth="${B}" data-idx="${N}" value="1" step="0.1" style="width: 60px;" placeholder="factor">
										<input type="number" class="spawn-bounceCost" data-depth="${B}" data-idx="${N}" value="0.003" step="0.001" style="width: 60px;" placeholder="cost">
									</div>
									
									<label style="display: block;"><input type="checkbox" class="spawn-hasKill" data-depth="${B}" data-idx="${N}"> Kill</label>
									
									<label style="display: block;"><input type="checkbox" class="spawn-hasCouldownDespawn" data-depth="${B}" data-idx="${N}"> Cooldown Despawn</label>
									<div class="spawn-despawn-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px;">
										<input type="number" class="spawn-despawnDuration" data-depth="${B}" data-idx="${N}" value="100" step="10" style="width: 60px;" placeholder="duration">
									</div>
									
									<label style="display: block; font-weight: bold; color: #6600cc;"><input type="checkbox" class="spawn-hasSpawner" data-depth="${B}" data-idx="${N}"> Spawner (nested)</label>
									<div class="spawn-spawner-opts" data-depth="${B}" data-idx="${N}" style="display: none; padding-left: 20px; border-left: 2px solid #6600cc; margin-top: 5px;">
										<label>Rythm: <input type="number" class="spawn-spawnerRythm" data-depth="${B}" data-idx="${N}" value="60" step="1" style="width: 80px;"></label><br>
										<div class="spawn-spawner-blocks" data-depth="${B}" data-idx="${N}"></div>
										<button class="spawn-addNestedBlock" data-depth="${B}" data-idx="${N}" style="background: #6600cc; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Nested Block</button>
									</div>
								</div>
							</details>
						`,ne.appendChild(ae),st(ae)}})}document.getElementById("addSpawnerBlock")?.addEventListener("click",()=>{let A=document.getElementById("spawnerBlocksList"),y=A.querySelectorAll(":scope > .spawner-block").length,_=document.createElement("div");_.className="spawner-block",_.setAttribute("data-depth","0"),_.setAttribute("data-idx",y.toString()),_.style.cssText="border: 1px solid #999; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #f9f9f9;",_.innerHTML=`
				<div style="display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap;">
					<input type="number" class="spawn-dx" data-depth="0" data-idx="${y}" value="0" step="1" style="width: 60px;" placeholder="dx">
					<input type="number" class="spawn-dy" data-depth="0" data-idx="${y}" value="0" step="1" style="width: 60px;" placeholder="dy">
					<input type="number" class="spawn-w" data-depth="0" data-idx="${y}" value="${u*2}" step="1" style="width: 60px;" placeholder="w">
					<input type="number" class="spawn-h" data-depth="0" data-idx="${y}" value="${u*2}" step="1" style="width: 60px;" placeholder="h">
					<button class="spawn-remove" data-depth="0" data-idx="${y}" style="background: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px;">\u2715</button>
				</div>
				
				<details>
					<summary style="cursor: pointer; font-weight: bold; margin: 5px 0;">Module Options</summary>
					<div style="padding-left: 10px; margin-top: 5px;">
						<label style="display: block;"><input type="checkbox" class="spawn-hasSpeed" data-depth="0" data-idx="${y}"> Speed</label>
						<div class="spawn-speed-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-speedVx" data-depth="0" data-idx="${y}" value="0" step="0.5" style="width: 60px;" placeholder="vx">
							<input type="number" class="spawn-speedVy" data-depth="0" data-idx="${y}" value="0" step="0.5" style="width: 60px;" placeholder="vy">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasAcceleration" data-depth="0" data-idx="${y}"> Acceleration</label>
						<div class="spawn-accel-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-accelAx" data-depth="0" data-idx="${y}" value="0" step="0.01" style="width: 60px;" placeholder="ax">
							<input type="number" class="spawn-accelAy" data-depth="0" data-idx="${y}" value="0" step="0.01" style="width: 60px;" placeholder="ay">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasRotation" data-depth="0" data-idx="${y}"> Rotation</label>
						<div class="spawn-rotation-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-rotationStart" data-depth="0" data-idx="${y}" value="0" step="0.1" style="width: 60px;" placeholder="start">
							<input type="number" class="spawn-rotationSpeed" data-depth="0" data-idx="${y}" value="0.01" step="0.01" style="width: 60px;" placeholder="speed">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasBounce" data-depth="0" data-idx="${y}"> Bounce</label>
						<div class="spawn-bounce-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-bounceFactor" data-depth="0" data-idx="${y}" value="1" step="0.1" style="width: 60px;" placeholder="factor">
							<input type="number" class="spawn-bounceCost" data-depth="0" data-idx="${y}" value="0.003" step="0.001" style="width: 60px;" placeholder="cost">
						</div>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasKill" data-depth="0" data-idx="${y}"> Kill</label>
						
						<label style="display: block;"><input type="checkbox" class="spawn-hasCouldownDespawn" data-depth="0" data-idx="${y}"> Cooldown Despawn</label>
						<div class="spawn-despawn-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px;">
							<input type="number" class="spawn-despawnDuration" data-depth="0" data-idx="${y}" value="100" step="10" style="width: 60px;" placeholder="duration">
						</div>
						
						<label style="display: block; font-weight: bold; color: #6600cc;"><input type="checkbox" class="spawn-hasSpawner" data-depth="0" data-idx="${y}"> Spawner (nested)</label>
						<div class="spawn-spawner-opts" data-depth="0" data-idx="${y}" style="display: none; padding-left: 20px; border-left: 2px solid #6600cc; margin-top: 5px;">
							<label>Rythm: <input type="number" class="spawn-spawnerRythm" data-depth="0" data-idx="${y}" value="60" step="1" style="width: 80px;"></label><br>
							<div class="spawn-spawner-blocks" data-depth="0" data-idx="${y}"></div>
							<button class="spawn-addNestedBlock" data-depth="0" data-idx="${y}" style="background: #6600cc; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; margin-top: 5px;">+ Add Nested Block</button>
						</div>
					</div>
				</details>
			`,A.appendChild(_),st(_)}),document.querySelectorAll(".spawner-block").forEach(st),n._updateDisplay=In}function Ft(n){t.classList.remove("hidden"),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px;">
				<h3>Room Properties</h3>
				<button id="deleteRoomBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Room (Suppr)</button>
				<div>
					<label>X: <input type="number" id="roomX" value="${n.x}" step="${u}"></label><br>
					<label>Y: <input type="number" id="roomY" value="${n.y}" step="${u}"></label><br>
					<label>Width: <input type="number" id="roomW" value="${n.w}" step="${u}" min="${u*4}"></label><br>
					<label>Height: <input type="number" id="roomH" value="${n.h}" step="${u}" min="${u*4}"></label><br>
				</div>
			</div>
		`,document.getElementById("deleteRoomBtn").addEventListener("click",()=>{let w=D[0],f=w.rooms.indexOf(n);f>=0&&w.rooms.splice(f,1),ye()});let r=()=>{let w=parseFloat(document.getElementById("roomX").value),f=parseFloat(document.getElementById("roomY").value),v=parseFloat(document.getElementById("roomW").value),T=parseFloat(document.getElementById("roomH").value);n.x=I(w),n.y=I(f),n.w=Math.max(u*4,I(v)),n.h=Math.max(u*4,I(T))},h=()=>{document.getElementById("roomX").value=n.x.toString(),document.getElementById("roomY").value=n.y.toString(),document.getElementById("roomW").value=n.w.toString(),document.getElementById("roomH").value=n.h.toString()};document.getElementById("roomX").addEventListener("change",r),document.getElementById("roomY").addEventListener("change",r),document.getElementById("roomW").addEventListener("change",r),document.getElementById("roomH").addEventListener("change",r),n._updateDisplay=h}t.addEventListener("mousedown",n=>{n.stopPropagation()}),t.addEventListener("click",n=>{n.stopPropagation()}),t.addEventListener("wheel",n=>{n.stopPropagation()}),t.addEventListener("pointerdown",n=>{n.stopPropagation()}),t.addEventListener("pointermove",n=>{n.stopPropagation()}),t.addEventListener("pointerup",n=>{n.stopPropagation()}),document.addEventListener("mousedown",n=>{let d=q(n.clientX,n.clientY);if(m.down=!0,m.button=n.button,m.sx=n.clientX,m.sy=n.clientY,m.wx=I(d.x),m.wy=I(d.y),p!=="play"){if(n.button===1){M=!0,C.x=n.clientX,C.y=n.clientY,n.preventDefault();return}if(n.button===2&&p==="default"){if(n.preventDefault(),o.length>0){let r=Pe(d.x,d.y);if(r&&o.includes(r)){a.active=!0,a.type="multi-select-move",a.startMouseX=d.x,a.startMouseY=d.y;return}}a.active=!0,a.type="multi-select",a.createStartX=d.x,a.createStartY=d.y;return}if(n.button===0){if(p==="default"){if(o.length>0){let h=Pe(d.x,d.y);if(h&&o.includes(h)){a.active=!0,a.type="multi-select-move",a.startMouseX=d.x,a.startMouseY=d.y;return}else o=[]}let r=Pe(d.x,d.y);if(r){let h=Pt(r,d.x,d.y);if(h){a.active=!0,a.type="resize-block",a.target=r,a.resizeEdge=h,a.startMouseX=d.x,a.startMouseY=d.y,a.startTargetX=r.x,a.startTargetY=r.y,a.startTargetW=r.w,a.startTargetH=r.h;return}a.active=!0,a.type="block",a.target=r,a.startMouseX=d.x,a.startMouseY=d.y,a.startTargetX=r.x,a.startTargetY=r.y,k=r,_t(r);return}a.active=!0,a.type="create-block",a.createStartX=I(d.x),a.createStartY=I(d.y)}else if(p==="rooms"){let r=fe(d.x,d.y);if(r){let h=Ot(r,d.x,d.y);if(h){a.active=!0,a.type="resize-room",a.target=r,a.resizeEdge=h,a.startMouseX=d.x,a.startMouseY=d.y,a.startTargetX=r.x,a.startTargetY=r.y,a.startTargetW=r.w,a.startTargetH=r.h;return}a.active=!0,a.type="room",a.target=r,a.startMouseX=d.x,a.startMouseY=d.y,a.startTargetX=r.x,a.startTargetY=r.y,k=r,Ft(r);return}a.active=!0,a.type="create-room",a.createStartX=I(d.x),a.createStartY=I(d.y)}}}}),document.addEventListener("mouseup",n=>{if(m.down=!1,n.button===1&&(M=!1),n.button===2&&a.active){if(a.type==="multi-select-move"){a.active=!1,a.type=null;return}if(a.type==="multi-select"){let d=q(n.clientX,n.clientY),r=Math.min(a.createStartX,d.x),h=Math.min(a.createStartY,d.y),w=Math.max(a.createStartX,d.x),f=Math.max(a.createStartY,d.y);o=[];let v=D[0];for(let T of v.rooms)for(let R of T.blocks){let S=R.x-R.w/2,x=R.x+R.w/2,$=R.y-R.h/2,z=R.y+R.h/2,Y=!(x<=r||S>=w),V=!(z<=h||$>=f);Y&&V&&o.push(R)}a.active=!1,a.type=null,o.length>0&&ye();return}}if(n.button===0&&a.active){let d=q(n.clientX,n.clientY);if(a.type==="multi-select-move"){a.active=!1,a.type=null;return}if(a.type==="create-block"){let r=Math.min(a.createStartX,I(d.x)),h=Math.min(a.createStartY,I(d.y)),w=Math.max(a.createStartX,I(d.x))+u,f=Math.max(a.createStartY,I(d.y))+u,v=w-r,T=f-h;if(v>=u&&T>=u){let R=r+v/2,S=h+T/2,x=new te(R,S,v,T,new ue({})),$=fe(x.x,x.y);if($){let z=D[0],Y=!0;for(let V of z.rooms){for(let J of V.blocks){let se=Math.abs(x.x-J.x),$e=Math.abs(x.y-J.y),Ce=(x.w+J.w)/2,Ie=(x.h+J.h)/2;if(se<Ce&&$e<Ie){Y=!1;break}}if(!Y)break}Y&&($.blocks.push(x),k=x,_t(x))}}}else if(a.type==="create-room"){let r=Math.min(a.createStartX,I(d.x)),h=Math.min(a.createStartY,I(d.y)),w=Math.max(a.createStartX,I(d.x))+u,f=Math.max(a.createStartY,I(d.y))+u,v=w-r,T=f-h;if(v>=u*4&&T>=u*4){let R=new ie(r,h,v,T,[]),S=D[0],x=!0;for(let $ of S.rooms){let z=!(R.x+R.w<=$.x||R.x>=$.x+$.w),Y=!(R.y+R.h<=$.y||R.y>=$.y+$.h);if(z&&Y){x=!1;break}}x&&(S.rooms.push(R),k=R,Ft(R))}}a.active=!1,a.type=null,a.target=null}}),document.addEventListener("mousemove",n=>{let d=q(n.clientX,n.clientY);if(m.sx=n.clientX,m.sy=n.clientY,m.wx=I(d.x),m.wy=I(d.y),p!=="play"&&!a.active&&!M){let r="default";if(p==="default"){let h=Pe(d.x,d.y);if(h){let w=Pt(h,d.x,d.y);r=w?Nt(w):"move"}}else if(p==="rooms"){let h=fe(d.x,d.y);if(h){let w=Ot(h,d.x,d.y);r=w?Nt(w):"move"}}r!==O&&(O=r,i.style.cursor=r)}else M&&(i.style.cursor="grabbing");if(M){let r=(n.clientX-C.x)/l.zoom,h=(n.clientY-C.y)/l.zoom;l.x-=r,l.y-=h,C.x=n.clientX,C.y=n.clientY}if(a.active&&(a.type==="multi-select-move"||a.type==="multi-select"&&o.length>0&&m.button===0)&&o.length>0){let r=I(d.x)-I(a.startMouseX),h=I(d.y)-I(a.startMouseY);if(r===0&&h===0)return;qs(o,r,h)&&(Js(o,r,h),a.startMouseX=I(d.x),a.startMouseY=I(d.y))}else if(a.active&&a.type==="block"&&a.target){let r=a.target,h=I(d.x)-I(a.startMouseX),w=I(d.y)-I(a.startMouseY),f=a.startTargetX+h,v=a.startTargetY+w,T=D[0],R=!0;for(let x of T.rooms){for(let $ of x.blocks){if($===r)continue;let z=Math.abs(f-$.x),Y=Math.abs(v-$.y),V=(r.w+$.w)/2,J=(r.h+$.h)/2;if(z<V&&Y<J){R=!1;break}}if(!R)break}let S=fe(f,v);(!S||!Se({x:f,y:v,w:r.w,h:r.h},S))&&(R=!1),R&&(S&&Re(r)!==S&&Wt(r,S),r.x=f,r.y=v,r._updateDisplay&&r._updateDisplay())}else if(a.active&&a.type==="room"&&a.target){let r=a.target,h=I(d.x)-I(a.startMouseX),w=I(d.y)-I(a.startMouseY),f=a.startTargetX+h,v=a.startTargetY+w,T=D[0],R=!0;for(let S of T.rooms){if(S===r)continue;let x=!(f+r.w<=S.x||f>=S.x+S.w),$=!(v+r.h<=S.y||v>=S.y+S.h);if(x&&$){R=!1;break}}if(R){let S=f-r.x,x=v-r.y;for(let $ of r.blocks)$.x+=S,$.y+=x;r.x=f,r.y=v,r._updateDisplay&&r._updateDisplay()}}else if(a.active&&a.type==="resize-block"&&a.target){let r=a.target,h=I(d.x)-I(a.startMouseX),w=I(d.y)-I(a.startMouseY),f=a.resizeEdge,v=u,T=n.shiftKey,R=a.startTargetX,S=a.startTargetY,x=a.startTargetW,$=a.startTargetH;if(T){let J=a.startTargetW/a.startTargetH;f.includes("left")||f.includes("right")?(x=f.includes("left")?a.startTargetW-h:a.startTargetW+h,x>=v?($=x/J,$>=v?(f.includes("left"),R=a.startTargetX+h/2,f.includes("top")?S=a.startTargetY+(a.startTargetH-$)/2:f.includes("bottom")&&(S=a.startTargetY-(a.startTargetH-$)/2)):(x=a.startTargetW,$=a.startTargetH)):(x=a.startTargetW,$=a.startTargetH)):($=f.includes("top")?a.startTargetH-w:a.startTargetH+w,$>=v?(x=$*J,x>=v?(f.includes("top"),S=a.startTargetY+w/2,f.includes("left")?R=a.startTargetX+(a.startTargetW-x)/2:f.includes("right")&&(R=a.startTargetX-(a.startTargetW-x)/2)):(x=a.startTargetW,$=a.startTargetH)):(x=a.startTargetW,$=a.startTargetH))}else f.includes("left")&&(x=a.startTargetW-h,x>=v?R=a.startTargetX+h/2:x=a.startTargetW),f.includes("right")&&(x=a.startTargetW+h,x>=v?R=a.startTargetX+h/2:x=a.startTargetW),f.includes("top")&&($=a.startTargetH-w,$>=v?S=a.startTargetY+w/2:$=a.startTargetH),f.includes("bottom")&&($=a.startTargetH+w,$>=v?S=a.startTargetY+w/2:$=a.startTargetH);let z=D[0],Y=!0;for(let J of z.rooms){for(let se of J.blocks){if(se===r)continue;let $e=Math.abs(R-se.x),Ce=Math.abs(S-se.y),Ie=(x+se.w)/2,tt=($+se.h)/2;if($e<Ie&&Ce<tt){Y=!1;break}}if(!Y)break}let V=Re(r);V&&!Se({x:R,y:S,w:x,h:$},V)&&(Y=!1),Y&&(r.x=R,r.y=S,r.w=x,r.h=$,r._updateDisplay&&r._updateDisplay())}else if(a.active&&a.type==="resize-room"&&a.target){let r=a.target,h=I(d.x)-I(a.startMouseX),w=I(d.y)-I(a.startMouseY),f=a.resizeEdge,v=u*4,T=n.shiftKey,R=a.startTargetX,S=a.startTargetY,x=a.startTargetW,$=a.startTargetH;if(T){let V=a.startTargetW/a.startTargetH;f.includes("left")||f.includes("right")?(x=f.includes("left")?a.startTargetW-h:a.startTargetW+h,x>=v?($=x/V,$>=v?(f.includes("left")&&(R=a.startTargetX+h),f.includes("top")&&(S=a.startTargetY+(a.startTargetH-$))):(x=a.startTargetW,$=a.startTargetH)):(x=a.startTargetW,$=a.startTargetH)):($=f.includes("top")?a.startTargetH-w:a.startTargetH+w,$>=v?(x=$*V,x>=v?(f.includes("top")&&(S=a.startTargetY+w),f.includes("left")&&(R=a.startTargetX+(a.startTargetW-x))):(x=a.startTargetW,$=a.startTargetH)):(x=a.startTargetW,$=a.startTargetH))}else f.includes("left")&&(x=a.startTargetW-h,x>=v?R=a.startTargetX+h:x=a.startTargetW),f.includes("right")&&(x=a.startTargetW+h,x<v&&(x=a.startTargetW)),f.includes("top")&&($=a.startTargetH-w,$>=v?S=a.startTargetY+w:$=a.startTargetH),f.includes("bottom")&&($=a.startTargetH+w,$<v&&($=a.startTargetH));let z=D[0],Y=!0;for(let V of z.rooms){if(V===r)continue;let J=!(R+x<=V.x||R>=V.x+V.w),se=!(S+$<=V.y||S>=V.y+V.h);if(J&&se){Y=!1;break}}if(Y){let V={x:R,y:S,w:x,h:$};for(let J of r.blocks)if(!Se(J,V)){Y=!1;break}}Y&&(r.x=R,r.y=S,r.w=x,r.h=$,r._updateDisplay&&r._updateDisplay())}}),document.addEventListener("keydown",n=>{switch(n.code){case"F1":{n.preventDefault(),p==="play"?(p="default",L=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",P>=0&&(clearInterval(P),P=-1)):(p==="default"?(p="rooms",e.style.backgroundColor="#ff0044",e.textContent="rooms"):(p="default",e.style.backgroundColor="black",e.textContent="default"),o=[],ye());break}case"F2":{if(n.preventDefault(),p==="play")p="default",L=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",P>=0&&(clearInterval(P),P=-1);else{p="play",o=[],ye();let d=localStorage.getItem("keyboardMode"),r="wasd";(d==="zqsd"||d==="wasd")&&(r=d);let h=new we(D[0].rooms.map(f=>new ie(f.x,f.y,f.w,f.h,f.blocks.map(v=>new te(v.x,v.y,v.w,v.h,v.module.copy()))))),w=He??"edited";L=new F(r,document,[[new Te("",h,w)]]),window.game=L,L.state.set("play"),L.startLevel(h,w),e.style.backgroundColor="rgb(0, 132, 255)",e.textContent="play"}break}case"F3":{n.preventDefault();break}case"F9":{n.preventDefault(),(async()=>{let r=await(await window.showSaveFilePicker({suggestedName:"stage.txt",types:[{description:"Stage",accept:{"text/plain":[".txt"]}}]})).createWritable(),h=new TextEncoder;function w(f){return r.write(h.encode(f+`
`))}await wa(D[0],w),await r.close()})();break}case"F10":{n.preventDefault(),(async()=>{let[d]=await window.showOpenFilePicker(),r=await d.getFile();async function*h(){let v=r.stream().getReader(),T=new TextDecoder,R,S="",x=!1;for(;!(R=await v.read()).done;){if(S+=T.decode(R.value,{stream:!0}),!x){let Y=S.search(/[\r\n]/);if(Y!==-1){let V=S.slice(0,Y).trim();S=S.slice(Y+1),yield V,x=!0}else continue}let z;for(;(z=S.search(/[ \r\n]/))!==-1;){let Y=S.slice(0,z).trim();S=S.slice(z+1),Y&&(yield Y)}}let $=S.trim();$&&(yield $)}let{stage:w,name:f}=await Me(h);He=f,D[0]=w})();break}case"Escape":{o.length>0?o=[]:k?ye():t.classList.toggle("hidden");break}case"Delete":{if(o.length>0){let d=D[0];for(let r of o)for(let h of d.rooms){let w=h.blocks.indexOf(r);if(w>=0){h.blocks.splice(w,1);break}}o=[]}else if(k){if(k instanceof te){let d=Re(k);if(d){let r=d.blocks.indexOf(k);r>=0&&d.blocks.splice(r,1)}}else if(k instanceof ie){let d=D[0],r=d.rooms.indexOf(k);r>=0&&d.rooms.splice(r,1)}ye()}break}case"KeyC":{if(n.ctrlKey&&o.length>0){n.preventDefault();let d=Math.min(...o.map(h=>h.x)),r=Math.min(...o.map(h=>h.y));c=o.map(h=>({module:h.module.copy(),dx:h.x-d,dy:h.y-r,w:h.w,h:h.h}))}break}case"KeyV":{if(n.ctrlKey&&c.length>0){n.preventDefault();let d=q(m.sx,m.sy),r=I(d.x),h=I(d.y),w=fe(r,h);if(!w)break;o=[];for(let f of c){let v=new te(r+f.dx,h+f.dy,f.w,f.h,f.module.copy());Se(v,w)&&(w.blocks.push(v),o.push(v))}}break}}}),document.addEventListener("wheel",n=>{n.preventDefault();let d=q(n.clientX,n.clientY),r=d.x,h=d.y,w=1.12,f=n.deltaY<0?w:1/w;l.zoom=G(l.zoom*f,.2,8)},{passive:!1}),document.addEventListener("contextmenu",n=>{p!=="play"&&n.preventDefault()});function Ks(n){let d=Math.floor((l.x-F.WIDTH_2/l.zoom)/u)*u,r=Math.ceil((l.x+F.WIDTH_2/l.zoom)/u)*u,h=Math.floor((l.y-F.HEIGHT_2/l.zoom)/u)*u,w=Math.ceil((l.y+F.HEIGHT_2/l.zoom)/u)*u;n.strokeStyle="#444";let f=.3,v=1,T=3,R=16,S=9;for(let x=d;x<=r;x+=u)Math.floor(x/u)%(R*4)===0?n.lineWidth=T:Math.floor(x/u)%R===0?n.lineWidth=v:n.lineWidth=f,n.beginPath(),n.moveTo(x,h),n.lineTo(x,w),n.stroke();for(let x=h;x<=w;x+=u)Math.floor(x/u)%(S*4)===0?n.lineWidth=T:Math.floor(x/u)%S===0?n.lineWidth=v:n.lineWidth=f,n.beginPath(),n.moveTo(d,x),n.lineTo(r,x),n.stroke()}function js(n){if(!a.active)return;let d=q(m.sx,m.sy);if(a.type==="create-block"){let r=Math.min(a.createStartX,I(d.x)),h=Math.min(a.createStartY,I(d.y)),w=Math.max(a.createStartX,I(d.x))+u,f=Math.max(a.createStartY,I(d.y))+u,v=w-r,T=f-h;n.strokeStyle="cyan",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(r,h,v,T),n.setLineDash([])}else if(a.type==="create-room"){let r=Math.min(a.createStartX,I(d.x)),h=Math.min(a.createStartY,I(d.y)),w=Math.max(a.createStartX,I(d.x))+u,f=Math.max(a.createStartY,I(d.y))+u,v=w-r,T=f-h;n.strokeStyle="lime",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(r,h,v,T),n.setLineDash([])}else if(a.type==="multi-select"){let r=Math.min(a.createStartX,d.x),h=Math.min(a.createStartY,d.y),w=Math.max(a.createStartX,d.x),f=Math.max(a.createStartY,d.y),v=w-r,T=f-h;n.strokeStyle="blue",n.fillStyle="rgba(0, 0, 255, 0.1)",n.lineWidth=2,n.setLineDash([5,5]),n.fillRect(r,h,v,T),n.strokeRect(r,h,v,T),n.setLineDash([])}}function Yt(n,d){let r=8/l.zoom;n.fillStyle="cyan",n.strokeStyle="white",n.lineWidth=2/l.zoom;let h,w,f,v;d instanceof te?(h=d.x-d.w/2,w=d.y-d.h/2,f=d.w,v=d.h):(h=d.x,w=d.y,f=d.w,v=d.h);let T=[[h,w],[h+f,w],[h,w+v],[h+f,w+v]];for(let[S,x]of T)n.fillRect(S-r/2,x-r/2,r,r),n.strokeRect(S-r/2,x-r/2,r,r);let R=[[h+f/2,w],[h+f/2,w+v],[h,w+v/2],[h+f,w+v/2]];for(let[S,x]of R)n.fillRect(S-r/2,x-r/2,r,r),n.strokeRect(S-r/2,x-r/2,r,r)}function Zs(n,d){d.module.rotation&&(n.save(),n.strokeStyle="rgba(255, 165, 0, 0.5)",n.lineWidth=2/l.zoom,n.setLineDash([5,5]),n.strokeRect(d.x-d.w/2,d.y-d.h/2,d.w,d.h),n.setLineDash([]),n.restore())}function Qs(n,d){d.module.spawner&&(n.save(),n.fillStyle="rgba(255, 0, 255, 0.3)",n.fillRect(d.x-d.w/2,d.y-d.h/2,d.w,d.h),n.fillStyle="magenta",n.font=`${Math.min(d.w,d.h)*.6}px Arial`,n.textAlign="center",n.textBaseline="middle",n.fillText("S",d.x,d.y),n.restore())}function en(n){let d=i.width/F.WIDTH,r=i.height/F.HEIGHT,h=Math.min(d,r),w=(i.width-F.WIDTH*h)/2,f=(i.height-F.HEIGHT*h)/2;n.fillStyle="black",n.fillRect(0,0,i.width,i.height),n.save(),n.translate(w,f),n.scale(h,h),n.save(),n.translate(F.WIDTH_2,F.HEIGHT_2),n.scale(l.zoom,l.zoom),n.translate(-l.x,-l.y),Ks(n);let v=D[0];n.fillStyle="#ccc2";for(let T of v.rooms)n.fillRect(T.x,T.y,T.w,T.h);for(let T of v.rooms)T.draw(n);for(let T of v.rooms)for(let R of T.blocks)R.module.rotation&&Zs(n,R),R.module.spawner&&Qs(n,R);n.strokeStyle="white",n.lineWidth=3;for(let T of v.rooms)n.strokeRect(T.x,T.y,T.w,T.h);n.strokeStyle="white",n.lineWidth=3;for(let T of v.rooms)n.strokeRect(T.x,T.y,T.w,T.h);if(k&&(k instanceof te?(n.strokeStyle="yellow",n.lineWidth=4/l.zoom,n.strokeRect(k.x-k.w/2,k.y-k.h/2,k.w,k.h),Yt(n,k)):k instanceof ie&&(n.strokeStyle="yellow",n.lineWidth=4/l.zoom,n.strokeRect(k.x,k.y,k.w,k.h),Yt(n,k))),o.length>0){n.strokeStyle="blue",n.lineWidth=3/l.zoom;for(let T of o)n.strokeRect(T.x-T.w/2,T.y-T.h/2,T.w,T.h)}a.active&&js(n),n.fillStyle="rgba(255, 255, 255, 0.3)",n.fillRect(m.wx,m.wy,u,u),n.strokeStyle="grey",n.fillStyle="grey",n.beginPath(),n.arc(0,0,u,0,Math.PI*2),n.stroke(),n.beginPath(),n.arc(0,0,u/2,0,Math.PI*2),n.fill(),n.restore(),n.restore(),n.fillStyle="black",f>0&&n.fillRect(0,0,i.width,f),f>0&&n.fillRect(0,i.height-f,i.width,f),w>0&&n.fillRect(0,0,w,i.height),w>0&&n.fillRect(i.width-w,0,w,i.height),n.fillStyle="white",n.font="16px monospace",n.fillText(`Camera: (${l.x.toFixed(0)}, ${l.y.toFixed(0)}) Zoom: ${l.zoom.toFixed(2)}`,10,i.height-60),n.fillText(`Mouse: (${m.wx.toFixed(0)}, ${m.wy.toFixed(0)})`,10,i.height-40),n.fillText(`Mode: ${p} | F1: Default/Rooms | F2: Play | Esc: deselect | Del: delete`,10,i.height-20),o.length>0&&(n.fillStyle="yellow",n.fillText(`Selected blocks: ${o.length} | Ctrl+C to copy | Ctrl+V to paste`,10,i.height-80))}function Xt(){p==="play"&&L?(L.gameLogic(),L.gameDraw(s,i.width,i.height,(n,d,r)=>{L.drawMethod(n,d,r)})):en(s),window.running&&requestAnimationFrame(Xt)}window.game=L,window.running=!0,Xt()}window.startEditor=ga;})();
