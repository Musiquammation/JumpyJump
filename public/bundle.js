(()=>{var pe=class r{static TRANSITION_DURATION=25;x=0;y=0;targetX=0;targetY=0;startX=0;startY=0;progress=0;moving=!1;move(e,t){this.startX=this.x,this.startY=this.y,this.targetX=e,this.targetY=t,this.progress=0,this.moving=!0}teleport(e,t){this.x=e,this.y=t,this.moving=!1}update(){this.moving&&(this.progress+=1/r.TRANSITION_DURATION,this.progress>=1&&(this.progress=1,this.moving=!1),this.x=this.startX+(this.targetX-this.startX)*this.progress,this.y=this.startY+(this.targetY-this.startY)*this.progress)}reset(){this.teleport(0,0)}};var ie=class{left=!1;right=!1;up=!1;down=!1;debug=!1;enter=!1},we=class r{keysDown=new ie;firstPress=new ie;killedPress=new ie;keyMap;static KEYBOARDS={zqsd:{KeyZ:"up",KeyQ:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"},wasd:{KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"}};constructor(e){this.keyMap=r.KEYBOARDS[e]}onKeydown=e=>{let t=e,s=this.keyMap[t.code];s&&(this.keysDown[s]||(this.firstPress[s]=!0),this.keysDown[s]=!0)};onKeyup=e=>{let t=e,s=this.keyMap[t.code];s&&(this.keysDown[s]=!1,this.killedPress[s]=!0)};addEventListeners(e){e.addEventListener("keydown",this.onKeydown),e.addEventListener("keyup",this.onKeyup)}update(){for(let e of["left","right","up","down","debug","enter"])this.firstPress[e]=!1,this.killedPress[e]=!1}press(e){return this.keysDown[e]}first(e){return this.firstPress[e]}killed(e){return this.killedPress[e]}};var Z=class{x;y;constructor(e,t){this.x=e,this.y=t}};var fe=class{x;y;hp;constructor(e,t,s){this.x=e,this.y=t,this.hp=s}getSize(){return new Z(64,64)}draw(e){e.fillStyle="green";let t=this.getSize();e.fillRect(this.x-t.x/2,this.y-t.y/2,t.x,t.y)}getRotation(){return 0}heal(e){}bounce(e,t){}};var ae=class r{static FAST_DURATION=10;static SLOW_DURATION=60;orientation;x;y;w;h;sections;background;borderColor;animColor;value;valueReference;timer;animDuration;mode;fastValue;slowValue;fastTimer;slowTimer;targetValue;fastStartValue;slowStartValue;constructor(e,t,s,a,d,v,h,m,u,n){this.orientation=e,this.x=s,this.y=a,this.w=d,this.h=v,this.sections=h,this.background=u,this.borderColor=n,this.animColor=m,t=Math.max(0,Math.min(1,t)),this.value=t,this.valueReference=t,this.timer=-1,this.animDuration=0,this.mode=null,this.fastValue=t,this.slowValue=t,this.fastTimer=-1,this.slowTimer=-1,this.targetValue=t,this.fastStartValue=t,this.slowStartValue=t}animFunction(e){return 1-Math.pow(1-e,3)}setValue(e){e=Math.max(0,Math.min(1,e)),e!==this.targetValue&&(this.targetValue=e,e>this.value?(this.mode="up",this.slowStartValue=this.value,this.slowTimer=0,this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0):(this.mode="down",this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0,this.slowStartValue=this.value,this.slowTimer=0))}update(){let e=!1;if(this.fastTimer>=0)if(this.fastTimer++,this.fastTimer<=r.FAST_DURATION){let t=this.fastTimer/r.FAST_DURATION,s=this.animFunction(t);this.mode==="up"?this.fastValue=this.fastStartValue+(this.targetValue-this.fastStartValue)*s:this.value=this.fastStartValue+(this.targetValue-this.fastStartValue)*s,e=!0}else this.mode==="up"?this.fastValue=this.targetValue:this.value=this.targetValue,this.fastTimer=-1;if(this.slowTimer>=0)if(this.slowTimer++,this.slowTimer<=r.SLOW_DURATION){let t=this.slowTimer/r.SLOW_DURATION,s=this.animFunction(t);this.mode==="up"?this.value=this.slowStartValue+(this.targetValue-this.slowStartValue)*s:this.slowValue=this.slowStartValue+(this.targetValue-this.slowStartValue)*s,e=!0}else this.mode==="up"?this.value=this.targetValue:this.slowValue=this.targetValue,this.slowTimer=-1;e||(this.mode=null,this.fastValue=this.value,this.slowValue=this.value)}draw(e){this.background&&(e.fillStyle=this.background,e.fillRect(this.x,this.y,this.w,this.h));let t=2,s=this.x+t,a=this.y+t,d=this.w-2*t,v=this.h-2*t;this.drawSections(e,s,a,d,v,this.value),this.mode==="up"&&this.slowTimer>=0?this.drawAnimationBar(e,s,a,d,v,this.value,this.fastValue):this.mode==="down"&&this.slowTimer>=0&&this.drawAnimationBar(e,s,a,d,v,this.value,this.slowValue),e.strokeStyle=this.borderColor,e.lineWidth=t,e.strokeRect(this.x,this.y,this.w,this.h)}drawSections(e,t,s,a,d,v){let h=this.sections.length;if(this.orientation==="horizontal"){let m=a*v,u=a/h,n=2;for(let w=0;w<h;w++){let g=t+w*u,R=t+(w+1)*u,M=Math.max(g,t),A=Math.min(R,t+m);A>M&&(e.fillStyle=this.sections[w],e.fillRect(M,s,A-M,d)),w<h-1&&R<t+m&&(e.fillStyle="black",e.fillRect(R-n/2,s,n,d))}}else{let m=d*v,u=d/h,n=2;for(let w=0;w<h;w++){let g=s+d-(w+1)*u,R=s+d-w*u,M=Math.max(g,s+d-m),A=Math.min(R,s+d);A>M&&(e.fillStyle=this.sections[w],e.fillRect(t,M,a,A-M)),w<h-1&&g>s+d-m&&(e.fillStyle="black",e.fillRect(t,g-n/2,a,n))}}}drawAnimationBar(e,t,s,a,d,v,h){if(e.fillStyle=this.animColor,this.orientation==="horizontal"){let m=t+a*Math.min(v,h),u=a*Math.abs(h-v);e.fillRect(m,s,u,d)}else{let m=s+d*(1-Math.max(v,h)),u=d*Math.abs(h-v);e.fillRect(t,m,a,u)}}};var $=class r extends fe{static GRAVITY=.9;static DASH=20;static JUMP=25;static MAX_SPEED=25;static SPEED_INC=3;static SPEED_DEC=10;static JUMP_COUNT=3;static HP=3;static JUMP_HP_COST=1;static RESPAWN_COULDOWN=30;static DEATH_ANIM_COULDOWN=60;static SIZE=40;static SIZE_2=r.SIZE/2;vx=0;vy=0;eternalMode=!1;jumps=r.JUMP_COUNT;respawnCouldown=-1;jump_leveledBar=new ae("vertical",1,1500,150,30,600,["#FFA800","#FFD000","#FFF200"],"#fffdceff",null,"black");hp_leveledBar=new ae("horizontal",1,300,100,1e3,30,["#ff0044","#ff002f","#ff001a"],"#ffb1c5",null,"black");constructor(){super(0,0,r.HP),this.respawn()}getSize(){return new Z(r.SIZE,r.SIZE)}consumeJump(e=1){if(this.jumps>0){this.jumps-=e,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT);return}this.hit(r.JUMP_HP_COST,null)}bounce(e,t){if(this.vy<=0)return;let s=t*this.vy;this.jumps>=s?(this.jumps-=s,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT)):(this.jumps=0,this.jump_leveledBar.setValue(0)),this.vy*=-e}restoreJumps(){this.jumps=r.JUMP_COUNT,this.jump_leveledBar.setValue(1)}restoreJumpAdd(e){let t=this.jumps+e;this.jumps=t>=r.JUMP_COUNT?r.JUMP_COUNT:t,this.jump_leveledBar.setValue(this.jumps/r.JUMP_COUNT)}restoreHp(){this.hp=r.HP,this.hp_leveledBar.setValue(1)}hit(e,t){this.eternalMode||this.isAlive()&&(this.hp-=e,this.hp_leveledBar.setValue(this.hp/r.HP),this.hp<=0&&this.kill())}heal(e){this.hp+=e,this.hp>=r.HP?(this.hp=r.HP,this.hp_leveledBar.setValue(1)):this.hp_leveledBar.setValue(this.hp/r.HP)}isAlive(){return this.respawnCouldown<=r.RESPAWN_COULDOWN}kill(){this.eternalMode||(this.respawnCouldown=r.DEATH_ANIM_COULDOWN)}respawn(){this.x=0,this.y=0,this.vx=0,this.vy=-r.JUMP,this.restoreHp(),this.restoreJumps()}frame(e){this.respawnCouldown>=0&&(this.respawnCouldown--,this.respawnCouldown==r.RESPAWN_COULDOWN&&this.respawn());let t=e.inputHandler;t.press("left")?this.vx>0?this.vx-=r.SPEED_DEC:this.vx-=r.SPEED_INC:t.press("right")?this.vx<0?this.vx+=r.SPEED_DEC:this.vx+=r.SPEED_INC:this.vx>0?(this.vx-=r.SPEED_DEC,this.vx<0&&(this.vx=0)):this.vx<0&&(this.vx+=r.SPEED_DEC,this.vx>0&&(this.vx=0)),this.vx>r.MAX_SPEED&&(this.vx=r.MAX_SPEED),this.vx<-r.MAX_SPEED&&(this.vx=-r.MAX_SPEED),t.first("up")&&(this.consumeJump(),this.vy=-r.JUMP),this.vy+=r.GRAVITY,t.press("down")&&(this.y+=r.DASH),this.x+=this.vx*(this.eternalMode?3:1),this.y+=this.vy}draw(e){e.fillStyle="white",e.strokeStyle="black",e.lineWidth=5;let t=4,s=this.x-r.SIZE_2,a=this.y-r.SIZE_2,d=r.SIZE;e.fillRect(s,a,d,d),e.beginPath(),e.moveTo(s+t,a),e.lineTo(s+d-t,a),e.quadraticCurveTo(s+d,a,s+d,a+t),e.lineTo(s+d,a+d-t),e.quadraticCurveTo(s+d,a+d,s+d-t,a+d),e.lineTo(s+t,a+d),e.quadraticCurveTo(s,a+d,s,a+d-t),e.lineTo(s,a+t),e.quadraticCurveTo(s,a,s+t,a),e.closePath(),e.stroke()}drawInfos(e){this.jump_leveledBar.update(),this.jump_leveledBar.draw(e),this.hp_leveledBar.update(),this.hp_leveledBar.draw(e)}drawDeathTransition(e){if(this.respawnCouldown<0)return;e.fillStyle="#ff0044";function t(a){return Math.sin(a*Math.PI/2)}let s=t(this.respawnCouldown/r.DEATH_ANIM_COULDOWN);if(s<.5){let a=B.WIDTH*2*s;e.fillRect(B.WIDTH-a,0,a,B.HEIGHT)}else{let a=B.WIDTH*2*(1-s);e.fillRect(0,0,a,B.HEIGHT)}}};var ye=class r{type="menu";chrono=0;static PLAY_TO_WIN_DURATION=60;update(){switch(this.chrono++,this.type){case"playToWin":this.chrono>=r.PLAY_TO_WIN_DURATION&&this.set("win");break}}getChrono(){return this.chrono}set(e){this.type=e,this.chrono=0}get(){return this.type}},B=class r{static WIDTH=1600;static HEIGHT=900;static WIDTH_2=r.WIDTH/2;static HEIGHT_2=r.HEIGHT/2;player=new $;camera=new pe;inputHandler;stageList;stage=null;frame=0;goalComplete=0;gameChrono=0;state=new ye;validRun=!0;currentWorld=0;currentLevel=0;constructor(e,t,s){this.inputHandler=new we(e),this.inputHandler.addEventListeners(t),this.stageList=s}startLevel(e){this.stage=e,this.resetStage()}playLogic(e){e&&(this.inputHandler.press("debug")?(this.validRun=!1,this.player.eternalMode=!0):this.player.eternalMode=!1),this.player.frame(this),this.stage.frame(this),this.player.respawnCouldown==$.RESPAWN_COULDOWN&&this.resetStage(),this.player.isAlive()&&this.handleRoom(),e&&(this.goalComplete>0&&this.state.set("playToWin"),this.player.respawnCouldown<0&&this.gameChrono++)}menuLogic(){if(this.inputHandler.first("enter")){let e=this.stageList[this.currentWorld][this.currentLevel];e&&(this.state.set("play"),this.startLevel(e))}this.inputHandler.first("right")&&this.currentLevel<this.stageList[this.currentWorld].length-1&&this.currentLevel++,this.inputHandler.first("left")&&this.currentLevel>0&&this.currentLevel--,this.inputHandler.first("down")&&this.currentWorld<this.stageList.length-1&&this.currentWorld++,this.inputHandler.first("up")&&this.currentWorld>0&&this.currentWorld--}winLogic(){if(this.validRun&&this.inputHandler.first("debug")){let e=window.open("","_blank"),t="This feature is coming soon...";if(e){let s=e?.document.createElement("div");s.innerText=t,e.document.body.appendChild(s)}else alert("inspect page to get run link"),console.log(t);this.validRun=!1}this.inputHandler.first("enter")&&this.state.set("menu")}gameLogic(){switch(this.state.get()){case"play":this.playLogic(!0);break;case"playToWin":this.playLogic(!1);break;case"menu":this.menuLogic();break;case"win":this.winLogic();break}this.frame++,this.state.update(),this.inputHandler.update()}generateChronoText(){let e=this.state.get();if(e!=="play"&&e!=="playToWin"&&e!=="win")return"";if(!this.validRun)return"debug";let t=this.gameChrono/60,s=Math.floor(t/60),a=Math.floor(t%60),d=Math.floor((t-Math.floor(t))*100),v=(h,m=2)=>h.toString().padStart(m,"0");return`${v(s)}:${v(a)}.${v(d)}`}resetStage(){this.stage.reset(),this.state.get()==="play"&&(this.player.respawn(),this.camera.reset(),this.validRun=!0,this.gameChrono=0,this.goalComplete=0)}handleRoom(){let e=this.player.getSize();switch(this.stage.update(this.player.x,this.player.y,e.x,e.y)){case"same":break;case"new":{this.player.restoreJumps();let t=this.stage.currentRoom;this.camera.move(t.x+t.w/2,t.y+t.h/2);break}case"out":this.player.kill();break}}drawMethod(e,t,s){let a=this.state.get();switch(this.state.get()){case"play":case"playToWin":{t(),e.fillStyle="#111",e.fillRect(this.stage.currentRoom.x,this.stage.currentRoom.y,this.stage.currentRoom.w,this.stage.currentRoom.h),e.fillStyle="#1a1a1a";for(let d of this.stage.currentRoom.adjacentRooms)e.fillRect(d.x,d.y,d.w,d.h);this.stage.currentRoom.draw(e);for(let d of this.stage.currentRoom.adjacentRooms)d.draw(e);if(this.player.draw(e),this.stage.drawAdjacenceRects(e,this.player),s(),this.player.drawInfos(e),this.player.drawDeathTransition(e),a==="playToWin"){let d=1.5*this.state.getChrono()/ye.PLAY_TO_WIN_DURATION;d<1?d=Math.sin(d*Math.PI/2):d=1,e.fillStyle=`rgba(0, 0, 0, ${d*d*d})`,e.fillRect(0,0,r.WIDTH,r.HEIGHT)}break}case"menu":{e.fillStyle="#111",e.fillRect(0,0,r.WIDTH,r.HEIGHT),e.font="30px Arial",e.fillStyle="white",e.fillText(`World ${this.currentWorld+1}`,r.WIDTH_2,100);for(let d=0;d<this.stageList[this.currentWorld].length;d++){e.fillStyle=d==this.currentLevel?"yellow":"white";let v=400+200*(d%5),h=300+Math.floor(d/5)*100;e.fillText(`#${d}`,v,h)}break}case"win":{e.fillStyle="black",e.fillRect(0,0,r.WIDTH,r.HEIGHT),e.font="30px Arial",e.fillStyle="white",e.fillText("Press P to save",r.WIDTH_2,r.HEIGHT_2-20),e.fillStyle="white",e.fillText("Press F5 to restart",r.WIDTH_2,r.HEIGHT_2+20),e.fillStyle="white",e.fillText("Press enter to select level",r.WIDTH_2,r.HEIGHT_2+60);break}}}gameDraw(e,t,s,a){let d=t/r.WIDTH,v=s/r.HEIGHT,h=Math.min(d,v),m=(t-r.WIDTH*h)/2,u=(s-r.HEIGHT*h)/2;e.save(),e.translate(m,u),e.scale(h,h),e.fillStyle="black",e.fillRect(0,0,r.WIDTH,r.HEIGHT),this.camera.update(),a(e,()=>{e.save(),e.translate(r.WIDTH_2-this.camera.x,r.HEIGHT_2-this.camera.y)},()=>{e.restore()}),e.restore(),e.fillStyle="black",u>0&&e.fillRect(0,0,t,u),u>0&&e.fillRect(0,s-u,t,u),m>0&&e.fillRect(0,0,m,s),m>0&&e.fillRect(t-m,0,m,s)}};var Q={checkRectRectCollision(r,e){let t=(g,R)=>g.x*R.x+g.y*R.y,s=(g,R)=>({x:g.x-R.x,y:g.y-R.y}),a=g=>{let R=Math.hypot(g.x,g.y);return R===0?{x:0,y:0}:{x:g.x/R,y:g.y/R}},d=g=>{let R=g.w/2,M=g.h/2,A=Math.cos(g.r),I=Math.sin(g.r);return[{x:-R,y:-M},{x:R,y:-M},{x:R,y:M},{x:-R,y:M}].map(O=>({x:g.x+O.x*A-O.y*I,y:g.y+O.x*I+O.y*A}))},v=g=>{let R=[];for(let M=0;M<2;M++){let A=g[M],I=g[(M+1)%4],H=s(I,A),O={x:-H.y,y:H.x};R.push(a(O))}return R},h=(g,R)=>{let M=t(g[0],R),A=M;for(let I=1;I<g.length;I++){let H=t(g[I],R);H<M&&(M=H),H>A&&(A=H)}return{min:M,max:A}},m=(g,R)=>!(g.max<R.min||R.max<g.min);if(r.w<=0||r.h<=0||e.w<=0||e.h<=0)return!1;let u=d(r),n=d(e),w=[...v(u),...v(n)];for(let g of w){let R=h(u,g),M=h(n,g);if(!m(R,M))return!1}return!0},getPointRectDist(r,e){function t(u){let n=Math.cos(u.r),w=Math.sin(u.r),g=u.w/2,R=u.h/2;return[[-g,-R],[g,-R],[g,R],[-g,R]].map(([A,I])=>[u.x+A*n-I*w,u.y+A*w+I*n])}function s(u,n,w,g,R,M){let A=R-w,I=M-g,H=A*A+I*I;if(H===0)return Math.hypot(u-w,n-g);let O=((u-w)*A+(n-g)*I)/H;O=Math.max(0,Math.min(1,O));let W=w+O*A,te=g+O*I;return Math.hypot(u-W,n-te)}function a(u,n,w){let g=Math.cos(-w.r),R=Math.sin(-w.r),M=(u-w.x)*g-(n-w.y)*R,A=(u-w.x)*R+(n-w.y)*g;return Math.abs(M)<=w.w/2&&Math.abs(A)<=w.h/2}function d(u,n){let w=t(u),g=t(n),R=[[Math.cos(u.r),Math.sin(u.r)],[-Math.sin(u.r),Math.cos(u.r)],[Math.cos(n.r),Math.sin(n.r)],[-Math.sin(n.r),Math.cos(n.r)]];for(let[M,A]of R){let I=w.map(([G,he])=>G*M+he*A),H=g.map(([G,he])=>G*M+he*A),O=Math.min(...I),W=Math.max(...I),te=Math.min(...H),D=Math.max(...H);if(W<te||D<O)return!1}return!0}if(d(r,e))return 0;let v=t(r),h=t(e),m=1/0;for(let u=0;u<4;u++){let[n,w]=v[u];for(let g=0;g<4;g++){let[R,M]=h[g],[A,I]=h[(g+1)%4],H=s(n,w,R,M,A,I);m=Math.min(m,H)}}for(let u=0;u<4;u++){let[n,w]=h[u];for(let g=0;g<4;g++){let[R,M]=v[g],[A,I]=v[(g+1)%4],H=s(n,w,R,M,A,I);m=Math.min(m,H)}}return m}};var Ce=class{dx;dy;duration;constructor(e,t,s=-1){this.dx=e,this.dy=t,this.duration=s}},ge=class{liberationCouldown;usages=new Map;constructor(e){this.liberationCouldown=e}track(e,t){let s=this.usages.get(e);return this.usages.set(e,t+this.liberationCouldown),s===void 0||s<=t}reset(){this.usages.clear()}},ke=class r{patterns;times;currentPattern;currentTime;loopCount;active;constructor(e,t){this.patterns=e,this.times=t,this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}update(e,t){if(!this.active||this.patterns.length===0)return;let s=this.patterns[this.currentPattern];if(e.x+=s.dx,e.y+=s.dy,this.currentTime++,s.duration!==-1&&this.currentTime>=s.duration&&(this.currentPattern++,this.currentTime=0,this.currentPattern>=this.patterns.length&&(this.loopCount++,this.times!==-1&&this.loopCount>=this.times?this.active=!1:this.currentPattern=0)),!t.containsBox(e.x,e.y,e.w,e.h)){let a=null;for(let d of t.adjacentRooms)d.containsBox(e.x,e.y,e.w,e.h)&&(a=d);a?e.toMove=a:e.toRemove=!0}}reset(){this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}copy(){let e=new r(this.patterns,this.times);return e.currentPattern=this.currentPattern,e.currentTime=this.currentTime,e.loopCount=this.loopCount,e.active=this.active,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},De=class{spikes_x;spikes_y;spikes_w;spikes_h;constructor(e,t,s=32,a=32){this.spikes_x=Math.max(1,Math.ceil(e/s)),this.spikes_w=e/this.spikes_x,this.spikes_y=Math.max(1,Math.ceil(t/a)),this.spikes_h=t/this.spikes_y}},Ee=class r{damages;duration;playerOnly;couldowns=new Map;constructor(e,t,s=!0){this.damages=e,this.duration=t,this.playerOnly=s}update(e){for(let[t,s]of this.couldowns){let a=s-1;a<=0?this.couldowns.delete(t):this.couldowns.set(t,a)}}reset(){this.couldowns.clear()}onTouch(e){this.playerOnly&&!(e instanceof $)||this.couldowns.has(e)||(this.couldowns.set(e,this.duration),e.hit(this.damages,null))}copy(){let e=new r(this.damages,this.duration,this.playerOnly);return e.couldowns=new Map(this.couldowns),e}draw(e,t,s){t.fillStyle="#9B59B6",t.fillRect(-e.w/2,-e.h/2,e.w,e.h);let a=1;for(let[v,h]of this.couldowns)if(v instanceof $){a=(this.duration-h)/this.duration,a<0&&(a=0),a>1&&(a=1);break}function d(v,h,m){let[u,n]=v,[w,g]=h,[R,M]=m;{let A=u+(R-u),I=n+(M-n),H=w+(R-w),O=g+(M-g);t.beginPath(),t.moveTo(u,n),t.lineTo(A,I),t.lineTo(H,O),t.lineTo(w,g),t.closePath(),t.fillStyle="#dec5ffff",t.fill()}if(t.beginPath(),t.moveTo(u,n),t.lineTo(R,M),t.lineTo(w,g),t.closePath(),t.strokeStyle="#FFEEAA",t.lineWidth=2,t.stroke(),a>0){let A=u+(R-u)*a,I=n+(M-n)*a,H=w+(R-w)*a,O=g+(M-g)*a;t.beginPath(),t.moveTo(u,n),t.lineTo(A,I),t.lineTo(H,O),t.lineTo(w,g),t.closePath(),t.fillStyle="#882dffff",t.fill()}}for(let v=0;v<s.spikes_x;v++){let h=-e.w/2+v*s.spikes_w+s.spikes_w/2,m=-e.h/2;d([h-s.spikes_w/2,m],[h+s.spikes_w/2,m],[h,m-s.spikes_h]);let u=e.h/2;d([h-s.spikes_w/2,u],[h+s.spikes_w/2,u],[h,u+s.spikes_h])}for(let v=0;v<s.spikes_y;v++){let h=-e.h/2+v*s.spikes_h+s.spikes_h/2,m=-e.w/2;d([m,h-s.spikes_w/2],[m,h+s.spikes_w/2],[m-s.spikes_h,h]);let u=e.w/2;d([u,h-s.spikes_w/2],[u,h+s.spikes_w/2],[u+s.spikes_h,h])}}generateAnimator(e){return new De(e.w,e.h)}},Se=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,a=e.createRadialGradient(0,0,0,0,0,t*1.5);a.addColorStop(0,`rgba(114, 0, 129, ${this.alpha})`),a.addColorStop(1,"rgba(114, 0, 129, 0)"),e.fillStyle=a,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},Ae=class r{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.particles.push(new Se(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Ie=class r{damages;playerOnly;constructor(e,t=!0){this.damages=e,this.playerOnly=t}reset(){}onTouch(e){this.playerOnly&&!(e instanceof $)||e.hit(this.damages,null)}copy(){return new r(this.damages,this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgb(111, 0, 255)",t.shadowBlur=50,t.fillStyle="rgba(212, 0, 255, 1)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new Ae}},Be=class{arrows=[];spacing;time=0;constructor(e,t=30){let s=Math.ceil(e/t);this.spacing=e/s;for(let a=0;a<s;a++)this.arrows.push({y:a*this.spacing})}getSpeed(){return Math.max(.3,Math.sin(this.time/2)*3)}update(e){this.time+=.1;let t=this.getSpeed();for(let s of this.arrows)s.y+=t,s.y>e&&(s.y-=e)}getArrows(){return this.arrows}getOpacity(e,t){let s=this.spacing;return e<s?e/s:e>t-s?(t-e)/s:1}},He=class r{cost;factor;playerOnly;helper;constructor(e,t,s=!0,a=12){this.factor=e,this.cost=t,this.playerOnly=s,this.helper=new ge(a)}reset(){this.helper.reset()}onTouch(e,t){this.playerOnly&&!(e instanceof $)||this.helper.track(e,t)&&e.bounce(this.factor,this.cost)}update(){}copy(){return new r(this.factor,this.cost,this.playerOnly)}draw(e,t,s){s.update(e.h),t.save(),t.shadowColor="rgba(255, 220, 100, 0.9)",t.shadowBlur=35;let a=t.createLinearGradient(-e.w/2,-e.h/2,e.w/2,e.h/2);a.addColorStop(0,"#FFE066"),a.addColorStop(1,"#FFAA00"),t.fillStyle=a,t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore();let d=e.w*.6,v=20;for(let h=0;h<s.getArrows().length;h++){let m=s.getArrows()[h],u=0,n=e.h/2-m.y-10,w=s.getOpacity(m.y,e.h);t.save(),t.globalAlpha=w,t.strokeStyle="#FFFF80",t.lineWidth=3,t.shadowColor="rgba(255, 240, 180, 1)",t.shadowBlur=20,t.beginPath(),t.moveTo(u,n-v/2),t.lineTo(u-d/2,n+v/2),t.moveTo(u,n-v/2),t.lineTo(u+d/2,n+v/2),t.stroke(),t.restore()}}generateAnimator(e){return new Be(e.h)}},Le=class{x;y;r;vx;vy;alpha;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.r=2+Math.random()*4,this.vx=(Math.random()-.5)*.5,this.vy=-.5-Math.random()*1,this.alpha=1.4}update(){return this.x+=this.vx,this.y+=this.vy,this.alpha-=.01,this.alpha>0}draw(e){let t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r*2);t.addColorStop(0,`rgba(200, 20, 0, ${this.alpha})`),t.addColorStop(1,"rgba(255, 30, 0, 0)"),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.r,0,Math.PI*2),e.fill()}},Pe=class r{bubbles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.bubbles.push(new Le(e,t))),this.bubbles=this.bubbles.filter(s=>s.update())}draw(e){this.bubbles.forEach(t=>t.draw(e))}},Oe=class r{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e){this.playerOnly&&!(e instanceof $)||e.hit(1/0,null)}copy(){return new r(this.playerOnly)}draw(e,t,s){t.save(),t.shadowColor="rgba(255,0,0,0.8)",t.shadowBlur=20,t.fillStyle="red",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new Pe}},We=class r{duration;couldown;constructor(e){this.duration=e,this.couldown=e}update(e){--this.couldown<=0&&(e.toRemove=!0)}reset(){this.couldown=this.duration}copy(){let e=new r(this.duration);return e.couldown=this.couldown,e}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Xe=class r{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e,t){this.playerOnly&&!(e instanceof $)||(t.toRemove=!0)}copy(){return new r(this.playerOnly)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},le=class r{particles=[];usableColor={r:50,g:150,b:50};touchedColor={r:30,g:100,b:30};currentColor={r:50,g:150,b:50};baseShadowBlur=30;shadowPulse=0;production=0;static PRODUCTION=2e5;update(e){e.module.heal?.playerHasTouched?(this.currentColor.r+=(this.touchedColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.touchedColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.touchedColor.b-this.currentColor.b)*.05):(this.currentColor.r+=(this.usableColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.usableColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.usableColor.b-this.currentColor.b)*.05),e.module.heal?.playerHasTouched?this.shadowPulse=0:this.shadowPulse+=.04,e.module.heal?.playerHasTouched||(this.production+=e.w*e.h,this.production>r.PRODUCTION&&(this.production-=r.PRODUCTION,this.particles.push({x:(Math.random()-.5)*e.w*.8,y:(Math.random()-.5)*e.h*.8,vy:-.5-Math.random(),size:5+Math.random()*5,alpha:1})));for(let s of this.particles)s.y+=s.vy,s.alpha-=.02;this.particles=this.particles.filter(s=>s.alpha>0)}getColor(){return`rgb(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b})`}getShadowBlur(e){return e.module.heal?.playerHasTouched?this.baseShadowBlur*.1:this.baseShadowBlur+Math.sin(this.shadowPulse)*5}},Ye=class r{hp;playerOnly;touched=new Set;playerHasTouched=!1;constructor(e,t=!0){this.hp=e,this.playerOnly=t}reset(){this.touched.clear(),this.playerHasTouched=!1}onTouch(e){let t=e instanceof $;this.playerOnly&&!t||(t&&(this.playerHasTouched=!0),this.touched.has(e)||(this.touched.add(e),e.heal(this.hp)))}copy(){let e=new r(this.hp,this.playerOnly);return e.touched=new Set(this.touched),e}draw(e,t,s){s.update(e);let a=s.getShadowBlur(e);t.save(),t.shadowColor="rgba(100, 255, 100, 0.8)",t.shadowBlur=a,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),e.cancelRotation(t,()=>{for(let d of s.particles){t.save(),t.globalAlpha=d.alpha,t.strokeStyle="#B0FFB0",t.lineWidth=2,t.shadowColor="rgba(180, 255, 180, 0.8)",t.shadowBlur=a/2;let v=d.x,h=d.y,m=d.size/2;t.beginPath(),t.moveTo(v-m,h),t.lineTo(v+m,h),t.moveTo(v,h-m),t.lineTo(v,h+m),t.stroke(),t.restore()}})}generateAnimator(e){return new le}},be=class r{vx;vy;constructor(e=0,t=0){this.vx=e,this.vy=t}update(e,t){if(e.x+=this.vx,e.y+=this.vy,!t.containsBox(e.x,e.y,e.w,e.h)){let s=null;for(let a of t.adjacentRooms)a.containsBox(e.x,e.y,e.w,e.h)&&(s=a);s?e.toMove=s:e.toRemove=!0}}reset(){}copy(){return new r(this.vx,this.vy)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},ze=class r{ax;ay;constructor(e,t){this.ax=e,this.ay=t}update(e){if(!e.module.speed)throw new Error("AccelerationModule requires SpeedModule to be used");e.module.speed.vx+=this.ax,e.module.speed.vy+=this.ay}reset(){}copy(){return new r(this.ax,this.ay)}draw(e,t,s){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},$e=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,s=t*.5,a=e.createRadialGradient(0,0,0,0,0,t*1.5);a.addColorStop(0,`rgba(255, 255, 180, ${this.alpha})`),a.addColorStop(1,"rgba(255, 200, 0, 0)"),e.fillStyle=a,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(s,-t+s,t,0),e.quadraticCurveTo(t-s,s,0,t),e.quadraticCurveTo(-s,t-s,-t,0),e.quadraticCurveTo(-t+s,-s,0,-t),e.closePath(),e.fill(),e.restore()}},_e=class{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>le.PRODUCTION&&(this.production-=le.PRODUCTION,this.particles.push(new $e(e,t))),this.particles=this.particles.filter(s=>s.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Fe=class r{gain;helper;constructor(e,t=12){this.gain=e,this.helper=new ge(t)}reset(){this.helper.reset()}onTouch(e,t){e instanceof $&&this.helper.track(e,t)&&e.restoreJumpAdd(this.gain)}copy(){return new r(this.gain)}draw(e,t,s){t.save(),t.shadowColor="rgba(255, 230, 100, 0.9)",t.shadowBlur=15,t.fillStyle="rgba(255, 220, 0, 0.6)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),s.update(e.w,e.h),e.cancelRotation(t,()=>s.draw(t))}generateAnimator(e){return new _e}},Ge=class r{start;speed;angle;constructor(e,t){this.start=e,this.speed=t,this.angle=e}update(){this.angle+=this.speed,this.angle>=360&&(this.angle-=360)}reset(){this.angle=this.start}getAngle(){let e=Math.PI*2;return(this.angle%e+e)%e}copy(){let e=new r(this.start,this.speed);return e.angle=this.angle,e}},Ve=class{time=0;getColor(){let e=.7+.3*Math.sin(this.time*4),t=0,s=Math.floor(150+50*e);return`rgb(${t}, ${s}, 255)`}getShadowBlur(e){return e+15*Math.sin(this.time*4)}},Ne=class{type;constructor(e){this.type=e}draw(e,t,s){s.time+=.015;function a(d){t.save(),t.shadowColor="rgba(0, 200, 255, 0.9)",t.shadowBlur=d,t.fillStyle=s.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),t.lineWidth=2,t.strokeStyle="rgba(0, 150, 255, 0.8)",t.strokeRect(-e.w/2,-e.h/2,e.w,e.h)}a(s.getShadowBlur(100)),a(s.getShadowBlur(70)),a(s.getShadowBlur(40))}generateAnimator(e){return new Ve}},je=class r{rythm;couldown;blocks;index=0;constructor(e,t,s){this.rythm=e,this.couldown=t?1:e,this.blocks=s}update(e,t){if(--this.couldown<=0){this.couldown+=this.rythm;let s=this.blocks[this.index];++this.index>=this.blocks.length&&(this.index-=this.blocks.length);let a=s.build(e);a&&(a.fromSpawner=!0,t.blocks.push(a))}}copy(){let e=new r(this.rythm,!1,this.blocks);return e.couldown=this.couldown,e.index=this.index,e}},ue=class r{static DEFAULT_SIZE=50;dx;dy;w;h;keepRotation;goal;module;constructor(e,t={}){this.dx=t.dx??0,this.dy=t.dy??0,this.w=t.w??r.DEFAULT_SIZE,this.h=t.h??r.DEFAULT_SIZE,this.goal=t.goal??0,this.keepRotation=t.keepRotation??!1,this.module=e}build(e){return this.module?new E(e.x+this.dx,e.y+this.dy,this.w,this.h,this.module.copy()):null}},S=class r{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal;checkCollision;runInAdjacentRoom;constructor(e){this.moving=e.moving,this.rotation=e.rotation,this.couldownedAttack=e.couldownedAttack,this.continuousAttack=e.continuousAttack,this.bounce=e.bounce,this.kill=e.kill,this.heal=e.heal,this.touchDespawn=e.touchDespawn,this.restoreJump=e.restoreJump,this.couldownDespawn=e.couldownDespawn,this.spawner=e.spawner,this.speed=e.speed,this.acceleration=e.acceleration,this.acceleration&&!this.speed&&(this.speed=new be(0,0)),this.runInAdjacentRoom=!!e.runInAdjacentRoom,e.goal&&(this.goal=new Ne(e.goal)),this.checkCollision=[e.couldownedAttack,e.continuousAttack,e.bounce,e.kill,e.heal,e.touchDespawn,e.restoreJump,e.goal].some(t=>t)}copy(){return new r({moving:this.moving?.copy(),rotation:this.rotation?.copy(),couldownedAttack:this.couldownedAttack?.copy(),continuousAttack:this.continuousAttack?.copy(),bounce:this.bounce?.copy(),kill:this.kill?.copy(),heal:this.heal?.copy(),touchDespawn:this.touchDespawn?.copy(),restoreJump:this.restoreJump?.copy(),couldownDespawn:this.couldownDespawn?.copy(),spawner:this.spawner?.copy(),speed:this.speed?.copy(),acceleration:this.acceleration?.copy(),runInAdjacentRoom:this.runInAdjacentRoom})}getDrawModule(e){let t=[this.goal,this.kill,this.heal,this.couldownedAttack,this.continuousAttack,this.restoreJump,this.bounce,this.moving,this.speed,this.acceleration],s=e;for(let a of t)if(a){if(s===0)return a;s--}return null}},E=class{x;y;w;h;start_x;start_y;start_w;start_h;module;toRemove=!1;addAtReset=!1;toMove=null;spawnRoom;fromSpawner=!1;drawMode;drawAnimator;constructor(e,t,s,a,d){this.x=e,this.y=t,this.w=s,this.h=a,this.start_x=e,this.start_y=t,this.start_w=s,this.start_h=a,this.module=d,this.drawMode=d.getDrawModule(0),this.drawMode?this.drawAnimator=this.drawMode.generateAnimator(this):this.drawAnimator=void 0}getRotation(){return this.module.rotation?this.module.rotation.getAngle():0}handleTouch(e,t){let s=e.getSize();Q.checkRectRectCollision({x:this.x,y:this.y,w:this.w,h:this.h,r:this.getRotation()},{x:e.x,y:e.y,w:s.x,h:s.y,r:e.getRotation()})&&(this.module.couldownedAttack?.onTouch(e),this.module.continuousAttack?.onTouch(e),this.module.bounce?.onTouch(e,t.frame),this.module.kill?.onTouch(e),this.module.heal?.onTouch(e),this.module.touchDespawn?.onTouch(e,this),this.module.restoreJump?.onTouch(e,t.frame),this.module.goal&&(t.goalComplete=this.module.goal.type))}init(e){this.spawnRoom=e}frame(e,t){this.module.moving?.update(this,t),this.module.speed?.update(this,t),this.module.acceleration?.update(this),this.module.rotation?.update(),this.module.couldownedAttack?.update(this),this.module.couldownDespawn?.update(this),this.module.spawner?.update(this,t),this.module.bounce?.update(),this.module.checkCollision&&this.handleTouch(e.player,e),this.toRemove&&!this.fromSpawner&&this.spawnRoom.missingBlocks.push(this)}reset(){this.x=this.start_x,this.y=this.start_y,this.w=this.start_w,this.h=this.start_h,this.module.moving?.reset(),this.module.rotation?.reset(),this.module.couldownedAttack?.reset(),this.module.continuousAttack?.reset(),this.module.bounce?.reset(),this.module.kill?.reset(),this.module.heal?.reset(),this.module.touchDespawn?.reset(),this.module.restoreJump?.reset(),this.module.couldownDespawn?.reset()}draw(e){e.fillStyle="#555",e.save(),e.translate(this.x,this.y),this.module.rotation&&e.rotate(this.module.rotation.getAngle()),this.drawMode?this.drawMode.draw(this,e,this.drawAnimator):this.drawAsDefault(e),e.restore()}drawAsDefault(e){e.fillStyle="#555",e.fillRect(-this.w/2,-this.h/2,this.w,this.h)}cancelRotation(e,t){this.module.rotation?(e.save(),e.rotate(-this.module.rotation.getAngle()),t(),e.restore()):t()}},ve={MovingPath:Ce,MovingModule:ke,CouldownedAttackModule:Ee,ContinuousAttackModule:Ie,BounceModule:He,KillModule:Oe,CouldownDespawnModule:We,TouchDespawnModule:Xe,HealModule:Ye,SpeedModule:be,AccelerationModule:ze,RestoreJumpModule:Fe,RotationModule:Ge,SpawnerModule:je};var L=class{x;y;w;h;blocks;missingBlocks=[];adjacentRooms=null;adjacenceRects=null;constructor(e,t,s,a,d){this.x=e,this.y=t,this.w=s,this.h=a,this.blocks=d}fillAdjacenceRects(){let e=this.adjacentRooms,t=[],s=20,a=[{name:"top",start:this.x,end:this.x+this.w,coord:this.y},{name:"bottom",start:this.x,end:this.x+this.w,coord:this.y+this.h},{name:"left",start:this.y,end:this.y+this.h,coord:this.x},{name:"right",start:this.y,end:this.y+this.h,coord:this.x+this.w}];for(let d of a){let v=[];for(let u of e)if(d.name==="top"&&u.y+u.h===this.y){let n=Math.max(this.x,u.x),w=Math.min(this.x+this.w,u.x+u.w);n<w&&v.push({start:n,end:w})}else if(d.name==="bottom"&&u.y===this.y+this.h){let n=Math.max(this.x,u.x),w=Math.min(this.x+this.w,u.x+u.w);n<w&&v.push({start:n,end:w})}else if(d.name==="left"&&u.x+u.w===this.x){let n=Math.max(this.y,u.y),w=Math.min(this.y+this.h,u.y+u.h);n<w&&v.push({start:n,end:w})}else if(d.name==="right"&&u.x===this.x+this.w){let n=Math.max(this.y,u.y),w=Math.min(this.y+this.h,u.y+u.h);n<w&&v.push({start:n,end:w})}v.sort((u,n)=>u.start-n.start);let h=[];for(let u of v)h.length===0||h[h.length-1].end<u.start?h.push({...u}):h[h.length-1].end=Math.max(h[h.length-1].end,u.end);let m=d.start;for(let u of h)m<u.start&&(d.name==="top"?t.push({x:m,y:this.y,w:u.start-m,h:s}):d.name==="bottom"?t.push({x:m,y:this.y+this.h-s,w:u.start-m,h:s}):d.name==="left"?t.push({x:this.x,y:m,w:s,h:u.start-m}):d.name==="right"&&t.push({x:this.x+this.w-s,y:m,w:s,h:u.start-m})),m=u.end;m<d.end&&(d.name==="top"?t.push({x:m,y:this.y,w:d.end-m,h:s}):d.name==="bottom"?t.push({x:m,y:this.y+this.h-s,w:d.end-m,h:s}):d.name==="left"?t.push({x:this.x,y:m,w:s,h:d.end-m}):d.name==="right"&&t.push({x:this.x+this.w-s,y:m,w:s,h:d.end-m}))}this.adjacenceRects=t}contains(e,t){return e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h}containsBox(e,t,s,a){let d=this.x,v=this.x+this.w,h=this.y,m=this.y+this.h,u=e-s/2,n=e+s/2,w=t-a/2,g=t+a/2;return v>=u&&d<=n&&m>=w&&h<=g}init(){let e=this.blocks.length;for(let t=0;t<e;t++)this.blocks[t].init(this)}frame(e,t){for(let s=this.blocks.length-1;s>=0;s--){let a=this.blocks[s];a.frame(e,this),a.toRemove&&(this.blocks.splice(s,1),a.toRemove=!1,a.toMove=null),a.toMove&&(t.push({block:a,dest:a.toMove}),this.blocks.splice(s,1),a.toMove=null)}}reset(){for(let e of this.missingBlocks)this.blocks.push(e);this.missingBlocks.length=0;for(let e=this.blocks.length-1;e>=0;e--)this.blocks[e].fromSpawner?this.blocks.splice(e,1):this.blocks[e].reset()}drawAdjacenceRects(e,t,s){let a=t.getSize(),d={x:t.x,y:t.y,w:a.x,h:a.y,r:0};for(let v of this.adjacenceRects){let h=Q.checkRectRectCollision({x:v.x,y:v.y,w:v.w,h:v.h,r:0},d);s===h&&e.fillRect(v.x,v.y,v.w,v.h)}}draw(e){for(let t of this.blocks)t.draw(e)}};var J=class{rooms;currentRoom;constructor(e){this.rooms=e,this.fillAdjacentRooms();for(let s of e)s.fillAdjacenceRects();let t=this.findRoom(0,0);if(t===null)throw new Error("Missing spawn room");this.currentRoom=t;for(let s of this.rooms)s.init()}fillAdjacentRooms(){for(let e=0;e<this.rooms.length;e++){let t=this.rooms[e];t.adjacentRooms=[];for(let s=0;s<this.rooms.length;s++){if(e===s)continue;let a=this.rooms[s];if(t.x>=a.x&&t.y>=a.y&&t.x+t.w<=a.x+a.w&&t.y+t.h<=a.y+a.h)throw new Error("A room touches another");let d=(t.x+t.w===a.x||a.x+a.w===t.x)&&t.y<a.y+a.h&&t.y+t.h>a.y,v=(t.y+t.h===a.y||a.y+a.h===t.y)&&t.x<a.x+a.w&&t.x+t.w>a.x;(d||v)&&t.adjacentRooms.push(a)}}}findRoom(e,t){for(let s of this.rooms)if(s.contains(e,t))return s;return null}frame(e){let t=[];this.currentRoom.frame(e,t);for(let s of this.currentRoom.adjacentRooms)s.frame(e,t);for(let s of t)s.dest.blocks.push(s.block)}drawAdjacenceRects(e,t){let d=[],v=t.getSize(),h={x:t.x,y:t.y,w:v.x,h:v.y,r:0};function m(n){return Q.getPointRectDist({x:n.x+n.w/2,y:n.y+n.h/2,w:n.w,h:n.h,r:0},h)}function u(n){for(let w of n.adjacenceRects){let g=m(w);g>400?e.fillRect(w.x,w.y,w.w,w.h):g>70?d.push({rect:w,factor:1-(g-70)/330}):d.push({rect:w,factor:1})}}e.fillStyle="white",u(this.currentRoom);for(let n of this.currentRoom.adjacentRooms)u(n);d.sort((n,w)=>n.factor-w.factor);for(let n of d){let w=[255,255,255],g=[247,112,34],R=Math.round(w[0]+(g[0]-w[0])*n.factor),M=Math.round(w[1]+(g[1]-w[1])*n.factor),A=Math.round(w[2]+(g[2]-w[2])*n.factor);e.fillStyle=`rgb(${R}, ${M}, ${A})`,e.fillRect(n.rect.x,n.rect.y,n.rect.w,n.rect.h)}}update(e,t,s,a){if(this.currentRoom.contains(e,t))return"same";let d=this.findRoom(e,t);return d?(this.currentRoom=d,"new"):this.currentRoom.containsBox(e,t,s,a)?"same":"out"}reset(){for(let e of this.rooms)e.reset()}};var{MovingPath:Ko,MovingModule:qo,CouldownedAttackModule:K,ContinuousAttackModule:Ue,BounceModule:ee,KillModule:V,CouldownDespawnModule:Zo,TouchDespawnModule:lo,HealModule:de,SpeedModule:dt,AccelerationModule:Qo,RestoreJumpModule:Je,RotationModule:en,SpawnerModule:ht}=ve,ct=[[new J([new L(-800,-450,1600,900,[new E(0,412.5,800,75,new S({bounce:new ee(.91,.003)})),new E(-662.5,-287.5,75,75,new S({kill:new V})),new E(-562.5,-187.5,75,75,new S({kill:new V})),new E(-662.5,-87.5,75,75,new S({kill:new V})),new E(-562.5,12.5,75,75,new S({kill:new V})),new E(575,300,100,100,new S({heal:new de(2)})),new E(312.5,-137.5,175,175,new S({restoreJump:new Je(2)})),new E(-662.5,112.5,75,75,new S({kill:new V}))]),new L(800,-450,1600,900,[new E(1600,0,800,450,new S({couldownedAttack:new K(1.5,100)}))]),new L(2e3,450,1200,625,[new E(2675,675,250,250,new S({heal:new de(12)}))]),new L(2800,-450,1600,900,[new E(3237.5,112.5,75,675,new S({kill:new V})),new E(3962.5,-112.5,75,675,new S({kill:new V})),new E(4e3,337.5,800,225,new S({restoreJump:new Je(1.7)}))]),new L(4e3,-1350,1600,900,[new E(4800,-900,400,700,new S({continuousAttack:new Ue(.04)})),new E(5175,-1162.5,50,375,new S({couldownedAttack:new K(1,120)}))]),new L(5200,-2250,1600,900,[new E(5425,-1500,350,150,new S({heal:new de(2)}))]),new L(6400,-1350,1600,900,[new E(7200,-900,150,150,new S({goal:1}))])]),new J([new L(-800,-450,1600,900,[new E(0,200,100,100,new S({bounce:new ee(1,.003)})),new E(500,200,100,100,new S({bounce:new ee(.9,.04)}))]),new L(800,-650,1600,900,[new E(1600,-200,300,300,new S({couldownedAttack:new K(1.8,100)}))]),new L(2400,-450,1600,900,[new E(2900,100,100,700,new S({couldownedAttack:new K(1,100)})),new E(3200,-150,100,600,new S({kill:new V})),new E(3500,100,100,700,new S({couldownedAttack:new K(1,100)})),new E(3200,400,300,50,new S({bounce:new ee(.9,.07)}))]),new L(4e3,-450,1600,900,[new E(4400,0,700,800,new S({continuousAttack:new Ue(.02)})),new E(5e3,0,200,200,new S({heal:new de(2)}))]),new L(5600,-950,1600,900,[new E(6450,-150,500,400,new S({continuousAttack:new Ue(.07)})),new E(6100,-400,100,700,new S({couldownedAttack:new K(1,100)})),new E(6400,-650,100,600,new S({kill:new V})),new E(6800,-400,100,700,new S({couldownedAttack:new K(1,100)})),new E(6400,-100,300,50,new S({bounce:new ee(.9,.07)})),new E(6600,-500,200,200,new S({restoreJump:new Je(1)}))]),new L(7e3,-50,700,900,[]),new L(7400,-950,1600,900,[new E(7900,-400,100,700,new S({kill:new V})),new E(8200,-650,100,600,new S({kill:new V})),new E(8700,-400,100,700,new S({kill:new V})),new E(8200,-100,300,50,new S({bounce:new ee(.9,.07)})),new E(8050,-60,20,20,new S({spawner:new ht(160,!0,[new ue(new S({couldownedAttack:new K(.5,100),speed:new dt(0,-5),touchDespawn:new lo}))])})),new E(8600,0,50,50,new S({spawner:new ht(160,!0,[new ue(new S({heal:new de(.9),speed:new dt(0,-5)}))])}))]),new L(9e3,-950,1600,900,[new E(9800,-500,100,100,new S({goal:1}))])])]];function uo(){let r=document.getElementById("gameCanvas");function e(){r.width=window.innerWidth,r.height=window.innerHeight}e(),window.addEventListener("resize",e);let t=localStorage.getItem("keyboardMode"),s;t!=="zqsd"&&t!=="wasd"?s="wasd":s=t;let a=r.getContext("2d"),d=new B(s,document,ct),v=document.getElementById("chrono");function h(){d.gameLogic(),d.gameDraw(a,r.width,r.height,(m,u,n)=>{d.drawMethod(m,u,n)}),v.innerText=d.generateChronoText(),window.running&&requestAnimationFrame(h)}window.game=d,window.running=!0,h()}window.game=null;window.running=!1;window.startGame=uo;var{MovingPath:hn,MovingModule:cn,CouldownedAttackModule:ho,ContinuousAttackModule:co,BounceModule:mo,KillModule:po,CouldownDespawnModule:wo,TouchDespawnModule:fo,HealModule:yo,SpeedModule:go,AccelerationModule:bo,RestoreJumpModule:vo,RotationModule:To,SpawnerModule:mn}=ve;function Mo(){let r=document.getElementById("gameCanvas"),e=document.getElementById("mode"),t=document.getElementById("panel"),s=r.getContext("2d"),a=[],d=[];function v(){r.width=window.innerWidth,r.height=window.innerHeight}v(),window.addEventListener("resize",v);let h=25,m={x:0,y:0,zoom:1},u={sx:0,sy:0,wx:0,wy:0,down:!1,button:-1},n={active:!1,type:null,target:null,startMouseX:0,startMouseY:0,startTargetX:0,startTargetY:0},w="default",g=!1,R={x:0,y:0},M=null,A=-1,I=null,H="default",O=[new L(-800,-450,1600,900,[])],W=[new J(O)],te=(o,i,l)=>Math.max(i,Math.min(l,o));function D(o){return Math.round(o/h-.5)*h}function G(o,i){let l=r.getBoundingClientRect(),c=(o-l.left)*(r.width/l.width),p=(i-l.top)*(r.height/l.height),f=r.width/B.WIDTH,b=r.height/B.HEIGHT,T=Math.min(f,b),x=(r.width-B.WIDTH*T)/2,k=(r.height-B.HEIGHT*T)/2,y=((c-x)/T-B.WIDTH_2)/m.zoom+m.x,C=((p-k)/T-B.HEIGHT_2)/m.zoom+m.y;return{x:y,y:C}}function he(){let o=G(u.sx,u.sy);u.wx=D(o.x),u.wy=D(o.y)}function Ke(o,i){let l=W[0];for(let c of l.rooms)for(let p of c.blocks){let f=p.w/2,b=p.h/2;if(o>=p.x-f&&o<=p.x+f&&i>=p.y-b&&i<=p.y+b)return p}return null}function ce(o,i){let l=W[0];for(let c of l.rooms)if(o>=c.x&&o<=c.x+c.w&&i>=c.y&&i<=c.y+c.h)return c;return null}function qe(o,i,l){let c=9/m.zoom,p=o.w/2,f=o.h/2,b=Math.abs(i-(o.x-p))<c,T=Math.abs(i-(o.x+p))<c,x=Math.abs(l-(o.y-f))<c,k=Math.abs(l-(o.y+f))<c;return x&&b?"top-left":x&&T?"top-right":k&&b?"bottom-left":k&&T?"bottom-right":b?"left":T?"right":x?"top":k?"bottom":null}function Ze(o,i,l){let c=19/m.zoom,p=Math.abs(i-o.x)<c,f=Math.abs(i-(o.x+o.w))<c,b=Math.abs(l-o.y)<c,T=Math.abs(l-(o.y+o.h))<c;return b&&p?"top-left":b&&f?"top-right":T&&p?"bottom-left":T&&f?"bottom-right":p?"left":f?"right":b?"top":T?"bottom":null}function Qe(o){return o&&{top:"ns-resize",bottom:"ns-resize",left:"ew-resize",right:"ew-resize","top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"}[o]||"default"}function et(o){let i=W[0];for(let l of i.rooms)if(l.containsBox(o.x,o.y,o.w,o.h))return l;return null}function mt(o,i){let l=o.x-o.w/2,c=o.x+o.w/2,p=o.y-o.h/2,f=o.y+o.h/2;return l>=i.x&&c<=i.x+i.w&&p>=i.y&&f<=i.y+i.h}function oe(){t.innerHTML="",t.classList.add("hidden"),M=null}function tt(o){t.classList.remove("hidden");let i=[],l=o.module.bounce?"checked":"",c=o.module.bounce?"block":"none",p=o.module.bounce?.factor||1,f=o.module.bounce?.cost||.003;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modBounce" ${l}> Bounce
				</label>
				<div id="bounceOptions" style="display: ${c}; margin-top: 10px; padding-left: 20px;">
					<label>Factor: <input type="number" id="bounceFactor" value="${p}" step="0.1" style="width: 80px;"></label><br>
					<label>Cost: <input type="number" id="bounceCost" value="${f}" step="0.001" style="width: 80px;"></label>
				</div>
			</div>
		`);let b=o.module.kill?"checked":"";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modKill" ${b}> Kill
				</label>
			</div>
		`);let T=o.module.heal?"checked":"",x=o.module.heal?"block":"none",k=o.module.heal?.hp||2;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modHeal" ${T}> Heal
				</label>
				<div id="healOptions" style="display: ${x}; margin-top: 10px; padding-left: 20px;">
					<label>HP: <input type="number" id="healHp" value="${k}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let y=o.module.couldownedAttack?"checked":"",C=o.module.couldownedAttack?"block":"none",_=o.module.couldownedAttack?.damages||1,X=o.module.couldownedAttack?.duration||100;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownAttack" ${y}> Cooldown Attack
				</label>
				<div id="cooldownAttackOptions" style="display: ${C}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="cooldownAttackDamages" value="${_}" step="0.1" style="width: 80px;"></label><br>
					<label>Duration: <input type="number" id="cooldownAttackDuration" value="${X}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let P=o.module.continuousAttack?"checked":"",Y=o.module.continuousAttack?"block":"none",q=o.module.continuousAttack?.damages||.02;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modContinuousAttack" ${P}> Continuous Attack
				</label>
				<div id="continuousAttackOptions" style="display: ${Y}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="continuousAttackDamages" value="${q}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let ne=o.module.restoreJump?"checked":"",se=o.module.restoreJump?"block":"none",re=o.module.restoreJump?.gain||1;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRestoreJump" ${ne}> Restore Jump
				</label>
				<div id="restoreJumpOptions" style="display: ${se}; margin-top: 10px; padding-left: 20px;">
					<label>Gain: <input type="number" id="restoreJumpGain" value="${re}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let bt=o.module.goal!==void 0?"checked":"",vt=o.module.goal!==void 0?"block":"none",Tt=o.module.goal?.type||1;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modGoal" ${bt}> Goal
				</label>
				<div id="goalOptions" style="display: ${vt}; margin-top: 10px; padding-left: 20px;">
					<label>Type: <input type="number" id="goalType" value="${Tt}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let Mt=o.module.moving?"checked":"",xt=o.module.moving?"block":"none";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modMoving" ${Mt}> Moving
				</label>
				<div id="movingOptions" style="display: ${xt}; margin-top: 10px; padding-left: 20px;">
					<p>Configure in code (MovingPath patterns)</p>
				</div>
			</div>
		`);let Rt=o.module.speed?"checked":"",Ct=o.module.speed?"block":"none",kt=o.module.speed?.vx||0,Dt=o.module.speed?.vy||0;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpeed" ${Rt}> Speed
				</label>
				<div id="speedOptions" style="display: ${Ct}; margin-top: 10px; padding-left: 20px;">
					<label>VX: <input type="number" id="speedVx" value="${kt}" step="0.5" style="width: 80px;"></label><br>
					<label>VY: <input type="number" id="speedVy" value="${Dt}" step="0.5" style="width: 80px;"></label>
				</div>
			</div>
		`);let Et=o.module.acceleration?"checked":"",St=o.module.acceleration?"block":"none",At=o.module.acceleration?.ax||0,It=o.module.acceleration?.ay||0;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modAcceleration" ${Et}> Acceleration
				</label>
				<div id="accelerationOptions" style="display: ${St}; margin-top: 10px; padding-left: 20px;">
					<label>AX: <input type="number" id="accelerationAx" value="${At}" step="0.01" style="width: 80px;"></label><br>
					<label>AY: <input type="number" id="accelerationAy" value="${It}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let Bt=o.module.rotation?"checked":"",Ht=o.module.rotation?"block":"none",Lt=o.module.rotation?.start||0,Pt=o.module.rotation?.speed||.01;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRotation" ${Bt}> Rotation
				</label>
				<div id="rotationOptions" style="display: ${Ht}; margin-top: 10px; padding-left: 20px;">
					<label>Start: <input type="number" id="rotationStart" value="${Lt}" step="0.1" style="width: 80px;"></label><br>
					<label>Speed: <input type="number" id="rotationSpeed" value="${Pt}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let Ot=o.module.spawner?"checked":"",Wt=o.module.spawner?"block":"none";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpawner" ${Ot}> Spawner
				</label>
				<div id="spawnerOptions" style="display: ${Wt}; margin-top: 10px; padding-left: 20px;">
					<p>Configure in code (BlockBuilder array)</p>
				</div>
			</div>
		`);let Xt=o.module.touchDespawn?"checked":"";i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modTouchDespawn" ${Xt}> Touch Despawn
				</label>
			</div>
		`);let Yt=o.module.couldownDespawn?"checked":"",zt=o.module.couldownDespawn?"block":"none",$t=o.module.couldownDespawn?.duration||100;i.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownDespawn" ${Yt}> Cooldown Despawn
				</label>
				<div id="cooldownDespawnOptions" style="display: ${zt}; margin-top: 10px; padding-left: 20px;">
					<label>Duration: <input type="number" id="cooldownDespawnDuration" value="${$t}" step="10" style="width: 80px;"></label>
				</div>
			</div>
		`),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px; max-height: 80vh; overflow-y: auto;">
				<h3>Block Properties</h3>
				<button id="deleteBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Block (Suppr)</button>
				<div>
					<label>X: <input type="number" id="blockX" value="${o.x}" step="${h}"></label><br>
					<label>Y: <input type="number" id="blockY" value="${o.y}" step="${h}"></label><br>
					<label>Width: <input type="number" id="blockW" value="${o.w}" step="${h}" min="${h}"></label><br>
					<label>Height: <input type="number" id="blockH" value="${o.h}" step="${h}" min="${h}"></label><br>
				</div>
				<div style="margin-top: 20px;">
					<h4>Modules</h4>
					${i.join("")}
				</div>
			</div>
		`,document.getElementById("deleteBtn").addEventListener("click",()=>{let F=et(o);if(F){let N=F.blocks.indexOf(o);N>=0&&F.blocks.splice(N,1)}oe()});let me=()=>{let F=parseFloat(document.getElementById("blockX").value),N=parseFloat(document.getElementById("blockY").value),j=parseFloat(document.getElementById("blockW").value),U=parseFloat(document.getElementById("blockH").value);o.x=D(F),o.y=D(N),o.w=Math.max(h,D(j)),o.h=Math.max(h,D(U))},_t=()=>{document.getElementById("blockX").value=o.x.toString(),document.getElementById("blockY").value=o.y.toString(),document.getElementById("blockW").value=o.w.toString(),document.getElementById("blockH").value=o.h.toString()};document.getElementById("blockX").addEventListener("change",me),document.getElementById("blockY").addEventListener("change",me),document.getElementById("blockW").addEventListener("change",me),document.getElementById("blockH").addEventListener("change",me);let Te=()=>{let F=document.getElementById("modBounce").checked,N=document.getElementById("modKill").checked,j=document.getElementById("modHeal").checked,U=document.getElementById("modCooldownAttack").checked,rt=document.getElementById("modContinuousAttack").checked,it=document.getElementById("modRestoreJump").checked,at=document.getElementById("modGoal").checked,Gt=document.getElementById("modMoving").checked,Me=document.getElementById("modSpeed").checked,xe=document.getElementById("modAcceleration").checked,Re=document.getElementById("modRotation").checked,Vt=document.getElementById("modSpawner").checked,Nt=document.getElementById("modTouchDespawn").checked,lt=document.getElementById("modCooldownDespawn").checked,jt=F?parseFloat(document.getElementById("bounceFactor").value):1,Ut=F?parseFloat(document.getElementById("bounceCost").value):.003,Jt=j?parseFloat(document.getElementById("healHp").value):2,Kt=U?parseFloat(document.getElementById("cooldownAttackDamages").value):1,qt=U?parseInt(document.getElementById("cooldownAttackDuration").value):100,Zt=rt?parseFloat(document.getElementById("continuousAttackDamages").value):.02,Qt=it?parseFloat(document.getElementById("restoreJumpGain").value):1,eo=at?parseInt(document.getElementById("goalType").value):1,to=Me?parseFloat(document.getElementById("speedVx").value):0,oo=Me?parseFloat(document.getElementById("speedVy").value):0,no=xe?parseFloat(document.getElementById("accelerationAx").value):0,so=xe?parseFloat(document.getElementById("accelerationAy").value):0,ro=Re?parseFloat(document.getElementById("rotationStart").value):0,io=Re?parseFloat(document.getElementById("rotationSpeed").value):.01,ao=lt?parseInt(document.getElementById("cooldownDespawnDuration").value):100,ut=new S({bounce:F?new mo(jt,Ut):void 0,kill:N?new po:void 0,heal:j?new yo(Jt):void 0,couldownedAttack:U?new ho(Kt,qt):void 0,continuousAttack:rt?new co(Zt):void 0,restoreJump:it?new vo(Qt):void 0,goal:at?eo:void 0,moving:Gt?o.module.moving:void 0,speed:Me?new go(to,oo):void 0,acceleration:xe?new bo(no,so):void 0,rotation:Re?new To(ro,io):void 0,spawner:Vt?o.module.spawner:void 0,touchDespawn:Nt?new fo:void 0,couldownDespawn:lt?new wo(ao):void 0});o.module=ut,o.drawMode=ut.getDrawModule(0),o.drawMode&&(o.drawAnimator=o.drawMode.generateAnimator(o))},z=(F,N)=>{let j=document.getElementById(F),U=document.getElementById(N);j&&U?j.addEventListener("change",()=>{U.style.display=j.checked?"block":"none",Te()}):j&&j.addEventListener("change",Te)};z("modBounce","bounceOptions"),z("modHeal","healOptions"),z("modCooldownAttack","cooldownAttackOptions"),z("modContinuousAttack","continuousAttackOptions"),z("modRestoreJump","restoreJumpOptions"),z("modGoal","goalOptions"),z("modSpeed","speedOptions"),z("modAcceleration","accelerationOptions"),z("modRotation","rotationOptions"),z("modCooldownDespawn","cooldownDespawnOptions"),z("modKill",""),z("modMoving","movingOptions"),z("modSpawner","spawnerOptions"),z("modTouchDespawn","");let Ft=["bounceFactor","bounceCost","healHp","cooldownAttackDamages","cooldownAttackDuration","continuousAttackDamages","restoreJumpGain","goalType","speedVx","speedVy","accelerationAx","accelerationAy","rotationStart","rotationSpeed","cooldownDespawnDuration"];for(let F of Ft){let N=document.getElementById(F);N&&N.addEventListener("change",Te)}o._updateDisplay=_t}function ot(o){t.classList.remove("hidden"),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px;">
				<h3>Room Properties</h3>
				<button id="deleteRoomBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Room (Suppr)</button>
				<div>
					<label>X: <input type="number" id="roomX" value="${o.x}" step="${h}"></label><br>
					<label>Y: <input type="number" id="roomY" value="${o.y}" step="${h}"></label><br>
					<label>Width: <input type="number" id="roomW" value="${o.w}" step="${h}" min="${h*4}"></label><br>
					<label>Height: <input type="number" id="roomH" value="${o.h}" step="${h}" min="${h*4}"></label><br>
				</div>
			</div>
		`,document.getElementById("deleteRoomBtn").addEventListener("click",()=>{let p=W[0],f=p.rooms.indexOf(o);f>=0&&p.rooms.splice(f,1),oe()});let l=()=>{let p=parseFloat(document.getElementById("roomX").value),f=parseFloat(document.getElementById("roomY").value),b=parseFloat(document.getElementById("roomW").value),T=parseFloat(document.getElementById("roomH").value);o.x=D(p),o.y=D(f),o.w=Math.max(h*4,D(b)),o.h=Math.max(h*4,D(T))},c=()=>{document.getElementById("roomX").value=o.x.toString(),document.getElementById("roomY").value=o.y.toString(),document.getElementById("roomW").value=o.w.toString(),document.getElementById("roomH").value=o.h.toString()};document.getElementById("roomX").addEventListener("change",l),document.getElementById("roomY").addEventListener("change",l),document.getElementById("roomW").addEventListener("change",l),document.getElementById("roomH").addEventListener("change",l),o._updateDisplay=c}t.addEventListener("mousedown",o=>{o.stopPropagation()}),t.addEventListener("click",o=>{o.stopPropagation()}),t.addEventListener("wheel",o=>{o.stopPropagation()}),t.addEventListener("pointerdown",o=>{o.stopPropagation()}),t.addEventListener("pointermove",o=>{o.stopPropagation()}),t.addEventListener("pointerup",o=>{o.stopPropagation()}),document.addEventListener("mousedown",o=>{let i=G(o.clientX,o.clientY);if(u.down=!0,u.button=o.button,u.sx=o.clientX,u.sy=o.clientY,u.wx=D(i.x),u.wy=D(i.y),w!=="play"){if(o.button===1){g=!0,R.x=o.clientX,R.y=o.clientY,o.preventDefault();return}if(o.button===2&&w==="default"){o.preventDefault(),n.active=!0,n.type="multi-select",n.createStartX=i.x,n.createStartY=i.y;return}if(o.button===0){if(w==="default"){let l=Ke(i.x,i.y);if(l){let c=qe(l,i.x,i.y);if(c){n.active=!0,n.type="resize-block",n.target=l,n.resizeEdge=c,n.startMouseX=i.x,n.startMouseY=i.y,n.startTargetX=l.x,n.startTargetY=l.y,n.startTargetW=l.w,n.startTargetH=l.h;return}n.active=!0,n.type="block",n.target=l,n.startMouseX=i.x,n.startMouseY=i.y,n.startTargetX=l.x,n.startTargetY=l.y,M=l,tt(l);return}n.active=!0,n.type="create-block",n.createStartX=D(i.x),n.createStartY=D(i.y)}else if(w==="rooms"){let l=ce(i.x,i.y);if(l){let c=Ze(l,i.x,i.y);if(c){n.active=!0,n.type="resize-room",n.target=l,n.resizeEdge=c,n.startMouseX=i.x,n.startMouseY=i.y,n.startTargetX=l.x,n.startTargetY=l.y,n.startTargetW=l.w,n.startTargetH=l.h;return}n.active=!0,n.type="room",n.target=l,n.startMouseX=i.x,n.startMouseY=i.y,n.startTargetX=l.x,n.startTargetY=l.y,M=l,ot(l);return}n.active=!0,n.type="create-room",n.createStartX=D(i.x),n.createStartY=D(i.y)}}}}),document.addEventListener("mouseup",o=>{if(u.down=!1,o.button===1&&(g=!1),o.button===2&&n.active&&n.type==="multi-select"){let i=G(o.clientX,o.clientY),l=Math.min(n.createStartX,i.x),c=Math.min(n.createStartY,i.y),p=Math.max(n.createStartX,i.x),f=Math.max(n.createStartY,i.y);a=[];let b=W[0];for(let T of b.rooms)for(let x of T.blocks){let k=x.x-x.w/2,y=x.x+x.w/2,C=x.y-x.h/2,_=x.y+x.h/2;k>=l&&y<=p&&C>=c&&_<=f&&a.push(x)}n.active=!1,n.type=null;return}if(o.button===0&&n.active){let i=G(o.clientX,o.clientY);if(n.type==="create-block"){let l=Math.min(n.createStartX,D(i.x)),c=Math.min(n.createStartY,D(i.y)),p=Math.max(n.createStartX,D(i.x))+h,f=Math.max(n.createStartY,D(i.y))+h,b=p-l,T=f-c;if(b>=h&&T>=h){let x=l+b/2,k=c+T/2,y=new E(x,k,b,T,new S({})),C=ce(y.x,y.y);if(C){let _=W[0],X=!0;for(let P of _.rooms){for(let Y of P.blocks){let q=Math.abs(y.x-Y.x),ne=Math.abs(y.y-Y.y),se=(y.w+Y.w)/2,re=(y.h+Y.h)/2;if(q<se&&ne<re){X=!1;break}}if(!X)break}X&&(C.blocks.push(y),M=y,tt(y))}}}else if(n.type==="create-room"){let l=Math.min(n.createStartX,D(i.x)),c=Math.min(n.createStartY,D(i.y)),p=Math.max(n.createStartX,D(i.x))+h,f=Math.max(n.createStartY,D(i.y))+h,b=p-l,T=f-c;if(b>=h*4&&T>=h*4){let x=new L(l,c,b,T,[]),k=W[0],y=!0;for(let C of k.rooms){let _=!(x.x+x.w<=C.x||x.x>=C.x+C.w),X=!(x.y+x.h<=C.y||x.y>=C.y+C.h);if(_&&X){y=!1;break}}y&&(k.rooms.push(x),M=x,ot(x))}}n.active=!1,n.type=null,n.target=null}}),document.addEventListener("mousemove",o=>{let i=G(o.clientX,o.clientY);if(u.sx=o.clientX,u.sy=o.clientY,u.wx=D(i.x),u.wy=D(i.y),w!=="play"&&!n.active&&!g){let l="default";if(w==="default"){let c=Ke(i.x,i.y);if(c){let p=qe(c,i.x,i.y);l=p?Qe(p):"move"}}else if(w==="rooms"){let c=ce(i.x,i.y);if(c){let p=Ze(c,i.x,i.y);l=p?Qe(p):"move"}}l!==H&&(H=l,r.style.cursor=l)}else g&&(r.style.cursor="grabbing");if(g){let l=(o.clientX-R.x)/m.zoom,c=(o.clientY-R.y)/m.zoom;m.x-=l,m.y-=c,R.x=o.clientX,R.y=o.clientY}if(n.active&&n.type==="block"&&n.target){let l=n.target,c=D(i.x)-D(n.startMouseX),p=D(i.y)-D(n.startMouseY),f=n.startTargetX+c,b=n.startTargetY+p,T=W[0],x=!0;for(let k of T.rooms){for(let y of k.blocks){if(y===l)continue;let C=Math.abs(f-y.x),_=Math.abs(b-y.y),X=(l.w+y.w)/2,P=(l.h+y.h)/2;if(C<X&&_<P){x=!1;break}}if(!x)break}x&&(l.x=f,l.y=b,l._updateDisplay&&l._updateDisplay())}else if(n.active&&n.type==="room"&&n.target){let l=n.target,c=D(i.x)-D(n.startMouseX),p=D(i.y)-D(n.startMouseY),f=n.startTargetX+c,b=n.startTargetY+p,T=W[0],x=!0;for(let k of T.rooms){if(k===l)continue;let y=!(f+l.w<=k.x||f>=k.x+k.w),C=!(b+l.h<=k.y||b>=k.y+k.h);if(y&&C){x=!1;break}}if(x){let k=f-l.x,y=b-l.y;for(let C of l.blocks)C.x+=k,C.y+=y;l.x=f,l.y=b,l._updateDisplay&&l._updateDisplay()}}else if(n.active&&n.type==="resize-block"&&n.target){let l=n.target,c=D(i.x)-D(n.startMouseX),p=D(i.y)-D(n.startMouseY),f=n.resizeEdge,b=h,T=o.shiftKey,x=n.startTargetX,k=n.startTargetY,y=n.startTargetW,C=n.startTargetH;if(T){let P=n.startTargetW/n.startTargetH;f.includes("left")||f.includes("right")?(y=f.includes("left")?n.startTargetW-c:n.startTargetW+c,y>=b?(C=y/P,C>=b?(f.includes("left"),x=n.startTargetX+c/2,f.includes("top")?k=n.startTargetY+(n.startTargetH-C)/2:f.includes("bottom")&&(k=n.startTargetY-(n.startTargetH-C)/2)):(y=n.startTargetW,C=n.startTargetH)):(y=n.startTargetW,C=n.startTargetH)):(C=f.includes("top")?n.startTargetH-p:n.startTargetH+p,C>=b?(y=C*P,y>=b?(f.includes("top"),k=n.startTargetY+p/2,f.includes("left")?x=n.startTargetX+(n.startTargetW-y)/2:f.includes("right")&&(x=n.startTargetX-(n.startTargetW-y)/2)):(y=n.startTargetW,C=n.startTargetH)):(y=n.startTargetW,C=n.startTargetH))}else f.includes("left")&&(y=n.startTargetW-c,y>=b?x=n.startTargetX+c/2:y=n.startTargetW),f.includes("right")&&(y=n.startTargetW+c,y>=b?x=n.startTargetX+c/2:y=n.startTargetW),f.includes("top")&&(C=n.startTargetH-p,C>=b?k=n.startTargetY+p/2:C=n.startTargetH),f.includes("bottom")&&(C=n.startTargetH+p,C>=b?k=n.startTargetY+p/2:C=n.startTargetH);let _=W[0],X=!0;for(let P of _.rooms){for(let Y of P.blocks){if(Y===l)continue;let q=Math.abs(x-Y.x),ne=Math.abs(k-Y.y),se=(y+Y.w)/2,re=(C+Y.h)/2;if(q<se&&ne<re){X=!1;break}}if(!X)break}X&&(l.x=x,l.y=k,l.w=y,l.h=C,l._updateDisplay&&l._updateDisplay())}else if(n.active&&n.type==="resize-room"&&n.target){let l=n.target,c=D(i.x)-D(n.startMouseX),p=D(i.y)-D(n.startMouseY),f=n.resizeEdge,b=h*4,T=o.shiftKey,x=n.startTargetX,k=n.startTargetY,y=n.startTargetW,C=n.startTargetH;if(T){let P=n.startTargetW/n.startTargetH;f.includes("left")||f.includes("right")?(y=f.includes("left")?n.startTargetW-c:n.startTargetW+c,y>=b?(C=y/P,C>=b?(f.includes("left")&&(x=n.startTargetX+c),f.includes("top")&&(k=n.startTargetY+(n.startTargetH-C))):(y=n.startTargetW,C=n.startTargetH)):(y=n.startTargetW,C=n.startTargetH)):(C=f.includes("top")?n.startTargetH-p:n.startTargetH+p,C>=b?(y=C*P,y>=b?(f.includes("top")&&(k=n.startTargetY+p),f.includes("left")&&(x=n.startTargetX+(n.startTargetW-y))):(y=n.startTargetW,C=n.startTargetH)):(y=n.startTargetW,C=n.startTargetH))}else f.includes("left")&&(y=n.startTargetW-c,y>=b?x=n.startTargetX+c:y=n.startTargetW),f.includes("right")&&(y=n.startTargetW+c,y<b&&(y=n.startTargetW)),f.includes("top")&&(C=n.startTargetH-p,C>=b?k=n.startTargetY+p:C=n.startTargetH),f.includes("bottom")&&(C=n.startTargetH+p,C<b&&(C=n.startTargetH));let _=W[0],X=!0;for(let P of _.rooms){if(P===l)continue;let Y=!(x+y<=P.x||x>=P.x+P.w),q=!(k+C<=P.y||k>=P.y+P.h);if(Y&&q){X=!1;break}}if(X){let P={x,y:k,w:y,h:C};for(let Y of l.blocks)if(!mt(Y,P)){X=!1;break}}X&&(l.x=x,l.y=k,l.w=y,l.h=C,l._updateDisplay&&l._updateDisplay())}}),document.addEventListener("keydown",o=>{switch(o.code){case"F3":{o.preventDefault();let i=["default","rooms","play"],l=["black","#ff0044","rgb(0, 132, 255)"],c=i.indexOf(w);if(c===i.length-2){w="play";let p=15;oe(),A>=0&&clearInterval(A),A=setInterval(()=>{if(p--,p<=0){let f=localStorage.getItem("keyboardMode"),b="wasd";(f==="zqsd"||f==="wasd")&&(b=f);let T=new J(W[0].rooms.map(x=>new L(x.x,x.y,x.w,x.h,x.blocks.map(k=>new E(k.x,k.y,k.w,k.h,k.module.copy())))));I=new B(b,document,[[T]]),I.startLevel(T),e.textContent="play",clearInterval(A),A=-1}else e.textContent=`play (${(p/10).toFixed(1)})`},100),e.style.backgroundColor=l[2],e.textContent=`play (${(p/10).toFixed(1)})`}else if(w==="play")w="default",I=null,e.style.backgroundColor=l[0],e.textContent="default",A>=0&&(clearInterval(A),A=-1);else{let p=(c+1)%(i.length-1);w=i[p],e.style.backgroundColor=l[p],e.textContent=w}break}case"Escape":{M?oe():t.classList.toggle("hidden");break}case"Delete":{if(M){if(M instanceof E){let i=et(M);if(i){let l=i.blocks.indexOf(M);l>=0&&i.blocks.splice(l,1)}}else if(M instanceof L){let i=W[0],l=i.rooms.indexOf(M);l>=0&&i.rooms.splice(l,1)}oe()}break}case"KeyC":{if(o.ctrlKey&&a.length>0){o.preventDefault();let i=Math.min(...a.map(c=>c.x)),l=Math.min(...a.map(c=>c.y));d=a.map(c=>({module:c.module.copy(),dx:c.x-i,dy:c.y-l,w:c.w,h:c.h}))}break}case"KeyV":{if(o.ctrlKey&&d.length>0){o.preventDefault();let i=G(u.sx,u.sy),l=D(i.x),c=D(i.y);a=[];for(let p of d){let f=new E(l+p.dx,c+p.dy,p.w,p.h,p.module.copy()),b=ce(f.x,f.y);b&&(b.blocks.push(f),a.push(f))}}break}}}),document.addEventListener("wheel",o=>{o.preventDefault();let i=G(o.clientX,o.clientY),l=i.x,c=i.y,p=1.12,f=o.deltaY<0?p:1/p;m.zoom=te(m.zoom*f,.2,8)},{passive:!1}),document.addEventListener("contextmenu",o=>{w!=="play"&&o.preventDefault()});function pt(o){let i=Math.floor((m.x-B.WIDTH_2/m.zoom)/h)*h,l=Math.ceil((m.x+B.WIDTH_2/m.zoom)/h)*h,c=Math.floor((m.y-B.HEIGHT_2/m.zoom)/h)*h,p=Math.ceil((m.y+B.HEIGHT_2/m.zoom)/h)*h;o.strokeStyle="#444";let f=.3,b=1,T=3,x=16,k=9;for(let y=i;y<=l;y+=h)Math.floor(y/h)%(x*4)===0?o.lineWidth=T:Math.floor(y/h)%x===0?o.lineWidth=b:o.lineWidth=f,o.beginPath(),o.moveTo(y,c),o.lineTo(y,p),o.stroke();for(let y=c;y<=p;y+=h)Math.floor(y/h)%(k*4)===0?o.lineWidth=T:Math.floor(y/h)%k===0?o.lineWidth=b:o.lineWidth=f,o.beginPath(),o.moveTo(i,y),o.lineTo(l,y),o.stroke()}function wt(o){if(!n.active)return;let i=G(u.sx,u.sy);if(n.type==="create-block"){let l=Math.min(n.createStartX,D(i.x)),c=Math.min(n.createStartY,D(i.y)),p=Math.max(n.createStartX,D(i.x))+h,f=Math.max(n.createStartY,D(i.y))+h,b=p-l,T=f-c;o.strokeStyle="cyan",o.lineWidth=3,o.setLineDash([10,5]),o.strokeRect(l,c,b,T),o.setLineDash([])}else if(n.type==="create-room"){let l=Math.min(n.createStartX,D(i.x)),c=Math.min(n.createStartY,D(i.y)),p=Math.max(n.createStartX,D(i.x))+h,f=Math.max(n.createStartY,D(i.y))+h,b=p-l,T=f-c;o.strokeStyle="lime",o.lineWidth=3,o.setLineDash([10,5]),o.strokeRect(l,c,b,T),o.setLineDash([])}else if(n.type==="multi-select"){let l=Math.min(n.createStartX,i.x),c=Math.min(n.createStartY,i.y),p=Math.max(n.createStartX,i.x),f=Math.max(n.createStartY,i.y),b=p-l,T=f-c;o.strokeStyle="blue",o.fillStyle="rgba(0, 0, 255, 0.1)",o.lineWidth=2,o.setLineDash([5,5]),o.fillRect(l,c,b,T),o.strokeRect(l,c,b,T),o.setLineDash([])}}function nt(o,i){let l=8/m.zoom;o.fillStyle="cyan",o.strokeStyle="white",o.lineWidth=2/m.zoom;let c,p,f,b;i instanceof E?(c=i.x-i.w/2,p=i.y-i.h/2,f=i.w,b=i.h):(c=i.x,p=i.y,f=i.w,b=i.h);let T=[[c,p],[c+f,p],[c,p+b],[c+f,p+b]];for(let[k,y]of T)o.fillRect(k-l/2,y-l/2,l,l),o.strokeRect(k-l/2,y-l/2,l,l);let x=[[c+f/2,p],[c+f/2,p+b],[c,p+b/2],[c+f,p+b/2]];for(let[k,y]of x)o.fillRect(k-l/2,y-l/2,l,l),o.strokeRect(k-l/2,y-l/2,l,l)}function ft(o,i){i.module.rotation&&(o.save(),o.strokeStyle="rgba(255, 165, 0, 0.5)",o.lineWidth=2/m.zoom,o.setLineDash([5,5]),o.strokeRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h),o.setLineDash([]),o.restore())}function yt(o,i){i.module.spawner&&(o.save(),o.fillStyle="rgba(255, 0, 255, 0.3)",o.fillRect(i.x-i.w/2,i.y-i.h/2,i.w,i.h),o.fillStyle="magenta",o.font=`${Math.min(i.w,i.h)*.6}px Arial`,o.textAlign="center",o.textBaseline="middle",o.fillText("S",i.x,i.y),o.restore())}function gt(o){let i=r.width/B.WIDTH,l=r.height/B.HEIGHT,c=Math.min(i,l),p=(r.width-B.WIDTH*c)/2,f=(r.height-B.HEIGHT*c)/2;o.fillStyle="black",o.fillRect(0,0,r.width,r.height),o.save(),o.translate(p,f),o.scale(c,c),o.save(),o.translate(B.WIDTH_2,B.HEIGHT_2),o.scale(m.zoom,m.zoom),o.translate(-m.x,-m.y),pt(o);let b=W[0];o.fillStyle="#ccc2";for(let T of b.rooms)o.fillRect(T.x,T.y,T.w,T.h);for(let T of b.rooms)T.draw(o);for(let T of b.rooms)for(let x of T.blocks)x.module.rotation&&ft(o,x),x.module.spawner&&yt(o,x);o.strokeStyle="white",o.lineWidth=3;for(let T of b.rooms)o.strokeRect(T.x,T.y,T.w,T.h);o.strokeStyle="white",o.lineWidth=3;for(let T of b.rooms)o.strokeRect(T.x,T.y,T.w,T.h);if(M&&(M instanceof E?(o.strokeStyle="yellow",o.lineWidth=4/m.zoom,o.strokeRect(M.x-M.w/2,M.y-M.h/2,M.w,M.h),nt(o,M)):M instanceof L&&(o.strokeStyle="yellow",o.lineWidth=4/m.zoom,o.strokeRect(M.x,M.y,M.w,M.h),nt(o,M))),a.length>0){o.strokeStyle="blue",o.lineWidth=3/m.zoom;for(let T of a)o.strokeRect(T.x-T.w/2,T.y-T.h/2,T.w,T.h)}wt(o),o.fillStyle="rgba(255, 255, 255, 0.3)",o.fillRect(u.wx,u.wy,h,h),o.restore(),o.restore(),o.fillStyle="black",f>0&&o.fillRect(0,0,r.width,f),f>0&&o.fillRect(0,r.height-f,r.width,f),p>0&&o.fillRect(0,0,p,r.height),p>0&&o.fillRect(r.width-p,0,p,r.height),o.fillStyle="white",o.font="16px monospace",o.fillText(`Camera: (${m.x.toFixed(0)}, ${m.y.toFixed(0)}) Zoom: ${m.zoom.toFixed(2)}`,10,r.height-80),o.fillText(`Mouse: (${u.wx.toFixed(0)}, ${u.wy.toFixed(0)})`,10,r.height-60),o.fillText(`Mode: ${w} | Press F3 to change mode | Esc to deselect | Del to delete`,10,r.height-40),a.length>0&&o.fillText(`Selected blocks: ${a.length} | Ctrl+C to copy | Ctrl+V to paste`,10,r.height-20)}function st(){w==="play"&&I?(I.gameLogic(),I.gameDraw(s,r.width,r.height,(o,i,l)=>{I.drawMethod(o,i,l)})):gt(s),window.running&&requestAnimationFrame(st)}window.game=I,window.running=!0,st()}window.startEditor=Mo;})();
