(()=>{var ee={checkRectRectCollision(a,e){let t=(y,k)=>y.x*k.x+y.y*k.y,o=(y,k)=>({x:y.x-k.x,y:y.y-k.y}),s=y=>{let k=Math.hypot(y.x,y.y);return k===0?{x:0,y:0}:{x:y.x/k,y:y.y/k}},l=y=>{let k=y.w/2,A=y.h/2,R=Math.cos(y.r),H=Math.sin(y.r);return[{x:-k,y:-A},{x:k,y:-A},{x:k,y:A},{x:-k,y:A}].map(N=>({x:y.x+N.x*R-N.y*H,y:y.y+N.x*H+N.y*R}))},p=y=>{let k=[];for(let A=0;A<2;A++){let R=y[A],H=y[(A+1)%4],I=o(H,R),N={x:-I.y,y:I.x};k.push(s(N))}return k},v=(y,k)=>{let A=t(y[0],k),R=A;for(let H=1;H<y.length;H++){let I=t(y[H],k);I<A&&(A=I),I>R&&(R=I)}return{min:A,max:R}},h=(y,k)=>!(y.max<k.min||k.max<y.min);if(a.w<=0||a.h<=0||e.w<=0||e.h<=0)return!1;let u=l(a),m=l(e),i=[...p(u),...p(m)];for(let y of i){let k=v(u,y),A=v(m,y);if(!h(k,A))return!1}return!0},getPointRectDist(a,e){function t(u){let m=Math.cos(u.r),i=Math.sin(u.r),y=u.w/2,k=u.h/2;return[[-y,-k],[y,-k],[y,k],[-y,k]].map(([R,H])=>[u.x+R*m-H*i,u.y+R*i+H*m])}function o(u,m,i,y,k,A){let R=k-i,H=A-y,I=R*R+H*H;if(I===0)return Math.hypot(u-i,m-y);let N=((u-i)*R+(m-y)*H)/I;N=Math.max(0,Math.min(1,N));let se=i+N*R,L=y+N*H;return Math.hypot(u-se,m-L)}function s(u,m,i){let y=Math.cos(-i.r),k=Math.sin(-i.r),A=(u-i.x)*y-(m-i.y)*k,R=(u-i.x)*k+(m-i.y)*y;return Math.abs(A)<=i.w/2&&Math.abs(R)<=i.h/2}function l(u,m){let i=t(u),y=t(m),k=[[Math.cos(u.r),Math.sin(u.r)],[-Math.sin(u.r),Math.cos(u.r)],[Math.cos(m.r),Math.sin(m.r)],[-Math.sin(m.r),Math.cos(m.r)]];for(let[A,R]of k){let H=i.map(([D,U])=>D*A+U*R),I=y.map(([D,U])=>D*A+U*R),N=Math.min(...H),se=Math.max(...H),L=Math.min(...I),xe=Math.max(...I);if(se<L||xe<N)return!1}return!0}if(l(a,e))return 0;let p=t(a),v=t(e),h=1/0;for(let u=0;u<4;u++){let[m,i]=p[u];for(let y=0;y<4;y++){let[k,A]=v[y],[R,H]=v[(y+1)%4],I=o(m,i,k,A,R,H);h=Math.min(h,I)}}for(let u=0;u<4;u++){let[m,i]=v[u];for(let y=0;y<4;y++){let[k,A]=p[y],[R,H]=p[(y+1)%4],I=o(m,i,k,A,R,H);h=Math.min(h,I)}}return h}};var te=class{x;y;constructor(e,t){this.x=e,this.y=t}};var ye=class{x;y;hp;constructor(e,t,o){this.x=e,this.y=t,this.hp=o}getSize(){return new te(64,64)}draw(e){e.fillStyle="green";let t=this.getSize();e.fillRect(this.x-t.x/2,this.y-t.y/2,t.x,t.y)}getRotation(){return 0}heal(e){}bounce(e,t){}};var ue=class a{static FAST_DURATION=10;static SLOW_DURATION=60;orientation;x;y;w;h;sections;background;borderColor;animColor;value;valueReference;timer;animDuration;mode;fastValue;slowValue;fastTimer;slowTimer;targetValue;fastStartValue;slowStartValue;constructor(e,t,o,s,l,p,v,h,u,m){this.orientation=e,this.x=o,this.y=s,this.w=l,this.h=p,this.sections=v,this.background=u,this.borderColor=m,this.animColor=h,t=Math.max(0,Math.min(1,t)),this.value=t,this.valueReference=t,this.timer=-1,this.animDuration=0,this.mode=null,this.fastValue=t,this.slowValue=t,this.fastTimer=-1,this.slowTimer=-1,this.targetValue=t,this.fastStartValue=t,this.slowStartValue=t}animFunction(e){return 1-Math.pow(1-e,3)}setValue(e){e=Math.max(0,Math.min(1,e)),e!==this.targetValue&&(this.targetValue=e,e>this.value?(this.mode="up",this.slowStartValue=this.value,this.slowTimer=0,this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0):(this.mode="down",this.fastStartValue=this.value,this.fastValue=this.value,this.fastTimer=0,this.slowStartValue=this.value,this.slowTimer=0))}update(){let e=!1;if(this.fastTimer>=0)if(this.fastTimer++,this.fastTimer<=a.FAST_DURATION){let t=this.fastTimer/a.FAST_DURATION,o=this.animFunction(t);this.mode==="up"?this.fastValue=this.fastStartValue+(this.targetValue-this.fastStartValue)*o:this.value=this.fastStartValue+(this.targetValue-this.fastStartValue)*o,e=!0}else this.mode==="up"?this.fastValue=this.targetValue:this.value=this.targetValue,this.fastTimer=-1;if(this.slowTimer>=0)if(this.slowTimer++,this.slowTimer<=a.SLOW_DURATION){let t=this.slowTimer/a.SLOW_DURATION,o=this.animFunction(t);this.mode==="up"?this.value=this.slowStartValue+(this.targetValue-this.slowStartValue)*o:this.slowValue=this.slowStartValue+(this.targetValue-this.slowStartValue)*o,e=!0}else this.mode==="up"?this.value=this.targetValue:this.slowValue=this.targetValue,this.slowTimer=-1;e||(this.mode=null,this.fastValue=this.value,this.slowValue=this.value)}draw(e){this.background&&(e.fillStyle=this.background,e.fillRect(this.x,this.y,this.w,this.h));let t=2,o=this.x+t,s=this.y+t,l=this.w-2*t,p=this.h-2*t;this.drawSections(e,o,s,l,p,this.value),this.mode==="up"&&this.slowTimer>=0?this.drawAnimationBar(e,o,s,l,p,this.value,this.fastValue):this.mode==="down"&&this.slowTimer>=0&&this.drawAnimationBar(e,o,s,l,p,this.value,this.slowValue),e.strokeStyle=this.borderColor,e.lineWidth=t,e.strokeRect(this.x,this.y,this.w,this.h)}drawSections(e,t,o,s,l,p){let v=this.sections.length;if(this.orientation==="horizontal"){let h=s*p,u=s/v,m=2;for(let i=0;i<v;i++){let y=t+i*u,k=t+(i+1)*u,A=Math.max(y,t),R=Math.min(k,t+h);R>A&&(e.fillStyle=this.sections[i],e.fillRect(A,o,R-A,l)),i<v-1&&k<t+h&&(e.fillStyle="black",e.fillRect(k-m/2,o,m,l))}}else{let h=l*p,u=l/v,m=2;for(let i=0;i<v;i++){let y=o+l-(i+1)*u,k=o+l-i*u,A=Math.max(y,o+l-h),R=Math.min(k,o+l);R>A&&(e.fillStyle=this.sections[i],e.fillRect(t,A,s,R-A)),i<v-1&&y>o+l-h&&(e.fillStyle="black",e.fillRect(t,y-m/2,s,m))}}}drawAnimationBar(e,t,o,s,l,p,v){if(e.fillStyle=this.animColor,this.orientation==="horizontal"){let h=t+s*Math.min(p,v),u=s*Math.abs(v-p);e.fillRect(h,o,u,l)}else{let h=o+l*(1-Math.max(p,v)),u=l*Math.abs(v-p);e.fillRect(t,h,s,u)}}};var $=class a extends ye{static GRAVITY=.9;static DASH=20;static JUMP=25;static MAX_SPEED=25;static SPEED_INC=3;static SPEED_DEC=10;static JUMP_COUNT=3;static HP=3;static JUMP_HP_COST=1;static RESPAWN_COULDOWN=30;static DEATH_ANIM_COULDOWN=60;static SIZE=40;static SIZE_2=a.SIZE/2;vx=0;vy=0;eternalMode=!1;jumps=a.JUMP_COUNT;respawnCouldown=-1;jump_leveledBar=new ue("vertical",1,1500,150,30,600,["#FFA800","#FFD000","#FFF200"],"#fffdceff",null,"black");hp_leveledBar=new ue("horizontal",1,300,100,1e3,30,["#ff0044","#ff002f","#ff001a"],"#ffb1c5",null,"black");constructor(){super(0,0,a.HP),this.respawn()}getSize(){return new te(a.SIZE,a.SIZE)}consumeJump(e=1){if(this.jumps>0){this.jumps-=e,this.jump_leveledBar.setValue(this.jumps/a.JUMP_COUNT);return}this.hit(a.JUMP_HP_COST,null)}bounce(e,t){if(this.vy<=0)return;let o=t*this.vy;this.jumps>=o?(this.jumps-=o,this.jump_leveledBar.setValue(this.jumps/a.JUMP_COUNT)):(this.jumps=0,this.jump_leveledBar.setValue(0)),this.vy*=-e}restoreJumps(){this.jumps=a.JUMP_COUNT,this.jump_leveledBar.setValue(1)}restoreJumpAdd(e){let t=this.jumps+e;this.jumps=t>=a.JUMP_COUNT?a.JUMP_COUNT:t,this.jump_leveledBar.setValue(this.jumps/a.JUMP_COUNT)}restoreHp(){this.hp=a.HP,this.hp_leveledBar.setValue(1)}hit(e,t){this.eternalMode||this.isAlive()&&(this.hp-=e,this.hp_leveledBar.setValue(this.hp/a.HP),this.hp<=0&&this.kill())}heal(e){this.hp+=e,this.hp>=a.HP?(this.hp=a.HP,this.hp_leveledBar.setValue(1)):this.hp_leveledBar.setValue(this.hp/a.HP)}isAlive(){return this.respawnCouldown<=a.RESPAWN_COULDOWN}kill(){this.eternalMode||(this.respawnCouldown=a.DEATH_ANIM_COULDOWN)}respawn(){this.x=0,this.y=0,this.vx=0,this.vy=-a.JUMP,this.restoreHp(),this.restoreJumps()}getSpeed2(){return this.vx*this.vx+this.vy*this.vy}frame(e){this.respawnCouldown>=0&&(this.respawnCouldown--,this.respawnCouldown==a.RESPAWN_COULDOWN&&this.respawn());let t=e.inputHandler;t.press("left")?this.vx>0?this.vx-=a.SPEED_DEC:this.vx-=a.SPEED_INC:t.press("right")?this.vx<0?this.vx+=a.SPEED_DEC:this.vx+=a.SPEED_INC:this.vx>0?(this.vx-=a.SPEED_DEC,this.vx<0&&(this.vx=0)):this.vx<0&&(this.vx+=a.SPEED_DEC,this.vx>0&&(this.vx=0)),this.vx>a.MAX_SPEED&&(this.vx=a.MAX_SPEED),this.vx<-a.MAX_SPEED&&(this.vx=-a.MAX_SPEED),t.first("up")&&(this.consumeJump(),this.vy=-a.JUMP),this.vy+=a.GRAVITY,t.press("down")&&(this.y+=a.DASH),this.x+=this.vx*(this.eternalMode?3:1),this.y+=this.vy}draw(e){e.fillStyle="white",e.strokeStyle="black",e.lineWidth=5;let t=4,o=this.x-a.SIZE_2,s=this.y-a.SIZE_2,l=a.SIZE;e.fillRect(o,s,l,l),e.beginPath(),e.moveTo(o+t,s),e.lineTo(o+l-t,s),e.quadraticCurveTo(o+l,s,o+l,s+t),e.lineTo(o+l,s+l-t),e.quadraticCurveTo(o+l,s+l,o+l-t,s+l),e.lineTo(o+t,s+l),e.quadraticCurveTo(o,s+l,o,s+l-t),e.lineTo(o,s+t),e.quadraticCurveTo(o,s,o+t,s),e.closePath(),e.stroke()}drawInfos(e){this.jump_leveledBar.update(),this.jump_leveledBar.draw(e),this.hp_leveledBar.update(),this.hp_leveledBar.draw(e)}drawDeathTransition(e){if(this.respawnCouldown<0)return;e.fillStyle="#ff0044";function t(s){return Math.sin(s*Math.PI/2)}let o=t(this.respawnCouldown/a.DEATH_ANIM_COULDOWN);if(o<.5){let s=B.WIDTH*2*o;e.fillRect(B.WIDTH-s,0,s,B.HEIGHT)}else{let s=B.WIDTH*2*(1-o);e.fillRect(0,0,s,B.HEIGHT)}}};var Se=class{dx;dy;duration;constructor(e,t,o=-1){this.dx=e,this.dy=t,this.duration=o}},ge=class{liberationCouldown;usages=new Map;constructor(e){this.liberationCouldown=e}track(e,t){let o=this.usages.get(e);return this.usages.set(e,t+this.liberationCouldown),o===void 0||o<=t}reset(){this.usages.clear()}},Ie=class a{patterns;times;currentPattern;currentTime;loopCount;active;constructor(e,t){this.patterns=e,this.times=t,this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}update(e,t){if(!this.active||this.patterns.length===0)return;let o=this.patterns[this.currentPattern];if(e.x+=o.dx,e.y+=o.dy,this.currentTime++,o.duration!==-1&&this.currentTime>=o.duration&&(this.currentPattern++,this.currentTime=0,this.currentPattern>=this.patterns.length&&(this.loopCount++,this.times!==-1&&this.loopCount>=this.times?this.active=!1:this.currentPattern=0)),!t.containsBox(e.x,e.y,e.w,e.h)){let s=null;for(let l of t.adjacentRooms)l.containsBox(e.x,e.y,e.w,e.h)&&(s=l);s?e.toMove=s:e.toRemove=!0}}reset(){this.currentPattern=0,this.currentTime=0,this.loopCount=0,this.active=!0}copy(){let e=new a(this.patterns,this.times);return e.currentPattern=this.currentPattern,e.currentTime=this.currentTime,e.loopCount=this.loopCount,e.active=this.active,e}draw(e,t,o){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},He=class{spikes_x;spikes_y;spikes_w;spikes_h;constructor(e,t,o=32,s=32){this.spikes_x=Math.max(1,Math.ceil(e/o)),this.spikes_w=e/this.spikes_x,this.spikes_y=Math.max(1,Math.ceil(t/s)),this.spikes_h=t/this.spikes_y}},Be=class a{damages;duration;playerOnly;couldowns=new Map;constructor(e,t,o=!0){this.damages=e,this.duration=t,this.playerOnly=o}update(e){for(let[t,o]of this.couldowns){let s=o-1;s<=0?this.couldowns.delete(t):this.couldowns.set(t,s)}}reset(){this.couldowns.clear()}onTouch(e){this.playerOnly&&!(e instanceof $)||this.couldowns.has(e)||(this.couldowns.set(e,this.duration),e.hit(this.damages,null))}copy(){let e=new a(this.damages,this.duration,this.playerOnly);return e.couldowns=new Map(this.couldowns),e}draw(e,t,o){t.fillStyle="#9B59B6",t.fillRect(-e.w/2,-e.h/2,e.w,e.h);let s=1;for(let[p,v]of this.couldowns)if(p instanceof $){s=(this.duration-v)/this.duration,s<0&&(s=0),s>1&&(s=1);break}function l(p,v,h){let[u,m]=p,[i,y]=v,[k,A]=h;{let R=u+(k-u),H=m+(A-m),I=i+(k-i),N=y+(A-y);t.beginPath(),t.moveTo(u,m),t.lineTo(R,H),t.lineTo(I,N),t.lineTo(i,y),t.closePath(),t.fillStyle="#dec5ffff",t.fill()}if(t.beginPath(),t.moveTo(u,m),t.lineTo(k,A),t.lineTo(i,y),t.closePath(),t.strokeStyle="#FFEEAA",t.lineWidth=2,t.stroke(),s>0){let R=u+(k-u)*s,H=m+(A-m)*s,I=i+(k-i)*s,N=y+(A-y)*s;t.beginPath(),t.moveTo(u,m),t.lineTo(R,H),t.lineTo(I,N),t.lineTo(i,y),t.closePath(),t.fillStyle="#882dffff",t.fill()}}for(let p=0;p<o.spikes_x;p++){let v=-e.w/2+p*o.spikes_w+o.spikes_w/2,h=-e.h/2;l([v-o.spikes_w/2,h],[v+o.spikes_w/2,h],[v,h-o.spikes_h]);let u=e.h/2;l([v-o.spikes_w/2,u],[v+o.spikes_w/2,u],[v,u+o.spikes_h])}for(let p=0;p<o.spikes_y;p++){let v=-e.h/2+p*o.spikes_h+o.spikes_h/2,h=-e.w/2;l([h,v-o.spikes_w/2],[h,v+o.spikes_w/2],[h-o.spikes_h,v]);let u=e.w/2;l([u,v-o.spikes_w/2],[u,v+o.spikes_w/2],[u+o.spikes_h,v])}}generateAnimator(e){return new He(e.w,e.h)}},Pe=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,o=t*.5,s=e.createRadialGradient(0,0,0,0,0,t*1.5);s.addColorStop(0,`rgba(114, 0, 129, ${this.alpha})`),s.addColorStop(1,"rgba(114, 0, 129, 0)"),e.fillStyle=s,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(o,-t+o,t,0),e.quadraticCurveTo(t-o,o,0,t),e.quadraticCurveTo(-o,t-o,-t,0),e.quadraticCurveTo(-t+o,-o,0,-t),e.closePath(),e.fill(),e.restore()}},Oe=class a{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>a.PRODUCTION&&(this.production-=a.PRODUCTION,this.particles.push(new Pe(e,t))),this.particles=this.particles.filter(o=>o.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Le=class a{damages;playerOnly;constructor(e,t=!0){this.damages=e,this.playerOnly=t}reset(){}onTouch(e){this.playerOnly&&!(e instanceof $)||e.hit(this.damages,null)}copy(){return new a(this.damages,this.playerOnly)}draw(e,t,o){t.save(),t.shadowColor="rgb(111, 0, 255)",t.shadowBlur=50,t.fillStyle="rgba(212, 0, 255, 1)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),o.update(e.w,e.h),e.cancelRotation(t,()=>o.draw(t))}generateAnimator(e){return new Oe}},We=class{arrows=[];spacing;time=0;constructor(e,t=30){let o=Math.ceil(e/t);this.spacing=e/o;for(let s=0;s<o;s++)this.arrows.push({y:s*this.spacing})}getSpeed(){return Math.max(.3,Math.sin(this.time/2)*3)}update(e){this.time+=.1;let t=this.getSpeed();for(let o of this.arrows)o.y+=t,o.y>e&&(o.y-=e)}getArrows(){return this.arrows}getOpacity(e,t){let o=this.spacing;return e<o?e/o:e>t-o?(t-e)/o:1}},Ne=class a{cost;factor;playerOnly;helper;constructor(e,t,o=!0,s=12){this.factor=e,this.cost=t,this.playerOnly=o,this.helper=new ge(s)}reset(){this.helper.reset()}onTouch(e,t){this.playerOnly&&!(e instanceof $)||this.helper.track(e,t)&&e.bounce(this.factor,this.cost)}update(){}copy(){return new a(this.factor,this.cost,this.playerOnly)}draw(e,t,o){o.update(e.h),t.save(),t.shadowColor="rgba(255, 220, 100, 0.9)",t.shadowBlur=35;let s=t.createLinearGradient(-e.w/2,-e.h/2,e.w/2,e.h/2);s.addColorStop(0,"#FFE066"),s.addColorStop(1,"#FFAA00"),t.fillStyle=s,t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore();let l=e.w*.6,p=20;for(let v=0;v<o.getArrows().length;v++){let h=o.getArrows()[v],u=0,m=e.h/2-h.y-10,i=o.getOpacity(h.y,e.h);t.save(),t.globalAlpha=i,t.strokeStyle="#FFFF80",t.lineWidth=3,t.shadowColor="rgba(255, 240, 180, 1)",t.shadowBlur=20,t.beginPath(),t.moveTo(u,m-p/2),t.lineTo(u-l/2,m+p/2),t.moveTo(u,m-p/2),t.lineTo(u+l/2,m+p/2),t.stroke(),t.restore()}}generateAnimator(e){return new We(e.h)}},_e=class{x;y;r;vx;vy;alpha;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.r=2+Math.random()*4,this.vx=(Math.random()-.5)*.5,this.vy=-.5-Math.random()*1,this.alpha=1.4}update(){return this.x+=this.vx,this.y+=this.vy,this.alpha-=.01,this.alpha>0}draw(e){let t=e.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r*2);t.addColorStop(0,`rgba(200, 20, 0, ${this.alpha})`),t.addColorStop(1,"rgba(255, 30, 0, 0)"),e.fillStyle=t,e.beginPath(),e.arc(this.x,this.y,this.r,0,Math.PI*2),e.fill()}},Xe=class a{bubbles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>a.PRODUCTION&&(this.production-=a.PRODUCTION,this.bubbles.push(new _e(e,t))),this.bubbles=this.bubbles.filter(o=>o.update())}draw(e){this.bubbles.forEach(t=>t.draw(e))}},Ye=class a{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e){this.playerOnly&&!(e instanceof $)||e.hit(1/0,null)}copy(){return new a(this.playerOnly)}draw(e,t,o){t.save(),t.shadowColor="rgba(255,0,0,0.8)",t.shadowBlur=20,t.fillStyle="red",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),o.update(e.w,e.h),e.cancelRotation(t,()=>o.draw(t))}generateAnimator(e){return new Xe}},$e=class a{duration;couldown;constructor(e){this.duration=e,this.couldown=e}update(e){--this.couldown<=0&&(e.toRemove=!0)}reset(){this.couldown=this.duration}copy(){let e=new a(this.duration);return e.couldown=this.couldown,e}draw(e,t,o){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Fe=class a{playerOnly;constructor(e=!0){this.playerOnly=e}reset(){}onTouch(e,t){this.playerOnly&&!(e instanceof $)||(t.toRemove=!0)}copy(){return new a(this.playerOnly)}draw(e,t,o){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},de=class a{particles=[];usableColor={r:50,g:150,b:50};touchedColor={r:30,g:100,b:30};currentColor={r:50,g:150,b:50};baseShadowBlur=30;shadowPulse=0;production=0;static PRODUCTION=2e5;update(e){e.module.heal?.playerHasTouched?(this.currentColor.r+=(this.touchedColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.touchedColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.touchedColor.b-this.currentColor.b)*.05):(this.currentColor.r+=(this.usableColor.r-this.currentColor.r)*.05,this.currentColor.g+=(this.usableColor.g-this.currentColor.g)*.05,this.currentColor.b+=(this.usableColor.b-this.currentColor.b)*.05),e.module.heal?.playerHasTouched?this.shadowPulse=0:this.shadowPulse+=.04,e.module.heal?.playerHasTouched||(this.production+=e.w*e.h,this.production>a.PRODUCTION&&(this.production-=a.PRODUCTION,this.particles.push({x:(Math.random()-.5)*e.w*.8,y:(Math.random()-.5)*e.h*.8,vy:-.5-Math.random(),size:5+Math.random()*5,alpha:1})));for(let o of this.particles)o.y+=o.vy,o.alpha-=.02;this.particles=this.particles.filter(o=>o.alpha>0)}getColor(){return`rgb(${this.currentColor.r}, ${this.currentColor.g}, ${this.currentColor.b})`}getShadowBlur(e){return e.module.heal?.playerHasTouched?this.baseShadowBlur*.1:this.baseShadowBlur+Math.sin(this.shadowPulse)*5}},Ue=class a{hp;playerOnly;touched=new Set;playerHasTouched=!1;constructor(e,t=!0){this.hp=e,this.playerOnly=t}reset(){this.touched.clear(),this.playerHasTouched=!1}onTouch(e){let t=e instanceof $;this.playerOnly&&!t||(t&&(this.playerHasTouched=!0),this.touched.has(e)||(this.touched.add(e),e.heal(this.hp)))}copy(){let e=new a(this.hp,this.playerOnly);return e.touched=new Set(this.touched),e}draw(e,t,o){o.update(e);let s=o.getShadowBlur(e);t.save(),t.shadowColor="rgba(100, 255, 100, 0.8)",t.shadowBlur=s,t.fillStyle=o.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),e.cancelRotation(t,()=>{for(let l of o.particles){t.save(),t.globalAlpha=l.alpha,t.strokeStyle="#B0FFB0",t.lineWidth=2,t.shadowColor="rgba(180, 255, 180, 0.8)",t.shadowBlur=s/2;let p=l.x,v=l.y,h=l.size/2;t.beginPath(),t.moveTo(p-h,v),t.lineTo(p+h,v),t.moveTo(p,v-h),t.lineTo(p,v+h),t.stroke(),t.restore()}})}generateAnimator(e){return new de}},be=class a{vx;vy;constructor(e=0,t=0){this.vx=e,this.vy=t}update(e,t){if(e.x+=this.vx,e.y+=this.vy,!t.containsBox(e.x,e.y,e.w,e.h)){let o=null;for(let s of t.adjacentRooms)s.containsBox(e.x,e.y,e.w,e.h)&&(o=s);o?e.toMove=o:e.toRemove=!0}}reset(){}copy(){return new a(this.vx,this.vy)}draw(e,t,o){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},ze=class a{ax;ay;constructor(e,t){this.ax=e,this.ay=t}update(e){if(!e.module.speed)throw new Error("AccelerationModule requires SpeedModule to be used");e.module.speed.vx+=this.ax,e.module.speed.vy+=this.ay}reset(){}copy(){return new a(this.ax,this.ay)}draw(e,t,o){t.fillStyle="#555",t.fillRect(-e.w/2,-e.h/2,e.w,e.h)}generateAnimator(e){return null}},Ge=class{x;y;size;vx;vy;alpha;rotation;vr;constructor(e,t){this.x=(Math.random()-.5)*e,this.y=(Math.random()-.5)*t,this.size=3+Math.random()*4,this.vx=(Math.random()-.5)*.3,this.vy=-.4-Math.random()*.6,this.alpha=1.2,this.rotation=Math.random()*Math.PI,this.vr=(Math.random()-.5)*.04}update(){return this.x+=this.vx,this.y+=this.vy,this.rotation+=this.vr,this.alpha-=.01,this.alpha>0}draw(e){e.save(),e.translate(this.x,this.y),e.rotate(this.rotation);let t=this.size,o=t*.5,s=e.createRadialGradient(0,0,0,0,0,t*1.5);s.addColorStop(0,`rgba(255, 255, 180, ${this.alpha})`),s.addColorStop(1,"rgba(255, 200, 0, 0)"),e.fillStyle=s,e.beginPath(),e.moveTo(0,-t),e.quadraticCurveTo(o,-t+o,t,0),e.quadraticCurveTo(t-o,o,0,t),e.quadraticCurveTo(-o,t-o,-t,0),e.quadraticCurveTo(-t+o,-o,0,-t),e.closePath(),e.fill(),e.restore()}},Ve=class{particles=[];production=0;static PRODUCTION=2e5;update(e,t){this.production+=e*t,this.production>de.PRODUCTION&&(this.production-=de.PRODUCTION,this.particles.push(new Ge(e,t))),this.particles=this.particles.filter(o=>o.update())}draw(e){this.particles.forEach(t=>t.draw(e))}},Ke=class a{gain;helper;constructor(e,t=12){this.gain=e,this.helper=new ge(t)}reset(){this.helper.reset()}onTouch(e,t){e instanceof $&&this.helper.track(e,t)&&e.restoreJumpAdd(this.gain)}copy(){return new a(this.gain)}draw(e,t,o){t.save(),t.shadowColor="rgba(255, 230, 100, 0.9)",t.shadowBlur=15,t.fillStyle="rgba(255, 220, 0, 0.6)",t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),o.update(e.w,e.h),e.cancelRotation(t,()=>o.draw(t))}generateAnimator(e){return new Ve}},Je=class a{start;speed;angle;constructor(e,t){this.start=e,this.speed=t,this.angle=e}update(){this.angle+=this.speed,this.angle>=360&&(this.angle-=360)}reset(){this.angle=this.start}getAngle(){let e=Math.PI*2;return(this.angle%e+e)%e}copy(){let e=new a(this.start,this.speed);return e.angle=this.angle,e}},je=class{time=0;getColor(){let e=.7+.3*Math.sin(this.time*4),t=0,o=Math.floor(150+50*e);return`rgb(${t}, ${o}, 255)`}getShadowBlur(e){return e+15*Math.sin(this.time*4)}},qe=class{type;constructor(e){this.type=e}draw(e,t,o){o.time+=.015;function s(l){t.save(),t.shadowColor="rgba(0, 200, 255, 0.9)",t.shadowBlur=l,t.fillStyle=o.getColor(),t.fillRect(-e.w/2,-e.h/2,e.w,e.h),t.restore(),t.lineWidth=2,t.strokeStyle="rgba(0, 150, 255, 0.8)",t.strokeRect(-e.w/2,-e.h/2,e.w,e.h)}s(o.getShadowBlur(100)),s(o.getShadowBlur(70)),s(o.getShadowBlur(40))}generateAnimator(e){return new je}},Ze=class a{rythm;couldown;blocks;index=0;constructor(e,t,o){this.rythm=e,this.couldown=t?1:e,this.blocks=o}update(e,t){if(--this.couldown<=0){this.couldown+=this.rythm;let o=this.blocks[this.index];++this.index>=this.blocks.length&&(this.index-=this.blocks.length);let s=o.build(e);s&&(s.fromSpawner=!0,t.blocks.push(s))}}copy(){let e=new a(this.rythm,!1,this.blocks);return e.couldown=this.couldown,e.index=this.index,e}},he=class a{static DEFAULT_SIZE=50;dx;dy;w;h;keepRotation;goal;module;constructor(e,t={}){this.dx=t.dx??0,this.dy=t.dy??0,this.w=t.w??a.DEFAULT_SIZE,this.h=t.h??a.DEFAULT_SIZE,this.goal=t.goal??0,this.keepRotation=t.keepRotation??!1,this.module=e}build(e){return this.module?new C(e.x+this.dx,e.y+this.dy,this.w,this.h,this.module.copy()):null}},S=class a{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal;checkCollision;runInAdjacentRoom;constructor(e){this.moving=e.moving,this.rotation=e.rotation,this.couldownedAttack=e.couldownedAttack,this.continuousAttack=e.continuousAttack,this.bounce=e.bounce,this.kill=e.kill,this.heal=e.heal,this.touchDespawn=e.touchDespawn,this.restoreJump=e.restoreJump,this.couldownDespawn=e.couldownDespawn,this.spawner=e.spawner,this.speed=e.speed,this.acceleration=e.acceleration,this.acceleration&&!this.speed&&(this.speed=new be(0,0)),this.runInAdjacentRoom=!!e.runInAdjacentRoom,e.goal&&(this.goal=new qe(e.goal)),this.checkCollision=[e.couldownedAttack,e.continuousAttack,e.bounce,e.kill,e.heal,e.touchDespawn,e.restoreJump,e.goal].some(t=>t)}copy(){return new a({moving:this.moving?.copy(),rotation:this.rotation?.copy(),couldownedAttack:this.couldownedAttack?.copy(),continuousAttack:this.continuousAttack?.copy(),bounce:this.bounce?.copy(),kill:this.kill?.copy(),heal:this.heal?.copy(),touchDespawn:this.touchDespawn?.copy(),restoreJump:this.restoreJump?.copy(),couldownDespawn:this.couldownDespawn?.copy(),spawner:this.spawner?.copy(),speed:this.speed?.copy(),acceleration:this.acceleration?.copy(),runInAdjacentRoom:this.runInAdjacentRoom})}getDrawModule(e){let t=[this.goal,this.kill,this.heal,this.couldownedAttack,this.continuousAttack,this.restoreJump,this.bounce,this.moving,this.speed,this.acceleration],o=e;for(let s of t)if(s){if(o===0)return s;o--}return null}},C=class{x;y;w;h;start_x;start_y;start_w;start_h;module;toRemove=!1;addAtReset=!1;toMove=null;spawnRoom;fromSpawner=!1;drawMode;drawAnimator;constructor(e,t,o,s,l){this.x=e,this.y=t,this.w=o,this.h=s,this.start_x=e,this.start_y=t,this.start_w=o,this.start_h=s,this.module=l,this.drawMode=l.getDrawModule(0),this.drawMode?this.drawAnimator=this.drawMode.generateAnimator(this):this.drawAnimator=void 0}getRotation(){return this.module.rotation?this.module.rotation.getAngle():0}handleTouch(e,t){let o=e.getSize();ee.checkRectRectCollision({x:this.x,y:this.y,w:this.w,h:this.h,r:this.getRotation()},{x:e.x,y:e.y,w:o.x,h:o.y,r:e.getRotation()})&&(this.module.couldownedAttack?.onTouch(e),this.module.continuousAttack?.onTouch(e),this.module.bounce?.onTouch(e,t.frame),this.module.kill?.onTouch(e),this.module.heal?.onTouch(e),this.module.touchDespawn?.onTouch(e,this),this.module.restoreJump?.onTouch(e,t.frame),this.module.goal&&(t.goalComplete=this.module.goal.type))}init(e){this.spawnRoom=e}frame(e,t){this.module.moving?.update(this,t),this.module.speed?.update(this,t),this.module.acceleration?.update(this),this.module.rotation?.update(),this.module.couldownedAttack?.update(this),this.module.couldownDespawn?.update(this),this.module.spawner?.update(this,t),this.module.bounce?.update(),this.module.checkCollision&&this.handleTouch(e.player,e),this.toRemove&&!this.fromSpawner&&this.spawnRoom.missingBlocks.push(this)}reset(){this.x=this.start_x,this.y=this.start_y,this.w=this.start_w,this.h=this.start_h,this.module.moving?.reset(),this.module.rotation?.reset(),this.module.couldownedAttack?.reset(),this.module.continuousAttack?.reset(),this.module.bounce?.reset(),this.module.kill?.reset(),this.module.heal?.reset(),this.module.touchDespawn?.reset(),this.module.restoreJump?.reset(),this.module.couldownDespawn?.reset()}draw(e){e.fillStyle="#555",e.save(),e.translate(this.x,this.y),this.module.rotation&&e.rotate(this.module.rotation.getAngle()),this.drawMode?this.drawMode.draw(this,e,this.drawAnimator):this.drawAsDefault(e),e.restore()}drawAsDefault(e){e.fillStyle="#555",e.fillRect(-this.w/2,-this.h/2,this.w,this.h)}cancelRotation(e,t){this.module.rotation?(e.save(),e.rotate(-this.module.rotation.getAngle()),t(),e.restore()):t()}},oe={MovingPath:Se,MovingModule:Ie,CouldownedAttackModule:Be,ContinuousAttackModule:Le,BounceModule:Ne,KillModule:Ye,CouldownDespawnModule:$e,TouchDespawnModule:Fe,HealModule:Ue,SpeedModule:be,AccelerationModule:ze,RestoreJumpModule:Ke,RotationModule:Je,SpawnerModule:Ze};var P=class{x;y;w;h;blocks;missingBlocks=[];adjacentRooms=null;adjacenceRects=null;constructor(e,t,o,s,l){this.x=e,this.y=t,this.w=o,this.h=s,this.blocks=l}fillAdjacenceRects(){let e=this.adjacentRooms,t=[],o=20,s=[{name:"top",start:this.x,end:this.x+this.w,coord:this.y},{name:"bottom",start:this.x,end:this.x+this.w,coord:this.y+this.h},{name:"left",start:this.y,end:this.y+this.h,coord:this.x},{name:"right",start:this.y,end:this.y+this.h,coord:this.x+this.w}];for(let l of s){let p=[];for(let u of e)if(l.name==="top"&&u.y+u.h===this.y){let m=Math.max(this.x,u.x),i=Math.min(this.x+this.w,u.x+u.w);m<i&&p.push({start:m,end:i})}else if(l.name==="bottom"&&u.y===this.y+this.h){let m=Math.max(this.x,u.x),i=Math.min(this.x+this.w,u.x+u.w);m<i&&p.push({start:m,end:i})}else if(l.name==="left"&&u.x+u.w===this.x){let m=Math.max(this.y,u.y),i=Math.min(this.y+this.h,u.y+u.h);m<i&&p.push({start:m,end:i})}else if(l.name==="right"&&u.x===this.x+this.w){let m=Math.max(this.y,u.y),i=Math.min(this.y+this.h,u.y+u.h);m<i&&p.push({start:m,end:i})}p.sort((u,m)=>u.start-m.start);let v=[];for(let u of p)v.length===0||v[v.length-1].end<u.start?v.push({...u}):v[v.length-1].end=Math.max(v[v.length-1].end,u.end);let h=l.start;for(let u of v)h<u.start&&(l.name==="top"?t.push({x:h,y:this.y,w:u.start-h,h:o}):l.name==="bottom"?t.push({x:h,y:this.y+this.h-o,w:u.start-h,h:o}):l.name==="left"?t.push({x:this.x,y:h,w:o,h:u.start-h}):l.name==="right"&&t.push({x:this.x+this.w-o,y:h,w:o,h:u.start-h})),h=u.end;h<l.end&&(l.name==="top"?t.push({x:h,y:this.y,w:l.end-h,h:o}):l.name==="bottom"?t.push({x:h,y:this.y+this.h-o,w:l.end-h,h:o}):l.name==="left"?t.push({x:this.x,y:h,w:o,h:l.end-h}):l.name==="right"&&t.push({x:this.x+this.w-o,y:h,w:o,h:l.end-h}))}this.adjacenceRects=t}contains(e,t){return e>=this.x&&e<this.x+this.w&&t>=this.y&&t<this.y+this.h}containsBox(e,t,o,s){let l=this.x,p=this.x+this.w,v=this.y,h=this.y+this.h,u=e-o/2,m=e+o/2,i=t-s/2,y=t+s/2;return p>=u&&l<=m&&h>=i&&v<=y}init(){let e=this.blocks.length;for(let t=0;t<e;t++)this.blocks[t].init(this)}frame(e,t){for(let o=this.blocks.length-1;o>=0;o--){let s=this.blocks[o];s.frame(e,this),s.toRemove&&(this.blocks.splice(o,1),s.toRemove=!1,s.toMove=null),s.toMove&&(t.push({block:s,dest:s.toMove}),this.blocks.splice(o,1),s.toMove=null)}}reset(){for(let e of this.missingBlocks)this.blocks.push(e);this.missingBlocks.length=0;for(let e=this.blocks.length-1;e>=0;e--)this.blocks[e].fromSpawner?this.blocks.splice(e,1):this.blocks[e].reset()}drawAdjacenceRects(e,t,o){let s=t.getSize(),l={x:t.x,y:t.y,w:s.x,h:s.y,r:0};for(let p of this.adjacenceRects){let v=ee.checkRectRectCollision({x:p.x,y:p.y,w:p.w,h:p.h,r:0},l);o===v&&e.fillRect(p.x,p.y,p.w,p.h)}}draw(e){for(let t of this.blocks)t.draw(e)}};var J=class{rooms;currentRoom;constructor(e){this.rooms=e,this.fillAdjacentRooms();for(let o of e)o.fillAdjacenceRects();let t=this.findRoom(0,0);if(t===null)throw new Error("Missing spawn room");this.currentRoom=t;for(let o of this.rooms)o.init()}fillAdjacentRooms(){for(let e=0;e<this.rooms.length;e++){let t=this.rooms[e];t.adjacentRooms=[];for(let o=0;o<this.rooms.length;o++){if(e===o)continue;let s=this.rooms[o];if(t.x>=s.x&&t.y>=s.y&&t.x+t.w<=s.x+s.w&&t.y+t.h<=s.y+s.h)throw new Error("A room touches another");let l=(t.x+t.w===s.x||s.x+s.w===t.x)&&t.y<s.y+s.h&&t.y+t.h>s.y,p=(t.y+t.h===s.y||s.y+s.h===t.y)&&t.x<s.x+s.w&&t.x+t.w>s.x;(l||p)&&t.adjacentRooms.push(s)}}}findRoom(e,t){for(let o of this.rooms)if(o.contains(e,t))return o;return null}frame(e){let t=[];this.currentRoom.frame(e,t);for(let o of this.currentRoom.adjacentRooms)o.frame(e,t);for(let o of t)o.dest.blocks.push(o.block)}drawAdjacenceRects(e,t){let l=[],p=t.getSize(),v={x:t.x,y:t.y,w:p.x,h:p.y,r:0};function h(m){return ee.getPointRectDist({x:m.x+m.w/2,y:m.y+m.h/2,w:m.w,h:m.h,r:0},v)}function u(m){for(let i of m.adjacenceRects){let y=h(i);y>400?e.fillRect(i.x,i.y,i.w,i.h):y>70?l.push({rect:i,factor:1-(y-70)/330}):l.push({rect:i,factor:1})}}e.fillStyle="white",u(this.currentRoom);for(let m of this.currentRoom.adjacentRooms)u(m);l.sort((m,i)=>m.factor-i.factor);for(let m of l){let i=[255,255,255],y=[247,112,34],k=Math.round(i[0]+(y[0]-i[0])*m.factor),A=Math.round(i[1]+(y[1]-i[1])*m.factor),R=Math.round(i[2]+(y[2]-i[2])*m.factor);e.fillStyle=`rgb(${k}, ${A}, ${R})`,e.fillRect(m.rect.x,m.rect.y,m.rect.w,m.rect.h)}}update(e,t,o,s){if(this.currentRoom.contains(e,t))return"same";let l=this.findRoom(e,t);return l?(this.currentRoom=l,"new"):this.currentRoom.containsBox(e,t,o,s)?"same":"out"}reset(){for(let e of this.rooms)e.reset()}};var{MovingModule:un,CouldownedAttackModule:fo,ContinuousAttackModule:wo,BounceModule:ft,KillModule:yo,CouldownDespawnModule:go,TouchDespawnModule:bo,HealModule:vo,SpeedModule:ko,AccelerationModule:To,RestoreJumpModule:Mo,RotationModule:xo,SpawnerModule:dn}=oe;async function ve(a){let e=[],t=[0,0,0,0],o=[0,0,0,0],s=[],l=null,p=0,v=[];class h{moving;rotation;couldownedAttack;continuousAttack;bounce;kill;heal;touchDespawn;restoreJump;couldownDespawn;spawner;speed;acceleration;goal=0;checkCollision=!1;runInAdjacentRoom=!1}let u=null;function m(k){let A=Number(k);if(!Number.isFinite(A))throw new Error(`"${k}" is not a number`);return A}function i(){u&&(v.push(new C(o[0],o[1],o[2],o[3],new S(u))),o[0]=-1,o[1]=-1,o[2]=-1,o[3]=-1,u=null)}function y(k=!1){(k||v.length)&&(console.log(t[0],t[1],t[2],t[3]),e.push(new P(t[0],t[1],t[2],t[3],v)),v=[])}for await(let k of a())switch(l){case"room":{i(),y(),t[p]=m(k),p++,p===4&&(l="block",p=0);break}case"emptyroom":{i(),y(),t[p]=m(k),p++,p===4&&(l=null,p=0,y(!0));break}case"block":{o[p]=m(k),p++,p===4&&(l=null,p=0,u=new h);break}case"bounce":if(s.push(m(k)),s.length<2)break;u.bounce=new ft(s[1],s[0]),s.length=0,l=null;break;case"moving":throw"Moving todo";case"rotation":if(s.push(m(k)),s.length<2)break;u.rotation=new xo(s[0],s[1]),s.length=0,l=null;break;case"couldownedAttack":if(s.push(m(k)),s.length<2)break;u.couldownedAttack=new fo(s[0],s[1]),s.length=0,l=null;break;case"continuousAttack":if(s.push(m(k)),s.length<1)break;u.continuousAttack=new wo(s[0]),s.length=0,l=null;break;case"bounce":if(s.push(m(k)),s.length<2)break;u.bounce=new ft(s[0],s[1]),s.length=0,l=null;break;case"kill":if(s.push(m(k)),s.length<1)break;u.kill=new yo(!!s[0]),s.length=0,l=null;break;case"heal":if(s.push(m(k)),s.length<1)break;u.heal=new vo(s[0]),s.length=0,l=null;break;case"touchDespawn":if(s.push(m(k)),s.length<1)break;u.touchDespawn=new bo(!!s[0]),s.length=0,l=null;break;case"restoreJump":if(s.push(m(k)),s.length<1)break;u.restoreJump=new Mo(s[0]),s.length=0,l=null;break;case"couldownDespawn":if(s.push(m(k)),s.length<1)break;u.couldownDespawn=new go(s[0]),s.length=0,l=null;break;case"spawner":if(s.push(m(k)),s.length<3)break;throw"Spawner todo";case"speed":if(s.push(m(k)),s.length<2)break;u.speed=new ko(s[0],s[1]),s.length=0,l=null;break;case"acceleration":if(s.push(m(k)),s.length<2)break;u.acceleration=new To(s[0],s[1]),s.length=0,l=null;break;case"goal":if(s.push(m(k)),s.length<1)break;u.goal=s[0],s.length=0,l=null;break;case null:{let A=+k;Number.isFinite(A)?(i(),u=new h,o[0]=m(k),p=1,l="block"):l=k;break}}return i(),y(),new J(e)}var ke=class a{static TRANSITION_SPEED=60;static TRANSITION_DURATION=25;x=0;y=0;startX=0;startY=0;targetX=0;targetY=0;instant=!0;speed=0;move(e,t){this.targetX=e,this.targetY=t}teleport(e,t){this.targetX=e,this.targetY=t,this.instant=!0}startTracker(e,t){let o=e-this.x,s=t-this.y,l=Math.sqrt(o*o+s*s);this.startX=this.x,this.startY=this.y,this.targetX=e,this.targetY=t,this.instant=!1,this.speed=l/a.TRANSITION_DURATION}update(e){if(this.instant){this.x=this.targetX,this.y=this.targetY;return}let t=this.targetX-this.x,o=this.targetY-this.y,s=t*t+o*o;if(s<this.speed*this.speed){this.x=this.targetX,this.y=this.targetY,this.instant=!0;return}let l=this.speed/Math.sqrt(s);this.x+=t*l,this.y+=o*l}reset(){this.teleport(0,0)}};var me=class{left=!1;right=!1;up=!1;down=!1;debug=!1;enter=!1};var Qe=class{left=0;right=0;up=0;down=0;debug=0;enter=0},Te=class a{static CONTROLS=["left","right","up","down","debug","enter"];keyboardUsed=!1;mobileUsed=!1;inFullScreen=!1;controlBounds=[];collectedKeys=new Qe;keysDown=new me;firstPress=new me;killedPress=new me;keyMap;static KEYBOARDS={zqsd:{KeyZ:"up",KeyQ:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"},wasd:{KeyW:"up",KeyA:"left",KeyS:"down",KeyD:"right",KeyP:"debug",Space:"up",ArrowUp:"up",ArrowLeft:"left",ArrowDown:"down",ArrowRight:"right",Enter:"enter"}};constructor(e){this.keyMap=a.KEYBOARDS[e]}onKeydown=e=>{let t=e,o=this.keyMap[t.code];if(o)switch(this.collectedKeys[o]){case 0:this.collectedKeys[o]=1;break;case 1:break;case 2:this.collectedKeys[o]=4;break;case 3:this.collectedKeys[o]=4;break;case 4:this.collectedKeys[o]=4;break}};onKeyup=e=>{let t=e,o=this.keyMap[t.code];if(o)switch(this.collectedKeys[o]){case 0:this.collectedKeys[o]=2;break;case 1:this.collectedKeys[o]=3;break;case 2:break;case 3:this.collectedKeys[o]=3;break;case 4:this.collectedKeys[o]=3;break}};getInputControl(e,t,o){if(this.controlBounds.length==0)return null;for(let s=0;s<this.controlBounds.length;s++){let l=this.controlBounds[s];if(e>=l.left+window.scrollX&&e<=l.right+window.scrollX&&t>=l.top+window.scrollY&&t<=l.bottom+window.scrollY)switch(s){case 0:return"left";case 1:return"right";case 2:return"up";case 3:return"down";case 4:{if(o!=="first")break;let p=prompt("Type 0 for enter ; 1 for debug ; 2 for fullscreen ; 3 for refresh");if(p===null)break;let v=Number.parseInt(p);if(v===0)return"enter";if(v===1)return"debug";if(v===2){try{document.body.requestFullscreen?document.body.requestFullscreen():document.body.webkitRequestFullscreen?document.body.webkitRequestFullscreen():document.body.msRequestFullscreen&&document.body.msRequestFullscreen()}catch(h){console.error(h)}return this.inFullScreen=!0,null}if(v===3)return window.location.reload(),null;break}}}return null}onTouchStart=e=>{e.preventDefault();let t=[!1,!1,!1,!1],o=Array.from(e.touches);for(let l of o){let p=this.getInputControl(l.clientX,l.clientY,"first");if(p){switch(p){case"left":t[0]=!0;break;case"right":t[1]=!0;break;case"up":t[2]=!0;break;case"down":t[3]=!0;break;case"debug":case"enter":this.collectedKeys[p]=3;break}switch(this.collectedKeys[p]){case 0:this.collectedKeys[p]=1;break;case 1:break;case 2:this.collectedKeys[p]=4;break;case 3:this.collectedKeys[p]=4;break;case 4:this.collectedKeys[p]=4;break}}}let s=document.getElementById("mobileEntryContainer");if(s)for(let l=0;l<4;l++)t[l]?s.children[l].classList.add("high"):s.children[l].classList.remove("high")};onTouchMove=e=>{e.preventDefault();let t=[!1,!1,!1,!1],o=Array.from(e.touches);for(let l of o){let p=this.getInputControl(l.clientX,l.clientY,"move");if(p){switch(p){case"left":t[0]=!0;break;case"right":t[1]=!0;break;case"up":t[2]=!0;break;case"down":t[3]=!0;break;case"debug":case"enter":this.collectedKeys[p]=3;break}switch(this.collectedKeys[p]){case 0:this.collectedKeys[p]=1;break;case 1:break;case 2:this.collectedKeys[p]=4;break;case 3:this.collectedKeys[p]=4;break;case 4:this.collectedKeys[p]=4;break}}}let s=document.getElementById("mobileEntryContainer");if(s)for(let l=0;l<4;l++)t[l]?s.children[l].classList.add("high"):s.children[l].classList.remove("high")};onTouchEnd=e=>{let t=Array.from(e.changedTouches),o=[!1,!1,!1,!1];for(let l of t){let p=this.getInputControl(l.clientX,l.clientY,"remove");if(p){switch(p){case"left":o[0]=!0;break;case"right":o[1]=!0;break;case"up":o[2]=!0;break;case"down":o[3]=!0;break}switch(this.collectedKeys[p]){case 0:this.collectedKeys[p]=2;break;case 1:this.collectedKeys[p]=3;break;case 2:break;case 3:this.collectedKeys[p]=3;break;case 4:this.collectedKeys[p]=3;break}}}let s=document.getElementById("mobileEntryContainer");if(s)for(let l=0;l<4;l++)o[l]&&s.children[l].classList.remove("high")};startListeners(e){"ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia("(pointer: coarse)").matches?this.startMobileListeners(e):this.enableKeyboardListeners(e)}removeListeners(e){this.keyboardUsed&&(e.removeEventListener("keydown",this.onKeydown),e.removeEventListener("keyup",this.onKeyup)),this.mobileUsed&&(e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchend",this.onTouchEnd))}enableKeyboardListeners(e){e.addEventListener("keydown",this.onKeydown),e.addEventListener("keyup",this.onKeyup),this.keyboardUsed=!0}startMobileListeners(e){e.addEventListener("touchstart",this.onTouchStart,{passive:!1}),e.addEventListener("touchmove",this.onTouchMove,{passive:!1}),e.addEventListener("touchend",this.onTouchEnd,{passive:!1});let t=document.getElementById("mobileEntryContainer");if(t){t.classList.remove("hidden");for(let o=0;o<t.children.length;o++){let s=t.children[o];this.controlBounds.push(s.getBoundingClientRect())}}this.mobileUsed=!0}update(){for(let e of a.CONTROLS){switch(this.collectedKeys[e]){case 0:this.firstPress[e]=!1,this.killedPress[e]=!1;break;case 1:this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break;case 2:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1);break;case 3:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1):this.firstPress[e]=!0,this.killedPress[e]=!0;break;case 4:this.keysDown[e]?(this.firstPress[e]=!1,this.keysDown[e]=!1,this.killedPress[e]=!0):(this.firstPress[e]=!1,this.killedPress[e]=!1),this.keysDown[e]?this.firstPress[e]=!1:(this.firstPress[e]=!0,this.keysDown[e]=!0),this.killedPress[e]=!1;break}this.collectedKeys[e]=0}}press(e){return this.firstPress[e]||this.keysDown[e]}first(e){return this.firstPress[e]}killed(e){return this.killedPress[e]}kill(e){this.keysDown[e]=!1}draw(){}};var Me=class a{type="menu";chrono=0;static PLAY_TO_WIN_DURATION=60;update(){switch(this.chrono++,this.type){case"playToWin":this.chrono>=a.PLAY_TO_WIN_DURATION&&this.set("win");break}}getChrono(){return this.chrono}set(e){this.type=e,this.chrono=0}get(){return this.type}},B=class a{static WIDTH=1600;static HEIGHT=900;static WIDTH_2=a.WIDTH/2;static HEIGHT_2=a.HEIGHT/2;static GAME_VERSION="1.2.0";player=new $;camera=new ke;inputHandler;stageList;stage=null;frame=0;goalComplete=0;gameChrono=0;state=new Me;validRun=!0;currentWorld=0;currentLevel=0;selectWorldFile=!1;constructor(e,t,o){this.inputHandler=new Te(e),this.inputHandler.startListeners(t),this.stageList=o}startLevel(e){this.stage=e,this.resetStage()}playLogic(e){e&&(this.inputHandler.press("debug")?(this.validRun=!1,this.player.eternalMode=!0):this.player.eternalMode=!1),this.player.frame(this),this.stage.frame(this),this.player.respawnCouldown==$.RESPAWN_COULDOWN&&this.resetStage(),this.player.isAlive()&&this.handleRoom(),e&&(this.goalComplete>0&&this.state.set("playToWin"),this.player.respawnCouldown<0&&this.gameChrono++)}menuLogic(){if(this.inputHandler.first("enter")&&!this.selectWorldFile){let e=this.stageList[this.currentWorld][this.currentLevel];e&&(this.state.set("play"),this.startLevel(e))}this.inputHandler.first("right")&&(this.selectWorldFile?this.selectWorldFile=!1:this.currentLevel<this.stageList[this.currentWorld].length-1&&this.currentLevel++),this.inputHandler.first("left")&&!this.selectWorldFile&&(this.currentLevel>0?this.currentLevel--:this.selectWorldFile=!0),this.selectWorldFile?this.inputHandler.first("debug")&&(async()=>{let[e]=await window.showOpenFilePicker(),t=await e.getFile();async function*o(){let l=t.stream().getReader(),p=new TextDecoder,v,h="";for(;!(v=await l.read()).done;){h+=p.decode(v.value,{stream:!0});let m;for(;(m=h.search(/[ \r\n]/))!==-1;){let i=h.slice(0,m).trim();h=h.slice(m+1),i&&(yield i)}}let u=h.trim();u&&(yield u)}let s=await ve(o);this.inputHandler.kill("debug"),this.state.set("play"),this.startLevel(s)})():(this.inputHandler.first("down")&&this.currentWorld<this.stageList.length-1&&this.currentWorld++,this.inputHandler.first("up")&&this.currentWorld>0&&this.currentWorld--)}winLogic(){if(this.validRun&&this.inputHandler.first("debug")){let e=window.open("","_blank"),t="This feature is coming soon...";if(e){let o=e?.document.createElement("div");o.innerText=t,e.document.body.appendChild(o)}else alert("inspect page to get run link"),console.log(t);this.validRun=!1}this.inputHandler.first("enter")&&this.state.set("menu")}gameLogic(){switch(this.inputHandler.update(),this.state.get()){case"play":this.playLogic(!0);break;case"playToWin":this.playLogic(!1);break;case"menu":this.menuLogic();break;case"win":this.winLogic();break}this.frame++,this.state.update()}generateChronoText(){let e=this.state.get();if(e!=="play"&&e!=="playToWin"&&e!=="win")return"";if(!this.validRun)return"debug";let t=this.gameChrono/60,o=Math.floor(t/60),s=Math.floor(t%60),l=Math.floor((t-Math.floor(t))*1e3),p=(v,h)=>v.toString().padStart(h,"0");return`${p(o,2)}:${p(s,2)}.${p(l,3)}`}resetStage(){this.stage.reset(),this.state.get()==="play"&&(this.player.respawn(),this.camera.reset(),this.validRun=!0,this.gameChrono=0,this.goalComplete=0)}handleRoom(){let e=this.player.getSize(),t=o=>{let s,l;return o.w<=a.WIDTH?s=o.x+o.w/2:this.player.x-a.WIDTH_2<=o.x?s=o.x+a.WIDTH_2:this.player.x+a.WIDTH_2>=o.x+o.w?s=o.x+o.w-a.WIDTH_2:s=this.player.x,o.h<=a.HEIGHT?l=o.y+o.h/2:this.player.y-a.HEIGHT_2<=o.y?l=o.y+a.HEIGHT_2:this.player.y+a.HEIGHT_2>=o.y+o.h?l=o.y+o.h-a.HEIGHT_2:l=this.player.y,{camX:s,camY:l}};switch(this.stage.update(this.player.x,this.player.y,e.x,e.y)){case"same":{let o=t(this.stage.currentRoom);this.camera.move(o.camX,o.camY);break}case"new":{let o=t(this.stage.currentRoom);this.camera.startTracker(o.camX,o.camY),this.player.restoreJumps();break}case"out":this.player.kill();break}}drawMethod(e,t,o){let s=this.state.get();switch(this.state.get()){case"play":case"playToWin":{t(),e.fillStyle="#111",e.fillRect(this.stage.currentRoom.x,this.stage.currentRoom.y,this.stage.currentRoom.w,this.stage.currentRoom.h),e.fillStyle="#1a1a1a";for(let l of this.stage.currentRoom.adjacentRooms)e.fillRect(l.x,l.y,l.w,l.h);this.stage.currentRoom.draw(e);for(let l of this.stage.currentRoom.adjacentRooms)l.draw(e);if(this.stage.drawAdjacenceRects(e,this.player),this.player.draw(e),o(),this.player.drawInfos(e),this.player.drawDeathTransition(e),s==="playToWin"){let l=1.5*this.state.getChrono()/Me.PLAY_TO_WIN_DURATION;l<1?l=Math.sin(l*Math.PI/2):l=1,e.fillStyle=`rgba(0, 0, 0, ${l*l*l})`,e.fillRect(0,0,a.WIDTH,a.HEIGHT)}break}case"menu":{if(e.fillStyle="#111",e.fillRect(0,0,a.WIDTH,a.HEIGHT),e.textAlign="center",e.font="30px Arial",e.fillStyle="white",this.selectWorldFile)e.fillText("Select file (press P)",a.WIDTH_2,100);else{e.fillText(`World ${this.currentWorld+1}`,a.WIDTH_2,100);for(let p=0;p<this.stageList[this.currentWorld].length;p++){e.fillStyle=p==this.currentLevel?"yellow":"white";let v=400+200*(p%5),h=300+Math.floor(p/5)*100;e.fillText(`#${p}`,v,h)}}let l=e.textBaseline;e.textBaseline="bottom",e.textAlign="right",e.font="20px monospace",e.fillText("v"+a.GAME_VERSION,a.WIDTH,a.HEIGHT),e.textBaseline=l;break}case"win":{e.fillStyle="black",e.fillRect(0,0,a.WIDTH,a.HEIGHT),e.font="30px Arial",e.fillStyle="white",e.textAlign="center",e.fillText("Press P to save",a.WIDTH_2,a.HEIGHT_2-20),e.fillStyle="white",e.fillText("Press F5 to restart",a.WIDTH_2,a.HEIGHT_2+20),e.fillStyle="white",e.fillText("Press enter to select level",a.WIDTH_2,a.HEIGHT_2+60);break}}}gameDraw(e,t,o,s){let l=t/a.WIDTH,p=o/a.HEIGHT,v=Math.min(l,p),h=(t-a.WIDTH*v)/2,u=(o-a.HEIGHT*v)/2;e.save(),e.translate(h,u),e.scale(v,v),e.fillStyle="black",e.fillRect(0,0,a.WIDTH,a.HEIGHT),this.camera.update(this.player.getSpeed2()),s(e,()=>{e.save(),e.translate(a.WIDTH_2-this.camera.x,a.HEIGHT_2-this.camera.y)},()=>{e.restore()}),e.restore(),e.fillStyle="black",u>0&&e.fillRect(0,0,t,u),u>0&&e.fillRect(0,o-u,t,u),h>0&&e.fillRect(0,0,h,o),h>0&&e.fillRect(t-h,0,h,o)}};var{MovingPath:Mn,MovingModule:xn,CouldownedAttackModule:q,ContinuousAttackModule:et,BounceModule:ne,KillModule:z,CouldownDespawnModule:Rn,TouchDespawnModule:Ro,HealModule:pe,SpeedModule:wt,AccelerationModule:En,RestoreJumpModule:tt,RotationModule:Dn,SpawnerModule:yt}=oe,gt=[[new J([new P(-800,-450,1600,900,[new C(0,412.5,800,75,new S({bounce:new ne(.91,.003)})),new C(-662.5,-287.5,75,75,new S({kill:new z})),new C(-562.5,-187.5,75,75,new S({kill:new z})),new C(-662.5,-87.5,75,75,new S({kill:new z})),new C(-562.5,12.5,75,75,new S({kill:new z})),new C(575,300,100,100,new S({heal:new pe(2)})),new C(312.5,-137.5,175,175,new S({restoreJump:new tt(2)})),new C(-662.5,112.5,75,75,new S({kill:new z}))]),new P(800,-450,1600,900,[new C(1600,0,800,450,new S({couldownedAttack:new q(1.5,100)}))]),new P(2e3,450,1200,625,[new C(2675,675,250,250,new S({heal:new pe(12)}))]),new P(2800,-450,1600,900,[new C(3237.5,112.5,75,675,new S({kill:new z})),new C(3962.5,-112.5,75,675,new S({kill:new z})),new C(4e3,337.5,800,225,new S({restoreJump:new tt(1.7)}))]),new P(4e3,-1350,1600,900,[new C(4800,-900,400,700,new S({continuousAttack:new et(.04)})),new C(5175,-1162.5,50,375,new S({couldownedAttack:new q(1,120)}))]),new P(5200,-2250,1600,900,[new C(5425,-1500,350,150,new S({heal:new pe(2)}))]),new P(6400,-1350,1600,900,[new C(7200,-900,150,150,new S({goal:1}))])]),new J([new P(-800,-450,1600,900,[new C(0,200,100,100,new S({bounce:new ne(1,.003)})),new C(500,200,100,100,new S({bounce:new ne(.9,.04)}))]),new P(800,-650,1600,900,[new C(1600,-200,300,300,new S({couldownedAttack:new q(1.8,100)}))]),new P(2400,-450,1600,900,[new C(2900,100,100,700,new S({couldownedAttack:new q(1,100)})),new C(3200,-150,100,600,new S({kill:new z})),new C(3500,100,100,700,new S({couldownedAttack:new q(1,100)})),new C(3200,400,300,50,new S({bounce:new ne(.9,.07)}))]),new P(4e3,-450,1600,900,[new C(4400,0,700,800,new S({continuousAttack:new et(.02)})),new C(5e3,0,200,200,new S({heal:new pe(2)}))]),new P(5600,-950,1600,900,[new C(6450,-150,500,400,new S({continuousAttack:new et(.07)})),new C(6100,-400,100,700,new S({couldownedAttack:new q(1,100)})),new C(6400,-650,100,600,new S({kill:new z})),new C(6800,-400,100,700,new S({couldownedAttack:new q(1,100)})),new C(6400,-100,300,50,new S({bounce:new ne(.9,.07)})),new C(6600,-500,200,200,new S({restoreJump:new tt(1)}))]),new P(7e3,-50,700,900,[]),new P(7400,-950,1600,900,[new C(7900,-400,100,700,new S({kill:new z})),new C(8200,-650,100,600,new S({kill:new z})),new C(8700,-400,100,700,new S({kill:new z})),new C(8200,-100,300,50,new S({bounce:new ne(.9,.07)})),new C(8050,-60,20,20,new S({spawner:new yt(160,!0,[new he(new S({couldownedAttack:new q(.5,100),speed:new wt(0,-5),touchDespawn:new Ro}))])})),new C(8600,0,50,50,new S({spawner:new yt(160,!0,[new he(new S({heal:new pe(.9),speed:new wt(0,-5)}))])}))]),new P(9e3,-950,1600,900,[new C(9800,-500,100,100,new S({goal:1}))])])]];function Eo(){let a=document.getElementById("gameCanvas");function e(){a.width=window.innerWidth,a.height=window.innerHeight}e(),window.addEventListener("resize",e);let t=localStorage.getItem("keyboardMode"),o;t!=="zqsd"&&t!=="wasd"?o="wasd":o=t;let s=a.getContext("2d"),l=new B(o,document,gt),p=document.getElementById("chrono");function v(){l.gameLogic(),l.gameDraw(s,a.width,a.height,(h,u,m)=>{l.drawMethod(h,u,m)}),p.innerHTML=l.generateChronoText(),window.running&&requestAnimationFrame(v)}window.game=l,window.running=!0,v()}window.game=null;window.running=!1;window.startGame=Eo;var{MovingPath:Wn,MovingModule:Nn,CouldownedAttackModule:Do,ContinuousAttackModule:Ao,BounceModule:Co,KillModule:So,CouldownDespawnModule:Io,TouchDespawnModule:Ho,HealModule:Bo,SpeedModule:Po,AccelerationModule:Oo,RestoreJumpModule:Lo,RotationModule:Wo,SpawnerModule:_n}=oe;async function No(a,e){for(let t of a.rooms){await e(`${t.blocks.length?"room":"emptyroom"} ${t.x} ${t.y} ${t.w} ${t.h}`);for(let o of t.blocks){await e(`	${o.x} ${o.y} ${o.w} ${o.h}`);let s=o.module;if(s){if(s.moving)throw"Moving todo";if(s.rotation&&await e(`		rotation ${s.rotation.start??0} ${s.rotation.speed??0}`),s.couldownedAttack&&await e(`		couldownedAttack ${s.couldownedAttack.damages??0} ${s.couldownedAttack.duration??0}`),s.continuousAttack&&await e(`		continuousAttack ${s.continuousAttack.damages??0}`),s.bounce&&await e(`		bounce ${s.bounce.factor??0} ${s.bounce.cost??0}`),s.kill&&await e(`		kill ${s.kill.playerOnly?1:0}`),s.heal&&await e(`		heal ${s.heal.hp??0}`),s.touchDespawn&&await e(`		touchDespawn ${s.touchDespawn.playerOnly?1:0}`),s.restoreJump&&await e(`		restoreJump ${s.restoreJump.gain??0}`),s.couldownDespawn&&await e(`		couldownDespawn ${s.couldownDespawn.duration??0}`),s.spawner)throw"Spawner to do";s.speed&&await e(`		speed ${s.speed.vx??0} ${s.speed.vy??0}`),s.acceleration&&await e(`		acceleration ${s.acceleration.ax??0} ${s.acceleration.ay??0}`),s.goal&&await e(`		goal ${s.goal.type??0}`)}}}}function _o(){let a=document.getElementById("gameCanvas"),e=document.getElementById("mode"),t=document.getElementById("panel"),o=a.getContext("2d"),s=[],l=[];function p(){I=null,window.game=null}function v(){a.width=window.innerWidth,a.height=window.innerHeight}v(),window.addEventListener("resize",v);let h=25,u={x:0,y:0,zoom:1},m={sx:0,sy:0,wx:0,wy:0,down:!1,button:-1},i={active:!1,type:null,target:null,startMouseX:0,startMouseY:0,startTargetX:0,startTargetY:0},y="default",k=!1,A={x:0,y:0},R=null,H=-1,I=null,N="default",se=[new P(-800,-450,1600,900,[])],L=[new J(se)],xe=(n,r,c)=>Math.max(r,Math.min(c,n));function D(n){return Math.round(n/h-.5)*h}function U(n,r){let c=a.getBoundingClientRect(),d=(n-c.left)*(a.width/c.width),w=(r-c.top)*(a.height/c.height),f=a.width/B.WIDTH,b=a.height/B.HEIGHT,T=Math.min(f,b),M=(a.width-B.WIDTH*T)/2,E=(a.height-B.HEIGHT*T)/2,g=((d-M)/T-B.WIDTH_2)/u.zoom+u.x,x=((w-E)/T-B.HEIGHT_2)/u.zoom+u.y;return{x:g,y:x}}function Xo(){let n=U(m.sx,m.sy);m.wx=D(n.x),m.wy=D(n.y)}function fe(n,r){let c=L[0];for(let d of c.rooms)for(let w of d.blocks){let f=w.w/2,b=w.h/2;if(n>=w.x-f&&n<=w.x+f&&r>=w.y-b&&r<=w.y+b)return w}return null}function Z(n,r){let c=L[0];for(let d of c.rooms)if(n>=d.x&&n<=d.x+d.w&&r>=d.y&&r<=d.y+d.h)return d;return null}function ot(n,r,c){let d=9/u.zoom,w=n.w/2,f=n.h/2,b=Math.abs(r-(n.x-w))<d,T=Math.abs(r-(n.x+w))<d,M=Math.abs(c-(n.y-f))<d,E=Math.abs(c-(n.y+f))<d;return M&&b?"top-left":M&&T?"top-right":E&&b?"bottom-left":E&&T?"bottom-right":b?"left":T?"right":M?"top":E?"bottom":null}function nt(n,r,c){let d=19/u.zoom,w=Math.abs(r-n.x)<d,f=Math.abs(r-(n.x+n.w))<d,b=Math.abs(c-n.y)<d,T=Math.abs(c-(n.y+n.h))<d;return b&&w?"top-left":b&&f?"top-right":T&&w?"bottom-left":T&&f?"bottom-right":w?"left":f?"right":b?"top":T?"bottom":null}function st(n){return n&&{top:"ns-resize",bottom:"ns-resize",left:"ew-resize",right:"ew-resize","top-left":"nwse-resize","bottom-right":"nwse-resize","top-right":"nesw-resize","bottom-left":"nesw-resize"}[n]||"default"}function ie(n){let r=L[0];for(let c of r.rooms)if(c.containsBox(n.x,n.y,n.w,n.h))return c;return null}function re(n,r){let c=n.x-n.w/2,d=n.x+n.w/2,w=n.y-n.h/2,f=n.y+n.h/2;return c>=r.x&&d<=r.x+r.w&&w>=r.y&&f<=r.y+r.h}function it(n,r){let c=L[0];for(let d of c.rooms){let w=d.blocks.indexOf(n);if(w>=0){d.blocks.splice(w,1);break}}r.blocks.push(n)}function Yo(n){if(n.length===0)return{minX:0,minY:0,maxX:0,maxY:0};let r=1/0,c=1/0,d=-1/0,w=-1/0;for(let f of n){let b=f.x-f.w/2,T=f.x+f.w/2,M=f.y-f.h/2,E=f.y+f.h/2;r=Math.min(r,b),d=Math.max(d,T),c=Math.min(c,M),w=Math.max(w,E)}return{minX:r,minY:c,maxX:d,maxY:w}}function bt(n,r,c){let d=L[0],w=new Set(n);for(let f of n){let b=f.x+r,T=f.y+c,M=Z(b,T);if(!M||!re({x:b,y:T,w:f.w,h:f.h},M))return!1;for(let E of d.rooms)for(let g of E.blocks){if(w.has(g))continue;let x=Math.abs(b-g.x),X=Math.abs(T-g.y),W=(f.w+g.w)/2,O=(f.h+g.h)/2;if(x<W&&X<O)return!1}}return!0}function vt(n,r,c){let d=L[0];for(let w of n){let f=w.x+r,b=w.y+c,T=Z(f,b);T&&ie(w)!==T&&it(w,T),w.x=f,w.y=b}}function Q(){t.innerHTML="",t.classList.add("hidden"),R=null}function rt(n){t.classList.remove("hidden");let r=[],c=n.module.bounce?"checked":"",d=n.module.bounce?"block":"none",w=n.module.bounce?.factor||1,f=n.module.bounce?.cost||.003;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modBounce" ${c}> Bounce
				</label>
				<div id="bounceOptions" style="display: ${d}; margin-top: 10px; padding-left: 20px;">
					<label>Factor: <input type="number" id="bounceFactor" value="${w}" step="0.1" style="width: 80px;"></label><br>
					<label>Cost: <input type="number" id="bounceCost" value="${f}" step="0.001" style="width: 80px;"></label>
				</div>
			</div>
		`);let b=n.module.kill?"checked":"";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modKill" ${b}> Kill
				</label>
			</div>
		`);let T=n.module.heal?"checked":"",M=n.module.heal?"block":"none",E=n.module.heal?.hp||2;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modHeal" ${T}> Heal
				</label>
				<div id="healOptions" style="display: ${M}; margin-top: 10px; padding-left: 20px;">
					<label>HP: <input type="number" id="healHp" value="${E}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let g=n.module.couldownedAttack?"checked":"",x=n.module.couldownedAttack?"block":"none",X=n.module.couldownedAttack?.damages||1,W=n.module.couldownedAttack?.duration||100;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownAttack" ${g}> Cooldown Attack
				</label>
				<div id="cooldownAttackOptions" style="display: ${x}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="cooldownAttackDamages" value="${X}" step="0.1" style="width: 80px;"></label><br>
					<label>Duration: <input type="number" id="cooldownAttackDuration" value="${W}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let O=n.module.continuousAttack?"checked":"",_=n.module.continuousAttack?"block":"none",G=n.module.continuousAttack?.damages||.02;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modContinuousAttack" ${O}> Continuous Attack
				</label>
				<div id="continuousAttackOptions" style="display: ${_}; margin-top: 10px; padding-left: 20px;">
					<label>Damages: <input type="number" id="continuousAttackDamages" value="${G}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let ae=n.module.restoreJump?"checked":"",le=n.module.restoreJump?"block":"none",ce=n.module.restoreJump?.gain||1;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRestoreJump" ${ae}> Restore Jump
				</label>
				<div id="restoreJumpOptions" style="display: ${le}; margin-top: 10px; padding-left: 20px;">
					<label>Gain: <input type="number" id="restoreJumpGain" value="${ce}" step="0.1" style="width: 80px;"></label>
				</div>
			</div>
		`);let Re=n.module.goal!==void 0?"checked":"",Et=n.module.goal!==void 0?"block":"none",Dt=n.module.goal?.type||1;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modGoal" ${Re}> Goal
				</label>
				<div id="goalOptions" style="display: ${Et}; margin-top: 10px; padding-left: 20px;">
					<label>Type: <input type="number" id="goalType" value="${Dt}" step="1" style="width: 80px;"></label>
				</div>
			</div>
		`);let At=n.module.moving?"checked":"",Ct=n.module.moving?"block":"none";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modMoving" ${At}> Moving
				</label>
				<div id="movingOptions" style="display: ${Ct}; margin-top: 10px; padding-left: 20px;">
					<p>Configure in code (MovingPath patterns)</p>
				</div>
			</div>
		`);let St=n.module.speed?"checked":"",It=n.module.speed?"block":"none",Ht=n.module.speed?.vx||0,Bt=n.module.speed?.vy||0;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpeed" ${St}> Speed
				</label>
				<div id="speedOptions" style="display: ${It}; margin-top: 10px; padding-left: 20px;">
					<label>VX: <input type="number" id="speedVx" value="${Ht}" step="0.5" style="width: 80px;"></label><br>
					<label>VY: <input type="number" id="speedVy" value="${Bt}" step="0.5" style="width: 80px;"></label>
				</div>
			</div>
		`);let Pt=n.module.acceleration?"checked":"",Ot=n.module.acceleration?"block":"none",Lt=n.module.acceleration?.ax||0,Wt=n.module.acceleration?.ay||0;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modAcceleration" ${Pt}> Acceleration
				</label>
				<div id="accelerationOptions" style="display: ${Ot}; margin-top: 10px; padding-left: 20px;">
					<label>AX: <input type="number" id="accelerationAx" value="${Lt}" step="0.01" style="width: 80px;"></label><br>
					<label>AY: <input type="number" id="accelerationAy" value="${Wt}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let Nt=n.module.rotation?"checked":"",_t=n.module.rotation?"block":"none",Xt=n.module.rotation?.start||0,Yt=n.module.rotation?.speed||.01;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modRotation" ${Nt}> Rotation
				</label>
				<div id="rotationOptions" style="display: ${_t}; margin-top: 10px; padding-left: 20px;">
					<label>Start: <input type="number" id="rotationStart" value="${Xt}" step="0.1" style="width: 80px;"></label><br>
					<label>Speed: <input type="number" id="rotationSpeed" value="${Yt}" step="0.01" style="width: 80px;"></label>
				</div>
			</div>
		`);let $t=n.module.spawner?"checked":"",Ft=n.module.spawner?"block":"none";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modSpawner" ${$t}> Spawner
				</label>
				<div id="spawnerOptions" style="display: ${Ft}; margin-top: 10px; padding-left: 20px;">
					<p>Configure in code (BlockBuilder array)</p>
				</div>
			</div>
		`);let Ut=n.module.touchDespawn?"checked":"";r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modTouchDespawn" ${Ut}> Touch Despawn
				</label>
			</div>
		`);let zt=n.module.couldownDespawn?"checked":"",Gt=n.module.couldownDespawn?"block":"none",Vt=n.module.couldownDespawn?.duration||100;r.push(`
			<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px;">
				<label style="font-weight: bold;">
					<input type="checkbox" id="modCooldownDespawn" ${zt}> Cooldown Despawn
				</label>
				<div id="cooldownDespawnOptions" style="display: ${Gt}; margin-top: 10px; padding-left: 20px;">
					<label>Duration: <input type="number" id="cooldownDespawnDuration" value="${Vt}" step="10" style="width: 80px;"></label>
				</div>
			</div>
		`),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px; max-height: 80vh; overflow-y: auto;">
				<h3>Block Properties</h3>
				<button id="deleteBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Block (Suppr)</button>
				<div>
					<label>X: <input type="number" id="blockX" value="${n.x}" step="${h}"></label><br>
					<label>Y: <input type="number" id="blockY" value="${n.y}" step="${h}"></label><br>
					<label>Width: <input type="number" id="blockW" value="${n.w}" step="${h}" min="${h}"></label><br>
					<label>Height: <input type="number" id="blockH" value="${n.h}" step="${h}" min="${h}"></label><br>
				</div>
				<div style="margin-top: 20px;">
					<h4>Modules</h4>
					${r.join("")}
				</div>
			</div>
		`,document.getElementById("deleteBtn").addEventListener("click",()=>{let F=ie(n);if(F){let V=F.blocks.indexOf(n);V>=0&&F.blocks.splice(V,1)}Q()});let we=()=>{let F=parseFloat(document.getElementById("blockX").value),V=parseFloat(document.getElementById("blockY").value),K=parseFloat(document.getElementById("blockW").value),j=parseFloat(document.getElementById("blockH").value);n.x=D(F),n.y=D(V),n.w=Math.max(h,D(K)),n.h=Math.max(h,D(j))},Kt=()=>{document.getElementById("blockX").value=n.x.toString(),document.getElementById("blockY").value=n.y.toString(),document.getElementById("blockW").value=n.w.toString(),document.getElementById("blockH").value=n.h.toString()};document.getElementById("blockX").addEventListener("change",we),document.getElementById("blockY").addEventListener("change",we),document.getElementById("blockW").addEventListener("change",we),document.getElementById("blockH").addEventListener("change",we);let Ee=()=>{let F=document.getElementById("modBounce").checked,V=document.getElementById("modKill").checked,K=document.getElementById("modHeal").checked,j=document.getElementById("modCooldownAttack").checked,ut=document.getElementById("modContinuousAttack").checked,dt=document.getElementById("modRestoreJump").checked,ht=document.getElementById("modGoal").checked,jt=document.getElementById("modMoving").checked,De=document.getElementById("modSpeed").checked,Ae=document.getElementById("modAcceleration").checked,Ce=document.getElementById("modRotation").checked,qt=document.getElementById("modSpawner").checked,Zt=document.getElementById("modTouchDespawn").checked,mt=document.getElementById("modCooldownDespawn").checked,Qt=F?parseFloat(document.getElementById("bounceFactor").value):1,eo=F?parseFloat(document.getElementById("bounceCost").value):.003,to=K?parseFloat(document.getElementById("healHp").value):2,oo=j?parseFloat(document.getElementById("cooldownAttackDamages").value):1,no=j?parseInt(document.getElementById("cooldownAttackDuration").value):100,so=ut?parseFloat(document.getElementById("continuousAttackDamages").value):.02,io=dt?parseFloat(document.getElementById("restoreJumpGain").value):1,ro=ht?parseInt(document.getElementById("goalType").value):1,ao=De?parseFloat(document.getElementById("speedVx").value):0,lo=De?parseFloat(document.getElementById("speedVy").value):0,co=Ae?parseFloat(document.getElementById("accelerationAx").value):0,uo=Ae?parseFloat(document.getElementById("accelerationAy").value):0,ho=Ce?parseFloat(document.getElementById("rotationStart").value):0,mo=Ce?parseFloat(document.getElementById("rotationSpeed").value):.01,po=mt?parseInt(document.getElementById("cooldownDespawnDuration").value):100,pt=new S({bounce:F?new Co(Qt,eo):void 0,kill:V?new So:void 0,heal:K?new Bo(to):void 0,couldownedAttack:j?new Do(oo,no):void 0,continuousAttack:ut?new Ao(so):void 0,restoreJump:dt?new Lo(io):void 0,goal:ht?ro:void 0,moving:jt?n.module.moving:void 0,speed:De?new Po(ao,lo):void 0,acceleration:Ae?new Oo(co,uo):void 0,rotation:Ce?new Wo(ho,mo):void 0,spawner:qt?n.module.spawner:void 0,touchDespawn:Zt?new Ho:void 0,couldownDespawn:mt?new Io(po):void 0});n.module=pt,n.drawMode=pt.getDrawModule(0),n.drawMode&&(n.drawAnimator=n.drawMode.generateAnimator(n))},Y=(F,V)=>{let K=document.getElementById(F),j=document.getElementById(V);K&&j?K.addEventListener("change",()=>{j.style.display=K.checked?"block":"none",Ee()}):K&&K.addEventListener("change",Ee)};Y("modBounce","bounceOptions"),Y("modHeal","healOptions"),Y("modCooldownAttack","cooldownAttackOptions"),Y("modContinuousAttack","continuousAttackOptions"),Y("modRestoreJump","restoreJumpOptions"),Y("modGoal","goalOptions"),Y("modSpeed","speedOptions"),Y("modAcceleration","accelerationOptions"),Y("modRotation","rotationOptions"),Y("modCooldownDespawn","cooldownDespawnOptions"),Y("modKill",""),Y("modMoving","movingOptions"),Y("modSpawner","spawnerOptions"),Y("modTouchDespawn","");let Jt=["bounceFactor","bounceCost","healHp","cooldownAttackDamages","cooldownAttackDuration","continuousAttackDamages","restoreJumpGain","goalType","speedVx","speedVy","accelerationAx","accelerationAy","rotationStart","rotationSpeed","cooldownDespawnDuration"];for(let F of Jt){let V=document.getElementById(F);V&&V.addEventListener("change",Ee)}n._updateDisplay=Kt}function at(n){t.classList.remove("hidden"),t.innerHTML=`
			<div style="position: absolute; left: 10px; top: 60px; background: white; padding: 20px; border-radius: 5px; max-width: 400px;">
				<h3>Room Properties</h3>
				<button id="deleteRoomBtn" style="background: red; color: white; padding: 10px; margin-bottom: 10px; cursor: pointer; border: none; border-radius: 3px;">Delete Room (Suppr)</button>
				<div>
					<label>X: <input type="number" id="roomX" value="${n.x}" step="${h}"></label><br>
					<label>Y: <input type="number" id="roomY" value="${n.y}" step="${h}"></label><br>
					<label>Width: <input type="number" id="roomW" value="${n.w}" step="${h}" min="${h*4}"></label><br>
					<label>Height: <input type="number" id="roomH" value="${n.h}" step="${h}" min="${h*4}"></label><br>
				</div>
			</div>
		`,document.getElementById("deleteRoomBtn").addEventListener("click",()=>{let w=L[0],f=w.rooms.indexOf(n);f>=0&&w.rooms.splice(f,1),Q()});let c=()=>{let w=parseFloat(document.getElementById("roomX").value),f=parseFloat(document.getElementById("roomY").value),b=parseFloat(document.getElementById("roomW").value),T=parseFloat(document.getElementById("roomH").value);n.x=D(w),n.y=D(f),n.w=Math.max(h*4,D(b)),n.h=Math.max(h*4,D(T))},d=()=>{document.getElementById("roomX").value=n.x.toString(),document.getElementById("roomY").value=n.y.toString(),document.getElementById("roomW").value=n.w.toString(),document.getElementById("roomH").value=n.h.toString()};document.getElementById("roomX").addEventListener("change",c),document.getElementById("roomY").addEventListener("change",c),document.getElementById("roomW").addEventListener("change",c),document.getElementById("roomH").addEventListener("change",c),n._updateDisplay=d}t.addEventListener("mousedown",n=>{n.stopPropagation()}),t.addEventListener("click",n=>{n.stopPropagation()}),t.addEventListener("wheel",n=>{n.stopPropagation()}),t.addEventListener("pointerdown",n=>{n.stopPropagation()}),t.addEventListener("pointermove",n=>{n.stopPropagation()}),t.addEventListener("pointerup",n=>{n.stopPropagation()}),document.addEventListener("mousedown",n=>{let r=U(n.clientX,n.clientY);if(m.down=!0,m.button=n.button,m.sx=n.clientX,m.sy=n.clientY,m.wx=D(r.x),m.wy=D(r.y),y!=="play"){if(n.button===1){k=!0,A.x=n.clientX,A.y=n.clientY,n.preventDefault();return}if(n.button===2&&y==="default"){if(n.preventDefault(),s.length>0){let c=fe(r.x,r.y);if(c&&s.includes(c)){i.active=!0,i.type="multi-select-move",i.startMouseX=r.x,i.startMouseY=r.y;return}}i.active=!0,i.type="multi-select",i.createStartX=r.x,i.createStartY=r.y;return}if(n.button===0){if(y==="default"){if(s.length>0){let d=fe(r.x,r.y);if(d&&s.includes(d)){i.active=!0,i.type="multi-select-move",i.startMouseX=r.x,i.startMouseY=r.y;return}else s=[]}let c=fe(r.x,r.y);if(c){let d=ot(c,r.x,r.y);if(d){i.active=!0,i.type="resize-block",i.target=c,i.resizeEdge=d,i.startMouseX=r.x,i.startMouseY=r.y,i.startTargetX=c.x,i.startTargetY=c.y,i.startTargetW=c.w,i.startTargetH=c.h;return}i.active=!0,i.type="block",i.target=c,i.startMouseX=r.x,i.startMouseY=r.y,i.startTargetX=c.x,i.startTargetY=c.y,R=c,rt(c);return}i.active=!0,i.type="create-block",i.createStartX=D(r.x),i.createStartY=D(r.y)}else if(y==="rooms"){let c=Z(r.x,r.y);if(c){let d=nt(c,r.x,r.y);if(d){i.active=!0,i.type="resize-room",i.target=c,i.resizeEdge=d,i.startMouseX=r.x,i.startMouseY=r.y,i.startTargetX=c.x,i.startTargetY=c.y,i.startTargetW=c.w,i.startTargetH=c.h;return}i.active=!0,i.type="room",i.target=c,i.startMouseX=r.x,i.startMouseY=r.y,i.startTargetX=c.x,i.startTargetY=c.y,R=c,at(c);return}i.active=!0,i.type="create-room",i.createStartX=D(r.x),i.createStartY=D(r.y)}}}}),document.addEventListener("mouseup",n=>{if(m.down=!1,n.button===1&&(k=!1),n.button===2&&i.active){if(i.type==="multi-select-move"){i.active=!1,i.type=null;return}if(i.type==="multi-select"){let r=U(n.clientX,n.clientY),c=Math.min(i.createStartX,r.x),d=Math.min(i.createStartY,r.y),w=Math.max(i.createStartX,r.x),f=Math.max(i.createStartY,r.y);s=[];let b=L[0];for(let T of b.rooms)for(let M of T.blocks){let E=M.x-M.w/2,g=M.x+M.w/2,x=M.y-M.h/2,X=M.y+M.h/2,W=!(g<=c||E>=w),O=!(X<=d||x>=f);W&&O&&s.push(M)}i.active=!1,i.type=null,s.length>0&&Q();return}}if(n.button===0&&i.active){let r=U(n.clientX,n.clientY);if(i.type==="multi-select-move"){i.active=!1,i.type=null;return}if(i.type==="create-block"){let c=Math.min(i.createStartX,D(r.x)),d=Math.min(i.createStartY,D(r.y)),w=Math.max(i.createStartX,D(r.x))+h,f=Math.max(i.createStartY,D(r.y))+h,b=w-c,T=f-d;if(b>=h&&T>=h){let M=c+b/2,E=d+T/2,g=new C(M,E,b,T,new S({})),x=Z(g.x,g.y);if(x){let X=L[0],W=!0;for(let O of X.rooms){for(let _ of O.blocks){let G=Math.abs(g.x-_.x),ae=Math.abs(g.y-_.y),le=(g.w+_.w)/2,ce=(g.h+_.h)/2;if(G<le&&ae<ce){W=!1;break}}if(!W)break}W&&(x.blocks.push(g),R=g,rt(g))}}}else if(i.type==="create-room"){let c=Math.min(i.createStartX,D(r.x)),d=Math.min(i.createStartY,D(r.y)),w=Math.max(i.createStartX,D(r.x))+h,f=Math.max(i.createStartY,D(r.y))+h,b=w-c,T=f-d;if(b>=h*4&&T>=h*4){let M=new P(c,d,b,T,[]),E=L[0],g=!0;for(let x of E.rooms){let X=!(M.x+M.w<=x.x||M.x>=x.x+x.w),W=!(M.y+M.h<=x.y||M.y>=x.y+x.h);if(X&&W){g=!1;break}}g&&(E.rooms.push(M),R=M,at(M))}}i.active=!1,i.type=null,i.target=null}}),document.addEventListener("mousemove",n=>{let r=U(n.clientX,n.clientY);if(m.sx=n.clientX,m.sy=n.clientY,m.wx=D(r.x),m.wy=D(r.y),y!=="play"&&!i.active&&!k){let c="default";if(y==="default"){let d=fe(r.x,r.y);if(d){let w=ot(d,r.x,r.y);c=w?st(w):"move"}}else if(y==="rooms"){let d=Z(r.x,r.y);if(d){let w=nt(d,r.x,r.y);c=w?st(w):"move"}}c!==N&&(N=c,a.style.cursor=c)}else k&&(a.style.cursor="grabbing");if(k){let c=(n.clientX-A.x)/u.zoom,d=(n.clientY-A.y)/u.zoom;u.x-=c,u.y-=d,A.x=n.clientX,A.y=n.clientY}if(i.active&&(i.type==="multi-select-move"||i.type==="multi-select"&&s.length>0&&m.button===0)&&s.length>0){let c=D(r.x)-D(i.startMouseX),d=D(r.y)-D(i.startMouseY);if(c===0&&d===0)return;bt(s,c,d)&&(vt(s,c,d),i.startMouseX=D(r.x),i.startMouseY=D(r.y))}else if(i.active&&i.type==="block"&&i.target){let c=i.target,d=D(r.x)-D(i.startMouseX),w=D(r.y)-D(i.startMouseY),f=i.startTargetX+d,b=i.startTargetY+w,T=L[0],M=!0;for(let g of T.rooms){for(let x of g.blocks){if(x===c)continue;let X=Math.abs(f-x.x),W=Math.abs(b-x.y),O=(c.w+x.w)/2,_=(c.h+x.h)/2;if(X<O&&W<_){M=!1;break}}if(!M)break}let E=Z(f,b);(!E||!re({x:f,y:b,w:c.w,h:c.h},E))&&(M=!1),M&&(E&&ie(c)!==E&&it(c,E),c.x=f,c.y=b,c._updateDisplay&&c._updateDisplay())}else if(i.active&&i.type==="room"&&i.target){let c=i.target,d=D(r.x)-D(i.startMouseX),w=D(r.y)-D(i.startMouseY),f=i.startTargetX+d,b=i.startTargetY+w,T=L[0],M=!0;for(let E of T.rooms){if(E===c)continue;let g=!(f+c.w<=E.x||f>=E.x+E.w),x=!(b+c.h<=E.y||b>=E.y+E.h);if(g&&x){M=!1;break}}if(M){let E=f-c.x,g=b-c.y;for(let x of c.blocks)x.x+=E,x.y+=g;c.x=f,c.y=b,c._updateDisplay&&c._updateDisplay()}}else if(i.active&&i.type==="resize-block"&&i.target){let c=i.target,d=D(r.x)-D(i.startMouseX),w=D(r.y)-D(i.startMouseY),f=i.resizeEdge,b=h,T=n.shiftKey,M=i.startTargetX,E=i.startTargetY,g=i.startTargetW,x=i.startTargetH;if(T){let _=i.startTargetW/i.startTargetH;f.includes("left")||f.includes("right")?(g=f.includes("left")?i.startTargetW-d:i.startTargetW+d,g>=b?(x=g/_,x>=b?(f.includes("left"),M=i.startTargetX+d/2,f.includes("top")?E=i.startTargetY+(i.startTargetH-x)/2:f.includes("bottom")&&(E=i.startTargetY-(i.startTargetH-x)/2)):(g=i.startTargetW,x=i.startTargetH)):(g=i.startTargetW,x=i.startTargetH)):(x=f.includes("top")?i.startTargetH-w:i.startTargetH+w,x>=b?(g=x*_,g>=b?(f.includes("top"),E=i.startTargetY+w/2,f.includes("left")?M=i.startTargetX+(i.startTargetW-g)/2:f.includes("right")&&(M=i.startTargetX-(i.startTargetW-g)/2)):(g=i.startTargetW,x=i.startTargetH)):(g=i.startTargetW,x=i.startTargetH))}else f.includes("left")&&(g=i.startTargetW-d,g>=b?M=i.startTargetX+d/2:g=i.startTargetW),f.includes("right")&&(g=i.startTargetW+d,g>=b?M=i.startTargetX+d/2:g=i.startTargetW),f.includes("top")&&(x=i.startTargetH-w,x>=b?E=i.startTargetY+w/2:x=i.startTargetH),f.includes("bottom")&&(x=i.startTargetH+w,x>=b?E=i.startTargetY+w/2:x=i.startTargetH);let X=L[0],W=!0;for(let _ of X.rooms){for(let G of _.blocks){if(G===c)continue;let ae=Math.abs(M-G.x),le=Math.abs(E-G.y),ce=(g+G.w)/2,Re=(x+G.h)/2;if(ae<ce&&le<Re){W=!1;break}}if(!W)break}let O=ie(c);O&&!re({x:M,y:E,w:g,h:x},O)&&(W=!1),W&&(c.x=M,c.y=E,c.w=g,c.h=x,c._updateDisplay&&c._updateDisplay())}else if(i.active&&i.type==="resize-room"&&i.target){let c=i.target,d=D(r.x)-D(i.startMouseX),w=D(r.y)-D(i.startMouseY),f=i.resizeEdge,b=h*4,T=n.shiftKey,M=i.startTargetX,E=i.startTargetY,g=i.startTargetW,x=i.startTargetH;if(T){let O=i.startTargetW/i.startTargetH;f.includes("left")||f.includes("right")?(g=f.includes("left")?i.startTargetW-d:i.startTargetW+d,g>=b?(x=g/O,x>=b?(f.includes("left")&&(M=i.startTargetX+d),f.includes("top")&&(E=i.startTargetY+(i.startTargetH-x))):(g=i.startTargetW,x=i.startTargetH)):(g=i.startTargetW,x=i.startTargetH)):(x=f.includes("top")?i.startTargetH-w:i.startTargetH+w,x>=b?(g=x*O,g>=b?(f.includes("top")&&(E=i.startTargetY+w),f.includes("left")&&(M=i.startTargetX+(i.startTargetW-g))):(g=i.startTargetW,x=i.startTargetH)):(g=i.startTargetW,x=i.startTargetH))}else f.includes("left")&&(g=i.startTargetW-d,g>=b?M=i.startTargetX+d:g=i.startTargetW),f.includes("right")&&(g=i.startTargetW+d,g<b&&(g=i.startTargetW)),f.includes("top")&&(x=i.startTargetH-w,x>=b?E=i.startTargetY+w:x=i.startTargetH),f.includes("bottom")&&(x=i.startTargetH+w,x<b&&(x=i.startTargetH));let X=L[0],W=!0;for(let O of X.rooms){if(O===c)continue;let _=!(M+g<=O.x||M>=O.x+O.w),G=!(E+x<=O.y||E>=O.y+O.h);if(_&&G){W=!1;break}}if(W){let O={x:M,y:E,w:g,h:x};for(let _ of c.blocks)if(!re(_,O)){W=!1;break}}W&&(c.x=M,c.y=E,c.w=g,c.h=x,c._updateDisplay&&c._updateDisplay())}}),document.addEventListener("keydown",n=>{switch(n.code){case"F1":{n.preventDefault(),y==="play"?(y="default",I=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",H>=0&&(clearInterval(H),H=-1)):(y==="default"?(y="rooms",e.style.backgroundColor="#ff0044",e.textContent="rooms"):(y="default",e.style.backgroundColor="black",e.textContent="default"),s=[],Q());break}case"F2":{if(n.preventDefault(),y==="play")y="default",I=null,window.game=null,e.style.backgroundColor="black",e.textContent="default",H>=0&&(clearInterval(H),H=-1);else{y="play",s=[],Q();let r=localStorage.getItem("keyboardMode"),c="wasd";(r==="zqsd"||r==="wasd")&&(c=r);let d=new J(L[0].rooms.map(w=>new P(w.x,w.y,w.w,w.h,w.blocks.map(f=>new C(f.x,f.y,f.w,f.h,f.module.copy())))));I=new B(c,document,[[d]]),window.game=I,I.state.set("play"),I.startLevel(d),e.style.backgroundColor="rgb(0, 132, 255)",e.textContent="play"}break}case"F3":{n.preventDefault();break}case"F9":{n.preventDefault(),(async()=>{let c=await(await window.showSaveFilePicker({suggestedName:"stage.txt",types:[{description:"Stage",accept:{"text/plain":[".txt"]}}]})).createWritable(),d=new TextEncoder;function w(f){return c.write(d.encode(f+`
`))}await No(L[0],w),await c.close()})();break}case"F10":{n.preventDefault(),(async()=>{let[r]=await window.showOpenFilePicker(),c=await r.getFile();async function*d(){let f=c.stream().getReader(),b=new TextDecoder,T,M="";for(;!(T=await f.read()).done;){M+=b.decode(T.value,{stream:!0});let g;for(;(g=M.search(/[ \r\n]/))!==-1;){let x=M.slice(0,g).trim();M=M.slice(g+1),x&&(yield x)}}let E=M.trim();E&&(yield E)}let w=await ve(d);L[0]=w})();break}case"Escape":{s.length>0?s=[]:R?Q():t.classList.toggle("hidden");break}case"Delete":{if(s.length>0){let r=L[0];for(let c of s)for(let d of r.rooms){let w=d.blocks.indexOf(c);if(w>=0){d.blocks.splice(w,1);break}}s=[]}else if(R){if(R instanceof C){let r=ie(R);if(r){let c=r.blocks.indexOf(R);c>=0&&r.blocks.splice(c,1)}}else if(R instanceof P){let r=L[0],c=r.rooms.indexOf(R);c>=0&&r.rooms.splice(c,1)}Q()}break}case"KeyC":{if(n.ctrlKey&&s.length>0){n.preventDefault();let r=Math.min(...s.map(d=>d.x)),c=Math.min(...s.map(d=>d.y));l=s.map(d=>({module:d.module.copy(),dx:d.x-r,dy:d.y-c,w:d.w,h:d.h}))}break}case"KeyV":{if(n.ctrlKey&&l.length>0){n.preventDefault();let r=U(m.sx,m.sy),c=D(r.x),d=D(r.y),w=Z(c,d);if(!w)break;s=[];for(let f of l){let b=new C(c+f.dx,d+f.dy,f.w,f.h,f.module.copy());re(b,w)&&(w.blocks.push(b),s.push(b))}}break}}}),document.addEventListener("wheel",n=>{n.preventDefault();let r=U(n.clientX,n.clientY),c=r.x,d=r.y,w=1.12,f=n.deltaY<0?w:1/w;u.zoom=xe(u.zoom*f,.2,8)},{passive:!1}),document.addEventListener("contextmenu",n=>{y!=="play"&&n.preventDefault()});function kt(n){let r=Math.floor((u.x-B.WIDTH_2/u.zoom)/h)*h,c=Math.ceil((u.x+B.WIDTH_2/u.zoom)/h)*h,d=Math.floor((u.y-B.HEIGHT_2/u.zoom)/h)*h,w=Math.ceil((u.y+B.HEIGHT_2/u.zoom)/h)*h;n.strokeStyle="#444";let f=.3,b=1,T=3,M=16,E=9;for(let g=r;g<=c;g+=h)Math.floor(g/h)%(M*4)===0?n.lineWidth=T:Math.floor(g/h)%M===0?n.lineWidth=b:n.lineWidth=f,n.beginPath(),n.moveTo(g,d),n.lineTo(g,w),n.stroke();for(let g=d;g<=w;g+=h)Math.floor(g/h)%(E*4)===0?n.lineWidth=T:Math.floor(g/h)%E===0?n.lineWidth=b:n.lineWidth=f,n.beginPath(),n.moveTo(r,g),n.lineTo(c,g),n.stroke()}function Tt(n){if(!i.active)return;let r=U(m.sx,m.sy);if(i.type==="create-block"){let c=Math.min(i.createStartX,D(r.x)),d=Math.min(i.createStartY,D(r.y)),w=Math.max(i.createStartX,D(r.x))+h,f=Math.max(i.createStartY,D(r.y))+h,b=w-c,T=f-d;n.strokeStyle="cyan",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(c,d,b,T),n.setLineDash([])}else if(i.type==="create-room"){let c=Math.min(i.createStartX,D(r.x)),d=Math.min(i.createStartY,D(r.y)),w=Math.max(i.createStartX,D(r.x))+h,f=Math.max(i.createStartY,D(r.y))+h,b=w-c,T=f-d;n.strokeStyle="lime",n.lineWidth=3,n.setLineDash([10,5]),n.strokeRect(c,d,b,T),n.setLineDash([])}else if(i.type==="multi-select"){let c=Math.min(i.createStartX,r.x),d=Math.min(i.createStartY,r.y),w=Math.max(i.createStartX,r.x),f=Math.max(i.createStartY,r.y),b=w-c,T=f-d;n.strokeStyle="blue",n.fillStyle="rgba(0, 0, 255, 0.1)",n.lineWidth=2,n.setLineDash([5,5]),n.fillRect(c,d,b,T),n.strokeRect(c,d,b,T),n.setLineDash([])}}function lt(n,r){let c=8/u.zoom;n.fillStyle="cyan",n.strokeStyle="white",n.lineWidth=2/u.zoom;let d,w,f,b;r instanceof C?(d=r.x-r.w/2,w=r.y-r.h/2,f=r.w,b=r.h):(d=r.x,w=r.y,f=r.w,b=r.h);let T=[[d,w],[d+f,w],[d,w+b],[d+f,w+b]];for(let[E,g]of T)n.fillRect(E-c/2,g-c/2,c,c),n.strokeRect(E-c/2,g-c/2,c,c);let M=[[d+f/2,w],[d+f/2,w+b],[d,w+b/2],[d+f,w+b/2]];for(let[E,g]of M)n.fillRect(E-c/2,g-c/2,c,c),n.strokeRect(E-c/2,g-c/2,c,c)}function Mt(n,r){r.module.rotation&&(n.save(),n.strokeStyle="rgba(255, 165, 0, 0.5)",n.lineWidth=2/u.zoom,n.setLineDash([5,5]),n.strokeRect(r.x-r.w/2,r.y-r.h/2,r.w,r.h),n.setLineDash([]),n.restore())}function xt(n,r){r.module.spawner&&(n.save(),n.fillStyle="rgba(255, 0, 255, 0.3)",n.fillRect(r.x-r.w/2,r.y-r.h/2,r.w,r.h),n.fillStyle="magenta",n.font=`${Math.min(r.w,r.h)*.6}px Arial`,n.textAlign="center",n.textBaseline="middle",n.fillText("S",r.x,r.y),n.restore())}function Rt(n){let r=a.width/B.WIDTH,c=a.height/B.HEIGHT,d=Math.min(r,c),w=(a.width-B.WIDTH*d)/2,f=(a.height-B.HEIGHT*d)/2;n.fillStyle="black",n.fillRect(0,0,a.width,a.height),n.save(),n.translate(w,f),n.scale(d,d),n.save(),n.translate(B.WIDTH_2,B.HEIGHT_2),n.scale(u.zoom,u.zoom),n.translate(-u.x,-u.y),kt(n);let b=L[0];n.fillStyle="#ccc2";for(let T of b.rooms)n.fillRect(T.x,T.y,T.w,T.h);for(let T of b.rooms)T.draw(n);for(let T of b.rooms)for(let M of T.blocks)M.module.rotation&&Mt(n,M),M.module.spawner&&xt(n,M);n.strokeStyle="white",n.lineWidth=3;for(let T of b.rooms)n.strokeRect(T.x,T.y,T.w,T.h);n.strokeStyle="white",n.lineWidth=3;for(let T of b.rooms)n.strokeRect(T.x,T.y,T.w,T.h);if(R&&(R instanceof C?(n.strokeStyle="yellow",n.lineWidth=4/u.zoom,n.strokeRect(R.x-R.w/2,R.y-R.h/2,R.w,R.h),lt(n,R)):R instanceof P&&(n.strokeStyle="yellow",n.lineWidth=4/u.zoom,n.strokeRect(R.x,R.y,R.w,R.h),lt(n,R))),s.length>0){n.strokeStyle="blue",n.lineWidth=3/u.zoom;for(let T of s)n.strokeRect(T.x-T.w/2,T.y-T.h/2,T.w,T.h)}i.active&&Tt(n),n.fillStyle="rgba(255, 255, 255, 0.3)",n.fillRect(m.wx,m.wy,h,h),n.restore(),n.restore(),n.fillStyle="black",f>0&&n.fillRect(0,0,a.width,f),f>0&&n.fillRect(0,a.height-f,a.width,f),w>0&&n.fillRect(0,0,w,a.height),w>0&&n.fillRect(a.width-w,0,w,a.height),n.fillStyle="white",n.font="16px monospace",n.fillText(`Camera: (${u.x.toFixed(0)}, ${u.y.toFixed(0)}) Zoom: ${u.zoom.toFixed(2)}`,10,a.height-60),n.fillText(`Mouse: (${m.wx.toFixed(0)}, ${m.wy.toFixed(0)})`,10,a.height-40),n.fillText(`Mode: ${y} | F1: Default/Rooms | F2: Play | Esc: deselect | Del: delete`,10,a.height-20),s.length>0&&(n.fillStyle="yellow",n.fillText(`Selected blocks: ${s.length} | Ctrl+C to copy | Ctrl+V to paste`,10,a.height-80))}function ct(){y==="play"&&I?(I.gameLogic(),I.gameDraw(o,a.width,a.height,(n,r,c)=>{I.drawMethod(n,r,c)})):Rt(o),window.running&&requestAnimationFrame(ct)}window.game=I,window.running=!0,ct()}window.startEditor=_o;})();
