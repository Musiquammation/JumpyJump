<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Admin - Jumpy Jump</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 20px;
			background: #f0f0f0;
		}
		h1, h2 {
			color: #333;
		}
		table {
			width: 100%;
			border-collapse: collapse;
			background: white;
			margin-bottom: 30px;
		}
		th, td {
			border: 1px solid #ddd;
			padding: 8px;
			text-align: left;
		}
		th {
			background: #667eea;
			color: white;
		}
		button {
			padding: 5px 10px;
			cursor: pointer;
		}
		.delete {
			background: #f44336;
			color: white;
			border: none;
		}
		.save {
			background: #4CAF50;
			color: white;
			border: none;
		}
		input[type="number"] {
			width: 80px;
		}
		.loading {
			text-align: center;
			padding: 20px;
		}
	</style>
</head>
<body>
	<h1>üîß Admin Panel - Jumpy Jump</h1>

	<h2>Runs</h2>
	<div id="runsSection">
		<div class="loading">Chargement...</div>
	</div>

	<h2>Maps</h2>
	<div id="mapsSection">
		<div class="loading">Chargement...</div>
	</div>

	<script>
		const LINK = "https://jumpyjump-production.up.railway.app";
		let adminPassword = "";

		// Demander le mot de passe au chargement
		async function init() {
			adminPassword = prompt("Password admin:");
			if (!adminPassword) {
				document.body.innerHTML = "<h1>Acc√®s refus√©</h1>";
				return;
			}
			await loadAll();
		}

		async function loadAll() {
			await loadRuns();
			await loadMaps();
		}

		// Charger toutes les runs
		async function loadRuns() {
			try {
				const response = await fetch(`${LINK}/admin/runs`, {
					headers: {
						'X-Admin-Password': adminPassword
					}
				});
				
				if (!response.ok) {
					throw new Error('Unauthorized');
				}

				const runs = await response.json();
				
				const runsSection = document.getElementById('runsSection');
				
				if (runs.length === 0) {
					runsSection.innerHTML = '<p>Aucune run</p>';
					return;
				}

				// Grouper par map
				const runsByMap = {};
				runs.forEach(run => {
					if (!runsByMap[run.mapname]) {
						runsByMap[run.mapname] = [];
					}
					runsByMap[run.mapname].push(run);
				});

				let html = '<table><thead><tr><th>Map</th><th>Username</th><th>Time</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
				
				Object.keys(runsByMap).sort().forEach(mapname => {
					runsByMap[mapname].sort((a, b) => a.time - b.time).forEach(run => {
						console.log(run.mapid);
						html += `
							<tr>
								<td>${escapeHtml(run.mapname)}</td>
								<td>${escapeHtml(run.username)}</td>
								<td>
									<input type="number" id="time-${run.runid}" value="${run.time}">
									<button class="save" onclick="updateRun('${run.username}', '${run.mapid}', '${run.runid}')">üíæ</button>
								</td>
								<td>${new Date(parseInt(run.date)).toLocaleString('fr-FR')}</td>
								<td>
									<button class="delete" onclick="deleteRun('${run.username}', '${run.mapid}')">üóëÔ∏è Supprimer</button>
								</td>
							</tr>
						`;
					});
				});
				
				html += '</tbody></table>';
				runsSection.innerHTML = html;

			} catch (error) {
				console.error('Erreur:', error);
				document.getElementById('runsSection').innerHTML = '<p style="color:red">Erreur de chargement (mauvais mot de passe?)</p>';
			}
		}

		// Charger toutes les maps
		async function loadMaps() {
			try {
				const response = await fetch(`${LINK}/allmaps`);
				const maps = await response.json();
				
				const mapsSection = document.getElementById('mapsSection');
				
				if (maps.length === 0) {
					mapsSection.innerHTML = '<p>Aucune map</p>';
					return;
				}

				let html = '<table><thead><tr><th>Map ID</th><th>Map Name</th><th>Actions</th></tr></thead><tbody>';
				
				maps.forEach(map => {
					html += `
						<tr>
							<td>${map.mapid}</td>
							<td>${escapeHtml(map.mapname)}</td>
							<td>
								<button class="delete" onclick="deleteMap(${map.mapid}, '${escapeHtml(map.mapname)}')">üóëÔ∏è Supprimer</button>
							</td>
						</tr>
					`;
				});
				
				html += '</tbody></table>';
				mapsSection.innerHTML = html;

			} catch (error) {
				console.error('Erreur:', error);
				document.getElementById('mapsSection').innerHTML = '<p style="color:red">Erreur de chargement</p>';
			}
		}

		// Supprimer une run
		async function deleteRun(username, mapid) {
			if (!confirm(`Supprimer la run de ${username} ?`)) return;

			try {
				const response = await fetch(`${LINK}/admin/run`, {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json',
						'X-Admin-Password': adminPassword
					},
					body: JSON.stringify({ username, mapid })
				});

				if (!response.ok) throw new Error('Failed');

				alert('Run supprim√©e');
				await loadRuns();
			} catch (error) {
				alert('Erreur lors de la suppression');
				console.error(error);
			}
		}

		// Modifier le temps d'une run
		async function updateRun(username, mapid, runid) {
			const newTime = parseInt(document.getElementById(`time-${runid}`).value);
			
			if (!newTime || newTime < 0) {
				alert('Temps invalide');
				return;
			}

			try {
				const response = await fetch(`${LINK}/admin/run`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
						'X-Admin-Password': adminPassword
					},
					body: JSON.stringify({ username, mapid, time: newTime })
				});

				if (!response.ok) throw new Error('Failed');

				alert('Run modifi√©e');
				await loadRuns();
			} catch (error) {
				alert('Erreur lors de la modification');
				console.error(error);
			}
		}

		// Supprimer une map
		async function deleteMap(mapid, mapname) {
			if (!confirm(`Supprimer la map "${mapname}" et TOUTES ses runs ?`)) return;

			try {
				const response = await fetch(`${LINK}/admin/map`, {
					method: 'DELETE',
					headers: {
						'Content-Type': 'application/json',
						'X-Admin-Password': adminPassword
					},
					body: JSON.stringify({ mapid })
				});

				if (!response.ok) throw new Error('Failed');

				alert('Map supprim√©e');
				await loadAll();
			} catch (error) {
				alert('Erreur lors de la suppression');
				console.error(error);
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		// Initialiser
		init();
	</script>
</body>
</html>